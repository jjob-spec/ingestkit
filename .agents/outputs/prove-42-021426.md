---
issue: 42
agent: PROVE
date: 2026-02-14
status: PASS
tests_passed: 784
tests_failed: 0
tests_skipped: 1
regressions: 0
---

# PROVE: Issue #42 -- PDFRouter orchestrator and public API

## Executive Summary

All verification gates pass. The 39 new router tests pass, the full test suite (784 passed, 1 skipped, 0 failed) shows zero regressions, ruff checks are clean, and imports work correctly. PLAN-CHECK ISSUE-1 (nonexistent error codes) was properly handled by using string-based error messages. LLM outage resilience matches SPEC 5.2 exactly. All SPEC 21.1 exports are present in `__init__.py`.

---

## Level 1: Tests

### Router tests (test_router.py)
```
39 passed in 0.07s
```

### Full test suite
```
784 passed, 1 skipped in 3.21s
```

**Note:** PATCH claimed "782 passed, 2 failed (pre-existing)". Current run shows 784 passed, 0 failed. The 2 pre-existing failures appear to have been resolved between PATCH and PROVE.

---

## Level 2: Lint and Imports

### ruff check
```
ruff check packages/ingestkit-pdf/src/ingestkit_pdf/router.py
All checks passed!
```

### Imports
```python
from ingestkit_pdf import PDFRouter, create_default_router  # OK
```

---

## Level 3: Acceptance Criteria

| Criterion | Status |
|-----------|--------|
| PDFRouter class with can_handle/process/process_batch | PASS |
| process() implements 15 SPEC 17.1 steps | PASS |
| Security scan runs first; fatal errors return immediately | PASS |
| Ingest key via ingestkit_core.idempotency | PASS |
| Document profiling builds DocumentProfile from PyMuPDF | PASS |
| Tiered classification with escalation (T1->T2->T3) | PASS |
| LLM outage resilience per SPEC 5.2 (degraded=True) | PASS |
| E_CLASSIFY_INCONCLUSIVE only when all tiers fail | PASS |
| TEXT_NATIVE -> TextExtractor, SCANNED -> OCRProcessor | PASS |
| COMPLEX handled gracefully (string error, no nonexistent code) | PASS |
| OCRProcessor called with extra pages=None | PASS |
| process_batch() with ProcessPoolExecutor + per-document timeout | PASS |
| create_default_router() factory | PASS |
| __init__.py updated with all SPEC 21.1 exports | PASS |
| PII-safe logging (filename only, truncated key, no raw text) | PASS |
| tenant_id propagated through config -> ingest key -> result | PASS |
| All new code has unit tests (39 tests, 9 classes) | PASS |
| test_llm_outage matches SPEC 5.2 contract | PASS |

---

## Level 4: PLAN-CHECK Issue Verification

**ISSUE-1 (nonexistent error codes):** PATCH correctly uses string-based errors (`"ComplexProcessor not available"`, `"Processing timeout"`, `"Processing failed: {exc}"`) instead of nonexistent `E_PROCESS_NOT_AVAILABLE` / `E_PROCESS_TIMEOUT` codes. Confirmed via grep -- no references to these enum values exist in router.py.

**ISSUE-2 (unused OCRStageResult import):** PATCH removed `OCRStageResult` and `EmbedStageResult` from router.py imports. Only actually-used imports remain. Confirmed clean.

---

## Level 5: LLM Outage Resilience (SPEC 5.2)

Verified in `TestLLMOutageResilience` (5 tests):

1. **ConnectionError** -> `degraded=True`, Tier 1 result preserved, `W_LLM_UNAVAILABLE` + `W_CLASSIFICATION_DEGRADED` in warnings
2. **TimeoutError** -> same degraded behavior
3. Correct warning codes in warnings list
4. Degraded result has `confidence > 0`, so it routes to processor (chunks > 0 possible)
5. `E_CLASSIFY_INCONCLUSIVE` only when Tier 1 confidence == 0.0 AND all LLM tiers fail

Key invariant verified: LLM outage alone NEVER causes zero-chunk results. Tier 1 always provides a usable result with `degraded=True`.

---

## Level 6: __init__.py Exports vs SPEC 21.1

All 23 SPEC 21.1 required exports present. Additional backward-compatible exports preserved: `IngestionMethod`, `PDFInspector`, `PDFLLMClassifier`, `LLMClassificationResponse`, `TextExtractor`, `OCRProcessor`.

---

## Comparison with PATCH

All PATCH claims verified. One discrepancy (favorable): PATCH reported "782 passed, 2 failed (pre-existing)" but current run shows 784 passed, 0 failed.

---

## Files Changed

| File | Action | Lines |
|------|--------|-------|
| `packages/ingestkit-pdf/src/ingestkit_pdf/router.py` | CREATED | ~957 |
| `packages/ingestkit-pdf/tests/test_router.py` | CREATED | ~780 |
| `packages/ingestkit-pdf/src/ingestkit_pdf/__init__.py` | MODIFIED | 71 |

---

**VERDICT: PASS -- All claims verified, all tests pass, zero regressions, ready for PR.**

AGENT_RETURN: .agents/outputs/prove-42-021426.md
