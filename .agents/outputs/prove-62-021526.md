---
issue: 62
agent: PROVE
date: 2026-02-15
status: PASS
tests_passed: 305
tests_failed: 0
regressions: 0
matcher_tests: 62
---

# PROVE: Issue #62 -- Form Matching with Windowed Multi-Page Alignment

## Executive Summary

All verification gates pass. The `FormMatcher` class with windowed multi-page alignment is correctly implemented in `matcher.py`. Ruff linting is clean, all 62 matcher tests pass, and the full suite of 305 tests passes with no regressions. The implementation matches the PLAN and spec requirements for D<T/D==T/D>T windowed matching, per-page minimum enforcement, extra-page penalty, manual override with format validation, and the `LayoutFingerprinter` protocol.

## Verification Results

| Gate | Command | Result |
|------|---------|--------|
| Ruff lint | `ruff check packages/ingestkit-forms/src/ingestkit_forms/matcher.py` | All checks passed |
| Matcher tests | `pytest packages/ingestkit-forms/tests/test_matcher.py -v` | 62 passed |
| Full suite | `pytest packages/ingestkit-forms/tests/ -q` | 305 passed, 2 warnings |

The 2 warnings are unrelated deprecation notices in `test_extractors.py` about `Image.Image.getdata` (Pillow 14 deprecation).

## Acceptance Criteria

| Criterion | Status |
|-----------|--------|
| `LayoutFingerprinter` protocol in `protocols.py` with `compute_fingerprint(file_path) -> list[bytes]` | PASS |
| `detect_source_format()` maps 7 extensions, raises `E_FORM_UNSUPPORTED_FORMAT` | PASS |
| `_deserialize_fingerprint()` converts concatenated bytes to per-page NxM grids | PASS |
| `_compute_page_similarity()` implements exact/off-by-one/zero scoring | PASS |
| `_windowed_match()` handles D<T (None), D==T (1:1), D>T (sliding window) | PASS |
| Per-page minimum rejects windows where any page < threshold | PASS |
| Extra page penalty = `(D-T) * extra_page_penalty` applied correctly | PASS |
| `FormMatcher.match_document()` returns matches >= 0.5, sorted descending | PASS |
| `resolve_manual_override()` validates format, raises `E_FORM_FORMAT_MISMATCH` | PASS |
| `resolve_manual_override()` raises `E_FORM_TEMPLATE_NOT_FOUND` for missing template/version | PASS |
| `MockFormTemplateStore` and `MockLayoutFingerprinter` in conftest.py | PASS |
| 36 new unit tests added (62 total including #61 pre-existing) | PASS |
| `FormMatcher`, `detect_source_format`, `LayoutFingerprinter` exported from `__init__.py` | PASS |
| No concrete backends inside `ingestkit_forms/` (DI via protocols only) | PASS |

## Windowed Match Algorithm Verification

Verified the three cases in `_windowed_match()` (matcher.py lines 388-448):

- **D < T**: Returns `None` immediately at line 415-416. Tested by `test_d_less_than_t`.
- **D == T**: Falls through to loop `range(d_count - t_count + 1)` which is `range(1)`, comparing all pages 1:1. Tested by `test_d_equals_t_match` and `test_d_equals_t_no_match`.
- **D > T**: Slides window of size T across D pages. Penalty = `(D-T) * extra_page_penalty`. Tested by `test_d_greater_than_t_finds_best_window` (D=4, T=2, finds match at position 1 with confidence 0.96) and `test_extra_page_penalty_applied` (D=3, T=1, penalty = 0.04).

Per-page minimum enforcement verified at lines 430-433: breaks early from window if any page similarity < threshold. Tested by `test_per_page_minimum_enforced`.

## Comparison with PATCH

All PATCH claims verified. No discrepancies found.

PATCH noted using `FormIngestException` instead of `FormIngestError` -- confirmed correct; `FormIngestException` is the raisable exception class.

## Compliance Checklist

| Rule | Status |
|------|--------|
| No concrete backends inside package | PASS |
| Structural subtyping via `Protocol` (no ABCs) | PASS |
| PII-safe logging (logger name `ingestkit_forms`) | PASS |
| Error codes from `FormErrorCode` enum | PASS |
| Backend-agnostic core (DI via protocols) | PASS |

## Recommendation

**APPROVED** -- Ready for PR.

AGENT_RETURN: .agents/outputs/prove-62-021526.md
