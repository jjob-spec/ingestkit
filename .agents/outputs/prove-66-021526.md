---
issue: 66
agent: PROVE
date: 2026-02-15
status: PASS
tests_passed: 417
tests_failed: 0
regressions: 0
vlm_tests_passed: 13
---

# PROVE: Issue #66 -- VLM Fallback Extraction (VLMFieldExtractor)

## Executive Summary

All three verification gates pass. Ruff reports zero lint issues across the extractors package. The 13 VLM-specific tests pass with the `unit` marker. The full test suite passes at 417 tests with zero regressions (matching the expected count). All acceptance criteria from the PLAN are satisfied.

## Verification Gates

| Gate | Command | Result |
|------|---------|--------|
| Lint | `ruff check packages/ingestkit-forms/src/ingestkit_forms/extractors/` | All checks passed |
| VLM tests | `pytest test_extractors.py -v -k "VLM or vlm" -m unit` | 13 passed |
| Full suite | `pytest packages/ingestkit-forms/tests/ -q --no-header` | 417 passed, 0 failed |
| Import check | `python3 -c "from ingestkit_forms.extractors import VLMFieldExtractor"` | OK |

## Acceptance Criteria

| Criterion | Status |
|-----------|--------|
| `VLMFieldExtractor` class with `apply_vlm_fallback()` method | PASS |
| Trigger: confidence < `form_vlm_fallback_threshold` AND `form_vlm_enabled=True` | PASS |
| Budget: max `form_vlm_max_fields_per_document`, `W_FORM_VLM_BUDGET_EXHAUSTED` for overflow | PASS |
| Priority: required first, lowest confidence first | PASS |
| Graceful degradation: TimeoutError/Exception retains original | PASS |
| 10% padded crop, clamped to image bounds | PASS |
| `extraction_method="vlm_fallback"` on VLM-improved fields | PASS |
| `W_FORM_VLM_FALLBACK_USED` warning on all VLM-processed fields | PASS |
| `is_available()` check; log if unavailable | PASS |
| PII-safe logging (`log_sample_data` guard) | PASS |
| All VLM access via `VLMBackend` protocol only (no concrete imports) | PASS |
| 13 unit tests with mock VLM backend | PASS |
| No regressions in existing tests | PASS |
| `VLMFieldExtractor` exported from `extractors/__init__.py` | PASS |
| `MockVLMBackend` + fixtures in `conftest.py` | PASS |

## Comparison with PATCH

All PATCH claims verified. No discrepancies found.

- PATCH reported 347 total tests; full suite now at 417 (other tests were added between PATCH and PROVE runs -- no conflict, VLM tests are additive).
- Files created/modified match PATCH report exactly: 1 created (`vlm_fallback.py`), 3 modified (`__init__.py`, `conftest.py`, `test_extractors.py`).

## Compliance Checklist

- [x] No concrete backend imports in `vlm_fallback.py` (VLM access via protocol only)
- [x] `@pytest.mark.unit` on `TestVLMFallback` class (covers all 13 tests)
- [x] All tests use `MockVLMBackend` and `unittest.mock.patch` for `get_page_image`
- [x] Logger name is `ingestkit_forms` (project convention)
- [x] PII-safe: values only logged when `log_sample_data=True`
- [x] Uses `typing.Protocol` (structural subtyping), no ABCs
- [x] Pydantic v2 `model_copy(update=...)` for immutable field updates

## Recommendation

**APPROVED** -- Ready for PR.

AGENT_RETURN: .agents/outputs/prove-66-021526.md
