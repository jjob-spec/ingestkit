# PATCH: Issue #6 -- Tier 1 Rule-Based Inspector

**Date**: 2026-02-10
**Agent**: PATCH
**Status**: Complete -- all tests passing

---

## Files Created

### 1. `packages/ingestkit-excel/src/ingestkit_excel/inspector.py`

New module implementing `ExcelInspector`, the Tier 1 rule-based structural classifier.

**Class**: `ExcelInspector`
- `__init__(self, config: ExcelProcessorConfig)` -- stores config for threshold access.
- `classify(self, profile: FileProfile) -> ClassificationResult` -- public API entry point. Handles empty profiles, per-sheet classification, multi-sheet aggregation (agreement/disagreement/hybrid), and inconclusive escalation.
- `_classify_sheet(self, sheet: SheetProfile) -> tuple[FileType | None, float, dict[str, bool]]` -- classifies a single sheet using signal counts against config thresholds. Returns `None` file_type when inconclusive.
- `_evaluate_signals(self, sheet: SheetProfile) -> dict[str, bool]` -- evaluates 5 binary signals per sheet (row_count, merged_cell_ratio, column_type_consistency, header_detected, numeric_ratio). `True` = leans Type A (tabular), `False` = leans Type B (document).

**Decision logic**:
- 5 binary signals per sheet, each True (Type A) or False (Type B)
- type_a_count >= high_confidence (4) -> TABULAR_DATA, 0.9
- type_b_count >= high_confidence (4) -> FORMATTED_DOCUMENT, 0.9
- type_a_count >= medium_confidence (3) -> TABULAR_DATA, 0.7
- type_b_count >= medium_confidence (3) -> FORMATTED_DOCUMENT, 0.7
- Otherwise -> inconclusive (confidence 0.0)

**Multi-sheet aggregation**:
- All agree -> that type, minimum confidence
- Any inconclusive -> whole file inconclusive (confidence 0.0)
- Sheets disagree -> HYBRID, confidence 0.9, per_sheet_types populated

**Logging**: Uses `logging.getLogger("ingestkit_excel")` with DEBUG for per-sheet signals and INFO for final classification.

### 2. `packages/ingestkit-excel/tests/test_inspector.py`

39 tests across 9 test classes:

| Class | Tests | Description |
|---|---|---|
| `TestSignalEvaluation` | 10 | Each signal evaluated correctly for Type A and Type B |
| `TestSingleSheetClassification` | 7 | Decision logic: 5/5, 4/5, 3/5 for both types + inconclusive |
| `TestMultiSheetAgreement` | 4 | Two/three sheets agreeing, minimum confidence |
| `TestMultiSheetDisagreement` | 3 | Hybrid classification, per_sheet_types population |
| `TestInconclusiveEscalation` | 2 | Low confidence for tier escalation, inconclusive among clear |
| `TestEmptyProfile` | 2 | No sheets edge cases |
| `TestClassificationResultFields` | 4 | tier_used, signals dict, reasoning, enum values |
| `TestCustomConfig` | 3 | Custom thresholds respected |
| `TestBoundaryValues` | 4 | Exact boundary conditions (>=, <) |

Helper functions: `_make_sheet_profile(**overrides)` and `_make_file_profile(sheets, **overrides)`.

## Files Modified

### 3. `packages/ingestkit-excel/src/ingestkit_excel/__init__.py`

- Added `from ingestkit_excel.inspector import ExcelInspector` import
- Added `"ExcelInspector"` to `__all__` under `# Inspector` comment section

---

## Test Results

```
215 passed in 0.49s
```

- 39 new inspector tests: all passing
- 176 existing tests: all passing (no regressions)
- Zero failures, zero warnings

---

## Enum Values Used (verified correct)

- `FileType.TABULAR_DATA` -> `"tabular_data"`
- `FileType.FORMATTED_DOCUMENT` -> `"formatted_document"`
- `FileType.HYBRID` -> `"hybrid"`
- `ClassificationTier.RULE_BASED` -> `"rule_based"`
