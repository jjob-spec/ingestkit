---
issue: 72
agent: PATCH
date: 2026-02-15
status: Complete
files_modified: 2
files_created: 0
tests_added: 15
lines_added: 285
lines_removed: 12
---

# PATCH: Issue #72 -- Pipeline Integration as Path F

## Executive Summary

Added `match_document()` and `try_match()` methods to the existing `FormRouter` class, plus structured per-stage logging (match and extract stages) per spec 18.4. The `try_match()` method serves as the pipeline gate interface: returns `TemplateMatch | None` with zero state mutation on fallthrough. Also added structured logging to `extract_form()` for both match and extract stages. 15 new tests covering all paths.

## Metrics

| Metric | Value |
|--------|-------|
| Files modified | 2 |
| Tests added | 15 |
| Tests total (router) | 33 |
| Full suite | 506 passed |
| Regressions | 0 |

## Files Changed

### `packages/ingestkit-forms/src/ingestkit_forms/router.py`

**Context**: Issue #69 already fully implemented `FormRouter` with `extract_form()`, `extract_form_batch()`, and all pipeline logic. #72 adds the pipeline gate interface and observability.

- Added `TemplateMatch` to imports from `models.py`
- Added `match_document(file_path, tenant_id)` public method: wraps `FormMatcher.match_document()` with structured logging; returns empty list when `form_match_enabled=False`
- Added `try_match(file_path, template_id, tenant_id)` method: pipeline gate returning `TemplateMatch | None`. Manual override returns synthetic match with confidence=1.0. Auto-match applies `form_match_confidence_threshold` (0.8). Catches all exceptions and returns `None` (graceful fallthrough).
- Added structured match-stage logging in `extract_form()` Step 3: logs `template_candidates`, `top_confidence`, `match_duration_ms`, `match_result` (values: "manual", "auto", "fallthrough")
- Added structured extract-stage logging after Step 7: logs `template_id`, `template_version`, `fields_extracted`, `fields_failed`, `extraction_method`, `extract_duration_ms`
- Removed old `logger.debug` fallthrough message (replaced by structured match-stage log)

### `packages/ingestkit-forms/tests/test_router.py`

- Added `TestMatchDocument` class (4 tests): disabled returns empty, no templates returns empty, structured log verification, disabled logs fallthrough
- Added `TestTryMatch` class (6 tests): manual template, auto below threshold, disabled+no manual, exception returns None, no state mutation, manual not found
- Added `TestStructuredLogging` class (5 tests): logger name, match-stage log fields, extract-stage log fields, PII safety, fallthrough log
- Fixed pre-existing unused import lint warnings with `noqa: F401` comments

## Deviations from MAP-PLAN

1. **`match_document()` on FormRouter**: MAP-PLAN proposed this as a wrapper. Implemented as described -- delegates to `FormMatcher` with structured logging.
2. **`extract_form()` not reimplemented**: MAP-PLAN was written when `router.py` was a stub. Since #69 already fully implemented `extract_form()`, we only added structured logging to the existing implementation.
3. **`__init__.py` not modified**: `FormRouter` was already exported by issue #69. No changes needed.
4. **Threshold semantics**: Per PLAN-CHECK 6b, `match_document()` returns the full ranked list (warning floor 0.5), while `try_match()` applies `form_match_confidence_threshold` (0.8) for the gate decision. Both documented in docstrings.

## Acceptance Criteria Status

All criteria met. See MAP-PLAN for full list.

Key confirmations:
- `try_match()` documented as internal/non-protocol per PLAN-CHECK 6a
- Structured logging fields match spec 18.4 exactly
- PII safety verified: no field values in logs (test asserts absence of planted PII value)
- Logger name is `ingestkit_forms`
- Zero state mutation verified in `test_try_match_no_state_mutation`

## Verification Performed

```
ruff check router.py test_router.py     -> All checks passed
pytest test_router.py -v                 -> 33 passed
pytest tests/ -q --no-header             -> 506 passed, 0 failed
```

AGENT_RETURN: PATCH complete for issue #72. Added `match_document()` + `try_match()` pipeline gate + structured logging (18.4) to FormRouter. 15 new tests, all passing. 506 total tests, zero regressions.
