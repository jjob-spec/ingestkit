# PATCH: Issue #7 -- Tier 2/3 LLM Classifier with Schema Validation

**Issue:** #7
**Date:** 2026-02-10
**Plan artifact:** `/home/jjob/projects/ingestkit/.agents/outputs/plan-7-021026.md`
**MAP artifact:** `/home/jjob/projects/ingestkit/.agents/outputs/map-7-021026.md`

---

## Summary

Implemented the Tier 2/3 LLM classifier (`LLMClassifier`) for the ingestkit-excel package. The classifier generates PII-safe structural summaries from `FileProfile` objects, sends classification prompts to an LLM backend, validates responses against a Pydantic schema, and returns `ClassificationResult` instances with proper enum conversions.

---

## Files Changed

| File | Action | Lines | Purpose |
|------|--------|-------|---------|
| `src/ingestkit_excel/llm_classifier.py` | **CREATED** | 309 | LLM classifier with validation pipeline |
| `tests/test_llm_classifier.py` | **CREATED** | 631 | 61 tests with MockLLMBackend |
| `src/ingestkit_excel/__init__.py` | **MODIFIED** | +3 | Added `LLMClassifier` to imports and `__all__` |

---

## Implementation Details

### `llm_classifier.py`

**LLMClassificationResponse** -- Pydantic model for validating raw LLM JSON output:
- `type: Literal["tabular_data", "formatted_document", "hybrid"]` -- uses string VALUES matching `FileType` enum
- `confidence: float` -- NO `ge`/`le` constraints; bounds checked manually to allow clamping
- `reasoning: str = Field(min_length=1)` -- rejects empty strings
- `sheet_types: dict[str, Literal["tabular_data", "formatted_document"]] | None` -- individual sheets cannot be "hybrid"

**_infer_cell_type(value: str) -> str** -- Module-level helper for type inference in structural summaries. Classifies cell strings as "empty", "int", "float", or "str".

**LLMClassifier** -- Main class with methods:
- `__init__(self, llm: LLMBackend, config: ExcelProcessorConfig)` -- stores backend and config
- `classify(self, profile: FileProfile, tier: ClassificationTier) -> ClassificationResult` -- main entry point
  - Rejects `RULE_BASED` tier with `ValueError`
  - Maps `LLM_BASIC` -> `config.classification_model`, `LLM_REASONING` -> `config.reasoning_model`
  - 2-attempt retry loop with correction hints appended to prompt
  - Catches `json.JSONDecodeError`, `TimeoutError`, and generic `Exception` from backend
  - Fail-closed: returns `confidence=0.0` after all attempts exhausted
- `_generate_structural_summary(self, profile: FileProfile) -> str` -- PII-safe summary
  - Default mode: shows cell TYPES only (int, float, str, empty)
  - Opt-in (`log_sample_data=True`): shows actual values with redaction
  - Always includes headers (structural metadata)
  - Extracts filename only from `file_path` (no full path leakage)
- `_build_classification_prompt(self, summary: str, tier: ClassificationTier) -> str` -- prompt with exact enum string values
- `_validate_and_parse_response(self, raw: dict, profile: FileProfile) -> tuple[LLMClassificationResponse | None, list[IngestError]]` -- 3-step validation:
  1. Pydantic schema validation -> `E_LLM_SCHEMA_INVALID` on failure
  2. Confidence bounds check -> clamp + `E_LLM_CONFIDENCE_OOB` warning (does NOT reject)
  3. Sheet types cross-check -> warning only for unknown sheet names
- `_to_classification_result(self, response: LLMClassificationResponse, tier: ClassificationTier) -> ClassificationResult` -- enum conversion via `FileType(value)` (VALUE form, not NAME form)
- `_redact(self, text: str) -> str` -- applies `config.redact_patterns` regex substitutions

### `test_llm_classifier.py`

**MockLLMBackend** -- Queue-based mock that supports:
- Dict responses (simulate successful JSON parse)
- Exception responses (simulate backend failures)
- Call recording for assertion

**11 test classes, 61 tests:**
- `TestValidResponseParsing` (7 tests) -- valid responses for all file types, tier tracking, signals=None
- `TestMalformedJsonRetry` (4 tests) -- JSONDecodeError, generic exceptions, fail-closed, correction hints
- `TestSchemaValidation` (6 tests) -- missing fields, wrong type values, empty reasoning, retry+success, fail-closed
- `TestConfidenceBounds` (5 tests) -- clamping above 1.0, below 0.0, boundary values, no retry on OOB
- `TestTimeoutHandling` (2 tests) -- timeout retry, two timeouts fail-closed
- `TestFailClosed` (3 tests) -- zero confidence, correct tier_used, reasoning mentions failure
- `TestTierModelSelection` (6 tests) -- model selection, custom models, temperature, timeout, ValueError on RULE_BASED
- `TestStructuralSummary` (11 tests) -- no raw values by default, values when opted in, filename safety, headers, merged cells, hidden/formula/password annotations, max_sample_rows, redaction
- `TestPromptContent` (5 tests) -- enum value strings in prompt, structural summary inclusion, JSON-only instruction
- `TestCellTypeInference` (7 tests) -- empty, whitespace, int, float, str, negative int, negative float
- `TestLLMClassificationResponseModel` (5 tests) -- valid creation, invalid type rejected, empty reasoning rejected, hybrid in sheet_types rejected, no Field bounds on confidence

### `__init__.py`

Added:
- `from ingestkit_excel.llm_classifier import LLMClassifier` (import)
- `"LLMClassifier"` (in `__all__`)

---

## ENUM_VALUE Compliance

| Location | Value Used | Correct? |
|----------|-----------|----------|
| `LLMClassificationResponse.type` | `Literal["tabular_data", "formatted_document", "hybrid"]` | Yes -- string VALUES |
| `LLMClassificationResponse.sheet_types` values | `Literal["tabular_data", "formatted_document"]` | Yes -- no "hybrid" for individual sheets |
| `FileType()` constructor | `FileType(response.type)` | Yes -- VALUE form, not NAME form |
| Prompt text | `"tabular_data"`, `"formatted_document"`, `"hybrid"` | Yes -- string values |
| `ErrorCode` usage | `ErrorCode.E_LLM_TIMEOUT` etc. | Yes -- enum members, not strings |
| `ClassificationTier` in result | `ClassificationTier.LLM_BASIC` / `ClassificationTier.LLM_REASONING` | Yes -- enum members |

---

## VERIFICATION_GAP Compliance

| Assumption | Verified? |
|-----------|-----------|
| `LLMBackend.classify()` returns `dict` | Yes -- no `json.loads()` step, straight to Pydantic |
| Backend may raise on malformed JSON | Yes -- catches `json.JSONDecodeError` and generic `Exception` |
| Backend may raise `TimeoutError` | Yes -- caught explicitly |
| `per_sheet_types` needs `dict[str, FileType]` conversion | Yes -- `FileType(value)` for each entry |
| Logger uses `"ingestkit_excel"` name | Yes |
| Prompts/responses logged at DEBUG only when `config.log_llm_prompts` | Yes |
| `redact_patterns` applied to logged text | Yes |
| `ClassificationTier.RULE_BASED` raises `ValueError` | Yes |

---

## Test Results

```
276 passed in 0.42s
```

- 61 new tests (all passing)
- 215 existing tests (no regressions)
