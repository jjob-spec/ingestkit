---
issue: 69
agent: MAP
date: 2026-02-15
complexity: COMPLEX
stack: backend
files_identified: 14
---

# MAP - Issue #69: FormRouter and Plugin API Surface

## Summary

Implement `FormRouter` (orchestrator) and expand `FormPluginAPI` (the full 10-operation API surface) for `ingestkit-forms`. The router orchestrates the end-to-end form pipeline: security scan, ingest key computation, form matching, source detection, extractor selection, field extraction, confidence checks, optional VLM fallback, and dual-write output. The API class currently exists as `FormTemplateAPI` with 6 template CRUD methods; it needs 4 additional operations (`render_document`, `preview_extraction`, `match_document`, `extract_form`). The `idempotency.py` module is a stub that needs the two-key system (global ingest key + form extraction key). A `create_default_router()` factory function is also required. Key risk: this issue touches nearly every module as the router is the integration point.

## Affected Files

### Must Create/Implement (stubs exist)
- `packages/ingestkit-forms/src/ingestkit_forms/router.py` -- Currently 5-line docstring stub. Needs full `FormRouter` class and `create_default_router()` factory.
- `packages/ingestkit-forms/src/ingestkit_forms/idempotency.py` -- Currently 5-line docstring stub. Needs `compute_form_ingest_key()` (global) and `compute_form_extraction_key()` (template-versioned).

### Must Extend
- `packages/ingestkit-forms/src/ingestkit_forms/api.py` -- Has `FormTemplateAPI` with 6 CRUD methods. Must add `render_document`, `preview_extraction`, `match_document`, `extract_form` (or the API class must compose the router for the last two).
- `packages/ingestkit-forms/src/ingestkit_forms/__init__.py` -- Must export `FormRouter`, `create_default_router`, and idempotency functions.

### Must Read (dependencies, no changes expected)
- `packages/ingestkit-forms/src/ingestkit_forms/protocols.py` -- 7 protocols: FormDBBackend, FormTemplateStore, LayoutFingerprinter, OCRBackend, PDFWidgetBackend, VLMBackend. All fully implemented.
- `packages/ingestkit-forms/src/ingestkit_forms/models.py` -- All data models implemented: FormIngestRequest, FormProcessingResult, FormExtractionResult, ExtractedField, ExtractionPreview, FormWrittenArtifacts, etc.
- `packages/ingestkit-forms/src/ingestkit_forms/config.py` -- FormProcessorConfig with all params. Fully implemented.
- `packages/ingestkit-forms/src/ingestkit_forms/errors.py` -- FormErrorCode enum (29 codes), FormIngestError, FormIngestException. Fully implemented.
- `packages/ingestkit-forms/src/ingestkit_forms/matcher.py` -- FormMatcher with `match_document()` and `resolve_manual_override()`. Also has `detect_source_format()`. Fully implemented.
- `packages/ingestkit-forms/src/ingestkit_forms/confidence.py` -- `compute_field_confidence()`, `compute_overall_confidence()`, `apply_confidence_actions()`. Fully implemented.
- `packages/ingestkit-forms/src/ingestkit_forms/extractors/` -- All 4 extractors implemented: ExcelCellExtractor, NativePDFExtractor, OCROverlayExtractor, VLMFieldExtractor. All share `extract(file_path, template) -> list[ExtractedField]` interface (VLM uses `apply_vlm_fallback(fields, template, file_path)`).
- `packages/ingestkit-forms/src/ingestkit_forms/output/` -- FormDBWriter, FormChunkWriter, FormDualWriter, `rollback_written_artifacts()`. All fully implemented.

### Tests
- `packages/ingestkit-forms/tests/test_router.py` -- Stub (1-line docstring). Needs full test suite.
- `packages/ingestkit-forms/tests/conftest.py` -- Has MockPDFWidgetBackend, MockOCRBackend. Will need additional mock backends for router tests (MockFormDBBackend, MockVectorStoreBackend, MockEmbeddingBackend, MockVLMBackend, MockLayoutFingerprinter).

## Pattern to Mirror

See `packages/ingestkit-excel/src/ingestkit_excel/router.py` for the ExcelRouter pattern. Key structural elements:
- **Constructor**: accepts all backend protocols via DI, builds internal components (lines 81-112)
- **process()**: single-file pipeline orchestration with timing, error collection, fail-closed check (lines 118-358)
- **process_batch()**: sequential iteration over process() (lines 360-379)
- **create_default_router()**: factory with lazy imports of concrete backends, kwargs separation (lines 472-553)

The FormRouter should follow the same structure but with form-specific stages (match -> detect source -> extract -> confidence -> VLM fallback -> dual-write).

## Key Design Decisions

### FormRouter.__init__ Dependencies
The router needs these injected backends (from protocols.py):
- `FormTemplateStore` -- for matcher and API
- `LayoutFingerprinter` -- for matcher
- `FormDBBackend` -- for db_writer
- `VectorStoreBackend` -- for chunk_writer
- `EmbeddingBackend` -- for chunk_writer
- `OCRBackend | None` -- for OCR extractor and native PDF fallback
- `PDFWidgetBackend | None` -- for native PDF extractor
- `VLMBackend | None` -- optional, for VLM fallback
- `FormProcessorConfig`

### Source Detection -> Extractor Mapping (spec 3.1)
- `.xlsx` -> ExcelCellExtractor
- `.pdf` with native form fields -> NativePDFExtractor (falls back to OCR if empty)
- `.pdf` without fields / scanned -> OCROverlayExtractor
- `.jpg/.png/.tiff` -> OCROverlayExtractor

### Idempotency Keys (spec 4.3)
Two keys needed:
1. `ingest_key_global = sha256(content_hash + source_uri + parser_version)` -- reuse `compute_ingest_key()` from `ingestkit_core.idempotency`
2. `form_extraction_key = sha256(ingest_key_global + template_id + template_version)` -- new, form-specific

### FormPluginAPI Expansion
The existing `FormTemplateAPI` has 6 methods. The spec (section 9.1) defines `FormPluginAPI` as a Protocol with 10 operations. The 4 missing ones require router capabilities. Options:
- **Preferred**: Compose `FormTemplateAPI` + router into a unified `FormPluginAPI` concrete class
- Alternative: Add methods directly to `FormTemplateAPI` (would require injecting extractors and matcher)

### Graceful Fallthrough
When no match found and no manual template_id: return `None` or a sentinel so the orchestration layer knows to continue to the standard pipeline. The spec says "return zero overhead beyond the matching check" (4.1 principle 8).

## Risks

1. **Extractor selection for PDFs**: requires calling `PDFWidgetBackend.has_form_fields()` to distinguish fillable vs scanned PDFs. If no PDFWidgetBackend is injected, all PDFs go through OCR.
2. **VLM fallback budget**: VLMFieldExtractor already handles budget limiting internally, but the router must pass the initial confidence-checked fields to it and merge results back.
3. **Dual-write error propagation**: FormDualWriter returns a 5-tuple `(written, errors, warnings, error_details, embed_result)` that must be correctly assembled into `FormProcessingResult`.
4. **API class composition**: The `FormPluginAPI` Protocol in the spec has `extract_form()` which returns `FormProcessingResult` -- this requires the full router pipeline. The API class must either own or compose a router instance.
5. **create_default_router factory**: No concrete backends exist yet in ingestkit-forms (unlike ingestkit-excel which has backends/). The factory may need to import from ingestkit-excel backends or define minimal stubs. Alternatively, require all backends to be passed explicitly.

---
AGENT_RETURN: map-69-021526.md
