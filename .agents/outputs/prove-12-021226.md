# PROVE: Issue #12 -- ExcelRouter Implementation

**Date:** 2026-02-14
**Branch:** feature/issue-12-excel-router
**Verdict:** PASS

---

## Level 1: Tests

### Router tests (test_router.py)
```
33 passed in 0.12s
```
- All 33 tests pass with zero failures or warnings.

### Full test suite
```
546 passed in 1.64s
```
- Zero regressions. All 546 tests pass (513 pre-existing + 33 new).

**CLAIM VERIFIED:** 33 new tests in test_router.py -- PASS
**CLAIM VERIFIED:** 546 total tests passing (zero regressions) -- PASS

---

## Level 2: Imports

```python
from ingestkit_excel import ExcelRouter, create_default_router  # OK
from ingestkit_excel.router import ExcelRouter, create_default_router  # OK
```

- Both `ExcelRouter` and `create_default_router` are exported from `__init__.py` (lines 41, 93-94).
- Direct module import also works.

**CLAIM VERIFIED:** ExcelRouter and create_default_router importable -- PASS

---

## Level 3: Acceptance Criteria

### 12-step process flow (router.py process() method)

| Step | Line(s) | Description | Verified |
|------|---------|-------------|----------|
| 1 | 146-152 | Compute deterministic IngestKey | YES |
| 2 | 157 | Generate ingest_run_id (UUID4) | YES |
| 3 | 162-164 | Parse via ParserChain | YES |
| 4 | 169-171 | Build ParseStageResult from FileProfile | YES |
| 5 | 174-181 | Log parse fallbacks as warnings | YES |
| 6 | 186-218 | Classify with tiered escalation (Tier 1->2->3) | YES |
| 7 | 225-282 | Fail-closed check (E_CLASSIFY_INCONCLUSIVE) | YES |
| 8 | 287-295 | Build ClassificationStageResult from classification + timing | YES |
| 9 | 308-309 | Route to processor (_select_processor) | YES |
| 10 | 322-330 | Process via selected processor | YES |
| 11 | 335 | Merge parse errors into processor result | YES |
| 12 | 337-356 | Finalize timing and PII-safe INFO log | YES |

### Tier escalation logic
- Tier 1 inconclusive (confidence == 0.0) triggers Tier 2 (line 192-201)
- Tier 2 below `config.tier2_confidence_threshold` triggers Tier 3 (line 203-218)
- `config.enable_tier3` gate respected (line 206)
- Tests: `TestTierEscalation` class covers all 4 scenarios (tier1->2, tier2->3, tier3 disabled, tier1 confident skips LLM)

### Fail-closed semantics
- confidence == 0.0 after all tiers returns ProcessingResult with:
  - `chunks_created=0`, `tables_created=0`, `tables=[]`
  - `ErrorCode.E_CLASSIFY_INCONCLUSIVE` in errors list
  - `IngestError` with `recoverable=False` in error_details
- Tests: `TestFailClosed` class with 2 tests covering structure and error codes

### Batch processing
- `process_batch()` (line 360-379) iterates sequentially, returns list in order
- Tests: `TestProcessBatch` covers 3-file batch and empty list

### PII-safe logging
- Logger name: `"ingestkit_excel"` (line 52) -- correct
- INFO logs use `filename` (basename only), truncated key (`ingest_key[:16]`), and aggregate counts -- no raw cell data
- Test: `TestPIISafeLogging` validates INFO log contains truncated key

### create_default_router() factory
- Lines 472-553: Separates router kwargs from config kwargs, lazy-imports concrete backends
- Tests: `TestCreateDefaultRouter` covers full override and config-kwarg passthrough

### ParseStageResult from FileProfile
- `_build_parse_stage_result()` (lines 386-425): Derives parser_used from first sheet, computes skipped reasons, fallback_reason_code
- Tests: `TestBuildParseStageResult` with 5 tests (openpyxl, pandas fallback, raw_text fallback, skipped sheets, empty profile)

### ClassificationStageResult from classification + timing
- Built at lines 231-239 (fail path) and 287-295 (success path)
- Captures tier_used, file_type, confidence, signals, reasoning, per_sheet_types, classification_duration_seconds
- Test: `TestClassificationResultPropagation` validates all fields

### Error merging
- `_merge_parse_errors()` (lines 427-444): E_* codes go to errors list, W_* codes go to warnings list, all go to error_details
- Tests: `TestParseErrorMerging` covers both warning and error merging

**ALL ACCEPTANCE CRITERIA VERIFIED**

---

## Level 4: Code Quality

### No hardcoded values
- Threshold uses `config.tier2_confidence_threshold` (line 204)
- `config.enable_tier3` gates Tier 3 (line 206)
- `config.parser_version` and `config.tenant_id` used for ingest key (lines 149-150)
- Only `0.0` literals are for the fail-closed sentinel check (inconclusive = confidence exactly 0.0), which is by design

### Follows existing module patterns
- Imports from same internal modules (models, errors, config, protocols)
- Uses Protocol-typed backends (VectorStoreBackend, StructuredDBBackend, LLMBackend, EmbeddingBackend)
- Returns Pydantic v2 models (ProcessingResult, ParseStageResult, etc.)
- Uses `IngestError` with `ErrorCode` enum for structured errors
- Dependency injection -- no concrete backends inside the core package

### PII-safe logging
- Logger name `"ingestkit_excel"` matches project convention
- Logs only: filename (basename), truncated key (16 chars), tier, file_type, confidence, path name, chunk/table counts, timing
- No raw cell data, no full file paths, no PII-bearing content logged

### Files changed
- **New:** `packages/ingestkit-excel/src/ingestkit_excel/router.py` (553 lines)
- **New:** `packages/ingestkit-excel/tests/test_router.py` (1381 lines)
- **Modified:** `packages/ingestkit-excel/src/ingestkit_excel/__init__.py` (+5/-3 lines -- added router exports)

**CLAIM VERIFIED:** 2 files created, 1 modified -- PASS

---

## Summary

| Claim | Status |
|-------|--------|
| 33 new tests in test_router.py | PASS |
| 546 total tests passing (zero regressions) | PASS |
| ExcelRouter and create_default_router importable | PASS |
| 12-step process flow | PASS |
| Tier escalation (1->2->3) with correct thresholds | PASS |
| Fail-closed with E_CLASSIFY_INCONCLUSIVE | PASS |
| Batch processing | PASS |
| PII-safe logging | PASS |
| create_default_router() factory | PASS |
| ParseStageResult from FileProfile | PASS |
| ClassificationStageResult built correctly | PASS |
| Error merging (parse errors into result) | PASS |
| No hardcoded values, uses config | PASS |
| Follows existing module patterns | PASS |
| 2 files created, 1 modified | PASS |

**VERDICT: ALL CLAIMS VERIFIED -- PASS**
