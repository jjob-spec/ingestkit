---
issue: 41
agent: PATCH
date: 2026-02-14
status: Complete
files_created: 2
files_modified: 1
tests_added: 26
lines_added: ~950
lines_removed: 3
---

# PATCH Artifact: Issue #41 -- Implement Path C Complex Processor

## Executive Summary

Implemented `ComplexProcessor` in `processors/complex_processor.py` with per-page routing for all 8 `PageType` values, form field extraction via `page.widgets()`, multi-column reordering via `LayoutAnalyzer`, header/footer stripping, and full ProcessingResult assembly. Added 26 unit tests covering page routing, form fields, multi-column, header/footer, and result assembly. All tests pass, no regressions.

## Metrics

| Metric | Value |
|--------|-------|
| Files created | 2 |
| Files modified | 1 |
| Tests added | 26 |
| Tests passing | 784 (+ 1 skipped) |
| Regressions | 0 |
| Lint clean (new files) | Yes |

## Files Changed

### Created: `packages/ingestkit-pdf/src/ingestkit_pdf/processors/complex_processor.py`

- `ComplexProcessor` class with SPEC 11.3 constructor: `(vector_store, structured_db, embedder, llm, config)`
- `process()` with B1-corrected parameter order: `(file_path, profile, ingest_key, ingest_run_id, parse_result, classification_result, classification)`
- Page routing for all 8 PageType values via `classification.per_page_types`
- `_extract_text_page()`: pymupdf4llm with get_text() fallback
- `_extract_form_fields()`: page.widgets() with checkbox/signature handling, "[Form Fields]" tagging
- `_extract_mixed_page()`: native text + OCR when image content adds >20% more words
- `_apply_layout_reorder()`: LayoutAnalyzer.detect_columns() + reorder_blocks() (W2 fix: single authority)
- `_ocr_single_page()` called with all 8 primitive args (B2 fix), tuple error case handled
- `_concatenate_pages()`, `_convert_headings_to_offsets()`: same pattern as TextExtractor
- `_embed_and_upsert()`: OCR metadata propagation for chunks from SCANNED pages
- `_classify_backend_error()`: same pattern as sibling processors
- TableExtractionResult.errors routed to error_details (W1 fix)

### Created: `packages/ingestkit-pdf/tests/test_complex_processor.py`

26 tests in 5 test classes:
- `TestComplexProcessorPageRouting` (9 tests): all 8 PageTypes + integration test with all types in one document
- `TestComplexProcessorFormFields` (5 tests): name/value pairs, empty values, checkboxes, signatures, regular text
- `TestComplexProcessorMultiColumn` (2 tests): reorder and no-op for single column
- `TestComplexProcessorHeaderFooter` (2 tests): stripping and recoverable detection failure
- `TestComplexProcessorAssembly` (8 tests): all fields populated, empty doc, ingestion method, tables count, OCR stage result presence/absence, warning accumulation, per-page error recovery

### Modified: `packages/ingestkit-pdf/src/ingestkit_pdf/processors/__init__.py`

Added `ComplexProcessor` to imports and `__all__`.

## Issues Encountered

1. **Early return swallowed table results**: When TABLE_HEAVY pages had no surrounding text and no table chunks (e.g., DB-routed large tables), the early return condition `not page_texts and not table_chunks` triggered prematurely, returning `tables=[]`. Fixed by adding `and not table_names` to the condition.

## PLAN-CHECK Corrections Applied

- **B1**: `process()` parameter order matches sibling processors -- `classification` is last
- **B2**: `_ocr_single_page()` called with all 8 primitive args; tuple error return handled
- **W1**: `TableExtractionResult.errors` (list[IngestError]) routed to `error_details`, converted to strings for `errors`
- **W2**: Multi-column detection uses `layout_analyzer.detect_columns()` as single authority, not redundant with profile flag

## Acceptance Criteria Status

All criteria met. See plan-41-021426.md for full list.

## Verification

```
pytest tests/test_complex_processor.py -v  -> 26 passed
pytest tests/ -q                           -> 784 passed, 1 skipped
ruff check (new files)                     -> All checks passed
python -c "from ingestkit_pdf.processors import ComplexProcessor"  -> OK
```

AGENT_RETURN: .agents/outputs/patch-41-021426.md
