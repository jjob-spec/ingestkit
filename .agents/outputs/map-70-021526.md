---
issue: 70
agent: MAP
date: 2026-02-15
complexity: COMPLEX
package: ingestkit-forms
spec_sections: "13, 13.1-13.5"
---

# MAP: Issue #70 -- Implement security controls and input validation

## 1. Executive Summary

Issue #70 requires implementing centralized security controls for `ingestkit-forms` per spec section 13. Investigation reveals that **significant security infrastructure already exists scattered across modules** (image safety in `_rendering.py`, ReDoS protection in `ocr_overlay.py` and `excel_cell.py`, PII-safe logging in three extractors, soft-delete in `filesystem.py`). What is **missing** is: (1) a centralized `security.py` pre-flight scanner (modeled after `ingestkit-pdf/security.py`), (2) magic byte verification for all supported formats, (3) template field count limit enforcement (200), (4) file size validation before processing, and (5) comprehensive security test coverage per spec section 13.5.

## 2. Spec Requirements (section 13)

### 13.1 Input Validation (5 controls)

| Control | Spec Requirement | Status |
|---------|-----------------|--------|
| File size limit | Reject > `max_file_size_mb` with `E_FORM_FILE_TOO_LARGE` | **NOT IMPLEMENTED** -- config param exists (`max_file_size_mb=100`) but no code checks it before processing |
| File type validation | Only `.pdf`, `.xlsx`, `.jpg`, `.jpeg`, `.png`, `.tiff`, `.tif` accepted | **PARTIAL** -- `_rendering.py:_IMAGE_EXTENSIONS` and `_PDF_EXTENSIONS` enforce at render time; `matcher.py:_EXTENSION_MAP` enforces at match time; but no centralized pre-flight check |
| Magic byte verification | Cross-check extension vs magic bytes; `.pdf` without `%PDF-` -> `E_FORM_FILE_CORRUPT` | **NOT IMPLEMENTED** -- no magic byte checks exist anywhere in ingestkit-forms |
| Template field count limit | Templates limited to 200 fields | **NOT IMPLEMENTED** -- `FormTemplate.fields` has `min_length=1` but no `max_length=200`; `FormTemplateCreateRequest.fields` also lacks max_length |
| Regex validation patterns | Compile at template creation; 1s timeout per pattern for ReDoS | **PARTIAL** -- ReDoS timeout exists in `ocr_overlay.py:_regex_match_with_timeout` and `excel_cell.py:_regex_match_with_timeout` (both with 1s timeout); but regex is NOT compiled/validated at template creation time in `api.py:create_template()` |

### 13.2 PII Safety (4 controls)

| Control | Spec Requirement | Status |
|---------|-----------------|--------|
| No field values in logs by default | Only log when `log_sample_data=True` | **IMPLEMENTED** -- `ocr_overlay.py:316` checks `log_ocr_output`; `excel_cell.py:230` checks `log_sample_data`; `vlm_fallback.py:249,286` checks `log_sample_data` |
| Template/field names safe to log | Structure names always loggable | **IMPLEMENTED** -- all loggers use field_name, template_name, never raw values |
| Confidence scores safe to log | Numeric, no PII | **IMPLEMENTED** -- confidence values logged freely |
| Configurable redaction | `redact_patterns` + `redact_target` | **PARTIAL** -- Config params exist in `config.py:218-222`; `RedactTarget` enum exists; but actual redaction application logic is in `output/dual_writer.py` (needs verification) |

### 13.3 Template Security (3 controls)

| Control | Spec Requirement | Status |
|---------|-----------------|--------|
| Soft delete only | Never hard-delete; preserve audit trail | **IMPLEMENTED** -- `filesystem.py:180-217` implements soft delete via `_TemplateMeta.deleted_versions` and `all_deleted` flag; files never removed from disk |
| Version immutability | Used versions cannot be modified; edits create new version | **IMPLEMENTED** -- `api.py:update_template()` always increments version and creates new template object |
| Tenant isolation | Templates carry `tenant_id`; store enforces scoping | **IMPLEMENTED** -- `FormTemplate.tenant_id` exists; `list_templates()` filters by `tenant_id`; spec notes enforcement is caller's responsibility |

### 13.4 Image Processing Security (3 controls)

| Control | Spec Requirement | Status |
|---------|-----------------|--------|
| Decompression bomb protection | Ratio > 100 -> rejected | **IMPLEMENTED** -- `_rendering.py:25-75` `validate_image_safety()` checks `decompressed_estimate / compressed_size > MAX_DECOMPRESSION_RATIO` |
| Resolution limits | > 10000px -> rejected | **IMPLEMENTED** -- `_rendering.py:22` `MAX_IMAGE_DIMENSION = 10_000`; checked in `validate_image_safety()` and `render_pdf_page()` |
| No external URL loading | Only local files | **IMPLEMENTED** -- all extractors take `file_path: str`; no URL fetching anywhere |

### 13.5 Security Test Requirements (7 tests)

| Test | Spec Requirement | Status |
|------|-----------------|--------|
| Regex validation timeout | ReDoS pattern times out within 1s | **IMPLEMENTED** -- `test_extractors.py:1431-1439` (OCR) and `test_extractors.py:2028-2038` (Excel) |
| Magic byte mismatch | Each format with wrong magic bytes -> `E_FORM_FILE_CORRUPT` | **NOT IMPLEMENTED** |
| Decompression bomb | Compression ratio > 100 -> rejected | **PARTIAL** -- `test_extractors.py:1414-1421` tests dimension limit but not actual decompression ratio |
| Resolution guardrail | Image > 10000px -> rejected | **IMPLEMENTED** -- `test_extractors.py:1423-1429` |
| File size limit | Exceeding `max_file_size_mb` -> `E_FORM_FILE_TOO_LARGE` | **NOT IMPLEMENTED** |
| Template field count limit | > 200 fields -> `E_FORM_TEMPLATE_INVALID` | **NOT IMPLEMENTED** |
| Redaction | Redacted values never in persisted DB rows/chunks | **NOT VERIFIED** -- depends on output writer implementation |

## 3. Existing Implementation Details

### 3.1 Image Security (`_rendering.py`)

- `validate_image_safety(file_path, max_dimension=10_000)` at lines 25-75
- Checks: empty file, resolution limit, decompression ratio
- Called from `load_image_file()` before full image load
- `render_pdf_page()` also validates rendered dimensions post-render (line 141)
- Error code: `E_FORM_FILE_CORRUPT` for all violations

### 3.2 ReDoS Protection (duplicated in two modules)

- `ocr_overlay.py:71-96` -- `_regex_match_with_timeout()` using `threading.Thread` with 1s timeout, uses `re.match`
- `excel_cell.py:31-53` -- identical implementation but uses `re.fullmatch`
- Both return `None` on timeout, `True`/`False` on match/no-match, `False` on `re.error`
- **Note**: Code is duplicated; should be consolidated into a shared location (e.g., `security.py`)

### 3.3 PII-Safe Logging

- `ocr_overlay.py:316` -- guards OCR output with `log_ocr_output` flag
- `excel_cell.py:230` -- guards cell values with `log_sample_data` flag
- `vlm_fallback.py:249,286` -- guards VLM results with `log_sample_data` flag
- `native_pdf.py` -- no value logging at all (safe by omission)

### 3.4 Error Codes Available

- `E_FORM_FILE_TOO_LARGE` -- exists in `errors.py:59`, not used anywhere
- `E_FORM_FILE_CORRUPT` -- exists in `errors.py:60`, used in `_rendering.py` and `excel_cell.py`
- `E_FORM_TEMPLATE_INVALID` -- exists in `errors.py:28`, not used for field count validation
- `E_FORM_UNSUPPORTED_FORMAT` -- exists in `errors.py:40`, used in `_rendering.py` and `matcher.py`

### 3.5 Config Parameters Available

- `max_file_size_mb: int = 100` -- exists in `config.py:191-194`
- `log_sample_data: bool = False` -- exists in `config.py:212-215`
- `log_ocr_output: bool = False` -- exists in `config.py:216`
- `redact_patterns: list[str] = []` -- exists in `config.py:218`
- `redact_target: str = "both"` -- exists in `config.py:219-222`

### 3.6 Reference Pattern (`ingestkit-pdf/security.py`)

The PDF package has a `PDFSecurityScanner` class (302 lines) that performs pre-flight checks in order:
1. Magic bytes (`%PDF-`)
2. File size vs `max_file_size_mb`
3. Open with PyMuPDF
4. Encryption check
5. Page count limit
6. Zero pages
7. Decompression bomb (xref count heuristic)
8. JavaScript detection
9. Signed PDF detection
10. Embedded files detection

Returns `(DocumentMetadata, list[IngestError])` with fatal vs warning classification.

## 4. Gap Analysis Summary

### Must Build (New)

1. **`security.py`** -- Centralized `FormSecurityScanner` class with:
   - File size check (using `max_file_size_mb` from config)
   - File type validation (extension whitelist)
   - Magic byte verification for all formats:
     - PDF: `%PDF-` (5 bytes)
     - XLSX: `PK\x03\x04` (ZIP magic, 4 bytes)
     - JPEG: `\xff\xd8\xff` (3 bytes)
     - PNG: `\x89PNG\r\n\x1a\n` (8 bytes)
     - TIFF: `II\x2a\x00` or `MM\x00\x2a` (4 bytes, little/big endian)
   - Shared `regex_match_with_timeout()` (consolidate from ocr_overlay + excel_cell)

2. **Template field count validation** -- Add `max_length=200` to `FormTemplate.fields` and `FormTemplateCreateRequest.fields` in `models.py`; or validate in `api.py:create_template()` with `E_FORM_TEMPLATE_INVALID`

3. **Regex compilation at template creation** -- Validate all `validation_pattern` fields compile successfully in `api.py:create_template()` and `update_template()`

### Must Test (New tests in `test_security.py`)

Per spec section 13.5:
1. Magic byte mismatch for each format (.pdf, .xlsx, .jpg, .png, .tiff)
2. File size limit enforcement
3. Template field count > 200 rejection
4. Decompression bomb (actual ratio test, not just dimension)
5. Redaction verification (if output writers are implemented)

### Should Refactor (Consolidation)

- Extract `_regex_match_with_timeout()` from `ocr_overlay.py` and `excel_cell.py` into `security.py`
- Both modules then import from `security.py`

## 5. Files to Modify

| File | Action | Details |
|------|--------|---------|
| `src/ingestkit_forms/security.py` | **CREATE** | `FormSecurityScanner` with file size, type, magic byte checks; shared `regex_match_with_timeout()` |
| `src/ingestkit_forms/models.py` | MODIFY | Add `max_length=200` to `FormTemplate.fields` and `FormTemplateCreateRequest.fields` |
| `src/ingestkit_forms/api.py` | MODIFY | Add regex validation at template creation/update; call security scanner or validate field count |
| `src/ingestkit_forms/extractors/ocr_overlay.py` | MODIFY | Import `regex_match_with_timeout` from `security.py`; remove local copy |
| `src/ingestkit_forms/extractors/excel_cell.py` | MODIFY | Import `regex_match_with_timeout` from `security.py`; remove local copy |
| `tests/test_security.py` | **CREATE** | All security tests per spec 13.5 |
| `tests/test_extractors.py` | MODIFY | Update imports if regex function moved; existing security tests may move to `test_security.py` |

## 6. Risk Assessment

| Risk | Mitigation |
|------|-----------|
| Moving `regex_match_with_timeout` breaks existing imports | Update all import sites; run full test suite |
| Template field count validation is a breaking change for existing templates | 200 is generous; unlikely any template exceeds this; Pydantic validation only triggers on creation |
| Magic byte check false positives for corrupted but valid files | Follow PDF package pattern: fail fast with clear error message |
| `E_FORM_TEMPLATE_INVALID` not yet used -- need to confirm error code semantics | Code exists in `errors.py:28`; spec assigns it for invalid template data |

---

AGENT_RETURN: MAP investigation complete. Ready for PLAN phase. Key finding: ~60% of security controls already exist (image safety, ReDoS, PII logging, soft delete, version immutability). Primary gaps are centralized file validation (size + magic bytes), template field count limits, and regex compilation at creation time. Recommend creating `security.py` following `ingestkit-pdf/security.py` pattern.
