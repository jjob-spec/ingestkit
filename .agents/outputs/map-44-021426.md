---
issue: 44
title: "Implement PaddleOCR adapter and engine fallback chain"
complexity: SIMPLE
agent: MAP
date: 2026-02-14
spec_sections: "§12.4, §12.5, §3.2, §3.3"
files_to_modify:
  - src/ingestkit_pdf/utils/ocr_engines.py
  - tests/test_ocr_engines.py
  - src/ingestkit_pdf/utils/__init__.py
dependencies:
  - "#34 (OCR engine abstraction with Tesseract) — MERGED"
status: COMPLETE
---

# MAP Artifact — Issue #44: PaddleOCR Adapter and Engine Fallback Chain

## Executive Summary

Issue #44 requires implementing the `PaddleOCREngine` adapter class and completing the engine fallback chain in `utils/ocr_engines.py`. The Tesseract adapter, Protocol, factory, and all scaffolding were delivered in #34. The current factory has a placeholder that raises `ImportError("PaddleOCREngine adapter not yet implemented")` even when `paddleocr` is importable. This issue replaces that stub with a working `PaddleOCREngine` class and adds PaddleOCR-specific tests gated behind `@pytest.mark.ocr_paddle`. Unit tests must pass without PaddleOCR installed via mocks.

## Investigation Findings

### 1. Current State of ocr_engines.py (Post-#34)

**File**: `packages/ingestkit-pdf/src/ingestkit_pdf/utils/ocr_engines.py` (~214 lines)

Already implemented:
- `OCRPageResult(BaseModel)` — text, confidence, word_confidences, language_detected
- `OCREngineInterface(Protocol)` with `recognize()` and `name()` methods
- `TesseractEngine` — full adapter with language mapping
- `EngineUnavailableError` exception
- `create_ocr_engine()` factory — has PaddleOCR stub at lines 194-205
- `_tesseract_available()` availability checker
- `_LANGUAGE_MAP` and `_to_tesseract_lang()` for Tesseract language codes

**Critical stub to replace** (lines 194-199):
```python
if config.ocr_engine == OCREngine.PADDLEOCR:
    try:
        import paddleocr  # noqa: F401
        # PaddleOCREngine adapter not yet implemented (future issue)
        raise ImportError("PaddleOCREngine adapter not yet implemented")
    except ImportError:
```

### 2. SPEC §12.4 — PaddleOCR Adapter Requirements

From SPEC.md lines 1220-1234:

```python
class PaddleOCREngine:
    """Adapter for PaddleOCR. Optional, higher accuracy (~96.6% vs ~89%)."""
    def __init__(self, lang: str = "en"): ...
    def recognize(self, image: "Image.Image", language: str) -> OCRPageResult: ...
    def name(self) -> str:
        return "paddleocr"
```

Key implementation details:
- Uses `paddleocr.PaddleOCR(lang=language, use_angle_cls=True)`
- Returns line-level text with confidence (NOT word-level like Tesseract)
- Supports 100+ languages
- Each `ProcessPoolExecutor` worker must create its own instance (known PaddleOCR thread-safety issue)
- Default lang is `"en"` (PaddleOCR uses ISO 639-1, unlike Tesseract's ISO 639-3)

### 3. SPEC §12.5 — Factory Fallback Chain (Updated)

From SPEC.md lines 1236-1267:

```python
def create_ocr_engine(config: PDFProcessorConfig) -> tuple[OCREngineInterface, list[str]]:
    warnings: list[str] = []
    if config.ocr_engine == OCREngine.PADDLEOCR:
        try:
            return PaddleOCREngine(lang=config.ocr_language), warnings
        except ImportError:
            warnings.append("W_OCR_ENGINE_FALLBACK")
            logger.warning("PaddleOCR requested but not installed, falling back to Tesseract baseline")
    # Tesseract: required baseline
    if not _tesseract_available():
        raise EngineUnavailableError(...)
    return TesseractEngine(lang=config.ocr_language), warnings
```

**Fallback chain**: PaddleOCR (if configured) -> Tesseract (baseline) -> `E_OCR_ENGINE_UNAVAILABLE`

### 4. PaddleOCR Python API Analysis

PaddleOCR's `ocr.ocr(image)` returns a nested list structure:
```python
# result = [[line1, line2, ...]]
# Each line = [bounding_box, (text, confidence)]
# bounding_box = [[x1,y1], [x2,y2], [x3,y3], [x4,y4]]
# text = str, confidence = float (0.0-1.0)
```

Key initialization parameters:
- `lang` — language code (e.g., `"en"`, `"ch"`, `"japan"`)
- `use_angle_cls=True` — enables text angle classification (per SPEC)
- `show_log=False` — suppress PaddleOCR's verbose logging (recommended)

The adapter must:
1. Convert PIL Image to numpy array (PaddleOCR expects ndarray)
2. Parse the nested result structure to extract text lines and per-line confidences
3. Join lines into full text
4. Compute average confidence from per-line confidences
5. Return `OCRPageResult` with text, confidence, word_confidences (line-level in this case)

### 5. Language Mapping (Already Exists)

`utils/language.py` already has `_PADDLEOCR_LANG_MAP` (lines 61-74):
```python
_PADDLEOCR_LANG_MAP = {
    "zh": "ch", "ko": "korean", "ja": "japan", "ar": "ar",
    "hi": "hi", "en": "en", "fr": "fr", "de": "german",
    "es": "es", "pt": "pt", "it": "it", "ru": "ru",
}
```

However, `PaddleOCREngine` needs its own language mapping in `ocr_engines.py` since the engine adapter handles mapping internally (same pattern as `TesseractEngine` with `_to_tesseract_lang()`). The SPEC says PaddleOCR uses ISO 639-1 directly for most languages with exceptions (zh -> ch, ko -> korean, ja -> japan, de -> german).

### 6. Existing Tests (test_ocr_engines.py)

**File**: `packages/ingestkit-pdf/tests/test_ocr_engines.py` (~382 lines)

Already has 7 test classes:
- `TestOCRPageResult` (6 tests)
- `TestOCREngineInterface` (2 tests)
- `TestLanguageMapping` (5 tests)
- `TestTesseractAvailable` (4 tests)
- `TestTesseractEngine` (8 tests)
- `TestCreateOCREngine` (7 tests)
- `TestEngineUnavailableError` (2 tests)

All marked `@pytest.mark.unit`. Existing `TestCreateOCREngine` already tests fallback from PaddleOCR to Tesseract when `paddleocr` is not importable (lines 293-338).

Tests to ADD:
- `TestPaddleOCREngine` class with `@pytest.mark.unit` — mock-based, no real PaddleOCR
- `TestPaddleOCREngineIntegration` class with `@pytest.mark.ocr_paddle` — requires PaddleOCR installed
- Update `TestOCREngineInterface` to verify `PaddleOCREngine` satisfies Protocol
- Update `TestCreateOCREngine` to test factory returns `PaddleOCREngine` when paddleocr is available

### 7. Error/Warning Codes

All needed codes exist in `errors.py`:
- `W_OCR_ENGINE_FALLBACK = "W_OCR_ENGINE_FALLBACK"` (line 64) — fallback from PaddleOCR to Tesseract
- `E_OCR_ENGINE_UNAVAILABLE = "E_OCR_ENGINE_UNAVAILABLE"` (line 33) — no engine available

### 8. Config Fields

`config.py` line 62: `ocr_engine: OCREngine = OCREngine.TESSERACT`
`config.py` line 64: `ocr_language: str = "en"`

`models.py` line 73: `OCREngine.PADDLEOCR = "paddleocr"`

### 9. __init__.py Exports

`utils/__init__.py` currently exports: `EngineUnavailableError`, `OCREngineInterface`, `OCRPageResult`, `TesseractEngine`, `create_ocr_engine`.

Must add: `PaddleOCREngine` to exports.

## Key Decisions for PLAN

### D1: PaddleOCR Language Mapping

Add a `_PADDLEOCR_LANG_MAP` dict and `_to_paddleocr_lang()` function in `ocr_engines.py`, mirroring the Tesseract pattern. Use the mapping from `language.py` as reference but keep it self-contained in the engine module.

### D2: PaddleOCR Instance Creation

Per SPEC §12.4: "Each ProcessPoolExecutor worker must create its own instance." The `PaddleOCREngine.__init__()` should create the PaddleOCR instance during initialization. The factory creates one instance; each subprocess worker will create its own via the factory (already handled by `_ocr_single_page()` in `ocr_processor.py` which calls `create_ocr_engine()` per invocation).

### D3: PaddleOCR Result Parsing

PaddleOCR returns `[[[bbox, (text, conf)], ...]]` per page. The adapter must:
1. Handle `None` result (empty page) -> empty OCRPageResult
2. Handle empty list result -> empty OCRPageResult
3. Flatten the nested structure to extract text lines and confidences
4. Join lines with newlines (line-level, not word-level)
5. Store per-line confidences as `word_confidences` (naming is from Protocol; repurposed for line-level)

### D4: PIL Image to numpy Conversion

PaddleOCR expects numpy arrays. The adapter must call `numpy.array(image)` on the PIL Image. `numpy` is already a transitive dependency via `pandas` (core dependency).

### D5: Suppressing PaddleOCR Logging

PaddleOCR produces verbose logging by default. Pass `show_log=False` to suppress.

### D6: ImportError Handling in Factory

The factory must catch `ImportError` when `paddleocr` package is not installed. The current stub catches it; the update replaces the artificial `raise ImportError` with actual `PaddleOCREngine` instantiation. If `paddleocr` is installed but fails to import for other reasons, same fallback applies.

### D7: Test Strategy

**Unit tests (`@pytest.mark.unit`)**:
- Mock `paddleocr.PaddleOCR` — test `PaddleOCREngine.recognize()` with mocked OCR results
- Test `PaddleOCREngine.name()` returns `"paddleocr"`
- Test Protocol conformance
- Test language mapping (`_to_paddleocr_lang`)
- Test factory returns `PaddleOCREngine` when paddleocr is available (mock import)
- Test factory fallback still works (existing tests sufficient)
- Test empty/None result handling
- Test confidence aggregation

**Integration tests (`@pytest.mark.ocr_paddle`)**:
- Test real PaddleOCR on a simple test image (requires paddleocr installed)
- These tests will skip in environments without PaddleOCR

## Dependency Analysis

### Internal Dependencies
- `ingestkit_pdf.config.PDFProcessorConfig` — factory parameter
- `ingestkit_pdf.models.OCREngine` — enum comparison
- `OCRPageResult` — return type (same module)
- `PIL.Image` (TYPE_CHECKING) — type annotation

### External Dependencies
- `paddleocr` — optional import, graceful fallback
- `numpy` — for PIL-to-ndarray conversion (transitive via pandas)

### Downstream Consumers
- `processors/ocr_processor.py` — calls `create_ocr_engine()` at lines 105, 115
- `utils/__init__.py` — exports

## File Inventory

### Files to Modify

| File | Change | Est. Lines Added |
|---|---|---|
| `packages/ingestkit-pdf/src/ingestkit_pdf/utils/ocr_engines.py` | Add `PaddleOCREngine` class, `_PADDLEOCR_LANG_MAP`, `_to_paddleocr_lang()`, update factory stub | ~80 |
| `packages/ingestkit-pdf/tests/test_ocr_engines.py` | Add `TestPaddleOCREngine` (unit, mocked), `TestPaddleOCRLanguageMapping`, update Protocol test, update factory test | ~150 |
| `packages/ingestkit-pdf/src/ingestkit_pdf/utils/__init__.py` | Add `PaddleOCREngine` to imports and `__all__` | ~2 |

### Files Read (Reference Only)

| File | What was extracted |
|---|---|
| `SPEC.md` §12.4-12.5, §3.2-3.3 | PaddleOCR adapter spec, engine policy, fallback behavior |
| `utils/ocr_engines.py` | Current implementation, stub location, existing patterns |
| `tests/test_ocr_engines.py` | Existing test patterns, mock strategies, test class structure |
| `errors.py` | `W_OCR_ENGINE_FALLBACK`, `E_OCR_ENGINE_UNAVAILABLE` codes exist |
| `config.py` | `ocr_engine`, `ocr_language` fields |
| `models.py` | `OCREngine.PADDLEOCR` enum value |
| `utils/language.py` | Reference `_PADDLEOCR_LANG_MAP` for language mapping |
| `processors/ocr_processor.py` | Downstream consumer of `create_ocr_engine()` |
| `utils/__init__.py` | Current exports list |
| `pyproject.toml` | `paddleocr>=2.7` optional dep, `ocr_paddle` marker |

## Risks and Mitigations

| Risk | Mitigation |
|---|---|
| PaddleOCR result format varies across versions | Defensive parsing with None/empty checks; test with mocked structure |
| PaddleOCR `show_log` parameter may not exist in all versions | Wrap in try/except during init or pass as kwargs |
| numpy import could fail | numpy is transitive via pandas (core dep); add explicit check if needed |

---

AGENT_RETURN: .agents/outputs/map-44-021426.md
