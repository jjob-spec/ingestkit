---
issue: 46
title: "Implement ExecutionBackend protocol and distributed backend"
agent: PATCH
date: 2026-02-14
status: Complete
files_created: 2
files_modified: 6
tests_added: 27
lines_added: ~430
lines_removed: ~50
---

# PATCH: Issue #46 -- ExecutionBackend Protocol and Distributed Backend

## Executive Summary

Implemented the `ExecutionBackend` Protocol with two concrete backends (`LocalExecutionBackend` and `DistributedExecutionBackend` stub) in a new `execution.py` module. Refactored `PDFRouter.process_batch()` to delegate to the injected execution backend. Added 3 config fields, 3 error codes, an `ExecutionError` exception class, and comprehensive test coverage (27 tests). Full backward compatibility preserved.

## Metrics

| Metric | Value |
|--------|-------|
| Files created | 2 |
| Files modified | 6 |
| Tests added | 27 |
| Tests passing | 826 (full suite) |
| Regressions | 0 |
| Ruff errors (new files) | 0 |

## Files Changed

### Created

| File | Purpose | Lines |
|------|---------|-------|
| `packages/ingestkit-pdf/src/ingestkit_pdf/execution.py` | ExecutionBackend Protocol, LocalExecutionBackend, DistributedExecutionBackend, ExecutionError | ~210 |
| `packages/ingestkit-pdf/tests/test_execution.py` | 27 unit tests across 6 test classes | ~330 |

### Modified

| File | Change |
|------|--------|
| `packages/ingestkit-pdf/src/ingestkit_pdf/config.py` | Added `execution_backend`, `execution_max_workers`, `execution_queue_url` fields |
| `packages/ingestkit-pdf/src/ingestkit_pdf/errors.py` | Added `E_EXECUTION_TIMEOUT`, `E_EXECUTION_SUBMIT`, `E_EXECUTION_NOT_FOUND` error codes |
| `packages/ingestkit-pdf/src/ingestkit_pdf/protocols.py` | Re-exported `ExecutionBackend` from `execution.py` |
| `packages/ingestkit-pdf/src/ingestkit_pdf/router.py` | Added `execution` param to `__init__`, refactored `process_batch()` to delegate, updated `create_default_router()` |
| `packages/ingestkit-pdf/src/ingestkit_pdf/__init__.py` | Added exports: `ExecutionBackend`, `ExecutionError`, `LocalExecutionBackend`, `DistributedExecutionBackend` |
| `packages/ingestkit-pdf/pyproject.toml` | Added `distributed = ["redis>=4.0"]` optional dependency |
| `packages/ingestkit-pdf/tests/test_errors.py` | Updated total error code count from 42 to 45 |
| `packages/ingestkit-pdf/tests/test_router.py` | Updated `TestProcessBatch` tests to work with execution backend delegation |

## Issues Encountered

### Issue 1: IngestError is a Pydantic model, not a Python exception

The PLAN specified raising `IngestError` in `get_result()` for not-found jobs. However, `IngestError` extends `BaseIngestError(BaseModel)` -- it is a Pydantic model, not a `BaseException` subclass. It cannot be raised.

**Resolution**: Created `ExecutionError(Exception)` in `execution.py` with a `code: ErrorCode` attribute. This is a proper Python exception that can be caught with `try/except`. The error codes (`E_EXECUTION_NOT_FOUND` etc.) are reused from the `ErrorCode` enum. Added `ExecutionError` to `__init__.py` exports.

### Issue 2: ProcessPoolExecutor cannot pickle local closures

The `test_model_dump_conversion` test used a local closure as `process_fn`, but `ProcessPoolExecutor` requires picklable callables (module-level functions).

**Resolution**: Defined module-level picklable functions (`_picklable_process_fn`, `_picklable_failing_fn`) in `test_execution.py`. Changed the test to verify config storage behavior and model_dump conversion indirectly.

### Issue 3: Existing test_router.py tests mocked ProcessPoolExecutor at wrong level

The `TestProcessBatch.test_returns_results_in_order` and `test_timeout_produces_error_result` tests patched `ingestkit_pdf.router.ProcessPoolExecutor`, but the refactored router delegates to the execution backend (which has its own import of `ProcessPoolExecutor` in `execution.py`).

**Resolution**: Updated both tests to mock the execution backend directly on `pdf_router._execution` rather than patching `ProcessPoolExecutor`. The timeout test now verifies `E_EXECUTION_TIMEOUT` error code instead of the string "Processing timeout".

## Deviations from PLAN

1. **ExecutionError exception class**: Added `ExecutionError(Exception)` (not in PLAN) because `IngestError` is a Pydantic model, not raisable. This is the correct design for an error that callers need to catch.
2. **Removed unused imports from execute_all()**: The PLAN included model imports in `execute_all()` that were only needed in `_build_error_result()` (which has its own local imports).
3. **Removed `ProcessPoolExecutor`/`as_completed` import from router.py**: No longer used directly in router after delegation to execution backend.

## Acceptance Criteria Status

All criteria from PLAN met. See plan-46-021426.md for full list.

## Verification

```
pytest packages/ingestkit-pdf/tests/test_execution.py -v  # 27 passed
pytest packages/ingestkit-pdf/tests/ -q                    # 826 passed, 0 failed
ruff check (changed files)                                 # All checks passed
```

---

AGENT_RETURN: .agents/outputs/patch-46-021426.md
