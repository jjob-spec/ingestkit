---
issue: 33
agent: PATCH
date: 2026-02-14
status: Complete
files_created: 2
files_modified: 1
tests_added: 21
lines_added: 258
lines_removed: 0
---

# PATCH: Issue #33 — Language Detection (`utils/language.py`)

## Executive Summary

Implemented the language detection utility module for `ingestkit-pdf` per SPEC sections 16.1-16.3 and the MAP-PLAN. Created `language.py` with `detect_language()` and `map_language_to_ocr()` functions, created `test_language.py` with 21 unit tests (exceeding the 16-test target), and updated `utils/__init__.py` with the new exports. All 21 new tests pass and the full suite of 485 tests passes with no regressions.

## Metrics

| Metric | Value |
|--------|-------|
| Files created | 2 |
| Files modified | 1 |
| Tests added | 21 |
| Tests passing | 485 (full suite) |
| Regressions | 0 |

## Files Changed

### `packages/ingestkit-pdf/src/ingestkit_pdf/utils/language.py` (NEW)

- Module docstring referencing SPEC sections 16.1-16.3
- `_TESSERACT_LANG_MAP`: 29 entries (ISO 639-1 to Tesseract ISO 639-3)
- `_PADDLEOCR_LANG_MAP`: 12 entries (ISO 639-1 to PaddleOCR codes)
- `detect_language(text, *, default_language="en") -> tuple[str, float]`: empty/whitespace returns `(default, 1.0)`, short text returns `(default, 0.5)`, graceful ImportError fallback, BCP-47 normalization, unexpected exception handling
- `map_language_to_ocr(lang, engine) -> str`: Tesseract lookup with default fallback, PaddleOCR lookup with pass-through for unmapped languages

### `packages/ingestkit-pdf/tests/test_language.py` (NEW)

- 12 `detect_language` tests: empty, whitespace, short text, custom default (2), English, Spanish, import error, unexpected error, zh-cn normalization, zh-tw normalization, lite model verification
- 9 `map_language_to_ocr` tests: en/zh/es/ja for Tesseract, en/zh/ja for PaddleOCR, unknown lang fallback for both engines
- All marked `@pytest.mark.unit` via class decorators
- Mocking uses `sys.modules` injection for `fast_langdetect` (avoids requiring the optional dependency)

### `packages/ingestkit-pdf/src/ingestkit_pdf/utils/__init__.py` (MODIFIED)

- Added imports for `detect_language` and `map_language_to_ocr`
- Updated `__all__` list

## Deviations from MAP-PLAN

1. **Test count**: 21 tests instead of 16. Added extra coverage for custom default on short text, zh-tw normalization, Japanese mappings for both engines. No scope creep — all within the `language.py` module boundary.
2. **Mocking strategy**: Used `sys.modules` injection instead of `@patch` decorator because `detect` is lazy-imported inside the function body. The `@patch("ingestkit_pdf.utils.language.detect")` approach from the MAP-PLAN wouldn't work for a function-local import.

## Issues Encountered

None.

## Verification

```
$ python3 -m pytest packages/ingestkit-pdf/tests/test_language.py -v
21 passed in 0.17s

$ python3 -m pytest packages/ingestkit-pdf/tests/ -v
485 passed, 1 skipped in 1.65s
```

## Acceptance Criteria Status

All criteria met. See MAP-PLAN for full list.

AGENT_RETURN: .agents/outputs/patch-33-021426.md
