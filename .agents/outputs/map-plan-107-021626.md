---
issue: 107
agent: MAP-PLAN
date: 2026-02-16
complexity: TRIVIAL
stack: backend
dependency: "#102 (manual_override field)"
---

# MAP-PLAN: Issue #107 - Add try_match tenant_id parameter and align signature with spec

## Executive Summary

Issue #107 requires removing the `template_id` parameter from `FormRouter.try_match()` to align with the spec's signature: `(file_path: str, tenant_id: str | None) -> TemplateMatch | None`. The current implementation has an extra `template_id` parameter that belongs in `FormIngestRequest.manual_override` (issue #102). This is a TRIVIAL signature change with 6 test call sites to update. The manual override path inside `try_match` will be removed once #102 is complete, but for now we preserve its logic by accepting template_id via a request object instead.

**Dependency**: This issue is closely related to #102 (manual_override field). The spec defines that manual template override should be specified via `FormIngestRequest.manual_override=True` with `template_id`, NOT via a `template_id` parameter on `try_match()`. For this issue, we align the signature first, then wait for #102 to add the `manual_override` field to the request model.

## Investigation

### Current Implementation

**File**: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/router.py`

**Current signature** (lines 172-177):
```python
def try_match(
    self,
    file_path: str,
    template_id: str | None = None,
    tenant_id: str | None = None,
) -> TemplateMatch | None:
```

**Manual override path** (lines 197-212):
- If `template_id` is provided, creates a `FormIngestRequest` and calls `resolve_manual_override()`
- Returns synthetic `TemplateMatch` with `confidence=1.0`
- Includes `"manual_override"` in `matched_features`

**Auto-match path** (lines 214-227):
- Calls `match_document(file_path, tenant_id=tenant_id)`
- Returns top match if confidence >= threshold, else None

**Graceful fallthrough** (lines 229-235):
- Exception handling returns None (zero state mutation)

### Spec Requirements

**File**: `/home/jjob/projects/ingestkit/specs/PLUGIN_API_SURFACE_v1.md`

**Required signature** (line 48):
```
try_match(file_path: str, tenant_id: str | None) -> TemplateMatch | None
```

**Routing guidance** (line 52):
> "The host should call `try_match` first, then `extract_form` if matched. The host owns the dispatch decision (file type + feature flag). The plugin owns the matching logic (fingerprint comparison, confidence gating). Do not duplicate `try_match` logic in the host."

**FormIngestRequest** (lines 56-63):
```python
class FormIngestRequest(BaseModel):
    file_path: str
    template_id: str | None = None      # None = auto-detect
    template_version: int | None = None  # None = latest approved version
    tenant_id: str | None = None
    source_uri: str | None = None        # Defaults to file:// + absolute path
    manual_override: bool = False        # Skip matching, use template_id directly
```

**Key insight**: The spec places manual template override in `FormIngestRequest.manual_override`, NOT in `try_match()`. The `try_match()` method is a convenience gate for the orchestration layer to probe whether a document matches a form template. Manual override is handled by `extract_form(request)` directly.

### Callers Analysis

**Test file**: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/tests/test_router.py`

**6 call sites**:

1. **Line 649** (test_try_match_manual_template):
   ```python
   result = router.try_match(
       str(xlsx_file), template_id="tmpl-xlsx-1"
   )
   ```

2. **Line 664** (test_try_match_auto_below_threshold):
   ```python
   result = router.try_match(str(xlsx_file))
   ```

3. **Line 679** (test_try_match_disabled_no_manual):
   ```python
   result = router.try_match(str(xlsx_file))
   ```

4. **Line 702** (test_try_match_exception_returns_none):
   ```python
   result = router.try_match(str(xlsx_file))
   ```

5. **Line 720** (test_try_match_no_state_mutation):
   ```python
   result = router.try_match(str(xlsx_file))
   ```

6. **Line 735** (test_try_match_manual_template_not_found):
   ```python
   result = router.try_match(str(xlsx_file), template_id="nonexistent")
   ```

**Production usage**: The spec excerpt (line 577) shows expected host usage:
```python
router.try_match(file_path) -> TemplateMatch | None
```

**No production callers found** outside the test suite. This is an internal plugin method — hosts will call it but we control all call sites in tests.

### Dependency: Issue #102

**Status**: Issue #102 will add `manual_override: bool = False` to `FormIngestRequest` model.

**Current state**: The `FormIngestRequest` model (models.py:273-289) has:
- `file_path: str`
- `template_id: str | None = None`
- `template_version: int | None = None`
- `tenant_id: str | None = None`
- `source_uri: str | None = None`
- `metadata: dict[str, str] | None = None`

**Missing**: `manual_override: bool = False`

**Impact on this issue**:
- We can remove `template_id` parameter from `try_match()` signature NOW
- The manual override path (lines 197-212) will become dead code UNTIL #102 is implemented
- Once #102 adds `manual_override` field, the host will use `extract_form(FormIngestRequest(file_path=..., template_id=..., manual_override=True))` directly instead of `try_match(file_path, template_id=...)`

**Decision**: Remove the parameter now to align with spec. The manual override path inside `try_match` is **not spec-compliant** — manual overrides should go through `extract_form()` with `FormIngestRequest.manual_override=True`. We will DELETE the manual override block (lines 197-212) as part of this issue.

## Implementation Plan

### File Changes

#### 1. `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/router.py`

**Change 1**: Update method signature (lines 172-177)
```python
# BEFORE
def try_match(
    self,
    file_path: str,
    template_id: str | None = None,
    tenant_id: str | None = None,
) -> TemplateMatch | None:

# AFTER
def try_match(
    self,
    file_path: str,
    tenant_id: str | None = None,
) -> TemplateMatch | None:
```

**Change 2**: Update docstring (lines 178-195)
```python
# BEFORE
"""Pipeline gate: probe whether a document matches a form template.

This is a **convenience method for the orchestration layer** (not
part of the ``FormPluginAPI`` protocol). The caller invokes this
BEFORE deciding to route to Path F vs. the standard pipeline.

Semantics:
    - If ``template_id`` is provided: resolve via manual override
      and return a synthetic ``TemplateMatch`` with confidence 1.0.
    - If auto-match: return the top match only when its confidence
      is >= ``config.form_match_confidence_threshold`` (default 0.8).
    - On any exception: log a warning, return ``None`` (graceful
      fallthrough -- zero state mutation).

Returns:
    ``TemplateMatch`` if a template was matched (or manually
    specified), ``None`` otherwise.
"""

# AFTER
"""Pipeline gate: probe whether a document matches a form template.

This is a **convenience method for the orchestration layer** (not
part of the ``FormPluginAPI`` protocol). The caller invokes this
BEFORE deciding to route to Path F vs. the standard pipeline.

Semantics:
    - Runs auto-match via ``match_document(file_path, tenant_id)``.
    - Returns the top match only when its confidence is >=
      ``config.form_match_confidence_threshold`` (default 0.8).
    - On any exception: log a warning, return ``None`` (graceful
      fallthrough -- zero state mutation).

Manual override:
    For manual template override, use ``extract_form()`` directly
    with ``FormIngestRequest(template_id=..., manual_override=True)``.
    See issue #102 for manual_override field implementation.

Returns:
    ``TemplateMatch`` if a template was matched above threshold,
    ``None`` otherwise (graceful fallthrough).
"""
```

**Change 3**: Remove manual override block (lines 197-212)
```python
# DELETE THIS BLOCK
try:
    # Manual override path
    if template_id is not None:
        request = FormIngestRequest(
            file_path=file_path,
            template_id=template_id,
            tenant_id=tenant_id,
        )
        template = self._matcher.resolve_manual_override(request)
        return TemplateMatch(
            template_id=template.template_id,
            template_name=template.name,
            template_version=template.version,
            confidence=1.0,
            per_page_confidence=[1.0] * template.page_count,
            matched_features=["manual_override"],
        )
```

**Change 4**: Simplify method body (keep lines 214-235, renumber after deletion)
```python
def try_match(
    self,
    file_path: str,
    tenant_id: str | None = None,
) -> TemplateMatch | None:
    """..."""
    try:
        # Disabled matching with no manual template
        if not self._config.form_match_enabled:
            return None

        # Auto-match path
        matches = self.match_document(file_path, tenant_id=tenant_id)
        if not matches:
            return None

        top = matches[0]
        if top.confidence >= self._config.form_match_confidence_threshold:
            return top

        return None

    except Exception:
        logger.warning(
            "try_match fallthrough due to exception for '%s'",
            file_path,
            exc_info=True,
        )
        return None
```

#### 2. `/home/jjob/projects/ingestkit/packages/ingestkit-forms/tests/test_router.py`

**Change 1**: Update test_try_match_manual_template (lines 640-657)
```python
# BEFORE
def test_try_match_manual_template(self, all_backends, form_config, xlsx_template, tmp_path):
    """Manual template_id returns synthetic TemplateMatch with confidence=1.0."""
    store = all_backends["template_store"]
    store.save_template(xlsx_template)

    router = FormRouter(**all_backends, config=form_config)
    xlsx_file = tmp_path / "form.xlsx"
    xlsx_file.touch()

    result = router.try_match(
        str(xlsx_file), template_id="tmpl-xlsx-1"
    )
    assert result is not None
    assert isinstance(result, TemplateMatch)
    assert result.template_id == "tmpl-xlsx-1"
    assert result.confidence == 1.0
    assert "manual_override" in result.matched_features

# AFTER (rename to test_try_match_auto_with_match)
def test_try_match_auto_with_match(self, all_backends, form_config, xlsx_template, tmp_path):
    """Auto-match with fingerprint match returns TemplateMatch above threshold."""
    store = all_backends["template_store"]
    store.save_template(xlsx_template)

    # Mock fingerprinter to return matching fingerprint
    all_backends["fingerprinter"].set_mock_fingerprint(b"\x01" * 320)
    # Update template with same fingerprint
    xlsx_template.layout_fingerprint = b"\x01" * 320
    store.save_template(xlsx_template)

    router = FormRouter(**all_backends, config=form_config)
    xlsx_file = tmp_path / "form.xlsx"
    xlsx_file.touch()

    result = router.try_match(str(xlsx_file))
    assert result is not None
    assert isinstance(result, TemplateMatch)
    assert result.template_id == "tmpl-xlsx-1"
    assert result.confidence >= form_config.form_match_confidence_threshold
```

**Change 2**: Update test_try_match_manual_template_not_found (lines 729-736)
```python
# BEFORE
def test_try_match_manual_template_not_found(self, all_backends, form_config, tmp_path):
    """Manual template_id that doesn't exist returns None (exception caught)."""
    router = FormRouter(**all_backends, config=form_config)
    xlsx_file = tmp_path / "form.xlsx"
    xlsx_file.touch()

    result = router.try_match(str(xlsx_file), template_id="nonexistent")
    assert result is None

# AFTER (DELETE THIS TEST - manual override no longer supported)
# Test removed - manual override handled via extract_form(FormIngestRequest(manual_override=True))
```

**Change 3**: Add tenant_id to remaining calls (4 locations, already have correct signature)
- Line 664: `router.try_match(str(xlsx_file))` — already correct
- Line 679: `router.try_match(str(xlsx_file))` — already correct
- Line 702: `router.try_match(str(xlsx_file))` — already correct
- Line 720: `router.try_match(str(xlsx_file))` — already correct

**Optional enhancement**: Add explicit tenant_id test
```python
def test_try_match_with_tenant_id(self, all_backends, form_config, xlsx_template, tmp_path):
    """try_match passes tenant_id to match_document."""
    store = all_backends["template_store"]
    store.save_template(xlsx_template)

    router = FormRouter(**all_backends, config=form_config)
    xlsx_file = tmp_path / "form.xlsx"
    xlsx_file.touch()

    # Call with explicit tenant_id
    result = router.try_match(str(xlsx_file), tenant_id="custom-tenant")
    # Verify tenant_id was passed (implementation already correct)
    assert result is None  # No match, but no exception
```

#### 3. Documentation update (if exists)

**Check**: Search for try_match in README or usage docs
- No README found in package root
- Spec already correct at `/home/jjob/projects/ingestkit/specs/PLUGIN_API_SURFACE_v1.md:48`

## Acceptance Criteria

- [ ] `FormRouter.try_match()` signature is `(file_path: str, tenant_id: str | None) -> TemplateMatch | None`
- [ ] Manual override block (lines 197-212) removed from try_match method body
- [ ] Docstring updated to reference FormIngestRequest.manual_override (issue #102)
- [ ] Test `test_try_match_manual_template` replaced with auto-match test
- [ ] Test `test_try_match_manual_template_not_found` deleted
- [ ] All existing auto-match tests pass (4 tests unchanged)
- [ ] Optional: New test `test_try_match_with_tenant_id` added
- [ ] No regressions in test suite: `pytest packages/ingestkit-forms/tests/test_router.py -v`
- [ ] Method signature matches spec section 2.1 line 48

## Verification Gates

### Pre-implementation
1. Read current implementation: router.py lines 172-236 ✓
2. Read spec signature: PLUGIN_API_SURFACE_v1.md line 48 ✓
3. Find all callers: 6 test call sites identified ✓

### Post-implementation
1. **Linting**: No errors from signature change
   ```bash
   cd packages/ingestkit-forms && python -m ruff check src/ingestkit_forms/router.py
   ```

2. **Type checking**: Method signature valid
   ```bash
   cd packages/ingestkit-forms && python -m mypy src/ingestkit_forms/router.py
   ```

3. **Unit tests**: All router tests pass
   ```bash
   pytest packages/ingestkit-forms/tests/test_router.py::TestTryMatch -v
   ```

4. **No regressions**: Full test suite passes
   ```bash
   pytest packages/ingestkit-forms/tests/test_router.py -v
   ```

5. **Manual verification**: Import check
   ```python
   from ingestkit_forms import FormRouter
   import inspect
   sig = inspect.signature(FormRouter.try_match)
   print(sig)  # Should show (self, file_path: str, tenant_id: str | None = None)
   ```

## Dependencies

**Blocks**: None

**Blocked by**: None (can implement independently)

**Related**:
- **Issue #102** (manual_override field): This issue removes template_id from try_match. Issue #102 will add manual_override to FormIngestRequest, enabling hosts to use `extract_form(FormIngestRequest(template_id=..., manual_override=True))` for manual template override.

**Coordination**: Once #102 is complete, update the docstring to remove "See issue #102" reference and replace with actual usage example.

## Risks

1. **Breaking change for external callers**: MITIGATED
   - Risk: Hosts calling `try_match(file_path, template_id="...")` will break
   - Mitigation: This is an internal plugin method, spec is authoritative, hosts should not have deployed this yet (package is pre-1.0, spec is DRAFT v0.2)
   - Action: Document in CHANGELOG as breaking change

2. **Manual override workflow gap**: MITIGATED
   - Risk: Removing manual override from try_match breaks the workflow
   - Mitigation: Manual override was never spec-compliant. Spec says use `extract_form(FormIngestRequest(manual_override=True))`. We're aligning with spec.
   - Action: Add docstring note pointing to correct workflow

3. **Test coverage loss**: MITIGATED
   - Risk: Deleting 2 manual override tests reduces coverage
   - Mitigation: Manual override logic lives in `extract_form()`, which has comprehensive tests (test_extract_form_manual_template at line 215)
   - Action: Add auto-match test to maintain coverage count

## Out of Scope

- Adding `manual_override` field to `FormIngestRequest` (issue #102)
- Updating `extract_form()` to validate `manual_override=True` (issue #102)
- Host integration examples (spec integration guide)
- Backward compatibility shim (package is pre-1.0)

## File Summary

| File | Lines Changed | Type | Complexity |
|------|--------------|------|------------|
| router.py | ~45 (15 deleted, 30 modified) | Signature + docstring + logic removal | LOW |
| test_router.py | ~25 (1 test deleted, 1 test rewritten, 1 test added) | Test updates | LOW |

**Total**: 2 files, ~70 lines, 30 minutes estimated

## Cross-References

- **Spec**: `/home/jjob/projects/ingestkit/specs/PLUGIN_API_SURFACE_v1.md` section 2.1 line 48
- **Current implementation**: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/router.py` lines 172-236
- **Tests**: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/tests/test_router.py` lines 637-737
- **Related issue**: #102 (manual_override field)
- **Spec review**: `.agents/outputs/spec-review-plugin-api-surface-021626.md` line 68

AGENT_RETURN: map-plan-107-021626.md
