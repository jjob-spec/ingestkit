---
issue: 5
agent: PATCH
date: 2026-02-10
status: complete
tests_before: 148
tests_after: 176
tests_new: 28
tests_failed: 0
---

# PATCH - Issue #5: Parser Fallback Chain

## Summary

Implemented the `ParserChain` class in a new `parser_chain.py` module providing a three-tier per-sheet fallback strategy for parsing `.xlsx` files. Updated `__init__.py` to export `ParserChain`. Created comprehensive test suite with 28 tests covering all acceptance criteria.

## Files Created

### 1. `packages/ingestkit-excel/src/ingestkit_excel/parser_chain.py` (NEW)

**Class:** `ParserChain`
- `__init__(self, config: ExcelProcessorConfig)` -- stores config for limits/thresholds
- `parse(self, file_path: str) -> tuple[FileProfile, list[IngestError]]` -- main public API

**Three-tier fallback chain (per-sheet):**
1. **Tier 1: openpyxl** (full fidelity) -- merged cells, formulas, formatting, hidden status
2. **Tier 2: pandas read_excel** (reduced fidelity) -- loses merged cell info, formulas, hidden status
3. **Tier 3: openpyxl data_only=True** (minimal fidelity) -- cached values only, no formula info

**Edge cases handled:**
- Password-protected files: `E_PARSE_PASSWORD` error
- Chart-only sheets (Chartsheet): `W_SHEET_SKIPPED_CHART` warning, skipped
- Zero-byte/empty files: `E_PARSE_EMPTY` error
- Sheet exceeds `max_rows_in_memory`: `W_ROWS_TRUNCATED` warning, skipped
- Completely corrupt file: `E_PARSE_CORRUPT` error (all parsers fail)
- File-level open failure: graceful cascade to pandas then raw text for all sheets

**SheetProfile fields populated:**
- `name`, `row_count`, `col_count`
- `merged_cell_count`, `merged_cell_ratio`
- `header_row_detected`, `header_values` (heuristic: first row all non-null, at least one string)
- `column_type_consistency` (dominant type per column / total non-null)
- `numeric_ratio`, `text_ratio`, `empty_ratio`
- `sample_rows` (first N rows as string lists, N = config.max_sample_rows)
- `has_formulas`, `is_hidden`
- `parser_used` (ParserUsed enum)

**FileProfile fields populated:**
- `file_path`, `file_size_bytes`, `content_hash` (SHA-256 hex)
- `sheet_count`, `sheet_names`, `sheets`
- `has_password_protected_sheets`, `has_chart_only_sheets`
- `total_merged_cells`, `total_rows`

**Private methods:**
- `_compute_content_hash` -- SHA-256 of raw file bytes
- `_try_parse_sheet_openpyxl` / `_build_sheet_profile_from_openpyxl` -- Tier 1
- `_try_parse_sheet_pandas` / `_build_sheet_profile_from_pandas` -- Tier 2
- `_try_parse_sheet_raw_text` / `_build_sheet_profile_from_raw_text` -- Tier 3
- `_parse_all_via_pandas_fallback` / `_parse_all_via_raw_text_fallback` -- file-level fallback
- `_detect_header`, `_compute_type_ratios`, `_compute_column_type_consistency`, `_extract_sample_rows` -- shared analysis
- `_build_empty_file_profile` -- minimal profile builder

### 2. `packages/ingestkit-excel/tests/test_parser_chain.py` (NEW)

28 tests in 16 test classes:

| Test Class | Test Method | What It Validates |
|---|---|---|
| TestCleanXlsxPrimaryParser | test_clean_xlsx_primary_parser | Clean xlsx parsed with openpyxl, ParserUsed.OPENPYXL |
| TestSheetProfileFieldsPopulated | test_sheet_profile_fields_populated | All SheetProfile fields have reasonable values |
| TestContentHashComputed | test_content_hash_computed | SHA-256 hex, matches independent computation |
| TestMergedCellsDetected | test_merged_cells_detected | merged_cell_count > 0, ratio > 0 |
| TestEmptyWorkbook | test_empty_workbook | Empty workbook handled gracefully |
| TestEmptyWorkbook | test_zero_byte_file | E_PARSE_EMPTY for zero-byte file |
| TestChartOnlySheet | test_chart_only_sheet | W_SHEET_SKIPPED_CHART, has_chart_only_sheets=True |
| TestMaxRowsTruncation | test_max_rows_truncation | W_ROWS_TRUNCATED when exceeding max_rows_in_memory |
| TestHeaderDetection | test_header_detection | header_row_detected=True, header_values populated |
| TestHeaderDetection | test_no_header_when_all_numeric | No header detected for all-numeric first row |
| TestSampleRowsPopulated | test_sample_rows_populated | sample_rows has max_sample_rows entries |
| TestSampleRowsPopulated | test_sample_rows_fewer_than_max | Fewer rows than max returns all |
| TestColumnTypeConsistency | test_uniform_types_high_consistency | Uniform types -> high consistency |
| TestColumnTypeConsistency | test_mixed_types_lower_consistency | Mixed types -> lower consistency |
| TestNumericTextRatios | test_numeric_heavy_xlsx | High numeric_ratio for numeric data |
| TestNumericTextRatios | test_text_heavy_xlsx | High text_ratio for text data |
| TestMultipleSheets | test_multiple_sheets | All 3 sheets parsed, aggregated correctly |
| TestFormulaDetection | test_formulas_detected | has_formulas=True for formula sheets |
| TestFormulaDetection | test_no_formulas_clean_data | has_formulas=False for clean data |
| TestHiddenSheetDetection | test_hidden_sheet_detected | Hidden sheet is_hidden=True |
| TestFileProfileAggregateFields | test_file_profile_aggregate_fields | Correct aggregation of all fields |
| TestCorruptFile | test_all_parsers_fail_produces_e_parse_corrupt | E_PARSE_CORRUPT for random bytes |
| TestPasswordProtectedFile | test_password_protected_file | E_PARSE_PASSWORD via mock |
| TestParserFallback | test_openpyxl_fail_falls_back_to_pandas | Tier 1 fail -> Tier 2 success |
| TestParserFallback | test_openpyxl_and_pandas_fail_falls_back_to_raw_text | Tier 1+2 fail -> Tier 3 |
| TestPerSheetFallbackIndependence | test_per_sheet_fallback_independence | Sheet1=openpyxl, Sheet2=pandas |
| TestFileNotFound | test_file_not_found | FileNotFoundError raised |
| TestFallbackReasonCode | test_fallback_reason_code_correctly_set | E_PARSE_OPENPYXL_FAIL in message |

## Files Modified

### 3. `packages/ingestkit-excel/src/ingestkit_excel/__init__.py` (MODIFIED)

- Added `from ingestkit_excel.parser_chain import ParserChain` import
- Added `"ParserChain"` to `__all__` list under `# Parser` comment

## Verification

```
$ pytest -q
176 passed in 0.46s
```

- 148 existing tests: all pass (no regressions)
- 28 new tests: all pass
- 0 failures

## Acceptance Criteria Met

1. Clean .xlsx parsed with openpyxl primary -- `test_clean_xlsx_primary_parser`
2. Fallback to pandas when openpyxl fails -- `test_openpyxl_fail_falls_back_to_pandas`
3. All-parsers-fail produces E_PARSE_CORRUPT -- `test_all_parsers_fail_produces_e_parse_corrupt`
4. Per-sheet fallback independence -- `test_per_sheet_fallback_independence`
5. fallback_reason_code correctly set -- `test_fallback_reason_code_correctly_set`
6. W_PARSER_FALLBACK in warnings -- verified in fallback tests
7. Password, chart-only, empty edge cases -- `test_password_protected_file`, `test_chart_only_sheet`, `test_zero_byte_file`
8. All tests pass -- 176/176 green

---

AGENT_RETURN: patch-5-021026.md
