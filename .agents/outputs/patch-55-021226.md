---
issue: 55
agent: PATCH
date: 2026-02-12
status: Complete
files_modified: 8
files_created: 12
tests_added: 83
---

# PATCH: Issue #55 -- Extract ingestkit-core Shared Package

## Summary

Created `packages/ingestkit-core/` containing 4 protocols, 6 models, 15 shared error codes (`CoreErrorCode`), `BaseIngestError`, and `compute_ingest_key`. Both sibling packages (`ingestkit-excel`, `ingestkit-pdf`) now depend on core and re-export shared symbols for backward compatibility. All existing import paths continue to work. Zero test regressions: Excel 335 passed, PDF 197 passed, Core 83 new tests passed.

## Pre-Flight Checklist

- [x] Read PLAN artifact at `.agents/outputs/plan-55-021226.md`
- [x] Read MAP artifact at `.agents/outputs/map-55-021226.md`
- [x] Read TEST-PLAN artifact at `.agents/outputs/test-plan-55-021226.md`
- [x] Verified on branch `feature/issue-55-ingestkit-core`
- [x] Read `CLAUDE.md` project rules
- [x] Read all source files before modifying

## Metrics

| Metric | Value |
|--------|-------|
| Files created | 12 (core package scaffold + source + tests) |
| Files modified | 8 (4 Excel, 4 PDF) |
| Tests added | 83 (core package) |
| Tests existing | 532 (335 Excel + 197 PDF) |
| Tests passing | 615 (83 + 335 + 197) |
| Regressions | 0 |

## Files Changed

### Created (`packages/ingestkit-core/`)

| File | Description |
|------|-------------|
| `pyproject.toml` | Package scaffold, pydantic>=2.0 only runtime dep |
| `src/ingestkit_core/__init__.py` | Re-exports all 13 public symbols with `__all__` |
| `src/ingestkit_core/errors.py` | `CoreErrorCode` (15 shared codes) + `BaseIngestError` |
| `src/ingestkit_core/models.py` | `ClassificationTier`, `IngestKey`, `EmbedStageResult`, `BaseChunkMetadata`, `ChunkPayload`, `WrittenArtifacts` |
| `src/ingestkit_core/protocols.py` | 4 protocols verbatim from Excel, TYPE_CHECKING import pointed to core |
| `src/ingestkit_core/idempotency.py` | `compute_ingest_key()` from Excel, import from core |
| `src/ingestkit_core/py.typed` | PEP 561 marker |
| `tests/__init__.py` | Empty |
| `tests/conftest.py` | Minimal |
| `tests/test_protocols.py` | 11 tests: runtime checkable, structural subtyping, non-conforming |
| `tests/test_models.py` | 30 tests: IngestKey, WrittenArtifacts, EmbedStageResult, BaseChunkMetadata, ClassificationTier |
| `tests/test_errors.py` | 24 tests: CoreErrorCode enumeration, BaseIngestError construction/serialization |
| `tests/test_imports.py` | 14 tests: core imports, Excel/PDF re-exports, circular import prevention |
| `tests/test_cross_package.py` | 4 integration tests: cross-package protocol/model identity |

### Modified (`packages/ingestkit-excel/`)

| File | Changes |
|------|---------|
| `pyproject.toml` | Added `ingestkit-core>=0.1.0` dependency |
| `src/ingestkit_excel/models.py` | Imported 6 shared types from core; deleted local `ClassificationTier`, `IngestKey`, `EmbedStageResult`, `ChunkPayload`, `WrittenArtifacts`; `ChunkMetadata` now extends `BaseChunkMetadata` |
| `src/ingestkit_excel/errors.py` | `IngestError` extends `BaseIngestError`; re-declares `code: ErrorCode`; keeps `sheet_name` |
| `src/ingestkit_excel/protocols.py` | Replaced with re-exports from `ingestkit_core.protocols` |
| `src/ingestkit_excel/idempotency.py` | Replaced with re-exports from `ingestkit_core` |

### Modified (`packages/ingestkit-pdf/`)

| File | Changes |
|------|---------|
| `pyproject.toml` | Added `ingestkit-core>=0.1.0` dependency |
| `src/ingestkit_pdf/models.py` | Same pattern as Excel; `PDFChunkMetadata` extends `BaseChunkMetadata` |
| `src/ingestkit_pdf/errors.py` | `IngestError` extends `BaseIngestError`; re-declares `code: ErrorCode`; keeps `page_number` |
| `src/ingestkit_pdf/protocols.py` | Replaced with re-exports from `ingestkit_core.protocols` |

## Verification Results

```
Core:  83 passed
Excel: 335 passed (baseline: 335)
PDF:   197 passed (baseline: 197)
```

Smoke test confirmed identity checks:
- `ingestkit_excel.protocols.VectorStoreBackend is ingestkit_core.protocols.VectorStoreBackend` -- True
- `ingestkit_pdf.protocols.VectorStoreBackend is ingestkit_core.protocols.VectorStoreBackend` -- True
- `IngestKey`, `WrittenArtifacts`, `EmbedStageResult` all share identity across all 3 packages
- `IngestError(Excel)` and `IngestError(PDF)` both subclass `BaseIngestError`
- No circular imports (core does not pull in excel or pdf)

## Issues Encountered

1. **Protocol `_is_runtime_checkable` vs `_is_runtime_protocol`**: The test plan used `_is_runtime_checkable` as the attribute name, but Python 3.12 uses `_is_runtime_protocol`. Fixed in `test_protocols.py`.

2. **`ChunkMetadata.ingest_run_id` type narrowing**: Both Excel and PDF had `ingest_run_id: str` (required), but `BaseChunkMetadata` defines it as `str | None = None` (optional) since some contexts may not have a run ID at construction time. Subclasses in Excel and PDF override with `ingest_run_id: str` to maintain backward compatibility. Added `# type: ignore[assignment]` comment for type checkers.

## Deviations from PLAN

1. **TRIVIAL**: `__all__` has 13 symbols not 16 -- the PLAN counted `CoreErrorCode` + `BaseIngestError` + 6 models + `compute_ingest_key` + 4 protocols = 13. The "16" figure in the plan was a minor counting error.

2. **TRIVIAL**: Test plan referenced `_is_runtime_checkable` attribute; corrected to `_is_runtime_protocol` (actual Python 3.12 attribute name).

3. **MINOR**: PDF package has no `idempotency.py` module (it was never created), so Step 9.5 from the PLAN was skipped. Only Excel had `idempotency.py`.

---

AGENT_RETURN: patch-55-021226.md
