# PROVE: Issue #11 -- Concrete Backends

**Date:** 2026-02-12
**Branch:** `feature/issue-8-path-a-processor`
**Verdict:** PASS

---

## Level 1: Tests

### Backend tests (`test_backends.py`)

```
66 collected, 66 passed in 0.73s
```

All 66 tests pass. Breakdown by class:

| Test Class | Count | Status |
|---|---|---|
| TestSQLiteStructuredDB | 12 | PASS |
| TestQdrantVectorStore | 15 | PASS |
| TestOllamaLLM | 10 | PASS |
| TestOllamaEmbedding | 9 | PASS |
| TestStubs | 9 | PASS |
| TestProtocolConformance | 6 | PASS |
| TestBackendsPackageImport | 5 | PASS |

### Full test suite

```
513 collected, 513 passed in 1.39s
```

Zero regressions. All pre-existing tests continue to pass.

---

## Level 2: Imports

All six backend classes import successfully from the `ingestkit_excel.backends` package:

| Class | Import Result |
|---|---|
| `SQLiteStructuredDB` | OK -- class loaded |
| `QdrantVectorStore` | OK -- `<class 'ingestkit_excel.backends.qdrant.QdrantVectorStore'>` |
| `OllamaLLM` | OK -- `<class 'ingestkit_excel.backends.ollama.OllamaLLM'>` |
| `OllamaEmbedding` | OK -- `<class 'ingestkit_excel.backends.ollama.OllamaEmbedding'>` |
| `MilvusVectorStore` | OK -- `<class 'ingestkit_excel.backends.milvus.MilvusVectorStore'>` |
| `PostgresStructuredDB` | OK -- `<class 'ingestkit_excel.backends.postgres.PostgresStructuredDB'>` |

Lazy import guards in `__init__.py` verified: `QdrantVectorStore`, `OllamaLLM`, `OllamaEmbedding` are wrapped in `try/except ImportError` blocks. When optional deps are missing, they default to `None` without breaking the package import.

---

## Level 3: Protocol Conformance

All six backends satisfy their respective `@runtime_checkable` Protocol via `isinstance()`:

```
SQLite satisfies StructuredDBBackend: True
Qdrant satisfies VectorStoreBackend: True
OllamaLLM satisfies LLMBackend: True
OllamaEmbedding satisfies EmbeddingBackend: True
MilvusVectorStore satisfies VectorStoreBackend: True
PostgresStructuredDB satisfies StructuredDBBackend: True
```

No ABC usage found. No explicit Protocol inheritance. Purely structural subtyping as required by project constraints.

### Protocol method coverage

| Protocol | Methods | Backend | Implemented |
|---|---|---|---|
| `StructuredDBBackend` | create_table_from_dataframe, drop_table, table_exists, get_table_schema, get_connection_uri | `SQLiteStructuredDB` | All 5 |
| `StructuredDBBackend` | (same 5) | `PostgresStructuredDB` (stub) | All 5 (raise NotImplementedError) |
| `VectorStoreBackend` | upsert_chunks, ensure_collection, create_payload_index, delete_by_ids | `QdrantVectorStore` | All 4 |
| `VectorStoreBackend` | (same 4) | `MilvusVectorStore` (stub) | All 4 (raise NotImplementedError) |
| `LLMBackend` | classify, generate | `OllamaLLM` | Both |
| `EmbeddingBackend` | embed, dimension | `OllamaEmbedding` | Both |

---

## Level 4: Acceptance Criteria

### Qdrant has timeout and retry

- **VERIFIED.** Constructor passes `config.backend_timeout_seconds` to `QdrantClient(timeout=...)`.
- **VERIFIED.** `_retry()` method implements exponential backoff using `config.backend_max_retries` and `config.backend_backoff_base`.
- **VERIFIED.** All four protocol methods (`ensure_collection`, `upsert_chunks`, `create_payload_index`, `delete_by_ids`) call `self._retry(...)`.
- **VERIFIED.** Test `test_upsert_chunks_retry_on_failure` confirms retry succeeds on second attempt.
- **VERIFIED.** Test `test_upsert_chunks_raises_after_retries_exhausted` confirms `ConnectionError` after all retries fail.

### SQLite creates/drops tables, reports schema

- **VERIFIED.** `create_table_from_dataframe()` uses `df.to_sql()` with `if_exists='replace'`.
- **VERIFIED.** `drop_table()` uses `DROP TABLE IF EXISTS` (no-op if missing).
- **VERIFIED.** `get_table_schema()` uses `PRAGMA table_info` and returns `{column_name: type_string}`.
- **VERIFIED.** `table_exists()` queries `sqlite_master`.
- **VERIFIED.** All tested with real in-memory SQLite (not mocked).

### Ollama LLM classify parses JSON, retry on malformed

- **VERIFIED.** `classify()` posts to `/api/generate` with `format="json"` and `stream=False`.
- **VERIFIED.** Response text is parsed via `json.loads()`.
- **VERIFIED.** On `JSONDecodeError`, retries once with a hint appended to the prompt.
- **VERIFIED.** After two consecutive malformed responses, raises `json.JSONDecodeError`.
- **VERIFIED.** Tests: `test_classify_retries_on_malformed_json` and `test_classify_raises_after_two_malformed_json`.

### Ollama embedding returns vectors

- **VERIFIED.** `embed()` posts to `/api/embed` and returns `data["embeddings"]`.
- **VERIFIED.** Empty input returns `[]` immediately.
- **VERIFIED.** `dimension()` returns the configured `embedding_dimension` value.
- **VERIFIED.** Has retry with exponential backoff on timeout/connection errors.
- **VERIFIED.** Test `test_embed_returns_vectors` confirms correct vector extraction.

### Stubs raise NotImplementedError

- **VERIFIED.** `MilvusVectorStore`: all 4 methods raise `NotImplementedError` with "stub" in message.
- **VERIFIED.** `PostgresStructuredDB`: all 5 methods raise `NotImplementedError` with "stub" in message.
- **VERIFIED.** 9 tests cover all stub methods.

### Unit tests use mocks only

- **VERIFIED.** Zero `@pytest.mark.integration` markers in test_backends.py.
- **VERIFIED.** No real network imports (`requests`, `urllib`, `socket`, `subprocess`).
- **VERIFIED.** Qdrant tests use `unittest.mock.MagicMock` for `QdrantClient`.
- **VERIFIED.** Ollama tests use `unittest.mock.patch("httpx.post", ...)`.
- **VERIFIED.** SQLite tests use real `:memory:` database (stdlib, no external service).
- **VERIFIED.** All 66 tests marked `@pytest.mark.unit`.

---

## File Inventory

### 7 files created

| File | Purpose | Lines |
|---|---|---|
| `backends/__init__.py` | Package init with lazy imports | 43 |
| `backends/sqlite.py` | SQLiteStructuredDB (real implementation) | 108 |
| `backends/qdrant.py` | QdrantVectorStore (real implementation) | 222 |
| `backends/ollama.py` | OllamaLLM + OllamaEmbedding (real implementations) | 299 |
| `backends/milvus.py` | MilvusVectorStore (stub) | 42 |
| `backends/postgres.py` | PostgresStructuredDB (stub) | 54 |
| `tests/test_backends.py` | 66 unit tests across 7 test classes | 846 |

### 1 file modified

| File | Change |
|---|---|
| `__init__.py` | Added backend imports and `__all__` exports (6 backend classes) |

---

## Architecture Compliance

| Constraint | Status |
|---|---|
| No ABC base classes | PASS -- zero ABC/ABCMeta/abstractmethod usage |
| Structural subtyping only | PASS -- no explicit Protocol inheritance in backends |
| Logger name `ingestkit_excel` | PASS -- all backends use `logging.getLogger("ingestkit_excel")` |
| Optional deps guarded | PASS -- qdrant-client and httpx guarded with try/except ImportError |
| No concrete backends inside core protocols | PASS -- backends are in separate `backends/` subpackage |
| Config-driven timeout/retry | PASS -- uses `backend_timeout_seconds`, `backend_max_retries`, `backend_backoff_base` |

---

## Summary

All PATCH claims verified:

| Claim | Verified |
|---|---|
| 66 new tests in test_backends.py | YES -- 66 collected, 66 passed |
| 513 total tests passing | YES -- 513 collected, 513 passed |
| Zero regressions | YES -- no failures in full suite |
| 7 files created, 1 modified | YES -- exact match |
| All backends satisfy Protocol (runtime_checkable isinstance) | YES -- all 6 return True |

**VERDICT: PASS -- all claims verified, zero discrepancies.**
