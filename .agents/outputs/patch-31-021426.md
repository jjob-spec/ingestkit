---
issue: 31
agent: PATCH
date: 2026-02-14
status: Complete
files_created: 2
files_modified: 1
tests_added: 27
lines_added: 443
lines_removed: 0
---

# PATCH: Issue #31 -- Heading Hierarchy Detection

## Executive Summary

Implemented `HeadingDetector` in `utils/heading_detector.py` with three strategies (outline, font-based, markdown) as specified in the MAP-PLAN. The class provides `detect()` returning `list[tuple[int, str, int]]` and `get_heading_path()` returning `list[str]`. All 27 tests pass. The `utils/__init__.py` was safely appended to (another agent had already added `HeaderFooterDetector`).

## Metrics

| Metric | Value |
|--------|-------|
| Files created | 2 |
| Files modified | 1 |
| Tests added | 27 |
| Tests passing | 27 |
| Tests failing | 0 |

## Files Changed

### Created: `packages/ingestkit-pdf/src/ingestkit_pdf/utils/heading_detector.py`

- `HeadingDetector` class with `__init__(config: PDFProcessorConfig)`
- `detect(doc)` -- public method, cascades through 3 strategies
- `_detect_from_outline(doc)` -- Strategy 1: uses `doc.get_toc()`
- `_detect_from_fonts(doc)` -- Strategy 2: body size via Counter, threshold via `heading_min_font_size_ratio`, requires bold, top 3 sizes mapped to H1/H2/H3, merges consecutive spans within 2pt y-tolerance
- `_detect_from_markdown(doc)` -- Strategy 3: parses `#{1,3}` headers from pymupdf4llm page chunks
- `get_heading_path(page_number, position_y)` -- builds ancestry by walking backward through detected headings
- Internal storage uses 4-tuples `(level, title, page, y_pos)` for y-position awareness; public API strips y_pos
- All exceptions caught and logged as warnings; returns empty lists on failure
- Logger name: `ingestkit_pdf`

### Modified: `packages/ingestkit-pdf/src/ingestkit_pdf/utils/__init__.py`

- Added `HeadingDetector` import alongside existing `HeaderFooterDetector` (safe append)
- Updated `__all__` to include both exports

### Created: `packages/ingestkit-pdf/tests/test_heading_detector.py`

- 27 tests across 6 test classes, all marked `@pytest.mark.unit`
- `TestDetectFromOutline` (3 tests): TOC parsing, empty title filtering, priority over fonts
- `TestDetectFromFonts` (8 tests): bold detection, body size calculation, level mapping, span merging, config ratio
- `TestDetectFromMarkdown` (3 tests): header parsing, H4+ ignored, page numbers from chunks
- `TestGetHeadingPath` (5 tests): ancestry building, mid-document, empty, before-first, y-position selection
- `TestStrategyCascade` (4 tests): priority ordering, fallback chain
- `TestEdgeCases` (4 tests): single page, unicode, long titles, idempotency
- All tests use mock fitz.Document/Page -- no binary PDF fixtures

## Verification Results

```
27 passed in 0.24s
```

## Issues Encountered

1. **`pymupdf4llm` mocking**: The initial `test_markdown_headers_parsed` used `patch()` on a module-level attribute, but `pymupdf4llm` is imported inside `_detect_from_markdown()` (lazy import). Fixed by injecting the mock via `sys.modules["pymupdf4llm"]` instead of `patch()`, matching the approach used in other markdown tests.

2. **Concurrent `__init__.py` modification**: Another agent (issue #30, HeaderFooterDetector) had already modified `utils/__init__.py` by the time this agent ran. Safely appended the `HeadingDetector` import without overwriting the existing `HeaderFooterDetector` export.

## Deviations from MAP-PLAN

None.

## Acceptance Criteria Status

All criteria met. See MAP-PLAN for full list.

AGENT_RETURN: .agents/outputs/patch-31-021426.md
