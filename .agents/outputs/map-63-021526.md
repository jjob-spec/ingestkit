# MAP Artifact: Issue #63 — Implement native PDF form field extraction

**Date**: 2026-02-15
**Issue**: #63 — Implement native PDF form field extraction
**Complexity**: COMPLEX

---

## 1. Codebase Investigation Summary

### 1.1 Spec Requirements (§7.1)

The spec at `/home/jjob/projects/ingestkit/docs/specs/form-ingestor-plugin.md` lines 693-742 defines the `NativePDFExtractor` algorithm:

1. Open PDF via `PDFWidgetBackend` (injected, never import PyMuPDF directly)
2. Iterate over form widgets on each page via `backend.extract_widgets(file_path, page)`
3. For each template `FieldMapping`:
   - Find the PDF widget whose bounding box overlaps the template field's bounding box
   - Overlap threshold: >= 50% IoU (configurable via `native_pdf_iou_threshold`)
   - Match found: value from widget, confidence = 0.95, method = `"native_fields"`
   - No match: fall back to OCR for that field, method = `"native_fields_with_ocr_fallback"`
4. Validate extracted values against `field_type` and `validation_pattern`
5. Return `list[ExtractedField]`

**Flattened form detection**: If `backend.has_form_fields(file_path)` returns False (zero widgets), auto-fallback to OCR for entire document, emit `W_FORM_FIELDS_FLATTENED` warning.

**Coordinate conversion**: PDF widgets use points from bottom-left origin. The `PDFWidgetBackend` is responsible for returning `WidgetField` with normalized 0.0-1.0 coordinates (top-left origin) in `BoundingBox` format. The `NativePDFExtractor` consumes already-normalized coordinates.

### 1.2 Current State of Files

| File | Status | Notes |
|------|--------|-------|
| `extractors/native_pdf.py` | **Stub** (7 lines, docstring only) | Needs full implementation |
| `protocols.py` | **Complete** | `PDFWidgetBackend`, `WidgetField` fully defined |
| `models.py` | **Complete** | `BoundingBox`, `ExtractedField`, `FieldMapping`, `FormTemplate`, `FieldType` all defined |
| `config.py` | **Complete** | `native_pdf_iou_threshold` (default 0.5), `form_extraction_min_field_confidence` (0.5) |
| `errors.py` | **Complete** | `W_FORM_FIELDS_FLATTENED`, `W_FORM_FIELD_VALIDATION_FAILED`, `W_FORM_FIELD_LOW_CONFIDENCE`, `E_FORM_NATIVE_FIELDS_UNAVAILABLE` all defined |
| `extractors/__init__.py` | **Stub** | Needs to export `NativePDFExtractor` |
| `tests/test_extractors.py` | **Stub** (1 line) | Needs full test suite |
| `tests/conftest.py` | **Placeholder** | `mock_pdf_widget_backend` fixture returns `None` — needs real mock |

### 1.3 Key Types and Interfaces

**`PDFWidgetBackend` protocol** (`protocols.py` lines 171-201):
```python
class PDFWidgetBackend(Protocol):
    def extract_widgets(self, file_path: str, page: int) -> list[WidgetField]: ...
    def has_form_fields(self, file_path: str) -> bool: ...
    def engine_name(self) -> str: ...
```

**`WidgetField`** (`protocols.py` lines 60-67):
```python
class WidgetField(BaseModel):
    field_name: str
    field_value: str | None
    field_type: str  # "text", "checkbox", "radio", "dropdown", "listbox"
    bbox: BoundingBox  # Normalized 0.0-1.0 coordinates
    page: int
```

**`BoundingBox`** (`models.py` lines 65-76):
```python
class BoundingBox(BaseModel):
    x: float = Field(ge=0.0, le=1.0)   # Left edge
    y: float = Field(ge=0.0, le=1.0)   # Top edge
    width: float = Field(gt=0.0, le=1.0)
    height: float = Field(gt=0.0, le=1.0)
```

**`ExtractedField`** (`models.py` lines 271-304):
```python
class ExtractedField(BaseModel):
    field_id: str
    field_name: str
    field_label: str
    field_type: FieldType
    value: str | bool | float | None
    raw_value: str | None = None
    confidence: float  # ge=0.0, le=1.0
    extraction_method: str  # "native_fields", "native_fields_with_ocr_fallback", etc.
    bounding_box: BoundingBox | None = None
    validation_passed: bool | None = None
    warnings: list[str] = []
```

**`FieldMapping`** (`models.py` lines 93-158):
- `field_id`, `field_name`, `field_label`, `field_type: FieldType`, `page_number: int` (0-indexed)
- `region: BoundingBox | None` (set for PDF/image templates)
- `validation_pattern: str | None` (regex)
- `options: list[str] | None` (for checkbox/radio/dropdown)
- `required: bool`

**`FormProcessorConfig`** relevant fields:
- `native_pdf_iou_threshold: float = 0.5` (configurable IoU threshold)
- `form_extraction_min_field_confidence: float = 0.5`

### 1.4 Existing Patterns

All three extractors (native_pdf, ocr_overlay, excel_cell) are stubs. There is no established extractor pattern yet. The implementation should follow the spec's function signature and algorithm directly.

---

## 2. Implementation Plan

### 2.1 Files to Create/Modify

#### A. `packages/ingestkit-forms/src/ingestkit_forms/extractors/native_pdf.py` (PRIMARY — full implementation)

**Class: `NativePDFExtractor`**

Constructor parameters:
- `pdf_backend: PDFWidgetBackend` — injected, never imported directly
- `ocr_backend: OCRBackend | None = None` — for per-field OCR fallback
- `config: FormProcessorConfig` — for `native_pdf_iou_threshold` and other settings

**Public method: `extract(file_path: str, template: FormTemplate) -> list[ExtractedField]`**

Algorithm:
1. Call `pdf_backend.has_form_fields(file_path)` to detect flattened forms
2. If no form fields: return early with `W_FORM_FIELDS_FLATTENED` warning and empty list (caller handles OCR fallback for entire document)
3. Group template fields by `page_number`
4. For each page with template fields:
   - Call `pdf_backend.extract_widgets(file_path, page)` to get `list[WidgetField]`
   - For each `FieldMapping` on this page:
     - Compute IoU between `field.region` and each widget's `bbox`
     - Select best-match widget with IoU >= `config.native_pdf_iou_threshold`
     - If matched: build `ExtractedField` with widget value, confidence=0.95, method=`"native_fields"`
     - If not matched: if `ocr_backend` available, fall back to OCR for this field; else set value=None with low confidence
5. Validate each extracted value against `field_type` and `validation_pattern`
6. Return `list[ExtractedField]`

**Private helper: `_compute_iou(box_a: BoundingBox, box_b: BoundingBox) -> float`**

Standard IoU on two axis-aligned rectangles:
- Convert (x, y, width, height) to (x1, y1, x2, y2)
- Intersection area = max(0, min(x2a,x2b)-max(x1a,x1b)) * max(0, min(y2a,y2b)-max(y1a,y1b))
- Union area = area_a + area_b - intersection
- IoU = intersection / union (0.0 if union == 0)

**Private helper: `_validate_field_value(value: str | bool | None, field: FieldMapping) -> tuple[str | bool | float | None, bool | None, list[str]]`**

- Check `field_type` compatibility (e.g., checkbox should be bool-ish, number should be numeric)
- If `validation_pattern` defined: match `re.fullmatch(pattern, str(value))`
- Return (coerced_value, validation_passed, warnings)

**Private helper: `_coerce_widget_value(raw_value: str | None, field_type: FieldType, widget_type: str) -> str | bool | float | None`**

- TEXT/DATE: return string as-is
- NUMBER: attempt `float()` conversion
- CHECKBOX/RADIO: map widget values ("Yes"/"On"/"true"/"1" -> True, others -> False)
- DROPDOWN: return string value
- SIGNATURE: check if non-empty -> True/False

#### B. `packages/ingestkit-forms/src/ingestkit_forms/extractors/__init__.py` (update)

Add export:
```python
from ingestkit_forms.extractors.native_pdf import NativePDFExtractor
```

#### C. `packages/ingestkit-forms/tests/conftest.py` (update mock fixtures)

Implement `MockPDFWidgetBackend` class:
- `extract_widgets()`: returns pre-configured `list[WidgetField]`
- `has_form_fields()`: configurable return value (True/False)
- `engine_name()`: returns `"mock"`

Add fixture helpers:
- `make_template()` — factory for `FormTemplate` with configurable fields
- `make_widget()` — factory for `WidgetField`

#### D. `packages/ingestkit-forms/tests/test_extractors.py` (full test suite)

**Test cases for `NativePDFExtractor`:**

| # | Test | Validates |
|---|------|-----------|
| 1 | `test_extract_text_field_exact_match` | Widget bbox exactly matches template field; value extracted, confidence=0.95 |
| 2 | `test_extract_text_field_iou_above_threshold` | Widget overlaps >= 50% IoU; matched correctly |
| 3 | `test_extract_text_field_iou_below_threshold` | Widget overlaps < 50% IoU; no match, OCR fallback attempted |
| 4 | `test_extract_checkbox_checked` | Checkbox widget value "Yes" -> `True` |
| 5 | `test_extract_checkbox_unchecked` | Checkbox widget value "Off" -> `False` |
| 6 | `test_extract_radio_button` | Radio widget value extraction |
| 7 | `test_extract_dropdown` | Dropdown widget value extraction |
| 8 | `test_extract_number_field_coercion` | String "42.5" coerced to float |
| 9 | `test_flattened_form_detection` | `has_form_fields` returns False -> empty list + `W_FORM_FIELDS_FLATTENED` warning |
| 10 | `test_validation_pattern_pass` | Value matches regex -> `validation_passed=True` |
| 11 | `test_validation_pattern_fail` | Value fails regex -> value=None, confidence=0.0, `W_FORM_FIELD_VALIDATION_FAILED` |
| 12 | `test_multiple_fields_multiple_pages` | Template with fields on pages 0 and 1; both pages extracted |
| 13 | `test_no_ocr_backend_unmatched_field` | No OCR backend injected; unmatched field -> value=None |
| 14 | `test_configurable_iou_threshold` | Custom threshold (e.g., 0.8) changes matching behavior |
| 15 | `test_iou_computation` | Direct unit test of `_compute_iou` with known boxes |
| 16 | `test_extraction_method_label` | Matched field -> `"native_fields"`, unmatched -> `"native_fields_with_ocr_fallback"` |

### 2.2 Dependency Graph

```
native_pdf.py
  ├── protocols.py (PDFWidgetBackend, OCRBackend, WidgetField)
  ├── models.py (BoundingBox, ExtractedField, FieldMapping, FormTemplate, FieldType)
  ├── config.py (FormProcessorConfig.native_pdf_iou_threshold)
  ├── errors.py (FormErrorCode.W_FORM_FIELDS_FLATTENED, W_FORM_FIELD_VALIDATION_FAILED)
  └── re (stdlib, for validation_pattern matching)
```

No new external dependencies required. The implementation uses only existing project types and the Python standard library.

### 2.3 Risks and Edge Cases

| Risk | Mitigation |
|------|------------|
| Widget `field_type` string doesn't match `FieldType` enum values | Map widget types to FieldType in `_coerce_widget_value`; widget uses "checkbox" string, FieldType has `CHECKBOX` enum with value `"checkbox"` — they align |
| Multiple widgets match the same template field above IoU threshold | Select the widget with the highest IoU score |
| Template field has no `region` (Excel-only field on a PDF template) | Skip with warning — `region` is None only for Excel fields |
| Empty widget value (field exists but not filled) | Return `value=None`, `confidence=0.95` (the field was found, just empty) |
| `validation_pattern` regex is invalid | Wrap in try/except, emit warning, treat as no pattern |

### 2.4 Coordinate System Note

The `PDFWidgetBackend` protocol contract states it returns `WidgetField` with `bbox: BoundingBox` already in **normalized 0.0-1.0 top-left coordinates**. The coordinate conversion from PDF points (bottom-left origin) to normalized top-left is the **backend's responsibility**, not the extractor's. The `NativePDFExtractor` operates entirely in normalized coordinate space.

However, if the implementor needs to verify coordinate conversion logic, the formula is:
```
norm_x = pdf_x / page_width
norm_y = 1.0 - (pdf_y / page_height)  # Flip Y axis
norm_width = pdf_width / page_width
norm_height = pdf_height / page_height
# Adjust y to be top-left of the box:
norm_y = norm_y - norm_height
```

This conversion belongs in the concrete `PDFWidgetBackend` implementation, NOT in `NativePDFExtractor`.

### 2.5 Implementation Order

1. Implement `_compute_iou()` — pure geometry, easily testable
2. Implement `_coerce_widget_value()` — type conversion logic
3. Implement `_validate_field_value()` — regex + type validation
4. Implement `extract()` main method — orchestrates the above
5. Update `__init__.py` exports
6. Implement `MockPDFWidgetBackend` in conftest
7. Write full test suite

---

## 3. Key File Paths

| Purpose | Absolute Path |
|---------|---------------|
| Spec §7.1 | `/home/jjob/projects/ingestkit/docs/specs/form-ingestor-plugin.md` (lines 693-742) |
| Extractor stub | `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/extractors/native_pdf.py` |
| Protocols | `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/protocols.py` |
| Models | `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/models.py` |
| Config | `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/config.py` |
| Errors | `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/errors.py` |
| Extractors __init__ | `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/extractors/__init__.py` |
| Test file | `/home/jjob/projects/ingestkit/packages/ingestkit-forms/tests/test_extractors.py` |
| Test fixtures | `/home/jjob/projects/ingestkit/packages/ingestkit-forms/tests/conftest.py` |

---

AGENT_RETURN: .agents/outputs/map-63-021526.md
