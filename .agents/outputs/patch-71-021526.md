---
issue: 71
agent: PATCH
date: 2026-02-15
status: Complete
files_modified: 2
files_created: 1
tests_added: 23
lines_added: 275
lines_removed: 5
---

# PATCH -- Issue #71: Implement Idempotency Keying for Form Extraction

## Executive Summary

Implemented the three-tier idempotency key system for `ingestkit-forms` as specified in spec section 4.3. Replaced the empty stub in `idempotency.py` with three functions: `compute_ingest_key` (delegates to core), `compute_form_extraction_key` (sha256 hex), and `compute_vector_point_id` (uuid5). Added public exports to `__init__.py`. Created 23 tests covering determinism, sensitivity, format, and end-to-end pipeline.

## Metrics

| Metric | Value |
|--------|-------|
| Files modified | 2 (`idempotency.py`, `__init__.py`) |
| Files created | 1 (`test_idempotency.py`) |
| Tests added | 23 |
| Tests passing | 440 (full suite) |
| Regressions | 0 |

## Files Changed

### `packages/ingestkit-forms/src/ingestkit_forms/idempotency.py`

Replaced 5-line stub with full implementation:
- Re-exports `compute_ingest_key` and `IngestKey` from `ingestkit_core`
- `compute_form_extraction_key(ingest_key_global, template_id, template_version)` -- `sha256(f"{global}|{id}|{version}")`, returns 64-char hex
- `compute_vector_point_id(form_extraction_key, chunk_index)` -- `uuid5(NAMESPACE_URL, f"{key}:{index}")`, returns UUID string
- `__all__` exports all four public names

### `packages/ingestkit-forms/src/ingestkit_forms/__init__.py`

- Added import block for `compute_ingest_key`, `compute_form_extraction_key`, `compute_vector_point_id`
- Added three entries to `__all__` under "Idempotency keying (from issue #71)" comment

### `packages/ingestkit-forms/tests/test_idempotency.py` (NEW)

23 tests across 4 classes:
- `TestComputeIngestKey` (8 tests) -- determinism, content sensitivity, parser version, tenant_id, source_uri, return type, hex format, FileNotFoundError
- `TestComputeFormExtractionKey` (7 tests) -- determinism, input sensitivity (3 params), hex format, formula verification, version bump
- `TestComputeVectorPointId` (6 tests) -- determinism, input sensitivity (2 params), UUID validity, uniqueness over 100 chunks, formula verification
- `TestEndToEndIdempotency` (2 tests) -- full pipeline determinism, template version change propagation

## Deviations from PLAN

None.

## Verification Performed

1. `ruff check idempotency.py` -- All checks passed
2. `pytest test_idempotency.py -v` -- 23/23 passed
3. `pytest tests/ -q` -- 440/440 passed, 0 regressions
4. `python3 -c "from ingestkit_forms import ..."` -- imports OK

## Acceptance Criteria Status

All criteria met. See MAP-PLAN for full list.
