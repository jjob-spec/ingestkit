---
issue: 4
agent: PATCH
date: 2026-02-10
status: Complete
files_modified: 1
files_created: 2
tests_added: 17
---

# PATCH - Issue #4

## Summary

Implemented the `compute_ingest_key()` function in a new `idempotency.py` module. The function reads raw file bytes, computes a SHA-256 content hash, derives a canonical absolute POSIX path (or accepts a source_uri override), and returns a fully populated `IngestKey` model instance. The function was exported from the package `__init__.py` and 17 tests were added covering all acceptance criteria.

## Pre-Flight

- [x] Read MAP-PLAN (`map-plan-4-021026.md`)
- [x] Read existing IngestKey model (`models.py` lines 85-104)
- [x] Branch: `feature/issue-4-idempotency`

## Files Changed

### Created

1. **`packages/ingestkit-excel/src/ingestkit_excel/idempotency.py`** -- New module containing `compute_ingest_key()` function. Uses `hashlib.sha256` for content hashing, `pathlib.Path.resolve().as_posix()` for canonical source URI derivation, and returns an `IngestKey` instance.

2. **`packages/ingestkit-excel/tests/test_idempotency.py`** -- 17 tests across 8 test classes covering all acceptance criteria: identical files produce identical keys, modified files produce different keys, parser version changes key, tenant_id affects key, source_uri override works, key is 64-char hex string, FileNotFoundError for missing files, and return type validation.

### Modified

3. **`packages/ingestkit-excel/src/ingestkit_excel/__init__.py`** -- Added `compute_ingest_key` import from `idempotency` module and added it to `__all__`.

## Verification

- `pytest -q`: **148/148 passing** (131 existing + 17 new)
- All 17 idempotency tests pass
- No regressions in existing test suite

## Issues Encountered

None

## Deviations from PLAN

None. Implementation matches the MAP-PLAN exactly, using `.as_posix()` for source URI derivation as recommended.

---

AGENT_RETURN: patch-4-021026.md
