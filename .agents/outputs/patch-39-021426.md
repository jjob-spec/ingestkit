---
issue: 39
agent: PATCH
date: 2026-02-14
status: Complete
files_created: 2
files_modified: 3
tests_added: 49
lines_added: ~1100
lines_removed: ~5
---

# PATCH Artifact: Issue #39 -- Path B OCR Processor

## Executive Summary

Implemented `OCRProcessor` in `processors/ocr_processor.py` (SPEC 11.2) -- the scanned-PDF processing path. The processor orchestrates page rendering, preprocessing, language detection, parallel OCR via ProcessPoolExecutor, postprocessing, optional LLM cleanup, low-confidence flagging, and downstream chunking/embedding/upsert. A module-level `_ocr_single_page()` worker function handles pickling constraints. Sequential fallback when `ocr_max_workers <= 1`. Full test suite with 49 unit tests, all passing. No regressions in existing 604 tests.

## Metrics

| Metric | Value |
|--------|-------|
| Files created | 2 |
| Files modified | 3 |
| Tests added | 49 |
| Tests passing | 653 (all) |
| Regressions | 0 |

## Files Changed

### Created: `packages/ingestkit-pdf/src/ingestkit_pdf/processors/ocr_processor.py`
- Module-level `_ocr_single_page()` worker: opens PDF, renders page, preprocesses, optionally detects language, runs OCR, postprocesses. Returns `OCRResult` or `(page_number, error_string)` tuple.
- `OCRProcessor` class with `process()` method (expanded 8-param signature per PLAN decision)
- `_select_pages()`: filters BLANK/TOC/VECTOR_ONLY with warnings; includes SCANNED/MIXED/TEXT
- `_ocr_pages()`: delegates to parallel or sequential based on `ocr_max_workers`
- `_ocr_pages_parallel()`: ProcessPoolExecutor with **per-future timeout** via `future.result(timeout=...)` (PLAN-CHECK Correction 1 applied)
- `_ocr_pages_sequential()`: direct calls in loop with per-page error isolation
- `_llm_cleanup()`: optional LLM text cleanup via `generate()`, graceful degradation
- `_flag_low_confidence()`: pages below threshold flagged with W_PAGE_LOW_OCR_CONFIDENCE
- `_chunk_and_embed()`: header/footer stripping, heading detection, chunking, batch embedding, vector upsert
- `_classify_backend_error()`: maps exceptions to ErrorCode

### Created: `packages/ingestkit-pdf/tests/test_ocr_processor.py`
- 16 test classes, 49 test cases, all `@pytest.mark.unit`
- TestOCRSinglePageWorker (4), TestOCRProcessorInit (2), TestPageFiltering (6)
- TestSinglePageOCR (3), TestMultiPageOCR (2), TestSequentialVsParallel (3)
- TestPerPageErrorIsolation (4), TestLowConfidenceWarning (3), TestLLMCleanup (5)
- TestOCRStageResult (3), TestHeaderFooterStripping (2), TestHeadingDetection (2)
- TestBatchEmbedding (2), TestProcessingResult (3), TestEngineUnavailable (1)
- TestEmptyOCROutput (2), TestLanguageDetection (2)

### Modified: `packages/ingestkit-pdf/tests/conftest.py`
- Added `MockVectorStoreBackend` class (tracks upserts, collections, deletions)
- Added `MockEmbeddingBackend` class (returns deterministic vectors, tracks calls)
- Updated `MockLLMBackend.generate()`: functional implementation (was `NotImplementedError`)
- Updated `_responses` type hint to `list[dict | str | Exception]` (PLAN-CHECK Correction 3)
- Added fixtures: `mock_vector_store`, `mock_embedder`, `mock_llm`

### Modified: `packages/ingestkit-pdf/src/ingestkit_pdf/processors/__init__.py`
- Added `OCRProcessor` to exports

### Modified: `packages/ingestkit-pdf/src/ingestkit_pdf/__init__.py`
- Added `OCRProcessor` to public API exports

## PLAN-CHECK Corrections Applied

1. **MUST FIX (Correction 1)**: Used `future.result(timeout=config.ocr_per_page_timeout_seconds)` per future, NOT `as_completed(timeout=T)` for the whole iteration. The `as_completed()` call has no timeout; per-page timeout is enforced on each `future.result()`.

2. **SHOULD FIX (Correction 2)**: The expanded `process()` signature (8 params including `parse_result`, `classification_result`, `classification`) is documented in the module docstring, explaining the SPEC deviation.

3. **MINOR (Correction 3)**: `MockLLMBackend._responses` type updated to `list[dict | str | Exception]` to support both `classify()` (dict) and `generate()` (str) responses.

## Issues Encountered

1. **Import patching challenge**: The initial design used deferred imports inside the worker function body (`from ingestkit_pdf.utils.page_renderer import PageRenderer` etc). This made unit test patching fail because `unittest.mock.patch` couldn't find these attributes at module level. Resolution: moved all utility imports to module-level. The worker function in a subprocess still gets them via the module's top-level namespace.

2. **conftest import path**: Tests needed `from tests.conftest import ...` (not `from conftest import ...`) matching the existing test_text_extractor.py pattern.

3. **Linter auto-added MockStructuredDBBackend**: The linter/formatter added a `MockStructuredDBBackend` class to conftest.py alongside the mock backends I added. This is compatible and was accepted.

## Verification Performed

```
pytest packages/ingestkit-pdf/tests/test_ocr_processor.py -v  # 49 passed
pytest packages/ingestkit-pdf/tests/ -v                       # 653 passed
python -c "from ingestkit_pdf import OCRProcessor"            # OK
python -c "from ingestkit_pdf.processors import OCRProcessor" # OK
```

## Acceptance Criteria Status

All criteria from plan-39-021426.md met. See PLAN for full list.

AGENT_RETURN: .agents/outputs/patch-39-021426.md
