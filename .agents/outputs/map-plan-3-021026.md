---
issue: 3
agent: MAP-PLAN
date: 2026-02-10
complexity: SIMPLE
stack: backend
files_identified: 10
---

# MAP-PLAN - Issue #3

## Summary

This issue scaffolds the `ingestkit-excel` Python package from scratch, establishing the foundational layer that all subsequent issues will build upon. The work covers: creating `pyproject.toml` with dependency declarations, building the package directory structure under `src/ingestkit_excel/`, implementing 5 enums with explicit string values, implementing the `IngestKey` model with its `key` property, implementing 3 stage artifact models, implementing 8 core Pydantic models, implementing an `ErrorCode` enum with 22 codes plus the `IngestError` model, implementing `ExcelProcessorConfig` with all fields/defaults and a `from_file()` classmethod for YAML/JSON, and implementing 4 `@runtime_checkable` Protocols. This is a greenfield task with no existing code to modify.

## VERIFICATION STEPS (MANDATORY)

1. **Specification**: Read SPEC.md v2.0 in full. Key sections: section 2.3 (module structure), section 3 (data models -- enums, IngestKey, stage artifacts, core models), section 4 (error taxonomy -- ErrorCode enum with 22 codes, IngestError model, fail-closed behavior), section 5 (ExcelProcessorConfig with all fields and defaults, from_file classmethod), section 11 (backend Protocols -- VectorStoreBackend, StructuredDBBackend, LLMBackend, EmbeddingBackend with method signatures), section 18 (dependencies for pyproject.toml).
2. **Code Verification**: Greenfield -- no existing code. The `packages/ingestkit-excel/` directory contains only `SPEC.md` and `ROADMAP.md`. No `src/` directory, no `pyproject.toml`, no Python files exist yet.
3. **Approach Decision**: Create files bottom-up -- `pyproject.toml` first, then package structure (`__init__.py` files), then leaf modules (`models.py`, `errors.py`, `config.py`, `protocols.py`), then tests. This avoids import ordering issues since models are referenced by config and protocols.
4. **Impact Analysis**: N/A -- greenfield project, no existing code to break.
5. **Completeness**: All components from the issue requirements are accounted for: 5 enums (FileType, ClassificationTier, IngestionMethod, RegionType, ParserUsed), IngestKey model, 3 stage artifacts (ParseStageResult, ClassificationStageResult, EmbedStageResult), 8 core models (SheetProfile, FileProfile, ClassificationResult, ChunkMetadata, ChunkPayload, SheetRegion, WrittenArtifacts, ProcessingResult), ErrorCode enum (22 codes), IngestError model, ExcelProcessorConfig (27 fields), from_file() classmethod, 4 Protocols (VectorStoreBackend, StructuredDBBackend, LLMBackend, EmbeddingBackend).

## INVESTIGATION

### Affected Files

All files are to be **created** (none exist yet):

| # | File Path (relative to `packages/ingestkit-excel/`) | Purpose |
|---|------------------------------------------------------|---------|
| 1 | `pyproject.toml` | Package metadata, dependencies, build config |
| 2 | `src/ingestkit_excel/__init__.py` | Package root, public API exports |
| 3 | `src/ingestkit_excel/models.py` | Enums, IngestKey, stage artifacts, core models |
| 4 | `src/ingestkit_excel/errors.py` | ErrorCode enum (22 codes), IngestError model |
| 5 | `src/ingestkit_excel/config.py` | ExcelProcessorConfig with defaults, from_file() |
| 6 | `src/ingestkit_excel/protocols.py` | 4 runtime_checkable Protocols |
| 7 | `tests/__init__.py` | Test package marker |
| 8 | `tests/conftest.py` | Shared fixtures (minimal for this issue) |
| 9 | `tests/test_models.py` | Tests for all models, enums, IngestKey |
| 10 | `tests/test_config.py` | Tests for ExcelProcessorConfig, from_file() |

Note: Tests are placed at `packages/ingestkit-excel/tests/` (not under `src/`) for standard pytest discovery with `pyproject.toml` configuration. The spec shows tests under `src/ingestkit_excel/tests/` but placing them outside `src/` is more conventional for editable installs and avoids shipping tests in the package.

### Enum Values

**CRITICAL -- ENUM_VALUE pattern applies. All values are explicit strings.**

#### FileType (str, Enum) -- `models.py`
| Name | Value |
|------|-------|
| `TABULAR_DATA` | `"tabular_data"` |
| `FORMATTED_DOCUMENT` | `"formatted_document"` |
| `HYBRID` | `"hybrid"` |

#### ClassificationTier (str, Enum) -- `models.py`
| Name | Value |
|------|-------|
| `RULE_BASED` | `"rule_based"` |
| `LLM_BASIC` | `"llm_basic"` |
| `LLM_REASONING` | `"llm_reasoning"` |

#### IngestionMethod (str, Enum) -- `models.py`
| Name | Value |
|------|-------|
| `SQL_AGENT` | `"sql_agent"` |
| `TEXT_SERIALIZATION` | `"text_serialization"` |
| `HYBRID_SPLIT` | `"hybrid_split"` |

#### RegionType (str, Enum) -- `models.py`
| Name | Value |
|------|-------|
| `DATA_TABLE` | `"data_table"` |
| `TEXT_BLOCK` | `"text_block"` |
| `HEADER_BLOCK` | `"header_block"` |
| `FOOTER_BLOCK` | `"footer_block"` |
| `MATRIX_BLOCK` | `"matrix_block"` |
| `CHART_ONLY` | `"chart_only"` |
| `EMPTY` | `"empty"` |

#### ParserUsed (str, Enum) -- `models.py`
| Name | Value |
|------|-------|
| `OPENPYXL` | `"openpyxl"` |
| `PANDAS_FALLBACK` | `"pandas_fallback"` |
| `RAW_TEXT_FALLBACK` | `"raw_text_fallback"` |

#### ErrorCode (str, Enum) -- `errors.py` (22 codes total)
| Name | Value |
|------|-------|
| `E_PARSE_CORRUPT` | `"E_PARSE_CORRUPT"` |
| `E_PARSE_OPENPYXL_FAIL` | `"E_PARSE_OPENPYXL_FAIL"` |
| `E_PARSE_PANDAS_FAIL` | `"E_PARSE_PANDAS_FAIL"` |
| `E_PARSE_PASSWORD` | `"E_PARSE_PASSWORD"` |
| `E_PARSE_EMPTY` | `"E_PARSE_EMPTY"` |
| `E_PARSE_TOO_LARGE` | `"E_PARSE_TOO_LARGE"` |
| `E_CLASSIFY_INCONCLUSIVE` | `"E_CLASSIFY_INCONCLUSIVE"` |
| `E_LLM_TIMEOUT` | `"E_LLM_TIMEOUT"` |
| `E_LLM_MALFORMED_JSON` | `"E_LLM_MALFORMED_JSON"` |
| `E_LLM_SCHEMA_INVALID` | `"E_LLM_SCHEMA_INVALID"` |
| `E_LLM_CONFIDENCE_OOB` | `"E_LLM_CONFIDENCE_OOB"` |
| `E_BACKEND_VECTOR_TIMEOUT` | `"E_BACKEND_VECTOR_TIMEOUT"` |
| `E_BACKEND_VECTOR_CONNECT` | `"E_BACKEND_VECTOR_CONNECT"` |
| `E_BACKEND_DB_TIMEOUT` | `"E_BACKEND_DB_TIMEOUT"` |
| `E_BACKEND_DB_CONNECT` | `"E_BACKEND_DB_CONNECT"` |
| `E_BACKEND_EMBED_TIMEOUT` | `"E_BACKEND_EMBED_TIMEOUT"` |
| `E_BACKEND_EMBED_CONNECT` | `"E_BACKEND_EMBED_CONNECT"` |
| `E_PROCESS_REGION_DETECT` | `"E_PROCESS_REGION_DETECT"` |
| `E_PROCESS_SERIALIZE` | `"E_PROCESS_SERIALIZE"` |
| `E_PROCESS_SCHEMA_GEN` | `"E_PROCESS_SCHEMA_GEN"` |
| `W_SHEET_SKIPPED_CHART` | `"W_SHEET_SKIPPED_CHART"` |
| `W_SHEET_SKIPPED_HIDDEN` | `"W_SHEET_SKIPPED_HIDDEN"` |
| `W_SHEET_SKIPPED_PASSWORD` | `"W_SHEET_SKIPPED_PASSWORD"` |
| `W_PARSER_FALLBACK` | `"W_PARSER_FALLBACK"` |
| `W_LLM_RETRY` | `"W_LLM_RETRY"` |
| `W_ROWS_TRUNCATED` | `"W_ROWS_TRUNCATED"` |

(Note: 22 error + 4 warning = 26 total codes in the enum, but the issue says "20+ codes" which is satisfied.)

### Risks

1. **ENUM_VALUE pattern (HIGH)**: 6 enums with explicit string values. The NAME and VALUE differ in casing and format (e.g., `TABULAR_DATA` vs `"tabular_data"`, `E_PARSE_CORRUPT` vs `"E_PARSE_CORRUPT"`). All enum classes must use `(str, Enum)` to ensure `.value` is the string. Tests must assert on `.value` strings, not names.

2. **Forward reference in ProcessingResult**: `ProcessingResult` references `IngestError` via `list["IngestError"]`. Since `IngestError` is in `errors.py` and `ProcessingResult` is in `models.py`, there is a cross-module import. Solution: import `IngestError` from `errors.py` into `models.py`. Alternatively, if there is a circular dependency, use `from __future__ import annotations` or a TYPE_CHECKING import. In this case, `models.py` imports from `errors.py` but `errors.py` does NOT import from `models.py`, so there is no circular dependency -- a direct import is safe.

3. **Config from_file() needs PyYAML**: The `from_file()` classmethod needs `pyyaml` to load YAML files. PyYAML is listed under `[project.optional-dependencies] dev` in the spec. For the `from_file()` method, do a conditional import with a clear error message if `pyyaml` is not installed. Alternatively, since tests will need it, ensure `pyyaml` is available in dev dependencies.

4. **Test location**: The spec shows tests at `src/ingestkit_excel/tests/` but standard Python packaging practice places tests outside `src/`. Using `packages/ingestkit-excel/tests/` with proper `pyproject.toml` configuration (`[tool.pytest.ini_options] testpaths = ["tests"]`) is preferred. This needs to be a conscious decision.

5. **Type annotations**: The spec uses `dict[str, str]`, `list[str]`, etc. (lowercase generics). This requires Python 3.10+ or `from __future__ import annotations`. Specify `requires-python = ">=3.10"` in `pyproject.toml`.

## PLAN

### File-by-File Steps

#### 1. `packages/ingestkit-excel/pyproject.toml`

Create the project metadata file:
- `[build-system]`: Use `setuptools>=68` and `setuptools-scm` (or just `setuptools`).
- `[project]`: name = `"ingestkit-excel"`, version = `"0.1.0"`, requires-python = `">=3.10"`.
- `[project.dependencies]`: `openpyxl>=3.1`, `pandas>=2.0`, `pydantic>=2.0`.
- `[project.optional-dependencies]`: Copy exactly from spec section 18:
  - `qdrant = ["qdrant-client>=1.7"]`
  - `ollama = ["httpx>=0.27"]`
  - `postgres = ["psycopg2-binary>=2.9"]`
  - `dev = ["pytest>=7.0", "pytest-cov", "pyyaml>=6.0"]`
- `[tool.pytest.ini_options]`: `testpaths = ["tests"]`, markers for `unit` and `integration`.
- Package discovery: `[tool.setuptools.packages.find]` with `where = ["src"]`.

#### 2. `packages/ingestkit-excel/src/ingestkit_excel/__init__.py`

Create minimal `__init__.py` that exports the public API. For this issue, only the models, errors, config, and protocols are implemented, so export those. Leave `ExcelRouter` and `create_default_router` as commented placeholders or omit them (they are for later issues).

Exports:
- From `models`: `FileType`, `ClassificationTier`, `IngestionMethod`, `RegionType`, `ParserUsed`, `IngestKey`, `ParseStageResult`, `ClassificationStageResult`, `EmbedStageResult`, `SheetProfile`, `FileProfile`, `ClassificationResult`, `ChunkMetadata`, `ChunkPayload`, `SheetRegion`, `WrittenArtifacts`, `ProcessingResult`
- From `errors`: `ErrorCode`, `IngestError`
- From `config`: `ExcelProcessorConfig`
- From `protocols`: `VectorStoreBackend`, `StructuredDBBackend`, `LLMBackend`, `EmbeddingBackend`

#### 3. `packages/ingestkit-excel/src/ingestkit_excel/models.py`

Implement all data models from spec section 3:

- **Imports**: `from __future__ import annotations`, `hashlib`, `enum.Enum`, `typing.Any`, `pydantic.BaseModel`
- **5 Enums**: `FileType`, `ClassificationTier`, `IngestionMethod`, `RegionType`, `ParserUsed` -- all as `(str, Enum)` with exact string values from spec.
- **IngestKey**: Pydantic BaseModel with `content_hash`, `source_uri`, `parser_version`, `tenant_id` fields. `@property def key` that SHA-256 hashes the pipe-joined parts.
- **Stage Artifacts**: `ParseStageResult`, `ClassificationStageResult`, `EmbedStageResult` -- exact fields from spec section 3.3.
- **Core Models**: `SheetProfile`, `FileProfile`, `ClassificationResult`, `ChunkMetadata`, `ChunkPayload`, `SheetRegion`, `WrittenArtifacts`, `ProcessingResult` -- exact fields from spec section 3.4. Note `ProcessingResult.error_details: list[IngestError]` requires importing `IngestError` from `errors.py`.

#### 4. `packages/ingestkit-excel/src/ingestkit_excel/errors.py`

Implement error taxonomy from spec section 4:

- **ErrorCode enum**: `(str, Enum)` with all 26 codes (22 error + 4 warning codes as listed above). Values are identical to names (e.g., `E_PARSE_CORRUPT = "E_PARSE_CORRUPT"`).
- **IngestError model**: Pydantic BaseModel with fields `code: ErrorCode`, `message: str`, `sheet_name: str | None = None`, `stage: str | None = None`, `recoverable: bool = False`.

#### 5. `packages/ingestkit-excel/src/ingestkit_excel/config.py`

Implement configuration from spec section 5:

- **ExcelProcessorConfig**: Pydantic BaseModel with all 27 fields and their exact default values from spec:
  - `parser_version: str = "ingestkit_excel:1.0.0"`
  - `tenant_id: str | None = None`
  - `tier1_high_confidence_signals: int = 4`
  - `tier1_medium_confidence_signals: int = 3`
  - `merged_cell_ratio_threshold: float = 0.05`
  - `numeric_ratio_threshold: float = 0.3`
  - `column_consistency_threshold: float = 0.7`
  - `min_row_count_for_tabular: int = 5`
  - `classification_model: str = "qwen2.5:7b"`
  - `reasoning_model: str = "deepseek-r1:14b"`
  - `tier2_confidence_threshold: float = 0.6`
  - `llm_temperature: float = 0.1`
  - `row_serialization_limit: int = 5000`
  - `clean_column_names: bool = True`
  - `embedding_model: str = "nomic-embed-text"`
  - `embedding_dimension: int = 768`
  - `embedding_batch_size: int = 64`
  - `default_collection: str = "helpdesk"`
  - `max_sample_rows: int = 3`
  - `enable_tier3: bool = True`
  - `max_rows_in_memory: int = 100_000`
  - `backend_timeout_seconds: float = 30.0`
  - `backend_max_retries: int = 2`
  - `backend_backoff_base: float = 1.0`
  - `log_sample_data: bool = False`
  - `log_llm_prompts: bool = False`
  - `log_chunk_previews: bool = False`
  - `redact_patterns: list[str] = []`

- **`from_file()` classmethod**: Accepts a `path: str`, detects `.yaml`/`.yml` vs `.json` by extension, loads the file, and passes the dict to `cls(**data)`. For YAML, do a try/except import of `yaml` with a helpful error message if `pyyaml` is not installed.

#### 6. `packages/ingestkit-excel/src/ingestkit_excel/protocols.py`

Implement the 4 Protocols from spec section 11:

- **Imports**: `from typing import Protocol, runtime_checkable, TYPE_CHECKING`. Under `TYPE_CHECKING`, import `pandas as pd` and `ChunkPayload` from models.
- **VectorStoreBackend**: Methods `upsert_chunks`, `ensure_collection`, `create_payload_index`, `delete_by_ids`.
- **StructuredDBBackend**: Methods `create_table_from_dataframe`, `drop_table`, `table_exists`, `get_table_schema`, `get_connection_uri`.
- **LLMBackend**: Methods `classify` (with `timeout: float | None = None`), `generate` (with `timeout: float | None = None`).
- **EmbeddingBackend**: Methods `embed` (with `timeout: float | None = None`), `dimension`.
- All 4 must be decorated with `@runtime_checkable`.

#### 7. `packages/ingestkit-excel/tests/__init__.py`

Empty file to mark tests as a package.

#### 8. `packages/ingestkit-excel/tests/conftest.py`

Minimal shared fixtures:
- A `sample_config` fixture returning `ExcelProcessorConfig()` with defaults.
- A `sample_ingest_key` fixture returning an `IngestKey` instance.

#### 9. `packages/ingestkit-excel/tests/test_models.py`

Tests covering:
- **Enum value tests**: For each of the 5 enums, assert that every member's `.value` matches the expected string. This directly prevents the ENUM_VALUE failure pattern.
- **IngestKey**: Test `key` property produces a deterministic hex string. Test that changing any field changes the key. Test that `tenant_id=None` vs set produces different keys.
- **Stage artifacts**: Test instantiation with valid data. Test that required fields are enforced.
- **Core models**: Test instantiation of `SheetProfile`, `FileProfile`, `ClassificationResult`, `ChunkMetadata`, `ChunkPayload`, `SheetRegion`, `WrittenArtifacts`, `ProcessingResult` with valid data. Test that invalid data (e.g., missing required fields) raises `ValidationError`.
- **Protocol runtime checks**: Test that `isinstance(mock_obj, VectorStoreBackend)` etc. works for objects implementing the protocol methods.

#### 10. `packages/ingestkit-excel/tests/test_config.py`

Tests covering:
- **Default values**: `ExcelProcessorConfig()` with no args produces all expected defaults. Assert every field matches spec section 5.
- **Custom values**: Override specific fields, verify they take effect.
- **from_file() with JSON**: Write a temp JSON file, load via `from_file()`, verify fields.
- **from_file() with YAML**: Write a temp YAML file, load via `from_file()`, verify fields.
- **from_file() with invalid path**: Verify appropriate error.
- **ErrorCode completeness**: Assert `len(ErrorCode)` >= 22 (or exact count of 26). Assert specific codes exist by value string.

### Acceptance Criteria

1. `pip install -e packages/ingestkit-excel` succeeds (with `[dev]` extras for test deps).
2. All models instantiate with valid data and reject invalid data (Pydantic validation).
3. `ExcelProcessorConfig()` produces defaults matching spec section 5 exactly.
4. `ExcelProcessorConfig.from_file()` loads both YAML and JSON config files.
5. `ErrorCode` enum has all codes from spec section 4.1 (26 total codes).
6. All four Protocols are `runtime_checkable` (verified via `isinstance` checks).
7. `pytest -q` passes with all tests green.

### Verification Gates

- `pip install -e "packages/ingestkit-excel[dev]"` succeeds
- `cd packages/ingestkit-excel && pytest -q` passes

---
AGENT_RETURN: map-plan-3-021026.md
