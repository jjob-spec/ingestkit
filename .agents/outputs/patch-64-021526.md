---
issue: 64
agent: PATCH
date: 2026-02-15
status: Complete
files_created: 2
files_modified: 4
tests_added: 44
lines_added: ~850
lines_removed: 7
---

# PATCH: Issue #64 -- OCR Overlay Extraction for Scanned/Image Forms

## Executive Summary

Implemented `OCROverlayExtractor` per spec section 7.2 with full preprocessing pipeline (deskew, CLAHE, bilateral noise reduction, adaptive thresholding), page rendering with security validation, and per-field OCR via the `OCRBackend` protocol. All 7 FieldTypes are handled: TEXT/NUMBER/DATE via OCR, CHECKBOX/RADIO via fill ratio, SIGNATURE via ink ratio. 44 new tests added, all 269 tests in the suite pass with zero regressions.

## Metrics

| Metric | Value |
|--------|-------|
| Files created | 2 (`_preprocessing.py`, `_rendering.py`) |
| Files modified | 4 (`ocr_overlay.py`, `__init__.py`, `pyproject.toml`, `test_extractors.py`) |
| Tests added | 44 (OCR overlay) |
| Tests total (suite) | 269 |
| Regressions | 0 |
| Linting errors | 0 (in changed files) |

## Files Changed

### Created: `_preprocessing.py`
- Path: `packages/ingestkit-forms/src/ingestkit_forms/extractors/_preprocessing.py`
- 8 functions: `deskew`, `enhance_contrast` (CLAHE via numpy), `reduce_noise` (bilateral filter via numpy), `adaptive_threshold` (integral image approach), `preprocess_for_ocr` (field-type dispatch), `compute_fill_ratio`, `compute_ink_ratio`
- See plan section 1 for algorithm details

### Created: `_rendering.py`
- Path: `packages/ingestkit-forms/src/ingestkit_forms/extractors/_rendering.py`
- 4 functions: `validate_image_safety`, `load_image_file`, `render_pdf_page`, `get_page_image`
- Security: decompression bomb check (ratio > 100), resolution limit (10000px)
- PyMuPDF import is lazy inside `render_pdf_page()`

### Modified: `ocr_overlay.py` (replaced stub)
- Path: `packages/ingestkit-forms/src/ingestkit_forms/extractors/ocr_overlay.py`
- `OCROverlayExtractor` class with `extract()` method
- Private helpers: `_build_ocr_config`, `_regex_match_with_timeout`, `_crop_field_region`, `_image_to_png_bytes`, `_post_process_value`
- Per-field timeout propagated to `ocr_backend.ocr_region()`
- ReDoS protection via threading-based regex timeout

### Modified: `extractors/__init__.py`
- Added `OCROverlayExtractor` to exports

### Modified: `pyproject.toml`
- Added `numpy>=1.24` to dependencies

### Modified: `test_extractors.py`
- Added 44 OCR overlay tests alongside 16 existing NativePDF tests
- Total: 60 tests in file, all passing

## Issues Encountered

### 1. FormIngestError vs FormIngestException (CRITICAL)

`FormIngestError` is a Pydantic `BaseModel` (data structure), not a Python `Exception`. Cannot be used with `raise`/`except`. The plan specified `FormIngestError` throughout, but the codebase has `FormIngestException(Exception)` as the raisable wrapper.

**Fix**: Changed all `raise FormIngestError(...)` to `raise FormIngestException(...)` and all `except FormIngestError` to `except FormIngestException` in both `_rendering.py` and `ocr_overlay.py`.

### 2. Adaptive threshold integral image indexing (MODERATE)

The initial integral image implementation had an off-by-one error -- `y2 = y1 + block_size` could exceed array bounds when the padded array didn't have an extra row/col of zeros prepended.

**Fix**: Added a zero-prepended row/col to the integral array: `integral = np.zeros((ph+1, pw+1))` with `integral[1:, 1:] = cumsum(...)`.

### 3. Checkbox/signature test images vs adaptive thresholding (MODERATE)

Uniformly black images become uniformly white after adaptive thresholding (no local contrast). Tests for checkbox-checked and signature-signed needed images with local contrast (dark regions against light backgrounds).

**Fix**: Used striped patterns (checkbox) and simulated signature strokes (dark lines on white background) instead of uniformly black images.

## PLAN-CHECK Corrections Applied

1. **test_field_without_region_fails_closed**: Used `FieldMapping` with `cell_address=CellAddress(cell="B2")` instead of attempting `region=None` (which violates the model validator).
2. **Removed unused imports**: `signal` and `time` not imported in `ocr_overlay.py` (plan listed them but implementation uses `threading` for ReDoS timeout).

## Deviations from Plan

1. Used `FormIngestException` (raisable Exception) instead of `FormIngestError` (Pydantic model) -- necessary for correct Python exception handling.
2. Test images for checkbox-checked and signature-signed use more realistic patterns (alternating stripes, scattered strokes) instead of solid fills to survive adaptive thresholding.

## Verification

```
ruff check (changed files): All checks passed
pytest test_extractors.py: 60 passed
pytest full suite: 269 passed, 0 failed
Import check: from ingestkit_forms.extractors import OCROverlayExtractor -> OK
```

## Acceptance Criteria Status

All criteria from plan met. See plan-64-021526.md for full list.

---

AGENT_RETURN: .agents/outputs/patch-64-021526.md
