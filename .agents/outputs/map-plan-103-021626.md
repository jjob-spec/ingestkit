# Implementation Plan: Issue #103 - Add Identifier Safety Validation

## Overview
Add `validate_table_name()` function to the security module to enforce safe SQL identifier constraints, preventing SQL injection and ensuring database compatibility. Apply this validation in `FormDBWriter` when generating table names.

## Current State Analysis

### 1. Security Module (`packages/ingestkit-forms/src/ingestkit_forms/security.py`)
- **Current capabilities:**
  - File-level security scanning (extension, size, magic bytes)
  - Regex timeout protection against ReDoS (`regex_match_with_timeout()`)
  - Regex pattern compilation validation (`validate_regex_pattern()`)
- **Missing:** No identifier validation for database table/column names
- **Pattern:** Functions are module-level utilities, not class methods

### 2. DB Writer (`packages/ingestkit-forms/src/ingestkit_forms/output/db_writer.py`)
- **Table name generation flow:**
  1. `get_table_name()` (line 82-84): Combines prefix + slugified template name
  2. `slugify_template_name()` (line 64-79): Converts name to DB-safe slug
     - Lowercases
     - Replaces non-alphanumeric with underscores
     - Collapses consecutive underscores
     - Strips leading/trailing underscores
- **Current behavior:** Slugification is defensive but has no validation step
- **Risk:** Slugified names could start with numbers, be empty, or exceed length limits

### 3. Error Codes (`packages/ingestkit-forms/src/ingestkit_forms/errors.py`)
- **Available security codes:**
  - `E_FORM_FILE_TOO_LARGE` (line 59)
  - `E_FORM_FILE_CORRUPT` (line 60)
- **Template validation:**
  - `E_FORM_TEMPLATE_INVALID` (line 27) - Used for regex validation failures
- **Recommendation:** Reuse `E_FORM_TEMPLATE_INVALID` for identifier validation failures (consistent with existing pattern where template-related structural issues use this code)

## Implementation Plan

### Phase 1: Add `validate_table_name()` to Security Module

**File:** `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/security.py`

**Location:** After the regex validation functions (after line 228), before the end of the file

**Function signature:**
```python
def validate_table_name(name: str) -> str | None:
    """Validate that a string is a safe SQL identifier.

    Enforces SQL-safe identifier constraints:
    - Must start with letter (a-z, A-Z) or underscore
    - Subsequent chars: letters, digits, underscore only
    - Length: 1-128 characters (PostgreSQL limit is 63, but we use 128 for flexibility)

    Args:
        name: The identifier to validate (table name, column name, etc.)

    Returns:
        None if valid, or an error description string if invalid.
    """
```

**Implementation details:**
- Regex pattern: `^[a-zA-Z_][a-zA-Z0-9_]{0,127}$`
- Pattern breakdown:
  - `^[a-zA-Z_]` - First character: letter or underscore
  - `[a-zA-Z0-9_]{0,127}` - Next 0-127 characters: letters, digits, or underscore
  - Total max length: 128 characters
- Return `None` for valid identifiers
- Return error string for invalid (consistent with `validate_regex_pattern()`)

**Error messages:**
- Empty string: `"Identifier cannot be empty"`
- Invalid start character: `"Identifier must start with a letter or underscore, got: '{name[0]}'"`
- Invalid characters: `"Identifier contains invalid characters (allowed: a-z, A-Z, 0-9, _)"`
- Too long: `"Identifier exceeds maximum length of 128 characters (got {len(name)})"`

### Phase 2: Update `get_table_name()` with Validation

**File:** `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/output/db_writer.py`

**Changes:**

1. **Add import** (line 18, after existing imports):
```python
from ingestkit_forms.security import validate_table_name
```

2. **Update `get_table_name()` function** (line 82-84):
```python
def get_table_name(config: FormProcessorConfig, template: FormTemplate) -> str:
    """Return the DB table name for a given template.

    Raises FormIngestException if the generated table name is not a safe identifier.
    """
    table_name = f"{config.form_db_table_prefix}{slugify_template_name(template.name)}"

    # Validate the generated table name is SQL-safe
    error = validate_table_name(table_name)
    if error is not None:
        raise FormIngestException(
            code=FormErrorCode.E_FORM_TEMPLATE_INVALID,
            message=(
                f"Generated table name '{table_name}' is not a safe SQL identifier: {error}. "
                f"Template: '{template.name}', prefix: '{config.form_db_table_prefix}'"
            ),
            stage="output",
            recoverable=False,
            template_id=template.template_id,
            template_version=template.version,
        )

    return table_name
```

**Rationale:**
- Validation happens at table name generation time (fail-fast)
- Uses `E_FORM_TEMPLATE_INVALID` (template structure issue)
- Provides actionable error message with template context
- Non-recoverable (table name must be fixed before processing can continue)

### Phase 3: Add Unit Tests

**File:** `/home/jjob/projects/ingestkit/packages/ingestkit-forms/tests/test_security.py`

**Location:** Add new test class after `TestAPIRegexValidation` (after line 364)

**Test cases for `validate_table_name()`:**

```python
@pytest.mark.unit
class TestValidateTableName:
    """Tests for SQL identifier validation."""

    def test_valid_simple(self):
        """Simple alphanumeric identifier -> None."""
        assert validate_table_name("employees") is None

    def test_valid_with_underscore(self):
        """Identifier with underscores -> None."""
        assert validate_table_name("employee_records") is None

    def test_valid_starts_with_underscore(self):
        """Identifier starting with underscore -> None."""
        assert validate_table_name("_private_table") is None

    def test_valid_mixed_case(self):
        """Mixed case identifier -> None."""
        assert validate_table_name("EmployeeRecords") is None

    def test_valid_with_numbers(self):
        """Identifier with numbers -> None."""
        assert validate_table_name("employees_2026") is None

    def test_valid_at_max_length(self):
        """128-character identifier -> None."""
        assert validate_table_name("a" * 128) is None

    def test_invalid_empty(self):
        """Empty string -> error."""
        result = validate_table_name("")
        assert result is not None
        assert "empty" in result.lower()

    def test_invalid_starts_with_number(self):
        """Starts with digit -> error."""
        result = validate_table_name("123_table")
        assert result is not None

    def test_invalid_contains_hyphen(self):
        """Contains hyphen -> error."""
        result = validate_table_name("employee-records")
        assert result is not None

    def test_invalid_contains_space(self):
        """Contains space -> error."""
        result = validate_table_name("employee records")
        assert result is not None

    def test_invalid_contains_special_chars(self):
        """Contains special characters -> error."""
        result = validate_table_name("employee@records")
        assert result is not None

    def test_invalid_too_long(self):
        """129+ characters -> error."""
        result = validate_table_name("a" * 129)
        assert result is not None
        assert "128" in result or "length" in result.lower()
```

**File:** `/home/jjob/projects/ingestkit/packages/ingestkit-forms/tests/test_output.py`

**Location:** Add test cases to `TestGetTableName` class (after line 78)

**Test cases for `get_table_name()` with validation:**

```python
@pytest.mark.unit
def test_invalid_table_name_raises(self, output_config):
    """Template name that generates invalid table name -> FormIngestException."""
    # Create template with name that slugifies to start with number
    template = make_template(name="123-start")
    with pytest.raises(FormIngestException) as exc_info:
        get_table_name(output_config, template)
    assert exc_info.value.code == FormErrorCode.E_FORM_TEMPLATE_INVALID
    assert "safe SQL identifier" in exc_info.value.message

@pytest.mark.unit
def test_empty_slug_raises(self, output_config):
    """Template name that slugifies to empty string -> FormIngestException."""
    template = make_template(name="!!!")
    with pytest.raises(FormIngestException) as exc_info:
        get_table_name(output_config, template)
    assert exc_info.value.code == FormErrorCode.E_FORM_TEMPLATE_INVALID

@pytest.mark.unit
def test_valid_edge_case_names(self, output_config):
    """Various valid but tricky template names -> success."""
    test_cases = [
        ("_Leading", "form__leading"),
        ("With123Numbers", "form_with123numbers"),
        ("UPPERCASE", "form_uppercase"),
    ]
    for template_name, expected_table in test_cases:
        template = make_template(name=template_name)
        result = get_table_name(output_config, template)
        assert result == expected_table
```

### Phase 4: Documentation Updates

**File:** `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/security.py`

**Update module docstring** (line 1-6):
```python
"""Security controls and input validation for ingestkit-forms.

Provides file validation (size, extension, magic bytes), regex timeout
protection against ReDoS, pattern compilation validation, and SQL
identifier validation for safe database operations.
See spec section 13.
"""
```

## Edge Cases & Considerations

### 1. Prefix + Slug Combination
**Scenario:** Config prefix is valid, but prefix + slug creates invalid identifier
- Example: prefix="form_", template="123" → "form_123" (starts with letter after prefix)
- **Solution:** Validation happens on final combined name, so this is handled correctly

### 2. Unicode Characters in Template Names
**Scenario:** Template name has unicode characters (e.g., "Formulaire de congé")
- `slugify_template_name()` converts to "formulaire_de_cong" (non-ASCII stripped)
- **Solution:** Already handled by slugification; validation ensures result is safe

### 3. Empty Slug After Slugification
**Scenario:** Template name is all special characters (e.g., "!!!")
- Slugification produces empty string
- **Solution:** `validate_table_name("")` will return error

### 4. Very Long Template Names
**Scenario:** Template name > 128 characters
- After prefix + slug, could exceed limit
- **Solution:** Validation catches this and raises error

### 5. Conflicting Table Names
**Scenario:** Two templates slugify to same name
- Not an identifier safety issue (handled by DB uniqueness constraints)
- **Out of scope:** This is a business logic concern, not security

## Testing Strategy

### Unit Tests (Required)
- `test_security.py`: 13 tests for `validate_table_name()`
  - Valid identifiers (6 tests)
  - Invalid identifiers (7 tests)
- `test_output.py`: 4 additional tests for `get_table_name()` integration
  - Invalid name raises exception
  - Empty slug raises exception
  - Edge case valid names

### Integration Tests (Recommended, but Optional for Issue #103)
- End-to-end test: Template with problematic name → pipeline error
- Verify error message is actionable for end users

## Success Criteria

1. `validate_table_name()` function added to `security.py` with correct regex pattern
2. `get_table_name()` validates table names and raises `FormIngestException` on failure
3. All 17 unit tests pass
4. No regressions in existing `test_security.py` and `test_output.py` tests
5. Error messages are clear and actionable

## Files Modified

1. `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/security.py`
   - Add `validate_table_name()` function (~25 lines)
   - Update module docstring

2. `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/output/db_writer.py`
   - Add import for `validate_table_name`
   - Update `get_table_name()` with validation (~15 lines added)

3. `/home/jjob/projects/ingestkit/packages/ingestkit-forms/tests/test_security.py`
   - Add `TestValidateTableName` class (~60 lines)

4. `/home/jjob/projects/ingestkit/packages/ingestkit-forms/tests/test_output.py`
   - Add 4 test methods to `TestGetTableName` (~30 lines)

## Dependencies & Risks

### Dependencies
- No new external dependencies
- Uses existing error handling infrastructure (`FormIngestException`, `FormErrorCode`)

### Risks
- **Low risk:** Pure additive change with comprehensive tests
- **Breaking change:** Templates with names that generate invalid identifiers will now fail
  - **Mitigation:** This is the desired behavior (fail-fast security control)

## Implementation Time Estimate
- Phase 1 (security.py): 30 minutes
- Phase 2 (db_writer.py): 20 minutes
- Phase 3 (tests): 45 minutes
- Phase 4 (docs): 5 minutes
- **Total: ~1.5-2 hours**

## Notes
- The 128-character limit is conservative (PostgreSQL has 63, MySQL has 64)
- Pattern `^[a-zA-Z_][a-zA-Z0-9_]{0,127}$` is standard SQL identifier syntax
- Using `E_FORM_TEMPLATE_INVALID` error code is consistent with existing template validation failures (e.g., invalid regex patterns)
