# MAP-PLAN: Issue #67 -- Per-field confidence scoring and overall aggregation

## Investigation Summary

### What exists today

**Models (already complete):**
- `ExtractedField` in `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/models.py` (line 271) already has a `confidence: float` field (0.0-1.0) and `extraction_method: str`.
- `FormExtractionResult` (line 307) already has `overall_confidence: float` but no logic computes it -- callers set it manually.
- `FormTemplate` (line 161) with `FieldMapping.required: bool` (line 123) is already defined and available for weighting.

**Extractors -- current confidence behavior:**

1. **NativePDFExtractor** (`/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/extractors/native_pdf.py`):
   - Line 112: hardcoded `confidence=0.95` for all matched widgets.
   - Line 133: `confidence=0.0` when no widget matches.
   - No per-field variation based on encoding or coercion.

2. **OCROverlayExtractor** (`/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/extractors/ocr_overlay.py`):
   - Text fields (line 379-383): uses mean of `char_confidences` or falls back to `result.confidence`. This is correct per spec.
   - Checkbox/radio (line 404-405): `confidence = min(abs(fill_ratio - threshold) / threshold, 1.0)`. This matches the spec formula.
   - Signature (line 425-426): same formula with ink_ratio. Correct.
   - Line 294: checks `form_extraction_min_field_confidence` and appends `W_FORM_FIELD_LOW_CONFIDENCE`, but does NOT set value to None or trigger VLM. Only appends a warning.
   - No VLM fallback logic exists yet.

3. **ExcelCellExtractor** (`/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/extractors/excel_cell.py`): stub only (6 lines). Not implemented yet. Not in scope for this issue.

**Config** (`/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/config.py`):
- `form_extraction_min_field_confidence: float = 0.5` (line 128)
- `form_extraction_min_overall_confidence: float = 0.3` (line 134)
- `form_vlm_fallback_threshold: float = 0.4` (line 111)
- `form_vlm_enabled: bool = False` (line 103)
- `checkbox_fill_threshold: float = 0.3` (line 143)
- Validator ensures `form_vlm_fallback_threshold < form_extraction_min_field_confidence` (line 241).

**Errors** (`/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/errors.py`):
- `E_FORM_EXTRACTION_LOW_CONFIDENCE` (line 38) -- for overall confidence below threshold.
- `W_FORM_FIELD_LOW_CONFIDENCE` (line 71) -- per-field warning.
- `W_FORM_VLM_FALLBACK_USED` (line 83) -- when VLM was invoked.

**Router** (`router.py`): stub only. No orchestration logic yet.

### What needs to change

Per spec section 7.4, four things are missing:

1. **NativePDFExtractor** uses a hardcoded 0.95 confidence. It should vary within 0.90-0.99 based on extraction quality (e.g., deduct for type coercion ambiguity or unusual encodings).

2. **Confidence-based actions** in OCR extractor: currently only appends a warning when below `min_field_confidence`. The spec requires a 4-tier action system (accept / accept+warning / trigger VLM / set None).

3. **`compute_overall_confidence()` function** does not exist. Needs to be created per the spec pseudocode.

4. **Overall confidence gate**: when `overall_confidence < form_extraction_min_overall_confidence`, the pipeline should emit `E_FORM_EXTRACTION_LOW_CONFIDENCE` with zero chunks. This belongs in the router/orchestrator layer, but we need the function available.

---

## Plan

### File 1: New module `confidence.py`

**Path:** `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/confidence.py`

**Create** a new module with two public functions:

```python
def compute_field_confidence(
    extraction_method: str,
    raw_confidence: float,
    field_type: FieldType,
    coercion_applied: bool = False,
) -> float:
    """Clamp/adjust raw confidence to spec-defined ranges per extraction method."""
```

Logic:
- `"native_fields"`: clamp to 0.90-0.99; deduct 0.02 if `coercion_applied`.
- `"ocr_overlay"`: pass through raw OCR confidence (already correct from char averaging).
- `"cell_mapping"`: clamp to 0.90-0.99; deduct 0.02 if `coercion_applied`.
- `"vlm_fallback"`: pass through raw VLM confidence.
- Checkbox/radio: already computed correctly in OCR extractor; pass through.

```python
def compute_overall_confidence(
    fields: list[ExtractedField],
    template: FormTemplate,
) -> float:
    """Weighted mean confidence. Required fields get 2x weight."""
```

Verbatim from spec section 7.4 pseudocode.

```python
def apply_confidence_actions(
    field: ExtractedField,
    config: FormProcessorConfig,
) -> tuple[ExtractedField, list[str]]:
    """Apply the 4-tier confidence-based action rules from spec section 7.4.

    Returns (possibly modified field, list of warning codes).
    Tier 1: confidence >= min_field -> accept as-is
    Tier 2: confidence >= vlm_threshold -> accept + W_FORM_FIELD_LOW_CONFIDENCE
    Tier 3: confidence < vlm_threshold + vlm_enabled -> return field marked for VLM
    Tier 4: confidence < vlm_threshold + no vlm -> value=None + W_FORM_FIELD_LOW_CONFIDENCE
    """
```

### File 2: Edit `native_pdf.py`

**Path:** `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/extractors/native_pdf.py`

**Change 1** (line 112): Replace hardcoded `confidence=0.95` with a call to `compute_field_confidence("native_fields", base_confidence, field.field_type, coercion_applied)`.
- Base confidence: 0.99 when widget value is non-empty and type matches; 0.95 when coercion was needed; 0.90 for edge cases (empty value coerced to default).
- Track whether `_coerce_widget_value` actually changed the value type (add a boolean return or detect before/after).

**Change 2**: Add import of `compute_field_confidence` from the new module.

### File 3: Edit `ocr_overlay.py`

**Path:** `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/extractors/ocr_overlay.py`

**Change 1** (around line 293-296): Replace the simple warning append with a call to `apply_confidence_actions()`. This implements the full 4-tier action system:
- If confidence >= min_field: keep value, no warning.
- If confidence >= vlm_threshold but < min_field: keep value, append `W_FORM_FIELD_LOW_CONFIDENCE`.
- If confidence < vlm_threshold and vlm_enabled: mark field with a flag/warning so the caller (router) can trigger VLM. Set `extraction_method` to indicate VLM is needed.
- If confidence < vlm_threshold and vlm not enabled: set `value = None`, append `W_FORM_FIELD_LOW_CONFIDENCE`.

**Change 2**: Add import of `apply_confidence_actions` from the new module.

### File 4: New test module `test_confidence.py`

**Path:** `/home/jjob/projects/ingestkit/packages/ingestkit-forms/tests/test_confidence.py`

Test cases:

**`compute_field_confidence` tests:**
- Native PDF: base 0.99, verify clamp to 0.90-0.99 range
- Native PDF with coercion: deduction applied, still in range
- OCR: pass-through of raw value
- Cell mapping: clamp to 0.90-0.99
- Checkbox/radio: pass-through

**`compute_overall_confidence` tests:**
- All fields equal confidence -> returns that confidence
- Required fields get 2x weight (2 required at 0.8, 1 optional at 0.4 -> weighted mean = (0.8*2 + 0.8*2 + 0.4*1) / (2+2+1) = 3.6/5 = 0.72)
- Empty fields list -> returns 0.0 (max(total_weight, 1.0) prevents division by zero)
- Fields with value=None and low confidence pull down the average

**`apply_confidence_actions` tests:**
- Tier 1: confidence 0.8 (>= min_field 0.5) -> value unchanged, no warnings
- Tier 2: confidence 0.45 (>= vlm_threshold 0.4, < min_field 0.5) -> value unchanged, W_FORM_FIELD_LOW_CONFIDENCE warning
- Tier 3: confidence 0.3 (< vlm_threshold 0.4), vlm_enabled=True -> field flagged for VLM
- Tier 4: confidence 0.3 (< vlm_threshold 0.4), vlm_enabled=False -> value=None, W_FORM_FIELD_LOW_CONFIDENCE

**Overall confidence gate test:**
- Verify that when overall < 0.3, the appropriate error code is identified (the gate check itself will live in the router, but test the function returns a value < threshold)

### File 5: Edit `test_extractors.py` (if needed)

**Path:** `/home/jjob/projects/ingestkit/packages/ingestkit-forms/tests/test_extractors.py`

Update existing NativePDFExtractor tests to expect variable confidence instead of hardcoded 0.95. Update OCR extractor tests to verify the new confidence-action behavior.

---

## Dependency Order

1. Create `confidence.py` (no internal dependencies beyond models/config/errors)
2. Edit `native_pdf.py` (imports from confidence.py)
3. Edit `ocr_overlay.py` (imports from confidence.py)
4. Create `test_confidence.py`
5. Update `test_extractors.py` for changed behavior

## Risks / Edge Cases

- **ExcelCellExtractor** is a stub. The `compute_field_confidence` function should handle `"cell_mapping"` method but the extractor itself won't call it until that extractor is implemented. No issue -- the function is ready.
- **VLM trigger**: The actual VLM call is NOT in scope for this issue. `apply_confidence_actions` should return a signal (e.g., a specific warning or flag) that the router will later use to invoke VLM. The action here is to mark the field, not invoke VLM.
- **FieldMapping default for required**: The spec pseudocode uses `FieldMapping().required` as a fallback when `field_map.get(ef.field_id)` returns None. We need a `FieldMapping` with defaults that won't fail validation (it requires either region or cell_address). Instead, default to `weight=1.0` when field_id is not found in the template.

AGENT_RETURN: .agents/outputs/map-plan-67-021526.md
