---
issue: 34
title: "Implement OCR engine abstraction with Tesseract adapter"
complexity: COMPLEX
agent: MAP
date: 2026-02-14
spec_sections: "§12.1–§12.5"
files_to_create:
  - src/ingestkit_pdf/utils/ocr_engines.py
  - tests/test_ocr_engines.py
files_to_modify:
  - src/ingestkit_pdf/utils/__init__.py
status: COMPLETE
---

# MAP Artifact — Issue #34: OCR Engine Abstraction

## Executive Summary

Issue #34 requires implementing the OCR engine abstraction layer defined in SPEC.md sections 12.1-12.5. This creates `utils/ocr_engines.py` with a Protocol-based `OCREngineInterface`, a Pydantic `OCRPageResult` model, a `TesseractEngine` adapter, and a `create_ocr_engine()` factory with PaddleOCR-to-Tesseract fallback. The module follows established patterns from sibling utilities (`header_footer.py`, `heading_detector.py`, `chunker.py`).

## Investigation Findings

### 1. SPEC §12.1–§12.5 Requirements (Verbatim)

**§12.1 Purpose:** Unified interface for swappable OCR engines. Tesseract = required baseline; PaddleOCR = optional upgrade.

**§12.2 Interface:**
- `OCREngineInterface(Protocol)` with two methods:
  - `recognize(self, image: "Image.Image", language: str) -> OCRPageResult`
  - `name(self) -> str`
- `OCRPageResult(BaseModel)` with fields: `text: str`, `confidence: float` (0.0-1.0 average), `word_confidences: list[float] | None = None`, `language_detected: str | None = None`

**§12.3 Tesseract Adapter:**
- `TesseractEngine(lang: str = "eng")` — note default is `"eng"` (Tesseract language code), NOT `"en"`
- Uses `pytesseract.image_to_data(output_type=pytesseract.Output.DICT)` for word-level confidence
- Language code mapping required: Tesseract uses `"eng"`, PaddleOCR uses `"en"`
- Must detect missing Tesseract binary -> `E_OCR_ENGINE_UNAVAILABLE`

**§12.4 PaddleOCR Adapter (NOT in scope for this issue):**
- `PaddleOCREngine` — issue says Tesseract adapter only, PaddleOCR is a separate issue
- However, the factory fallback FROM PaddleOCR TO Tesseract IS in scope

**§12.5 Factory:**
- `create_ocr_engine(config: PDFProcessorConfig) -> tuple[OCREngineInterface, list[str]]`
- Returns `(engine, warnings)` tuple
- Fallback chain: PaddleOCR (if configured) -> ImportError catch -> `W_OCR_ENGINE_FALLBACK` warning -> Tesseract
- If Tesseract unavailable: raise error with `E_OCR_ENGINE_UNAVAILABLE`
- Uses a private `_tesseract_available()` helper

### 2. Existing Models (models.py)

Already defined and available for use:

| Model/Enum | Location | Relevance |
|---|---|---|
| `OCREngine(str, Enum)` | `models.py:69-73` | Values: `TESSERACT = "tesseract"`, `PADDLEOCR = "paddleocr"` |
| `OCRResult(BaseModel)` | `models.py:206-216` | Per-page result (different from `OCRPageResult` — this is higher-level) |
| `OCRStageResult(BaseModel)` | `models.py:281-289` | Stage-level aggregation |

**Key distinction:** `OCRPageResult` (new, in this module) is the raw engine output. `OCRResult` (existing) is the per-page pipeline result that wraps `OCRPageResult` with page number, DPI, preprocessing steps.

### 3. Protocols (protocols.py)

Currently re-exports only 4 backend protocols from `ingestkit_core`:
- `VectorStoreBackend`, `StructuredDBBackend`, `LLMBackend`, `EmbeddingBackend`

No OCR protocol exists. Per SPEC, `OCREngineInterface` lives in `utils/ocr_engines.py`, NOT in `protocols.py`. This is correct — OCR engines are internal utilities, not external backends.

### 4. Configuration (config.py)

OCR-related config fields already defined in `PDFProcessorConfig`:

| Field | Type | Default | Used By |
|---|---|---|---|
| `ocr_engine` | `OCREngine` | `OCREngine.TESSERACT` | Factory: selects engine |
| `ocr_dpi` | `int` | `300` | Not used by engine abstraction |
| `ocr_language` | `str` | `"en"` | Factory: passed to engine constructor |
| `ocr_confidence_threshold` | `float` | `0.7` | Not used by engine abstraction directly |
| `ocr_preprocessing_steps` | `list[str]` | `["deskew"]` | Not used by engine abstraction |
| `ocr_max_workers` | `int` | `4` | Not used by engine abstraction |
| `ocr_per_page_timeout_seconds` | `int` | `60` | Not used by engine abstraction |

**IMPORTANT DECISION — Language code mapping:** Config stores `ocr_language = "en"` but Tesseract expects `"eng"`. The adapter must handle this mapping internally (per §12.3: "Language codes differ from PaddleOCR... Adapter handles mapping").

### 5. Error/Warning Codes (errors.py)

All needed codes already exist:

| Code | Type | Usage |
|---|---|---|
| `E_OCR_ENGINE_UNAVAILABLE` | Error | Tesseract binary not found |
| `E_OCR_TIMEOUT` | Error | Not used by this module |
| `E_OCR_FAILED` | Error | Not used by this module |
| `W_OCR_ENGINE_FALLBACK` | Warning | PaddleOCR unavailable, falling back to Tesseract |

The SPEC shows the factory raising `EngineUnavailableError` — this is NOT an existing class. Need to decide: use `IngestError` with `E_OCR_ENGINE_UNAVAILABLE` code, or create a simple custom exception. Given the project pattern of using `IngestError` for structured errors in pipeline results, the factory should raise a plain `RuntimeError` or custom exception (since it's called during setup, not during pipeline processing). The SPEC's pseudocode names it `EngineUnavailableError`.

### 6. Dependencies (pyproject.toml)

- `pytesseract>=0.3` listed under `[project.optional-dependencies] tesseract` extra
- `paddleocr>=2.7` listed under `paddleocr` extra
- `Pillow>=10.0` is a core dependency (provides `PIL.Image`)
- Both OCR packages are optional imports — must handle `ImportError` gracefully

### 7. Test Patterns (conftest.py, existing tests)

Established patterns:
- Tests use `pytest` with class-based grouping (`class TestXxx:`)
- Factory helpers prefixed with `_make_*` for building test objects
- Mock backends defined in `conftest.py` or inline
- `@pytest.mark.unit` for unit tests (no external services)
- `@pytest.mark.ocr` marker exists in `pyproject.toml` for tests requiring Tesseract
- Config overrides via `PDFProcessorConfig(**overrides)`
- Logger name: `"ingestkit_pdf"` (prefix)

## Key Decisions for PLAN

### D1: OCRPageResult Location
`OCRPageResult` should be defined in `utils/ocr_engines.py` per SPEC, NOT in `models.py`. It is engine-internal. The existing `OCRResult` in `models.py` wraps this with pipeline context.

### D2: EngineUnavailableError
Define as a simple `class EngineUnavailableError(Exception)` in `ocr_engines.py`. It's a setup-time error, not a pipeline IngestError. The caller (future OCR processor) will catch it and convert to `IngestError(code=E_OCR_ENGINE_UNAVAILABLE)`.

### D3: Language Code Mapping
TesseractEngine must map ISO 639-1 codes (e.g., `"en"`) to Tesseract's ISO 639-3 codes (e.g., `"eng"`). Include a mapping dict for common languages. Pass-through unknown codes as-is.

### D4: _tesseract_available() Implementation
Use `shutil.which("tesseract")` to check binary availability, plus try-import of `pytesseract`. Both must be present.

### D5: PaddleOCR Stub in Factory
The factory must handle `config.ocr_engine == OCREngine.PADDLEOCR` with an `ImportError` catch even though `PaddleOCREngine` is not implemented yet. The fallback path attempts `import paddleocr` which will fail, triggering the Tesseract fallback with `W_OCR_ENGINE_FALLBACK`.

### D6: Test Strategy
- Unit tests with mocked `pytesseract` (no actual Tesseract binary needed for `@pytest.mark.unit`)
- Test `TesseractEngine.recognize()` with mocked `pytesseract.image_to_data`
- Test `TesseractEngine.name()` returns `"tesseract"`
- Test `create_ocr_engine()` with Tesseract config (happy path, mocked available)
- Test `create_ocr_engine()` with PaddleOCR config -> fallback to Tesseract
- Test `create_ocr_engine()` when Tesseract unavailable -> `EngineUnavailableError`
- Test `OCRPageResult` validation
- Test language code mapping
- Test word confidence extraction from Tesseract data dict

### D7: Protocol Style
Use `typing.Protocol` with `@runtime_checkable` per project conventions. No ABC.

## Dependency Analysis

### Internal Dependencies (this module imports)
- `ingestkit_pdf.config.PDFProcessorConfig` — for factory config parameter
- `ingestkit_pdf.models.OCREngine` — for enum comparison in factory
- `pydantic.BaseModel` — for `OCRPageResult`
- `typing.Protocol`, `typing.runtime_checkable` — for `OCREngineInterface`
- `PIL.Image` (TYPE_CHECKING only) — for type annotation on `recognize()`
- `logging` — logger name `"ingestkit_pdf.utils.ocr_engines"`

### External Optional Dependencies
- `pytesseract` — optional import, graceful degradation
- `shutil` — for `which("tesseract")` binary check

### Downstream Consumers (will import from this module)
- Future OCR processor (Path B, not yet implemented)
- `utils/__init__.py` — will need updated exports

## File Inventory

### Files to Create

| File | Purpose | Est. Lines |
|---|---|---|
| `packages/ingestkit-pdf/src/ingestkit_pdf/utils/ocr_engines.py` | OCR engine protocol, TesseractEngine adapter, factory | ~180 |
| `packages/ingestkit-pdf/tests/test_ocr_engines.py` | Unit tests for all public interfaces | ~250 |

### Files to Modify

| File | Change |
|---|---|
| `packages/ingestkit-pdf/src/ingestkit_pdf/utils/__init__.py` | Add exports for `OCREngineInterface`, `OCRPageResult`, `TesseractEngine`, `create_ocr_engine`, `EngineUnavailableError` |

### Files Read (Reference Only)

| File | What was extracted |
|---|---|
| `packages/ingestkit-pdf/SPEC.md` §12.1–12.5 | Full OCR engine abstraction specification |
| `packages/ingestkit-pdf/src/ingestkit_pdf/models.py` | `OCREngine` enum, `OCRResult`, `OCRStageResult` |
| `packages/ingestkit-pdf/src/ingestkit_pdf/protocols.py` | Confirmed no OCR protocol exists (correct per SPEC) |
| `packages/ingestkit-pdf/src/ingestkit_pdf/config.py` | OCR config fields, `ocr_engine`, `ocr_language` |
| `packages/ingestkit-pdf/src/ingestkit_pdf/errors.py` | `E_OCR_ENGINE_UNAVAILABLE`, `W_OCR_ENGINE_FALLBACK` codes |
| `packages/ingestkit-pdf/pyproject.toml` | `pytesseract>=0.3` in tesseract extra, `paddleocr>=2.7` in paddleocr extra, `@pytest.mark.ocr` marker |
| `packages/ingestkit-pdf/tests/conftest.py` | Test patterns, mock backend style, fixture conventions |
| `packages/ingestkit-pdf/src/ingestkit_pdf/utils/__init__.py` | Current exports (HeaderFooterDetector, HeadingDetector) |
| `packages/ingestkit-pdf/src/ingestkit_pdf/utils/header_footer.py` | Reference pattern for util module structure |

---

AGENT_RETURN: .agents/outputs/map-34-021426.md
