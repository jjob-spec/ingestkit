---
issue: 35
agent: MAP-PLAN
date: 2026-02-14
complexity: SIMPLE
stack: backend
---

# MAP-PLAN: Issue #35 -- Page Renderer and OCR Preprocessing

## Executive Summary

Implement `utils/page_renderer.py`, a utility module that converts PyMuPDF (`fitz`) page objects into PIL Images at configurable DPI, then applies a configurable sequence of OpenCV-based preprocessing steps (deskew, denoise, binarize, contrast) to prepare images for OCR. This is a prerequisite for the OCR processor (Path B, SPEC 11.2 steps 1-2).

## Investigation Findings

### Spec Requirements (SPEC 11.2, steps 1-2)

- **Step 1 -- Render:** Render each page to a high-DPI image (default 300 DPI) using `page.get_pixmap()`.
- **Step 2 -- Preprocess:** Apply preprocessing steps from `config.ocr_preprocessing_steps` in order:
  - **deskew** -- detect skew angle via Hough transform, rotate to correct.
  - **denoise** -- `cv2.fastNlMeansDenoisingColored()`.
  - **binarize** -- adaptive thresholding (Otsu's method).
  - **contrast** -- CLAHE enhancement.

### Configuration (config.py)

- `ocr_dpi: int = 300` -- rendering resolution.
- `ocr_preprocessing_steps: list[str] = ["deskew"]` -- ordered list of steps to apply. Valid values: `"deskew"`, `"denoise"`, `"binarize"`, `"contrast"`.

### Dependencies (pyproject.toml)

- `pymupdf>=1.24` -- core dependency, provides `fitz`.
- `Pillow>=10.0` -- core dependency, provides PIL.Image.
- `opencv-python-headless>=4.8` -- optional dependency under `[opencv]` extra. The preprocessing functions require this.

### Existing Patterns

- Utils modules follow the pattern in `header_footer.py`: module-level docstring, `from __future__ import annotations`, `TYPE_CHECKING` guard for `fitz`, logger named `ingestkit_pdf.utils.<module>`, config injected via constructor.
- Tests use `unittest.mock.MagicMock` for `fitz.Page` objects and `@pytest.mark.unit` markers.
- The `utils/__init__.py` re-exports public classes.

### Models

- `OCRResult` in `models.py` has `preprocessing_steps: list[str]` field, confirming the renderer should track which steps were applied.
- `PDFChunkMetadata` has `ocr_preprocessing: list[str] | None` for downstream metadata.

### Error Codes

- `E_OCR_FAILED = "E_OCR_FAILED"` -- applicable if rendering fails.
- No specific error code for preprocessing failure; `E_OCR_FAILED` with descriptive message is appropriate.

## Implementation Plan

### File: `packages/ingestkit-pdf/src/ingestkit_pdf/utils/page_renderer.py`

**Public API:**

```python
class PageRenderer:
    def __init__(self, config: PDFProcessorConfig) -> None: ...
    def render_page(self, page: fitz.Page) -> PIL.Image.Image: ...
    def preprocess(self, image: PIL.Image.Image) -> PIL.Image.Image: ...
```

**Implementation Details:**

1. **`__init__(self, config)`** -- Store `config.ocr_dpi` and `config.ocr_preprocessing_steps`. Validate that all step names are in the allowed set `{"deskew", "denoise", "binarize", "contrast"}`. Log a warning for unknown steps (skip them).

2. **`render_page(self, page)`**:
   - Call `page.get_pixmap(dpi=self._dpi)`.
   - Convert pixmap to PIL Image via `PIL.Image.frombytes("RGB", (pix.width, pix.height), pix.samples)`.
   - Handle large pages: if pixmap dimensions exceed a reasonable threshold (e.g., 10000x10000), log a warning but still proceed. PyMuPDF handles memory internally.
   - Return PIL Image.

3. **`preprocess(self, image)`**:
   - Convert PIL Image to numpy array for OpenCV.
   - Apply each step in `self._steps` order via a dispatch dict mapping step name to handler method.
   - Convert back to PIL Image and return.

4. **Private preprocessing methods:**
   - `_deskew(img_array)` -- Convert to grayscale, edge detect (Canny), Hough line transform, compute median angle, rotate with `cv2.getRotationMatrix2D` + `cv2.warpAffine`. Return corrected array.
   - `_denoise(img_array)` -- Call `cv2.fastNlMeansDenoisingColored(img_array, None, 10, 10, 7, 21)`. Return denoised array.
   - `_binarize(img_array)` -- Convert to grayscale, apply `cv2.threshold()` with `cv2.THRESH_BINARY + cv2.THRESH_OTSU`. Convert back to 3-channel for consistency. Return array.
   - `_contrast(img_array)` -- Convert to LAB color space, apply CLAHE (`cv2.createCLAHE(clipLimit=2.0, tileGridSize=(8,8))`) to L channel, merge back, convert to BGR. Return array.

5. **Logging:** Logger name `ingestkit_pdf.utils.page_renderer`. Log rendering at DEBUG level (page number, DPI, dimensions). Log each preprocessing step at DEBUG. Log warnings for unknown steps or large pages.

6. **Import guard:** OpenCV import inside preprocessing methods or guarded at module level with a clear error message if `cv2` is not installed (since it's an optional dependency).

### File: `packages/ingestkit-pdf/src/ingestkit_pdf/utils/__init__.py`

Add `PageRenderer` to the re-exports.

## Test Plan

### File: `packages/ingestkit-pdf/tests/test_page_renderer.py`

All tests use `@pytest.mark.unit`. No real PDFs or external services.

**Test categories:**

1. **Rendering tests (mock fitz.Page):**
   - `test_render_page_default_dpi` -- Mock `page.get_pixmap(dpi=300)` returning a mock pixmap with known width/height/samples. Verify PIL Image dimensions match.
   - `test_render_page_custom_dpi` -- Config with `ocr_dpi=150`. Verify `get_pixmap` called with `dpi=150`.
   - `test_render_page_large_dimensions` -- Mock pixmap with large dimensions (e.g., 8000x8000). Verify no error, warning logged.

2. **Preprocessing pipeline tests (synthetic PIL images):**
   - `test_preprocess_no_steps` -- Config with `ocr_preprocessing_steps=[]`. Verify image passes through unchanged.
   - `test_preprocess_deskew_only` -- Default config. Create a synthetic image (white background with a black line at 5 degrees). Verify output image is returned (not error), same dimensions.
   - `test_preprocess_denoise` -- Config with `["denoise"]`. Create a noisy synthetic image. Verify output is returned without error.
   - `test_preprocess_binarize` -- Config with `["binarize"]`. Create a grayscale gradient image. Verify output contains only black/white (or near) pixels.
   - `test_preprocess_contrast` -- Config with `["contrast"]`. Create a low-contrast image. Verify output is returned without error.
   - `test_preprocess_multiple_steps` -- Config with `["deskew", "denoise", "binarize"]`. Verify all steps applied in order (can verify via mocking internal methods).
   - `test_preprocess_unknown_step_skipped` -- Config with `["deskew", "invalid_step"]`. Verify warning logged, valid steps still applied.

3. **Integration of render + preprocess:**
   - `test_render_and_preprocess_pipeline` -- Mock fitz.Page, render, then preprocess. Verify end-to-end returns a PIL Image.

4. **Edge cases:**
   - `test_preprocess_grayscale_input` -- Pass a grayscale (mode "L") image. Verify preprocessing handles it (converts to RGB internally or handles gracefully).
   - `test_opencv_not_installed` -- Mock `cv2` import failure. Verify clear error message when preprocessing is attempted with steps configured.

**Test helper:**
- `_make_synthetic_image(width=200, height=200, mode="RGB")` -- Creates a simple PIL Image for testing.
- `_make_mock_pixmap(width, height)` -- Creates a mock fitz Pixmap with correct `.width`, `.height`, `.samples` attributes.

## Acceptance Criteria

1. `PageRenderer` renders a `fitz.Page` to a PIL Image at the configured DPI (default 300).
2. `PageRenderer.preprocess()` applies configured steps in order from `config.ocr_preprocessing_steps`.
3. All four preprocessing steps are implemented: deskew (Hough), denoise (fastNlMeansDenoisingColored), binarize (Otsu), contrast (CLAHE).
4. Unknown preprocessing step names are skipped with a logged warning (not an error).
5. OpenCV is imported lazily or guarded, with a clear error if `cv2` is unavailable and preprocessing steps are configured.
6. Large page dimensions are handled gracefully (warning, not crash).
7. `PageRenderer` is re-exported from `utils/__init__.py`.
8. All unit tests pass with `pytest packages/ingestkit-pdf/tests/test_page_renderer.py -m unit`.
9. Tests use only synthetic images (`PIL.Image.new`, numpy arrays) and mock `fitz.Page` -- no real PDFs.
10. Logger uses name `ingestkit_pdf.utils.page_renderer`.
11. Module follows existing code conventions: `from __future__ import annotations`, `TYPE_CHECKING` guard for fitz, Pydantic config injection.
