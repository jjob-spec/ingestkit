---
issue: 60
agent: PATCH
date: 2026-02-15
status: Complete
files_modified: 2
files_created: 1
tests_added: 20
lines_added: 245
lines_removed: 5
---

# PATCH: Issue #60 -- Implement Form-Specific Protocols

## Executive Summary

Implemented 4 form-specific protocols (`FormTemplateStore`, `OCRBackend`, `PDFWidgetBackend`, `VLMBackend`) and 3 result models (`OCRRegionResult`, `WidgetField`, `VLMFieldResult`) in `protocols.py`. Re-exported `VectorStoreBackend`, `StructuredDBBackend`, `EmbeddingBackend` from `ingestkit-core`. All protocols use `@runtime_checkable` with `typing.Protocol` (no ABCs). Updated `__init__.py` with protocol exports. Created 20 unit tests -- all pass. Full suite: 152 passed, 0 failed.

## Metrics

| Metric | Value |
|--------|-------|
| Files modified | 2 (`protocols.py`, `__init__.py`) |
| Files created | 1 (`test_protocols.py`) |
| Tests added | 20 |
| Tests total (suite) | 152 |
| Lines added | ~245 |
| Lines removed | ~5 |

## Files Changed

### `packages/ingestkit-forms/src/ingestkit_forms/protocols.py`

Replaced 6-line stub with full implementation:
- 3 result models: `OCRRegionResult`, `WidgetField`, `VLMFieldResult` (Pydantic BaseModel)
- 4 protocols: `FormTemplateStore` (6 methods), `OCRBackend` (2 methods), `PDFWidgetBackend` (3 methods), `VLMBackend` (3 methods)
- 3 re-exports from `ingestkit_core.protocols`
- `__all__` with 10 exports
- See map-plan-60-021526.md for spec-exact signatures

### `packages/ingestkit-forms/src/ingestkit_forms/__init__.py`

Added protocol imports and exports (10 new names). Existing exports preserved.

### `packages/ingestkit-forms/tests/test_protocols.py`

Created 20 tests across 7 test classes:
- 4 positive isinstance checks (one per protocol)
- 1 negative isinstance check (non-conforming class)
- 4 OCRRegionResult tests (construction, char_confidences, bounds)
- 2 WidgetField tests (construction, None value)
- 6 VLMFieldResult tests (construction, bool/None values, tokens, bounds)
- 3 re-export identity tests

## Issues Encountered

### BoundingBox Forward Reference (Pydantic v2)

`WidgetField.bbox` uses `BoundingBox` from `models.py`. Initially placed under `TYPE_CHECKING` guard (matching plan), but Pydantic v2 requires the actual type at runtime for model instantiation -- `from __future__ import annotations` defers annotation evaluation but Pydantic still needs the concrete type to build its schema. Fixed by importing `BoundingBox` at runtime while keeping `FormTemplate` under `TYPE_CHECKING` (since `FormTemplate` is only referenced in protocol method signatures which are never called on the Protocol class itself).

## Deviations from PLAN

| Deviation | Reason |
|-----------|--------|
| `BoundingBox` imported at runtime instead of `TYPE_CHECKING` | Pydantic v2 needs concrete type for `WidgetField.bbox` field schema. `FormTemplate` remains under `TYPE_CHECKING` since protocols don't instantiate it. |
| 20 tests instead of planned 11 | Added more granular tests for result models (bool/None values, token counts, char_confidences). |

## Verification

```
ruff check protocols.py        -- All checks passed
ruff check __init__.py          -- All checks passed
ruff check test_protocols.py    -- All checks passed
pytest test_protocols.py -v     -- 20 passed
pytest tests/ -q                -- 152 passed (0 failed, 0 regressions)
```

## Acceptance Criteria Status

All criteria met. See MAP-PLAN for full list.

AGENT_RETURN: .agents/outputs/patch-60-021526.md
