# MAP Artifact: Issue #43 — Test Infrastructure, Mock Backends, and PDF Fixtures

**Date:** 2026-02-14
**Issue:** #43 — Implement test infrastructure, mock backends, and PDF fixtures (conftest.py)
**SPEC Sections:** 22.1, 22.2, 22.3, 22.4, 22.5

---

## 1. Current State Analysis

### 1.1 Existing `conftest.py` (Already Implemented)

**File:** `/home/jjob/projects/ingestkit/packages/ingestkit-pdf/tests/conftest.py`

Already contains:
- **MockLLMBackend** (lines 29-86): Queue-based with `classify()` and `generate()`. Supports configurable responses via list. Pops from front. Raises `RuntimeError` when empty.
- **MockVectorStoreBackend** (lines 94-115): Tracks `collections_ensured`, `upserted`, `payload_indices`, `deleted`.
- **MockEmbeddingBackend** (lines 123-135): Returns `[0.1] * dim` vectors, tracks calls.
- **MockStructuredDBBackend** (lines 143-167): In-memory dict of tables, tracks drops.
- **Factory helpers**: `_make_extraction_quality()`, `_make_page_profile()`, `_make_document_profile()`, `_valid_response()`.
- **Pytest fixtures**: `pdf_config`, `pdf_inspector`, `document_profile`, `mock_structured_db`, `mock_vector_store`, `mock_embedder`, `mock_llm`.

### 1.2 Existing pytest markers

**File:** `/home/jjob/projects/ingestkit/packages/ingestkit-pdf/pyproject.toml` (lines 62-67)

Already configured:
```
markers = [
    "unit: Unit tests (no external services)",
    "integration: Integration tests (require external services)",
    "ocr: Tests requiring Tesseract OCR engine installed (baseline)",
    "ocr_paddle: Tests requiring PaddleOCR installed (optional upgrade)",
]
```

All four markers from SPEC 22.4 are already present.

### 1.3 Dependencies

**reportlab** is already in dev dependencies (pyproject.toml line 52): `"reportlab>=4.0"`

**fpdf2** is NOT listed. Only `reportlab` is needed based on existing usage patterns (test_security.py uses reportlab).

**PyMuPDF (fitz)** is a core dependency and is used for encrypted PDF generation (test_security.py lines 248-264).

### 1.4 What Tests Already Use

Several test files already import from conftest:
- `test_llm_classifier.py` imports: `MockLLMBackend`, `_make_document_profile`, `_make_page_profile`, `_valid_response`
- `test_text_extractor.py` imports: `_make_document_profile`, `_make_page_profile`
- `test_inspector.py` has its own inline `_default_extraction_quality()` helper (duplicates conftest)

### 1.5 Existing PDF Generation Patterns

`test_security.py` already has:
- `_make_simple_pdf()`: Uses reportlab `canvas.Canvas` to create N-page PDFs with text
- `_write_pdf()`: Writes PDF bytes to tmp_path
- `_make_encrypted_pdf()`: Uses PyMuPDF (`fitz`) for AES-256 encryption with user/owner passwords

---

## 2. Gap Analysis (What Needs to Be Added)

### 2.1 Mock Backends — Configurable Errors (Issue Requirement)

The existing mock backends are functional but the issue specifically calls out **"configurable errors"**. Comparing with the Excel package's `MockLLM` (which has `__TIMEOUT__` and `__MALFORMED_JSON__` sentinel values), the PDF `MockLLMBackend` only raises when responses run out.

**Gaps to fill:**
- **MockLLMBackend**: Add sentinel support for `__TIMEOUT__` (raises `TimeoutError`) and `__MALFORMED_JSON__` (returns garbled dict), matching the Excel `MockLLM` pattern. Add `enqueue_classify()` / `enqueue_generate()` convenience methods.
- **MockVectorStoreBackend**: Add configurable error injection (e.g., `fail_on_upsert: bool` or error queue).
- **MockStructuredDBBackend**: Add configurable error injection.
- **MockEmbeddingBackend**: Add configurable error injection (e.g., `fail_on_embed: bool` or error queue).

### 2.2 Programmatic PDF Fixtures (SPEC 22.2 — Not Yet Implemented)

None of the five SPEC-required PDF fixtures exist. All must be created in `conftest.py`:

| Fixture | SPEC Description | Implementation Strategy |
|---------|-----------------|------------------------|
| `text_native_pdf(tmp_path)` | Multi-page PDF with headings, paragraphs, page numbers | reportlab `canvas.Canvas` with multiple pages, varied fonts, `drawString` |
| `scanned_pdf(tmp_path)` | PDF with pages that are images (simulated scan) | reportlab: render text to PIL Image, embed as full-page image in PDF |
| `complex_pdf(tmp_path)` | Tables, multi-column layout, mixed content | reportlab: data table via `Table`, two-column section, headers/footers |
| `encrypted_pdf(tmp_path)` | Password-protected PDF | PyMuPDF `fitz`: create PDF then encrypt with AES-256 (pattern exists in test_security.py) |
| `garbled_pdf(tmp_path)` | Intentionally garbled text (CIDFont issues simulation) | reportlab: write gibberish/non-printable chars, or embed text that reads as garbled when extracted |

### 2.3 `test_utils.py` (SPEC 2.2 File Layout — Not Yet Implemented)

**File:** `packages/ingestkit-pdf/tests/test_utils.py`

The SPEC file layout (line 180) lists `test_utils.py` as part of the test directory. This file doesn't exist yet. Based on the issue description, it should contain tests for any utility functions in the test infrastructure, or be a utility module for tests. Given the issue title mentions "test infrastructure", this likely contains:
- Reusable test helper functions (PDF generation helpers that are shared across test files)
- Assertions helpers specific to PDF testing
- Possibly tests for the `utils/` subpackage modules

---

## 3. Protocol Conformance Check

All four protocols are re-exported from `ingestkit_core.protocols` via `ingestkit_pdf.protocols`.

**Protocol method signatures (from `/home/jjob/projects/ingestkit/packages/ingestkit-core/src/ingestkit_core/protocols.py`):**

| Protocol | Methods |
|----------|---------|
| `VectorStoreBackend` | `upsert_chunks(collection, chunks) -> int`, `ensure_collection(collection, vector_size)`, `create_payload_index(collection, field, field_type)`, `delete_by_ids(collection, ids) -> int` |
| `StructuredDBBackend` | `create_table_from_dataframe(table_name, df)`, `drop_table(table_name)`, `table_exists(table_name) -> bool`, `get_table_schema(table_name) -> dict`, `get_connection_uri() -> str` |
| `LLMBackend` | `classify(prompt, model, temperature=0.1, timeout=None) -> dict`, `generate(prompt, model, temperature=0.7, timeout=None) -> str` |
| `EmbeddingBackend` | `embed(texts, timeout=None) -> list[list[float]]`, `dimension() -> int` |

**Current mock conformance:**
- All four existing mocks satisfy their respective protocol signatures. Confirmed by comparing method signatures.

---

## 4. Implementation Plan

### 4.1 Expand `conftest.py` — Mock Backend Enhancements

1. Add `enqueue_classify()` / `enqueue_generate()` to `MockLLMBackend`
2. Add `__TIMEOUT__` and `__MALFORMED_JSON__` sentinel handling (matching Excel's `MockLLM`)
3. Add configurable error injection to `MockVectorStoreBackend`, `MockStructuredDBBackend`, `MockEmbeddingBackend` (e.g., `error_on_next: Exception | None` field)

### 4.2 Expand `conftest.py` — PDF Fixtures

Add five `@pytest.fixture` functions using `tmp_path`:

1. **`text_native_pdf`**: 3-page PDF with heading (large bold font), body paragraphs, page numbers in footer. Use `reportlab.pdfgen.canvas` with `setFont("Helvetica-Bold", 18)` for headings and `setFont("Helvetica", 11)` for body.

2. **`scanned_pdf`**: Create text on a PIL Image, then embed as image-only PDF page. Use `reportlab.lib.utils.ImageReader` with `canvas.drawImage()`. This creates a PDF that has no extractable text layer — only raster images.

3. **`complex_pdf`**: Use `reportlab.platypus` with `Table`, `SimpleDocTemplate`, multi-column `Frame` layout. Include a data table, a two-column text section, and headers/footers via `onPage` callbacks.

4. **`encrypted_pdf`**: Create a simple PDF with reportlab, then encrypt using `fitz.open()` + `doc.save(encryption=...)`. Pattern already proven in test_security.py.

5. **`garbled_pdf`**: Create PDF with custom encoding or CIDFont simulation where extracted text is non-printable / garbled. Can use reportlab to write text with random bytes or characters that appear garbled when extracted by pdfminer/pymupdf.

### 4.3 Create `test_utils.py`

Create as a test file for utility-level tests or as a shared test helper module. Based on the SPEC listing it alongside other `test_*.py` files, it should contain tests for `utils/` subpackage modules (chunker, heading_detector, header_footer, etc.). However, given the issue scope is about *test infrastructure*, it more likely serves as a shared helper module with:
- `make_simple_pdf()` — extracted from test_security.py pattern
- `write_pdf_to_path()` — helper
- PDF content validation helpers
- Any reusable assertion helpers

---

## 5. Risks and Considerations

| Risk | Mitigation |
|------|-----------|
| `scanned_pdf` fixture requires PIL/Pillow | Pillow is already a dependency (`Pillow>=10.0` in pyproject.toml) |
| Garbled PDF is hard to simulate convincingly | Use non-printable Unicode characters or write bytes that mimic CIDFont encoding issues; test against `printable_ratio` quality check |
| Encrypted PDF needs fitz (PyMuPDF) | Already a core dependency (`pymupdf>=1.24`) |
| reportlab `platypus` for complex_pdf may be complex | Keep table simple; focus on layout that exercises table_extractor and multi-column detection |
| Fixture scope: `tmp_path` is function-scoped | SPEC uses `tmp_path` (function scope). For expensive PDF generation, could use `tmp_path_factory` with session scope, but SPEC explicitly shows `tmp_path`. Follow SPEC. |

---

## 6. Files to Modify/Create

| File | Action | Description |
|------|--------|-------------|
| `packages/ingestkit-pdf/tests/conftest.py` | **Modify** | Add configurable error support to mocks; add 5 PDF fixture functions |
| `packages/ingestkit-pdf/tests/test_utils.py` | **Create** | Shared test utilities or tests for utils modules |

---

## 7. Dependencies Verified

- Issue #21 (scaffolding): Package structure exists
- Issue #22 (models): `models.py` is fully implemented with all enums and models
- Issue #23 (errors): `errors.py` is fully implemented with all ErrorCode values
- Issue #24 (config): `config.py` is fully implemented with PDFProcessorConfig
- Issue #25 (protocols): `protocols.py` re-exports from ingestkit_core

All dependencies are satisfied.

---

## 8. Key Source Files Referenced

| File | Purpose |
|------|---------|
| `/home/jjob/projects/ingestkit/packages/ingestkit-pdf/tests/conftest.py` | Current conftest to expand |
| `/home/jjob/projects/ingestkit/packages/ingestkit-pdf/src/ingestkit_pdf/protocols.py` | Protocol re-exports |
| `/home/jjob/projects/ingestkit/packages/ingestkit-core/src/ingestkit_core/protocols.py` | Canonical protocol definitions |
| `/home/jjob/projects/ingestkit/packages/ingestkit-pdf/src/ingestkit_pdf/models.py` | All data models |
| `/home/jjob/projects/ingestkit/packages/ingestkit-pdf/src/ingestkit_pdf/config.py` | PDFProcessorConfig |
| `/home/jjob/projects/ingestkit/packages/ingestkit-pdf/src/ingestkit_pdf/errors.py` | ErrorCode enum |
| `/home/jjob/projects/ingestkit/packages/ingestkit-pdf/pyproject.toml` | Dependencies and markers |
| `/home/jjob/projects/ingestkit/packages/ingestkit-pdf/tests/test_security.py` | Existing reportlab/fitz PDF generation patterns |
| `/home/jjob/projects/ingestkit/packages/ingestkit-excel/tests/conftest.py` | Reference pattern for mock backends |
| `/home/jjob/projects/ingestkit/packages/ingestkit-pdf/SPEC.md` (lines 1682-1781) | SPEC section 22 |
