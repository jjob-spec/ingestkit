---
issue: 61
agent: MAP
date: 2026-02-15
complexity: COMPLEX
stack: backend
---

# MAP: Issue #61 -- Implement Template System: CRUD, Versioning, and Fingerprinting

## 1. Executive Summary

Issue #61 requires implementing three interconnected components for the form template system: (1) CRUD operations in `api.py` (create, update with version increment, soft-delete, get, list, list_versions), (2) layout fingerprinting and similarity computation in `matcher.py` (render at 150 DPI, grayscale, adaptive threshold, 16x20 grid, 4-level quantization, multi-page concat), and (3) a `FileSystemTemplateStore` implementing the `FormTemplateStore` protocol for persistence. The spec (sections 5.3, 5.4, 9.1, 9.2, 15.3) provides complete algorithmic definitions. Key risks: (1) `FormTemplate` model lacks an `is_deleted` field -- the store must track soft-delete state externally or the model needs extension, (2) fingerprint computation requires `Pillow` for image processing (already a core dependency), (3) versioning immutability must be enforced at the API layer since the model itself is mutable.

---

## 2. Existing Codebase State

### 2.1 Stubs (Empty)

| File | Current State | Target |
|------|--------------|--------|
| `packages/ingestkit-forms/src/ingestkit_forms/api.py` | Docstring only (6 lines) | Template CRUD: create, update, delete, get, list, list_versions |
| `packages/ingestkit-forms/src/ingestkit_forms/matcher.py` | Docstring only (6 lines) | `compute_layout_fingerprint()`, `compute_layout_similarity()` |
| New file: `stores/filesystem.py` | Does not exist | `FileSystemTemplateStore` class |

### 2.2 Already Implemented (Dependencies)

| File | What's Available | Location |
|------|-----------------|----------|
| `protocols.py:86-134` | `FormTemplateStore` protocol -- 6 methods: `save_template`, `get_template`, `list_templates`, `list_versions`, `delete_template`, `get_all_fingerprints` | Fully defined |
| `models.py:161-219` | `FormTemplate` model -- 13 fields including `layout_fingerprint: bytes \| None`, `version: int`, `tenant_id` | Fully defined |
| `models.py:450-476` | `FormTemplateCreateRequest`, `FormTemplateUpdateRequest` | Fully defined |
| `config.py:62-73` | Fingerprint config: `fingerprint_dpi=150`, `fingerprint_grid_rows=20`, `fingerprint_grid_cols=16` | Fully defined |
| `errors.py:26-29` | Template error codes: `E_FORM_TEMPLATE_NOT_FOUND`, `E_FORM_TEMPLATE_INVALID`, `E_FORM_TEMPLATE_VERSION_CONFLICT`, `E_FORM_TEMPLATE_STORE_UNAVAILABLE` | Fully defined |
| `conftest.py:31-37` | `mock_template_store` fixture -- placeholder returning `None` | Needs implementation |
| `tests/test_api.py` | Docstring only | Needs tests |
| `tests/test_matcher.py` | Docstring only | Needs tests |

### 2.3 Test Infrastructure

- Test files exist but are empty: `test_api.py`, `test_matcher.py`
- `conftest.py` has placeholder fixtures that need to be fleshed out
- `pyproject.toml` already has `pytest` markers: `unit`, `integration`
- Pillow is already a core dependency in `pyproject.toml`

---

## 3. Spec Analysis

### 3.1 Template CRUD (Spec Section 9.1, lines 1233-1300)

**Operations required:**

| Method | Spec Signature | Key Behavior |
|--------|---------------|--------------|
| `create_template(template_def: FormTemplateCreateRequest) -> FormTemplate` | Section 9.1 line 1265-1274 | Generate UUID, compute fingerprint from `sample_file_path`, set version=1, save via store |
| `update_template(template_id: str, template_def: FormTemplateUpdateRequest) -> FormTemplate` | Section 9.1 line 1276-1287 | Load latest version, increment version, apply updates, recompute fingerprint if new sample_file_path, save as new version |
| `delete_template(template_id: str, version: int \| None = None) -> None` | Section 9.1 line 1289-1300 | Soft-delete. If version=None, mark all versions inactive. Hard delete NOT supported. |
| `get_template(template_id: str, version: int \| None = None) -> FormTemplate` | Section 9.1 line 1246-1255 | Return template or raise `E_FORM_TEMPLATE_NOT_FOUND` |
| `list_templates(tenant_id, source_format) -> list[FormTemplate]` | Section 9.1 line 1235-1244 | Latest version of each active template |
| `list_template_versions(template_id: str) -> list[FormTemplate]` | Section 9.1 line 1258-1262 | All versions, ordered by version descending |

**CRITICAL NOTE**: The `FormPluginAPI` protocol (spec section 9.1) defines the public API surface. Our `api.py` should implement these methods. The API delegates to `FormTemplateStore` for persistence and `matcher.py` for fingerprinting.

### 3.2 Template Versioning (Spec Section 5.3, lines 495-521)

Key rules from spec:
1. **Version increment**: Updates create new version, previous retained
2. **Immutable snapshots**: Once used for extraction, version is immutable (enforcement deferred -- this is an extraction-time concern, not CRUD-time)
3. **Fingerprint per version**: Each version gets its own `layout_fingerprint`
4. **Latest version**: Store must support retrieval of latest version by template_id
5. **Active listing**: `list_templates(active_only=True)` returns only latest versions of non-deleted templates

### 3.3 Layout Fingerprinting (Spec Section 5.4, lines 522-564)

**Algorithm (verbatim from spec):**
1. Render document page(s) at 150 DPI (configurable via `fingerprint_dpi`)
2. Convert to grayscale
3. Apply adaptive thresholding to isolate structural elements
4. Compute structural hash:
   a. Divide page into 16x20 grid (configurable via `fingerprint_grid_cols`, `fingerprint_grid_rows`)
   b. For each cell: compute fill ratio (dark pixels / total pixels)
   c. Quantize to 4 levels: empty (0), sparse (1), partial (2), dense (3)
   d. The NxM matrix of quantized values IS the fingerprint
5. For multi-page: concatenate per-page fingerprints

**Quantization thresholds** (not specified in spec, must define):
- Level 0 (empty): fill_ratio < 0.05
- Level 1 (sparse): 0.05 <= fill_ratio < 0.25
- Level 2 (partial): 0.25 <= fill_ratio < 0.60
- Level 3 (dense): fill_ratio >= 0.60

**Fingerprint storage format**: `bytes` -- the quantized grid values packed as raw bytes. For a single page with 16x20=320 cells at 2 bits each, this is 80 bytes per page. However, since values are 0-3 (2 bits), packing 4 values per byte is efficient. Alternative: store as 1 byte per cell (320 bytes/page) for simplicity and debuggability. The spec says `bytes` type but doesn't mandate packing.

**Recommendation**: Use 1 byte per cell for simplicity. 320 bytes per page is negligible.

### 3.4 Similarity Comparison (Spec Section 5.4, lines 547-562)

```
compute_layout_similarity(fp_a: bytes, fp_b: bytes) -> float:
    1. Deserialize both fingerprints into NxM matrices
    2. If page counts differ -> 0.0
    3. For each grid cell:
       - Exact match: 1.0
       - Off by one quantization level: 0.5
       - Off by two or more: 0.0
    4. Similarity = sum(cell_scores) / total_cells
```

### 3.5 FileSystemTemplateStore (Spec Section 15.3, line 2148-2153)

The spec says: "Concrete implementations might use: filesystem (JSON/YAML files), SQLite, PostgreSQL, or any key-value store."

**Design for FileSystemTemplateStore:**
- Directory structure: `{base_path}/{template_id}/v{version}.json`
- Metadata index: `{base_path}/{template_id}/_meta.json` (tracks `is_deleted` per version, latest version number)
- Template data serialized as JSON via Pydantic's `model_dump(mode="json")`
- `layout_fingerprint` and `thumbnail` serialized as hex strings (already handled by `FormTemplate._serialize_bytes`)

---

## 4. Design Decisions Required

### 4.1 Soft-Delete Tracking

**Problem**: `FormTemplate` model has no `is_deleted` field. The `FormTemplateStore.delete_template()` does "soft-delete."

**Options**:
1. Add `is_deleted: bool = False` to `FormTemplate` model -- **REJECTED**: changes the shared model, affects serialization
2. Track deletion state in store metadata (external to model) -- **RECOMMENDED**: `_meta.json` per template tracks deleted versions
3. Move deleted files to a `_deleted/` subdirectory -- simpler but loses version ordering

**Decision**: Option 2 -- store-level metadata. The `_meta.json` file for each template tracks:
```json
{
    "template_id": "...",
    "deleted_versions": [1, 2],
    "all_deleted": false
}
```

### 4.2 Fingerprint Rendering

**Problem**: Computing fingerprints requires rendering PDF/image/Excel pages at 150 DPI. This needs page rendering capability.

**For this issue**: The `compute_layout_fingerprint` function should accept `PIL.Image` objects (already-rendered pages) rather than raw file paths. The rendering step (PDF-to-image, Excel-to-image) is a separate concern that will be handled by document renderers. The API's `create_template` will need a rendering helper, but for unit testing we can pass synthetic images.

**Function signatures:**
- `compute_layout_fingerprint(pages: list[Image.Image], config: FormProcessorConfig) -> bytes` -- computes fingerprint from pre-rendered page images
- `compute_layout_fingerprint_from_file(file_path: str, config: FormProcessorConfig) -> bytes` -- renders file then computes (may raise if rendering unavailable)
- `compute_layout_similarity(fp_a: bytes, fp_b: bytes, grid_cols: int, grid_rows: int) -> float`

### 4.3 File Rendering for Fingerprinting

For the `create_template` and `update_template` API methods, we need to render the sample file to images. Options:
- PDF: requires PyMuPDF or pdf2image (optional deps)
- Images: direct load via Pillow
- Excel: requires openpyxl + rendering (complex)

**For this issue**: Support images directly (Pillow load), provide a pluggable rendering hook for PDF/Excel, and raise `E_FORM_FINGERPRINT_FAILED` if rendering is unavailable for the format. The rendering abstraction can be a simple callable: `Callable[[str, int], list[Image.Image]]` (file_path, dpi -> page images).

---

## 5. Risk Analysis

| Risk | Severity | Mitigation |
|------|----------|------------|
| `FormTemplate` has no `is_deleted` field | Medium | Track in store metadata (`_meta.json`), not model |
| Fingerprint quantization thresholds not in spec | Medium | Define reasonable defaults (0.05/0.25/0.60), make configurable |
| PDF rendering requires optional deps | Low | Accept `Image.Image` list as input; file-based rendering is secondary |
| Concurrent access to filesystem store | Low | Out of scope for v1 (single-process on-prem). Document limitation. |
| `bytes` field serialization for JSON | Low | Already handled by `FormTemplate._serialize_bytes` (hex encoding) |
| Version conflict on update | Low | Read-then-write with version check |

---

## 6. Files to Create/Modify

### New Files (3)

| File | Purpose | Est. Lines |
|------|---------|-----------|
| `packages/ingestkit-forms/src/ingestkit_forms/stores/__init__.py` | Package init, export `FileSystemTemplateStore` | ~10 |
| `packages/ingestkit-forms/src/ingestkit_forms/stores/filesystem.py` | `FileSystemTemplateStore` implementing `FormTemplateStore` protocol | ~250 |
| `packages/ingestkit-forms/tests/test_stores.py` | Tests for `FileSystemTemplateStore` | ~200 |

### Modified Files (5)

| File | Changes | Est. Lines Changed |
|------|---------|-------------------|
| `packages/ingestkit-forms/src/ingestkit_forms/api.py` | Implement CRUD operations | ~200 |
| `packages/ingestkit-forms/src/ingestkit_forms/matcher.py` | Implement fingerprinting + similarity | ~180 |
| `packages/ingestkit-forms/tests/test_api.py` | Add CRUD tests | ~250 |
| `packages/ingestkit-forms/tests/test_matcher.py` | Add fingerprinting + similarity tests | ~200 |
| `packages/ingestkit-forms/tests/conftest.py` | Implement mock template store fixture, add image fixtures | ~80 |

### Possibly Modified (1)

| File | Changes | Condition |
|------|---------|-----------|
| `packages/ingestkit-forms/src/ingestkit_forms/__init__.py` | Export new public symbols | If api.py or stores expose new public classes |

---

## 7. Acceptance Criteria

- [ ] `api.py` implements `create_template()` that generates UUID, computes fingerprint, sets version=1, persists via store
- [ ] `api.py` implements `update_template()` that loads latest version, increments version, applies partial updates, recomputes fingerprint if new sample provided, saves as new version
- [ ] `api.py` implements `delete_template()` as soft-delete (version-specific or all versions)
- [ ] `api.py` implements `get_template()` returning template or raising `E_FORM_TEMPLATE_NOT_FOUND`
- [ ] `api.py` implements `list_templates()` returning latest active versions with optional tenant/format filters
- [ ] `api.py` implements `list_template_versions()` returning all versions ordered descending
- [ ] `matcher.py` implements `compute_layout_fingerprint()` with: grayscale conversion, adaptive thresholding, 16x20 grid, fill ratio, 4-level quantization, multi-page concatenation
- [ ] `matcher.py` implements `compute_layout_similarity()` with: exact=1.0, off-by-one=0.5, off-by-two+=0.0, page count mismatch=0.0
- [ ] `FileSystemTemplateStore` implements all 6 `FormTemplateStore` protocol methods
- [ ] `FileSystemTemplateStore` passes `isinstance(store, FormTemplateStore)` check
- [ ] Soft-delete tracked in store metadata, not in `FormTemplate` model
- [ ] All new code has unit tests (no external services required)
- [ ] Fingerprint is deterministic for the same input image
- [ ] Config values (`fingerprint_dpi`, `fingerprint_grid_rows`, `fingerprint_grid_cols`) are used, not hardcoded

---

## 8. Verification Gates (for PROVE)

```bash
# All unit tests pass
pytest packages/ingestkit-forms/tests -m unit -v

# New test files run specifically
pytest packages/ingestkit-forms/tests/test_api.py -v
pytest packages/ingestkit-forms/tests/test_matcher.py -v
pytest packages/ingestkit-forms/tests/test_stores.py -v

# Protocol isinstance check
python -c "from ingestkit_forms.stores.filesystem import FileSystemTemplateStore; from ingestkit_forms.protocols import FormTemplateStore; s = FileSystemTemplateStore('/tmp/test'); print(isinstance(s, FormTemplateStore))"

# No regressions in existing tests
pytest packages/ingestkit-forms/tests -v
```

---

## 9. Implementation Order

1. **matcher.py** (fingerprinting) -- no dependencies on store or API
2. **stores/filesystem.py** -- depends on models only
3. **api.py** (CRUD) -- depends on matcher + store
4. **conftest.py** -- test fixtures for all three
5. **test_matcher.py** -- test fingerprinting in isolation
6. **test_stores.py** -- test store persistence
7. **test_api.py** -- test CRUD operations with mock store

---

AGENT_RETURN: .agents/outputs/map-61-021526.md
