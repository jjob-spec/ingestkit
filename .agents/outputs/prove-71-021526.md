---
issue: 71
agent: PROVE
date: 2026-02-15
status: BLOCKED
tests_passed: 506
tests_failed: 0
regressions: 0
output_tests: 23
---

# PROVE: Issue #71 -- Idempotency Keying for Form Extraction

## Executive Summary

All verification gates PASS for correctness: ruff clean, 23/23 idempotency tests pass, 506/506 full suite passes with zero regressions. The three idempotency functions are correctly implemented with proper formulas and delegation. Public exports are present in `__init__.py`. However, **one acceptance criterion is not met**: the 23 tests in `test_idempotency.py` are missing `@pytest.mark.unit` decorators on their 4 test classes. This is required by the acceptance criteria ("Tests marked @pytest.mark.unit") and is the convention used by all other test files in ingestkit-forms. Status: **BLOCKED** pending trivial fix.

---

## Verification Gates

| Gate | Command | Result |
|------|---------|--------|
| Ruff lint | `ruff check idempotency.py` | All checks passed |
| Idempotency tests | `pytest test_idempotency.py -v` | 23/23 passed in 0.03s |
| Full suite | `pytest tests/ -q` | 506 passed, 2 warnings in 45.91s |
| Unit marker filter | `pytest test_idempotency.py -m unit` | 0 selected (23 deselected) |
| Public imports | `from ingestkit_forms import ...` | OK |

---

## Acceptance Criteria

| Criterion | Status |
|-----------|--------|
| Both keys are deterministic and reproducible | PASS |
| Same input always produces same key | PASS |
| Different template version produces different form_extraction_key | PASS |
| UUID5 vector point IDs are deterministic | PASS |
| Global ingest key delegates to core compute_ingest_key | PASS |
| Form extraction key = sha256(ingest_key_global\|template_id\|template_version) | PASS |
| Vector point ID = uuid5(NAMESPACE_URL, form_extraction_key:chunk_index) | PASS |
| All functions exported from __init__.py | PASS |
| Tests marked @pytest.mark.unit | FAIL |

---

## Issue Found

### ISSUE-1: Missing `@pytest.mark.unit` on test classes (BLOCKING)

**File**: `packages/ingestkit-forms/tests/test_idempotency.py`

All 4 test classes (`TestComputeIngestKey`, `TestComputeFormExtractionKey`, `TestComputeVectorPointId`, `TestEndToEndIdempotency`) lack `@pytest.mark.unit` decorators. When running `pytest -m unit`, all 23 tests are deselected.

Every other test file in ingestkit-forms (test_stores.py, test_api.py, test_output.py, test_models.py, test_matcher.py, test_extractors.py, test_confidence.py, test_security.py, test_protocols.py) marks test classes/methods with `@pytest.mark.unit`.

**Fix**: Add `@pytest.mark.unit` before each of the 4 class definitions.

---

## Comparison with PATCH

- PATCH reported 23 tests: confirmed (23 passed)
- PATCH reported 440 full suite: **actual is 506** (86 more tests exist now, likely from concurrent issues merged since PATCH ran)
- PATCH reported ruff clean: confirmed
- PATCH did not mention `@pytest.mark.unit` markers: this is the gap

---

## Compliance Checklist

| Rule | Status |
|------|--------|
| No concrete backends in idempotency module | PASS |
| Structural subtyping via Protocol (no ABCs) | PASS |
| Delegates to ingestkit_core (no reimplementation) | PASS |
| Pydantic v2 models (IngestKey from core) | PASS |

---

## Recommendation

**BLOCKED** -- Add `@pytest.mark.unit` to the 4 test classes in `test_idempotency.py`, then re-verify with `pytest -m unit`. This is a 4-line fix. All other criteria are met.

---
AGENT_RETURN: .agents/outputs/prove-71-021526.md
