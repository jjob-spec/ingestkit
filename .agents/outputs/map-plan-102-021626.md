---
issue: 102
agent: MAP-PLAN
date: 2026-02-16
complexity: TRIVIAL
stack: backend
---

# MAP-PLAN: Issue #102 - Add manual_override field to FormIngestRequest

## Executive Summary

Issue #102 adds a `manual_override: bool = False` field to `FormIngestRequest` model. When `True`, the router skips auto-matching and uses `template_id` directly without validation warnings. Current implementation infers manual override from presence of `template_id`, but spec requires explicit field. Changes affect only `models.py` (add field) and `router.py` (consume field for logging). Zero behavioral changes - existing manual override path via `template_id` remains identical. The `metadata` field stays as general-purpose extension.

## Investigation Findings

### Current State

**File**: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/models.py`

`FormIngestRequest` (lines 273-289):
- Has `template_id: str | None = None`
- Has `template_version: int | None = None`
- Has `metadata: dict[str, str] | None = None`
- Missing `manual_override: bool = False`

**File**: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/router.py`

Current manual override logic (lines 284-294):
```python
if request.template_id is not None:
    # Manual override
    template = self._matcher.resolve_manual_override(request)
    match_method = "manual_override"
    # Logs with match_result=manual
```

Infers manual override from `template_id` presence. No explicit `manual_override` field check.

### Spec Requirements

Per `.agents/outputs/spec-review-plugin-api-surface-021626.md`:
- **R13**: FormIngestRequest has `manual_override: bool = False`
- **Purpose**: Explicit signal to skip matching and use `template_id` directly
- **Semantics**: When `True`, bypass auto-match even if `template_id` is `None` (though that would fail in `resolve_manual_override`)
- **Logging**: Should use `manual_override` field for structured log events

### Gap Analysis

1. **Missing field**: `FormIngestRequest` has no `manual_override` field
2. **Implicit inference**: Router checks `template_id` presence instead of explicit flag
3. **Logging**: Uses `template_id` presence to determine `match_result=manual`, not `manual_override` flag

### Implementation Approach

**Minimal change** - add field, consume for logging, preserve existing behavior:

1. Add `manual_override: bool = False` to `FormIngestRequest` (after `metadata`)
2. Update router to check `manual_override` OR `template_id` for manual path (backward compat)
3. Use `manual_override` flag in structured logging instead of inferring from `template_id`
4. Update tests to cover new field

**Rationale**: Existing callers may not set `manual_override` but do set `template_id`. Router must handle both:
- `manual_override=True` → manual path
- `template_id is not None` → manual path (backward compat)
- Neither → auto-match path

**Note**: Spec says "when True, skip matching and use template_id directly" but doesn't require `template_id` to be set. If `manual_override=True` but `template_id=None`, `resolve_manual_override` will raise `E_FORM_TEMPLATE_NOT_FOUND` (expected behavior - caller error).

## File-by-File Implementation Plan

### File 1: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/models.py`

**Change**: Add `manual_override` field to `FormIngestRequest`

**Location**: Line 289 (after `metadata` field)

**Code**:
```python
manual_override: bool = Field(
    default=False,
    description=(
        "When True, skip auto-matching and use template_id directly. "
        "Requires template_id to be set."
    ),
)
```

**Placement**: After `metadata` field, before class end.

**Rationale**: Explicit field per spec. Defaults to `False` for backward compatibility.

### File 2: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/router.py`

**Change 1**: Update manual override detection logic

**Location**: Lines 284-294 (`extract_form` method, template resolution section)

**Current**:
```python
if request.template_id is not None:
    # Manual override
    template = self._matcher.resolve_manual_override(request)
    match_method = "manual_override"
    # ... logging ...
```

**New**:
```python
if request.manual_override or request.template_id is not None:
    # Manual override (explicit flag or template_id presence for backward compat)
    template = self._matcher.resolve_manual_override(request)
    match_method = "manual_override"
    # ... logging ...
```

**Rationale**: Check `manual_override` first (explicit), fall back to `template_id` presence (implicit, backward compat).

**Change 2**: Update structured logging to use `manual_override` field

**Location**: Line 289-293 (logging block in manual override path)

**Current**:
```python
logger.info(
    "form_match stage=match template_candidates=1 "
    "top_confidence=1.000 match_duration_ms=%.1f "
    "match_result=manual",
    match_duration_ms,
)
```

**New**: No change to log format, but ensure semantics match `manual_override` flag.

**Note**: Log format already correct (`match_result=manual`). No code change needed - just verify it's reached when `manual_override=True`.

**Change 3**: Update `try_match` method (convenience gate)

**Location**: Lines 197-212 (`try_match` method, manual override path)

**Current**:
```python
if template_id is not None:
    request = FormIngestRequest(
        file_path=file_path,
        template_id=template_id,
        tenant_id=tenant_id,
    )
    template = self._matcher.resolve_manual_override(request)
    # ...
```

**New**:
```python
if template_id is not None:
    request = FormIngestRequest(
        file_path=file_path,
        template_id=template_id,
        tenant_id=tenant_id,
        manual_override=True,  # Explicit flag when template_id provided
    )
    template = self._matcher.resolve_manual_override(request)
    # ...
```

**Rationale**: When `try_match` is called with `template_id`, set `manual_override=True` explicitly to match intent.

### File 3: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/tests/test_models.py`

**Change**: Add test for `manual_override` field

**New Test**:
```python
@pytest.mark.unit
def test_form_ingest_request_manual_override_default():
    """FormIngestRequest.manual_override defaults to False."""
    req = FormIngestRequest(file_path="form.pdf")
    assert req.manual_override is False


@pytest.mark.unit
def test_form_ingest_request_manual_override_explicit():
    """FormIngestRequest accepts manual_override=True."""
    req = FormIngestRequest(
        file_path="form.pdf",
        template_id="tmpl-1",
        manual_override=True,
    )
    assert req.manual_override is True
    assert req.template_id == "tmpl-1"
```

**Location**: Add to existing `TestFormIngestRequest` class or create new class if needed.

### File 4: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/tests/test_router.py`

**Change 1**: Update existing manual override test to verify new field

**Location**: Find test that exercises manual override path (likely `test_extract_form_manual_override`)

**Update**: Add assertion to verify `manual_override` flag is set correctly in request.

**Change 2**: Add test for `manual_override=True` without `template_id`

**New Test**:
```python
@pytest.mark.unit
def test_extract_form_manual_override_without_template_id(
    router_with_mocks, sample_pdf_file
):
    """Manual override without template_id raises E_FORM_TEMPLATE_NOT_FOUND."""
    request = FormIngestRequest(
        file_path=sample_pdf_file,
        manual_override=True,
        # template_id intentionally omitted
    )
    with pytest.raises(FormIngestException) as exc_info:
        router_with_mocks.extract_form(request)
    assert exc_info.value.code == FormErrorCode.E_FORM_TEMPLATE_NOT_FOUND
```

**Rationale**: Verify that `manual_override=True` with missing `template_id` fails gracefully.

**Change 3**: Update `try_match` test

**Location**: Find test for `try_match` with `template_id` parameter

**Update**: Add assertion to verify `manual_override=True` is set in constructed request.

## Acceptance Criteria

- [ ] `FormIngestRequest` has `manual_override: bool = False` field
- [ ] `manual_override=True` triggers manual override path in `extract_form`
- [ ] Backward compatibility: `template_id` presence (without `manual_override`) still works
- [ ] `try_match(template_id=...)` sets `manual_override=True` explicitly
- [ ] `manual_override=True` with missing `template_id` raises `E_FORM_TEMPLATE_NOT_FOUND`
- [ ] Tests verify default value (`False`)
- [ ] Tests verify explicit `True` value
- [ ] Tests verify backward compatibility (template_id without manual_override)
- [ ] All existing tests pass (no regressions)

## Verification Gates (for PROVE)

1. **Unit tests pass**: `pytest packages/ingestkit-forms/tests/test_models.py::test_form_ingest_request_manual_override* -v`
2. **Router tests pass**: `pytest packages/ingestkit-forms/tests/test_router.py -v -k manual_override`
3. **All tests pass**: `pytest packages/ingestkit-forms/tests -m unit`
4. **No regressions**: `pytest packages/ingestkit-forms/tests`

## Deferred / Out of Scope

- **API surface changes**: No changes to `FormRouter.try_match` signature (it already accepts `template_id` parameter, which is spec-compliant when used with internal `manual_override` flag)
- **Matcher changes**: No changes to `FormMatcher.resolve_manual_override` - it already handles the request correctly
- **Migration guide**: Not needed - new field defaults to `False`, existing callers unaffected

## Risk Assessment

**Low Risk**:
- Additive change (new field with default value)
- Backward compatible (existing `template_id` usage preserved)
- No breaking changes to protocols or public API
- Well-defined failure mode (manual_override without template_id)

**Testing Coverage**:
- Default value test
- Explicit value test
- Error case (manual_override without template_id)
- Backward compat test (template_id without manual_override)

**Rollback**: Zero risk - remove field and revert router logic. No data migration needed.

## Dependencies

None. Standalone change to models and router.

---

AGENT_RETURN: map-plan-102-021626.md
