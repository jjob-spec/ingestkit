# Patch Output: Issue #11 -- Concrete Backends

**Issue:** [Spec] Implement concrete backends: Qdrant, SQLite, Ollama + stubs
**Branch:** feature/issue-11-concrete-backends
**Date:** 2026-02-12

## Summary

Implemented 6 concrete backend classes across 7 new files, plus a comprehensive test suite (66 tests). All backends conform to the 4 Protocol interfaces defined in `ingestkit_core.protocols`. Full regression suite passes (513 tests, 0 failures).

## Files Created

### 1. `packages/ingestkit-excel/src/ingestkit_excel/backends/__init__.py`
- Package init with lazy imports using try/except ImportError guards
- Exports all 6 backend classes: `SQLiteStructuredDB`, `QdrantVectorStore`, `OllamaLLM`, `OllamaEmbedding`, `MilvusVectorStore`, `PostgresStructuredDB`
- Optional-dep backends (`QdrantVectorStore`, `OllamaLLM`, `OllamaEmbedding`) gracefully fall back to `None` when deps missing

### 2. `packages/ingestkit-excel/src/ingestkit_excel/backends/sqlite.py`
- `SQLiteStructuredDB` -- satisfies `StructuredDBBackend` protocol
- Uses stdlib `sqlite3` (no external deps)
- Methods: `create_table_from_dataframe`, `drop_table`, `table_exists`, `get_table_schema`, `get_connection_uri`, `close`
- Uses `df.to_sql()` with `if_exists='replace'`
- Schema via `PRAGMA table_info`

### 3. `packages/ingestkit-excel/src/ingestkit_excel/backends/qdrant.py`
- `QdrantVectorStore` -- satisfies `VectorStoreBackend` protocol
- Lazy import of `qdrant_client` (optional dep)
- Methods: `ensure_collection`, `upsert_chunks`, `create_payload_index`, `delete_by_ids`
- Collection prefix support for multi-tenant isolation
- Exponential backoff retry via `config.backend_max_retries` and `config.backend_backoff_base`
- Converts `ChunkPayload` to Qdrant `PointStruct` format
- Cosine distance for collections

### 4. `packages/ingestkit-excel/src/ingestkit_excel/backends/ollama.py`
- `OllamaLLM` -- satisfies `LLMBackend` protocol
  - `classify()` -- POST /api/generate with format=json, JSON parse with 1 retry on malformed
  - `generate()` -- POST /api/generate, return raw text
  - Retry with backoff on timeout/connection errors
  - Raises `TimeoutError` / `ConnectionError` (compatible with processor error classification)
- `OllamaEmbedding` -- satisfies `EmbeddingBackend` protocol
  - `embed()` -- POST /api/embed, return vectors
  - `dimension()` -- return configured dimension
  - Retry with backoff on timeout/connection errors

### 5. `packages/ingestkit-excel/src/ingestkit_excel/backends/milvus.py`
- `MilvusVectorStore` stub -- all methods raise `NotImplementedError`
- Satisfies `VectorStoreBackend` protocol shape for isinstance checks

### 6. `packages/ingestkit-excel/src/ingestkit_excel/backends/postgres.py`
- `PostgresStructuredDB` stub -- all methods raise `NotImplementedError`
- Satisfies `StructuredDBBackend` protocol shape for isinstance checks

### 7. `packages/ingestkit-excel/tests/test_backends.py`
- 66 unit tests across 7 test classes:
  - `TestSQLiteStructuredDB` (12 tests) -- real in-memory SQLite
  - `TestQdrantVectorStore` (15 tests) -- mocked qdrant_client
  - `TestOllamaLLM` (10 tests) -- mocked httpx
  - `TestOllamaEmbedding` (9 tests) -- mocked httpx
  - `TestStubs` (9 tests) -- NotImplementedError verification
  - `TestProtocolConformance` (6 tests) -- isinstance checks
  - `TestBackendsPackageImport` (5 tests) -- import verification

## Files Modified

### 8. `packages/ingestkit-excel/src/ingestkit_excel/__init__.py`
- Added backend imports from `ingestkit_excel.backends`
- Added 6 backend classes to `__all__`

## Design Decisions

1. **Standard exceptions, not IngestError**: Backends raise `ConnectionError`, `TimeoutError`, `json.JSONDecodeError`, and `RuntimeError` instead of `IngestError` (which is a Pydantic BaseModel, not an Exception). This is consistent with how existing processors catch and classify backend errors via `_classify_backend_error()`.

2. **Exception messages include keywords**: Error messages include terms like "vector", "qdrant", "connection", "timed out", "embed" so that the processor's `_classify_backend_error()` method can correctly map them to error codes.

3. **Retry is internal to backends**: The retry-with-backoff logic lives inside each backend method, using `config.backend_max_retries` and `config.backend_backoff_base`. After retries are exhausted, a standard Python exception propagates to the caller.

4. **classify() JSON retry**: `OllamaLLM.classify()` has its own 1-retry for malformed JSON (separate from HTTP retries), consistent with the LLM classifier's retry pattern.

## Verification

```
$ pytest packages/ingestkit-excel/tests/test_backends.py -v
66 passed in 0.77s

$ pytest packages/ingestkit-excel/tests -v
513 passed in 1.33s

$ python3 -c "from ingestkit_excel.backends import QdrantVectorStore, SQLiteStructuredDB, OllamaLLM, OllamaEmbedding; print('OK')"
OK
```

AGENT_RETURN: patch-11-021226.md
