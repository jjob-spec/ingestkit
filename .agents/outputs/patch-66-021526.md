---
issue: 66
agent: PATCH
date: 2026-02-15
status: Complete
files_created: 1
files_modified: 3
tests_added: 13
lines_added: 385
lines_removed: 8
---

# PATCH: Issue #66 -- VLM Fallback Extraction for Low-Confidence OCR Fields

## Executive Summary

Implemented `VLMFieldExtractor` in `extractors/vlm_fallback.py` as a standalone post-processing class that re-extracts OCR fields with confidence below `form_vlm_fallback_threshold` (0.4) using a VLM backend. Extended `make_field_mapping()` in conftest.py with `field_id` and `extraction_hint` optional params per PLAN-CHECK correction. Added `MockVLMBackend` to conftest.py and 13 unit tests to test_extractors.py, all using `unittest.mock.patch` for `get_page_image` per PLAN-CHECK recommendation.

## Metrics

| Metric | Value |
|--------|-------|
| Files created | 1 |
| Files modified | 3 |
| Tests added | 13 |
| Tests total (suite) | 347 |
| Tests passing | 347 |
| Regressions | 0 |

## Files Changed

### `packages/ingestkit-forms/src/ingestkit_forms/extractors/vlm_fallback.py` (CREATED)

- `VLMFieldExtractor` class with `apply_vlm_fallback()` method
- `_crop_field_region_with_padding()` helper with 10% padding, clamped to bounds
- `_image_to_png_bytes()` helper (duplicated from ocr_overlay, per plan)
- Budget enforcement, priority sorting, graceful degradation
- PII-safe logging (values only logged when `log_sample_data=True`)

### `packages/ingestkit-forms/src/ingestkit_forms/extractors/__init__.py` (MODIFIED)

- Added `VLMFieldExtractor` to imports and `__all__`

### `packages/ingestkit-forms/tests/conftest.py` (MODIFIED)

- Extended `make_field_mapping()` with `field_id` and `extraction_hint` optional params (PLAN-CHECK correction #1)
- Added `MockVLMBackend` class with configurable value/confidence/availability/timeout/error
- Added `mock_vlm_backend` and `vlm_enabled_config` fixtures
- Added `VLMFieldResult` to protocol imports

### `packages/ingestkit-forms/tests/test_extractors.py` (MODIFIED)

- Added 13 VLM fallback tests in `TestVLMFallback` class
- All tests use `unittest.mock.patch` for `get_page_image` (PLAN-CHECK correction #2)
- Added `ExtractedField` to model imports
- Added VLM test helper factories: `_make_vlm_extracted_field`, `_make_vlm_template`, `_make_vlm_field_mapping`

## Issues Encountered

None. Implementation followed the plan without deviations.

## Deviations from PLAN

1. **`__init__.py` had `ExcelCellExtractor` already imported** (added since MAP was written). Preserved existing imports and added `VLMFieldExtractor`.
2. **Used `model_copy(update=...)` instead of constructing new `ExtractedField`** for cases where original is retained with updated warnings. This is cleaner and preserves all original fields without manual copying.

## Verification

```
ruff check vlm_fallback.py                          -> All checks passed
pytest test_extractors.py -k "vlm" (13 tests)       -> 13 passed
pytest tests/ (full suite, 347 tests)                -> 347 passed, 0 regressions
```

## Acceptance Criteria Status

All criteria met. See plan-66-021526.md for full list.

AGENT_RETURN: .agents/outputs/patch-66-021526.md
