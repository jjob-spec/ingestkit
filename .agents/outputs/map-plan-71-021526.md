---
issue: 71
agent: MAP-PLAN
date: 2026-02-15
complexity: SIMPLE
stack: backend
package: ingestkit-forms
---

# MAP-PLAN -- Issue #71: Implement Idempotency Keying for Form Extraction

## Executive Summary

This issue implements the three-tier idempotency key system for `ingestkit-forms` as specified in spec section 4.3. The stub at `idempotency.py` currently contains only a docstring. We need to add: (1) `compute_ingest_key` -- reuses `ingestkit_core.idempotency.compute_ingest_key` for global document-level dedup, (2) `compute_form_extraction_key` -- new function producing `sha256(ingest_key_global + template_id + template_version)`, and (3) `compute_vector_point_id` -- new function producing `uuid5(NAMESPACE, form_extraction_key + chunk_index)`. The chunk_writer.py currently uses an ad-hoc `uuid5(NAMESPACE_URL, ingest_key:chunk_hash)` for point IDs which must be updated to use the spec-compliant form_extraction_key approach. Tests follow the pattern from `ingestkit-excel/tests/test_idempotency.py`.

## Investigation Findings

### Current State of `idempotency.py` Stub

File: `packages/ingestkit-forms/src/ingestkit_forms/idempotency.py` (lines 1-6)
- Contains only a docstring referencing spec section 4.2 (should be 4.3).
- No functions, no imports.

### Pattern from `ingestkit-excel` (see `idempotency.py:1-73`)

- Re-exports `compute_ingest_key` from `ingestkit_core.idempotency` and `IngestKey` from `ingestkit_core.models`.
- `compute_ingest_key(file_path, parser_version, tenant_id, source_uri)` reads raw file bytes, computes SHA-256 content hash, returns `IngestKey`.
- `IngestKey.key` property: `sha256("|".join([content_hash, source_uri, parser_version, ?tenant_id]))`.

### Spec Section 4.3 Requirements

Three keys with distinct scopes:

| Key | Formula | Purpose |
|-----|---------|---------|
| `ingest_key_global` | `sha256(content_hash + source_uri + parser_version)` | Document-level dedup gate |
| `form_extraction_key` | `sha256(ingest_key_global + template_id + template_version)` | Template-versioned dedup, DB `_form_id`, vector point seed |
| Vector point ID | `uuid5(NAMESPACE, form_extraction_key + chunk_index)` | Deterministic chunk IDs |

Re-extraction semantics: new template version produces new `form_extraction_key`, old artifacts remain.

### Current Chunk Writer Point ID (see `chunk_writer.py:225-226`)

```python
chunk_id = str(uuid.uuid5(uuid.NAMESPACE_URL, f"{ingest_key}:{chunk_hash}"))
```

This uses `ingest_key` + `chunk_hash`, not the spec-compliant `form_extraction_key + chunk_index`. This must be updated.

### Current DB Writer `_form_id` (see `db_writer.py:113`)

```python
"_form_id": extraction.form_id,
```

Currently uses `extraction.form_id` (a random UUID). The spec says `_form_id` should be `form_extraction_key`. This is a downstream concern but worth noting -- the caller of `build_row_dict` should pass the `form_extraction_key` as the form_id. This may be addressed separately or as part of this issue.

### `__init__.py` Exports

File: `packages/ingestkit-forms/src/ingestkit_forms/__init__.py`
- Does NOT currently import or export anything from `idempotency.py`.
- Needs to export `compute_ingest_key`, `compute_form_extraction_key`, `compute_vector_point_id`.

### Config Parser Version

File: `packages/ingestkit-forms/src/ingestkit_forms/config.py:33`
- `parser_version: str = "ingestkit_forms:1.0.0"` -- available for callers.

## Implementation Plan

### File 1: `packages/ingestkit-forms/src/ingestkit_forms/idempotency.py`

**Action**: Replace stub with full implementation.

**Functions to implement**:

1. `compute_ingest_key(file_path, parser_version, tenant_id=None, source_uri=None) -> IngestKey`
   - Re-export / delegate to `ingestkit_core.idempotency.compute_ingest_key`.
   - Identical to ingestkit-excel pattern.

2. `compute_form_extraction_key(ingest_key_global: str, template_id: str, template_version: int) -> str`
   - `sha256(f"{ingest_key_global}|{template_id}|{template_version}").hexdigest()`
   - Returns 64-char hex string.
   - Pure function, no I/O.

3. `compute_vector_point_id(form_extraction_key: str, chunk_index: int) -> str`
   - `str(uuid5(NAMESPACE_URL, f"{form_extraction_key}:{chunk_index}"))`
   - Returns UUID string.
   - Pure function, no I/O.

**Exports**: All three functions + `IngestKey` re-export.

### File 2: `packages/ingestkit-forms/src/ingestkit_forms/__init__.py`

**Action**: Add imports and `__all__` entries for the three idempotency functions and `IngestKey`.

Add to imports:
```python
from ingestkit_forms.idempotency import (
    compute_ingest_key,
    compute_form_extraction_key,
    compute_vector_point_id,
)
```

Add to `__all__`:
```python
"compute_ingest_key",
"compute_form_extraction_key",
"compute_vector_point_id",
```

### File 3: `packages/ingestkit-forms/tests/test_idempotency.py`

**Action**: Create new test file.

**Test classes** (following ingestkit-excel test_idempotency.py pattern):

1. `TestComputeIngestKey`
   - `test_same_file_produces_same_key` -- idempotent
   - `test_different_content_produces_different_key`
   - `test_different_parser_version_produces_different_key`
   - `test_tenant_id_affects_key`
   - `test_source_uri_override`
   - `test_returns_ingest_key_instance`
   - `test_key_is_64_char_hex`
   - `test_file_not_found_raises`

2. `TestComputeFormExtractionKey`
   - `test_deterministic_same_inputs`
   - `test_different_ingest_key_produces_different_result`
   - `test_different_template_id_produces_different_result`
   - `test_different_template_version_produces_different_result`
   - `test_result_is_64_char_hex`
   - `test_re_extraction_new_version_new_key` -- same doc, new template version

3. `TestComputeVectorPointId`
   - `test_deterministic_same_inputs`
   - `test_different_form_extraction_key_produces_different_id`
   - `test_different_chunk_index_produces_different_id`
   - `test_result_is_valid_uuid`
   - `test_sequential_chunks_produce_unique_ids`

4. `TestEndToEndIdempotency`
   - `test_full_pipeline_determinism` -- file -> ingest_key -> form_extraction_key -> point_ids, all deterministic
   - `test_template_version_change_changes_downstream_keys` -- same file, version 1 vs 2 produces different form_extraction_key and point IDs but same ingest_key_global

### File 4 (optional): `packages/ingestkit-forms/src/ingestkit_forms/output/chunk_writer.py`

**Action**: Update point ID generation to use `compute_vector_point_id`. This is a downstream integration change. The current code at line 225-226 should be updated to:

```python
from ingestkit_forms.idempotency import compute_vector_point_id
# ...
chunk_id = compute_vector_point_id(form_extraction_key, i)
```

**Note**: This requires the caller (`write_chunks`) to receive `form_extraction_key` instead of (or in addition to) `ingest_key`. This is an interface change on `ChunkWriter.write_chunks()` and `DualWriter.write()`. Given the scope of issue #71 focuses on the idempotency module itself, this integration can be deferred to the router integration issue if preferred. However, if implementing now, the signature change is:

- `write_chunks(..., ingest_key: str, ...)` -> `write_chunks(..., ingest_key: str, form_extraction_key: str, ...)`
- Or compute `form_extraction_key` inside `write_chunks` if template_id and template_version are already available via `extraction`.

**Decision**: Defer chunk_writer and db_writer integration to a follow-up issue. Issue #71 scope is the idempotency module and its tests. The functions must be correct and tested; wiring them into the pipeline is separate.

## Acceptance Criteria

- [ ] `compute_ingest_key` delegates to `ingestkit_core` and produces deterministic `IngestKey` from file bytes
- [ ] `compute_form_extraction_key` produces `sha256(ingest_key_global + template_id + template_version)` as 64-char hex
- [ ] `compute_vector_point_id` produces `uuid5(NAMESPACE, form_extraction_key + chunk_index)` as UUID string
- [ ] Same inputs always produce same outputs (idempotency)
- [ ] Different template version with same document produces different `form_extraction_key` but same `ingest_key_global`
- [ ] All public functions exported from `ingestkit_forms.__init__`
- [ ] All tests pass: `pytest packages/ingestkit-forms/tests/test_idempotency.py -v`
- [ ] No regressions: `pytest packages/ingestkit-forms/tests/ -v`

## Verification Gates (for PROVE)

```bash
pytest packages/ingestkit-forms/tests/test_idempotency.py -v
pytest packages/ingestkit-forms/tests/ -v
python -c "from ingestkit_forms import compute_ingest_key, compute_form_extraction_key, compute_vector_point_id; print('imports OK')"
```

## Risk Assessment

**Low risk**. This is a pure-function module with no I/O dependencies (except file reading in `compute_ingest_key`, which delegates to core). The pattern is well-established in ingestkit-excel. No existing code depends on the stub, so there is no breakage risk.
