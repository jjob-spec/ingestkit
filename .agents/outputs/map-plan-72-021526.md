---
issue: 72
agent: MAP-PLAN
date: 2026-02-15
complexity: SIMPLE
stack: backend
package: ingestkit-forms
depends_on: 69
spec_sections: "4.1, 4.2, 18.4"
---

# MAP-PLAN: Issue #72 -- Implement Pipeline Integration as Path F

## Executive Summary

Issue #72 adds the pipeline integration layer to `ingestkit-forms`: the `FormRouter` class in `router.py` that orchestrates matching, extraction decision, and fallthrough to the standard pipeline. The router currently exists as a stub (docstring only). This issue implements the `extract_form()` and `match_document()` entry points per spec section 9.1, the pipeline gate logic per spec section 4.2 (Form Matcher runs AFTER security/idempotency, BEFORE Inspector), graceful fallthrough when no match is found, structured per-stage logging per section 18.4, and PII-safe log enforcement. The router produces `FormProcessingResult` (not standard `ProcessingResult`). Depends on #69 which provides the FormRouter skeleton; this issue adds the orchestration logic itself.

---

## 1. Investigation Findings

### 1.1 Current State of `router.py`

The file at `/packages/ingestkit-forms/src/ingestkit_forms/router.py` is a **stub** -- contains only a module docstring (6 lines). No class, no functions. The `__init__.py` does not currently export a `FormRouter` class. This is the primary file to implement.

### 1.2 Available Components (Already Built)

| Component | File | Status |
|-----------|------|--------|
| `FormMatcher` | `matcher.py` | Complete -- `match_document()`, `resolve_manual_override()` |
| `FormProcessorConfig` | `config.py` | Complete -- `form_match_enabled`, thresholds, all params |
| `FormProcessingResult` | `models.py:410` | Complete -- all fields defined |
| `FormIngestRequest` | `models.py:248` | Complete -- `file_path`, `template_id`, `tenant_id`, etc. |
| `TemplateMatch` | `models.py:226` | Complete -- `confidence`, `template_id`, etc. |
| `FormErrorCode` | `errors.py` | Complete -- `E_FORM_NO_MATCH`, `E_FORM_EXTRACTION_LOW_CONFIDENCE`, etc. |
| `FormIngestException` | `errors.py:119` | Complete -- wraps `FormIngestError` |
| Mock backends | `conftest.py` | Complete -- `MockFormTemplateStore`, `MockLayoutFingerprinter`, etc. |
| Confidence scoring | `confidence.py` | Complete -- `compute_overall_confidence`, `apply_confidence_actions` |
| Test file | `test_router.py` | Stub (docstring only) |

### 1.3 ExcelRouter Pattern (Reference)

The `ExcelRouter` at `packages/ingestkit-excel/src/ingestkit_excel/router.py` provides the established pattern:
- Constructor takes injected backends + config
- `process()` method orchestrates the full pipeline
- Uses `time.monotonic()` for per-stage timing
- Generates `ingest_run_id = str(uuid.uuid4())`
- Logger name: `ingestkit_excel`
- Returns typed result model

### 1.4 Spec Requirements Analysis

**Spec 4.2 Pipeline Flow:**
```
Security Scan -> Idempotency -> Form Matcher (gate) -> Path F or Standard Pipeline
```

**Spec 9.1 API Surface (FormPluginAPI protocol):**
- `match_document(file_path, tenant_id) -> list[TemplateMatch]` -- public matching
- `extract_form(request: FormIngestRequest) -> FormProcessingResult` -- full extraction

**Spec 18.4 Observability (Structured Logging):**
- Stage `match`: `template_candidates`, `top_confidence`, `match_duration_ms`, `match_result` ("auto", "manual", "fallthrough")
- Stage `extract`: `template_id`, `template_version`, `fields_extracted`, `fields_failed`, `extraction_method`, `extract_duration_ms`
- Logger name: `ingestkit_forms`
- No field values in logs unless `log_sample_data=True`

### 1.5 What #72 Adds vs. #69

Issue #69 is the FormRouter skeleton. Issue #72 adds:
1. **Pipeline gate logic**: check `form_match_enabled`, run matcher, evaluate confidence threshold
2. **Graceful fallthrough**: return `None` / sentinel when no match, zero state mutation
3. **`extract_form()` orchestration**: match -> extract -> return `FormProcessingResult`
4. **`match_document()` public wrapper**: delegates to `FormMatcher` with logging
5. **Structured per-stage logging**: match stage, extract stage with timing
6. **PII-safe logging enforcement**: never log field values unless `log_sample_data=True`

---

## 2. ENUM VALUES (use string values, NOT Python names)

### FormErrorCode -- `errors.py`

| Python Name | String VALUE |
|---|---|
| `FormErrorCode.E_FORM_NO_MATCH` | `"E_FORM_NO_MATCH"` |
| `FormErrorCode.E_FORM_EXTRACTION_LOW_CONFIDENCE` | `"E_FORM_EXTRACTION_LOW_CONFIDENCE"` |
| `FormErrorCode.E_FORM_EXTRACTION_FAILED` | `"E_FORM_EXTRACTION_FAILED"` |
| `FormErrorCode.E_FORM_TEMPLATE_NOT_FOUND` | `"E_FORM_TEMPLATE_NOT_FOUND"` |

### SourceFormat -- `models.py:33`

| Python Name | String VALUE |
|---|---|
| `SourceFormat.PDF` | `"pdf"` |
| `SourceFormat.XLSX` | `"xlsx"` |
| `SourceFormat.IMAGE` | `"image"` |

---

## 3. Implementation Plan

### 3.1 File: `packages/ingestkit-forms/src/ingestkit_forms/router.py`

**Action**: Implement `FormRouter` class (primary deliverable).

**Class signature:**
```python
class FormRouter:
    def __init__(
        self,
        template_store: FormTemplateStore,
        fingerprinter: LayoutFingerprinter,
        config: FormProcessorConfig | None = None,
    ) -> None: ...
```

**Methods to implement:**

1. **`match_document(file_path: str, tenant_id: str | None = None) -> list[TemplateMatch]`**
   - If `config.form_match_enabled` is `False`: return empty list immediately
   - Delegate to `FormMatcher.match_document(file_path)`
   - Log structured match stage per 18.4: `template_candidates`, `top_confidence`, `match_duration_ms`, `match_result`
   - `match_result` values: `"auto"` (match found above threshold), `"fallthrough"` (no match)
   - Return ranked match list

2. **`extract_form(request: FormIngestRequest) -> FormProcessingResult`**
   - **Step 1**: Check pipeline gate
     - If `request.template_id` is provided: use `FormMatcher.resolve_manual_override(request)` (manual path, `match_result="manual"`)
     - Else if `config.form_match_enabled`: run `match_document()`, take top match if confidence >= threshold
     - Else: raise `FormIngestException` with `E_FORM_NO_MATCH` (no match enabled and no manual template)
   - **Step 2**: If no match found and no manual template: raise `FormIngestException` with `E_FORM_NO_MATCH`
   - **Step 3**: Extract fields (placeholder -- extractors are separate issues). For now, raise `NotImplementedError` for the extraction step with a clear message that extractors are not yet wired.
   - **Step 4**: Return `FormProcessingResult`
   - Log structured extract stage per 18.4

3. **`try_match(file_path: str, template_id: str | None = None, tenant_id: str | None = None) -> TemplateMatch | None`**
   - Convenience method for the orchestration layer to probe whether a document matches
   - Returns top match or `None` -- zero state mutation, zero side effects
   - This is the **pipeline gate interface**: caller invokes this BEFORE deciding to route to Path F vs standard pipeline
   - If `template_id` provided: resolve manual override, return synthetic `TemplateMatch` with confidence=1.0
   - If auto-match: return top match if confidence >= threshold, else `None`
   - On any exception: log warning, return `None` (graceful fallthrough)

**Logging contract (18.4):**

Match stage log:
```python
logger.info(
    "form_match stage=%s template_candidates=%d top_confidence=%.3f "
    "match_duration_ms=%.1f match_result=%s",
    "match", len(matches), top_confidence, duration_ms, match_result,
)
```

Extract stage log (when extractors are wired):
```python
logger.info(
    "form_extract stage=%s template_id=%s template_version=%d "
    "fields_extracted=%d fields_failed=%d extraction_method=%s "
    "extract_duration_ms=%.1f",
    "extract", template_id, version, extracted, failed, method, duration_ms,
)
```

**PII safety:**
- Never log field values, `request.file_path` is safe (path, not content)
- Template names and field names are safe to log (spec 4.1 principle 6)
- Only log field values if `config.log_sample_data is True`

### 3.2 File: `packages/ingestkit-forms/src/ingestkit_forms/__init__.py`

**Action**: Add `FormRouter` to exports.

Add to imports:
```python
from ingestkit_forms.router import FormRouter
```

Add `"FormRouter"` to `__all__` list.

### 3.3 File: `packages/ingestkit-forms/tests/test_router.py`

**Action**: Implement unit tests for `FormRouter`.

**Test cases:**

| # | Test | Description |
|---|------|-------------|
| 1 | `test_match_document_disabled` | `form_match_enabled=False` returns empty list |
| 2 | `test_match_document_no_templates` | No stored templates returns empty list |
| 3 | `test_match_document_with_match` | Match above threshold returns ranked list |
| 4 | `test_match_document_below_threshold` | All matches below threshold returns empty or low-confidence list |
| 5 | `test_match_document_logs_structured` | Verifies structured log output per 18.4 |
| 6 | `test_try_match_auto_above_threshold` | Returns top `TemplateMatch` when confidence >= threshold |
| 7 | `test_try_match_auto_below_threshold` | Returns `None` for graceful fallthrough |
| 8 | `test_try_match_manual_template` | Returns synthetic match for manual template_id |
| 9 | `test_try_match_disabled_no_manual` | Returns `None` when disabled and no manual template |
| 10 | `test_try_match_exception_returns_none` | Graceful fallthrough on exception |
| 11 | `test_try_match_no_state_mutation` | Verify store/backends unchanged after fallthrough |
| 12 | `test_extract_form_manual_template` | `extract_form()` with manual `template_id` |
| 13 | `test_extract_form_auto_match` | `extract_form()` with auto-detected template |
| 14 | `test_extract_form_no_match_raises` | `E_FORM_NO_MATCH` when no template found |
| 15 | `test_pii_safe_logging` | No field values in log output |
| 16 | `test_logger_name` | Logger is `ingestkit_forms` |

**Test approach:**
- Use `MockFormTemplateStore` and `MockLayoutFingerprinter` from `conftest.py`
- Pre-populate store with templates that have known fingerprints
- Use `caplog` fixture to capture and assert structured log output
- Tests marked `@pytest.mark.unit`

---

## 4. Acceptance Criteria

- [ ] `FormRouter` class implemented in `router.py` with constructor accepting `FormTemplateStore`, `LayoutFingerprinter`, `FormProcessorConfig`
- [ ] `match_document()` method: delegates to `FormMatcher`, respects `form_match_enabled`, returns `list[TemplateMatch]`
- [ ] `try_match()` method: pipeline gate interface, returns `TemplateMatch | None`, zero state mutation on fallthrough
- [ ] `extract_form()` method: orchestrates match -> extraction, returns `FormProcessingResult`, raises `E_FORM_NO_MATCH` when appropriate
- [ ] Graceful fallthrough: no match + no manual template = `None` from `try_match()`, no side effects
- [ ] Structured logging per spec 18.4: match stage with `template_candidates`, `top_confidence`, `match_duration_ms`, `match_result`
- [ ] Logger name is `ingestkit_forms`
- [ ] PII-safe: no field values in logs unless `log_sample_data=True`
- [ ] `FormRouter` exported from `__init__.py`
- [ ] Unit tests in `test_router.py` covering: disabled matching, no templates, match found, fallthrough, manual override, structured logging, PII safety
- [ ] All existing tests pass (no regressions)

---

## 5. Verification Gates

```bash
# Run new tests
pytest packages/ingestkit-forms/tests/test_router.py -v -m unit

# Run all forms tests (regression check)
pytest packages/ingestkit-forms/tests/ -v

# Lint check
cd packages/ingestkit-forms && python -m py_compile src/ingestkit_forms/router.py
```

---

## 6. Risks and Mitigations

| Risk | Mitigation |
|------|-----------|
| Extractors not yet built (separate issues) | `extract_form()` implements match logic fully but raises `NotImplementedError` for extraction step with clear message. Pipeline gate and logging are complete. |
| #69 dependency not merged yet | `router.py` is currently a stub -- our implementation replaces it entirely. No conflict. |
| `FormMatcher` returns matches below threshold | `try_match()` filters by `form_match_confidence_threshold` before returning. Raw `match_document()` returns all matches >= 0.5 (warning floor). |

---

AGENT_RETURN: MAP-PLAN complete for issue #72. Primary deliverable: `FormRouter` class in `router.py` with `match_document()`, `try_match()`, `extract_form()`. 3 files to modify/create: `router.py` (implement), `__init__.py` (export), `test_router.py` (tests). Estimated ~16 test cases.
