---
issue: 38
agent: PATCH
date: 2026-02-14
status: Complete
files_created: 2
files_modified: 2
tests_added: 37
lines_added: ~850
lines_removed: 0
---

# PATCH Artifact: Issue #38 -- Path A Text Extractor

## Executive Summary

Implemented `TextExtractor` class in `processors/text_extractor.py` (~340 lines) with the full 10-step pipeline for text-native PDF extraction. Created 37 unit tests (~700 lines) covering all pipeline steps and edge cases. All tests pass (37/37), no regressions in existing suite (604/604 total). Exported `TextExtractor` from both `processors/__init__.py` and the package `__init__.py`.

## Metrics

| Metric | Value |
|--------|-------|
| Files created | 2 |
| Files modified | 2 |
| Tests added | 37 |
| Tests passing | 37/37 |
| Regressions | 0 (604 total pass) |

## Files Changed

### Created: `packages/ingestkit-pdf/src/ingestkit_pdf/processors/text_extractor.py`
- `TextExtractor` class with `__init__(vector_store, embedder, config)` constructor
- `process()` method implementing 10-step pipeline per SPEC 11.1
- `_extract_pages()`: steps 1-5 (pymupdf4llm extraction, quality fallback, h/f stripping, TOC/blank skip)
- `_is_toc_page()`, `_is_blank_page()`: static detection methods
- `_convert_headings_to_offsets()`: page-number to char-offset heading conversion
- `_concatenate_pages()`: page text concatenation with boundary offset tracking
- `_embed_and_upsert()`: batch embedding and vector store upsert (steps 9-10)
- `_classify_backend_error()`: error code classification for backend exceptions
- See plan-38-021426.md for detailed section-by-section specification

### Created: `packages/ingestkit-pdf/tests/test_text_extractor.py`
- 37 tests across 12 test classes, all `@pytest.mark.unit`
- All external deps (fitz, pymupdf4llm, backends) mocked
- Helper functions for building process() arguments and mock outputs

### Modified: `packages/ingestkit-pdf/src/ingestkit_pdf/processors/__init__.py`
- Added `TextExtractor` to exports (auto-formatter also added existing OCRProcessor, TableExtractor)

### Modified: `packages/ingestkit-pdf/src/ingestkit_pdf/__init__.py`
- Added `TextExtractor` to public API `__all__`

## Issues Encountered

### ISSUE-1: Lazy imports vs mock patching
`fitz` and `pymupdf4llm` were initially imported lazily inside methods (`import fitz` inside `_extract_pages()` and `process()`). This prevented `@patch("ingestkit_pdf.processors.text_extractor.fitz")` from working since the attribute didn't exist at module level. Fixed by moving both imports to module-level. This is consistent with how they're used in other modules (e.g., `heading_detector.py` imports fitz at module level under TYPE_CHECKING).

### ISSUE-2: conftest import path
Tests initially used `from conftest import ...` which fails. Corrected to `from tests.conftest import ...` matching the pattern in `test_llm_classifier.py`.

## Deviations from PLAN

1. **Module-level imports**: Moved `fitz` and `pymupdf4llm` imports from lazy (inside methods) to module-level to enable test mocking via `@patch`. This is a minor structural change that doesn't affect behavior.

2. **`_extract_pages()` return type simplified**: Returns only `dict[int, str]` (page_texts) instead of a 4-tuple. Warnings and error_details are passed in as mutable lists and modified in-place, which is cleaner and matches the actual usage pattern.

3. **PLAN-CHECK ISSUE-1 resolved**: Implemented `_concatenate_pages()` with the corrected 3-return-value signature `(str, list[int], dict[int, int])` directly, skipping the initial 2-return-value version.

## Acceptance Criteria Status

All criteria met. See plan-38-021426.md for full list.

## Verification

```
pytest packages/ingestkit-pdf/tests/test_text_extractor.py -v  # 37/37 passed
pytest packages/ingestkit-pdf/tests/ -v                         # 604/604 passed
python -c "from ingestkit_pdf.processors.text_extractor import TextExtractor; print('OK')"  # OK
python -c "from ingestkit_pdf import TextExtractor; print('OK')"  # OK
```

AGENT_RETURN: .agents/outputs/patch-38-021426.md
