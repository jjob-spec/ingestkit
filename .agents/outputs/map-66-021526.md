---
issue: 66
agent: MAP
date: 2026-02-15
complexity: COMPLEX
stack: backend
---

# MAP Artifact: Issue #66 — Implement VLM Fallback Extraction for Low-Confidence OCR Fields

**Date:** 2026-02-15
**Issue:** #66 — Implement VLM fallback extraction for low-confidence OCR fields
**Complexity:** COMPLEX

---

## 1. Executive Summary

The VLM fallback extractor is a new module that re-processes OCR fields with confidence below `form_vlm_fallback_threshold` (0.4) by cropping the field region with 10% padding, constructing a prompt per the spec template, and calling the `VLMBackend` protocol. The infrastructure is fully ready: `VLMBackend` protocol, `VLMFieldResult` model, config fields (`form_vlm_enabled`, `form_vlm_fallback_threshold`, `form_vlm_timeout_seconds`, `form_vlm_max_fields_per_document`, `form_vlm_model`), error codes (`E_FORM_VLM_UNAVAILABLE`, `E_FORM_VLM_TIMEOUT`, `W_FORM_VLM_FALLBACK_USED`, `W_FORM_VLM_BUDGET_EXHAUSTED`), and the `ExtractedField` model already supports `extraction_method="vlm_fallback"`. The implementation is a new `VLMFieldExtractor` class plus integration into the OCR overlay extractor's post-extraction flow.

---

## 2. Codebase Context

### 2.1 Files Investigated

| File | Path | Status | Relevance |
|------|------|--------|-----------|
| Spec §7.5 | `docs/specs/form-ingestor-plugin.md` L909-975 | Authoritative | Full VLM algorithm, prompt template, budget guard, priority logic |
| Spec §7.4 | Same file, L870-907 | Authoritative | Confidence-based action table defining when VLM triggers |
| Protocols | `packages/ingestkit-forms/src/ingestkit_forms/protocols.py` L231-271 | Complete | `VLMBackend` protocol (3 methods), `VLMFieldResult` model |
| Config | `packages/ingestkit-forms/src/ingestkit_forms/config.py` L102-125 | Complete | 5 VLM config fields, validator at L241-245 |
| Errors | `packages/ingestkit-forms/src/ingestkit_forms/errors.py` L54-56, L83-84 | Complete | 4 VLM error/warning codes |
| OCR Overlay | `packages/ingestkit-forms/src/ingestkit_forms/extractors/ocr_overlay.py` | Complete | Integration point — `_crop_field_region`, `_image_to_png_bytes` helpers reusable |
| Models | `packages/ingestkit-forms/src/ingestkit_forms/models.py` L93-140, L271-304 | Complete | `FieldMapping.required`, `FieldMapping.extraction_hint`, `ExtractedField` |
| Extractors __init__ | `packages/ingestkit-forms/src/ingestkit_forms/extractors/__init__.py` | Complete | Will need `VLMFieldExtractor` export |
| Test file | `packages/ingestkit-forms/tests/test_extractors.py` | Complete | Mock patterns: `_MockOCRBackend`, `_MockPDFWidgetBackend` — follow same pattern for `_MockVLMBackend` |

### 2.2 Key Design Constraints

1. **Backend-agnostic**: VLM access only via `VLMBackend` protocol — never import Ollama directly.
2. **Opt-in only**: VLM fallback runs only when `form_vlm_enabled=True` AND VLM backend is provided.
3. **Budget guard**: Max `form_vlm_max_fields_per_document` (default 10) VLM calls per document. Emit `W_FORM_VLM_BUDGET_EXHAUSTED` for overflow fields.
4. **Priority ordering**: Required fields first, then lowest confidence first (spec §7.5).
5. **Graceful degradation**: On VLM timeout/error, return original OCR result unchanged.
6. **Config validator**: `form_vlm_fallback_threshold` (0.4) must be < `form_extraction_min_field_confidence` (0.5) — already enforced in `config.py` L241-245.
7. **Fail-closed**: If VLM confidence < `form_extraction_min_field_confidence`, retain original OCR result.
8. **PII-safe logging**: No extracted values in logs unless `config.log_sample_data=True`.

### 2.3 Existing Helpers Available for Reuse

From `ocr_overlay.py`:
- `_crop_field_region(page_image, region) -> Image` — crops using normalized bbox, clamps to bounds
- `_image_to_png_bytes(image) -> bytes` — converts PIL Image to PNG bytes

These are module-level functions and can be imported directly. The 10% padding for VLM cropping is a **new** requirement not covered by the existing `_crop_field_region` (which crops exactly to the bbox).

### 2.4 Protocol & Model Details

**VLMBackend protocol** (3 methods):
```python
def extract_field(image_bytes, field_type, field_name, extraction_hint=None, timeout=None) -> VLMFieldResult
def model_name() -> str
def is_available() -> bool
```

**VLMFieldResult** fields: `value: str | bool | None`, `confidence: float`, `model: str`, `prompt_tokens: int | None`, `completion_tokens: int | None`

**Prompt template** (spec §7.5):
```
Extract the value of the form field shown in this image.

Field name: {field_name}
Field type: {field_type}
{extraction_hint_line}

Respond with ONLY valid JSON:
{{"value": "<extracted value>", "confidence": <0.0 to 1.0>}}
```

Note: The prompt is constructed by the `VLMFieldExtractor` but the actual VLM call goes through `VLMBackend.extract_field()` which accepts `field_name`, `field_type`, and `extraction_hint` as separate parameters. The backend implementation is responsible for assembling the prompt. This means the extractor does NOT need to format the prompt itself — it passes structured parameters to the protocol.

### 2.5 Error Codes Available

| Code | Type | Usage |
|------|------|-------|
| `E_FORM_VLM_UNAVAILABLE` | Error | VLM backend not reachable (`is_available()` returns False) |
| `E_FORM_VLM_TIMEOUT` | Error | VLM call exceeds `form_vlm_timeout_seconds` |
| `W_FORM_VLM_FALLBACK_USED` | Warning | VLM was invoked (regardless of whether it improved confidence) |
| `W_FORM_VLM_BUDGET_EXHAUSTED` | Warning | Field skipped because per-document VLM budget was exhausted |

### 2.6 Integration Point Analysis

The VLM fallback operates as a **post-processing step** on the list of `ExtractedField` results returned by `OCROverlayExtractor.extract()`. Per spec §7.4-7.5:

1. `OCROverlayExtractor.extract()` returns `list[ExtractedField]`
2. VLM fallback iterates those results, identifies fields below threshold
3. For qualifying fields, it needs the page image + field mapping to re-crop with padding
4. Returns updated `list[ExtractedField]` with VLM results replacing low-confidence OCR results

This means `VLMFieldExtractor` needs access to:
- The original `list[ExtractedField]` from OCR
- The `FormTemplate` (for field mappings, including `required` flag)
- Page images (for re-cropping with 10% padding)
- Config and VLM backend

**Two design options**:
1. **Standalone class** called after OCR extractor (cleaner separation)
2. **Integrated into OCR extractor** as a post-processing method

Option 1 is preferred — it follows the same pattern as the existing extractors (each is a standalone class) and keeps VLM logic isolated.

---

## 3. Implementation Plan

### 3.1 New File: `VLMFieldExtractor`

**File:** `packages/ingestkit-forms/src/ingestkit_forms/extractors/vlm_fallback.py`

**Class: `VLMFieldExtractor`**

Constructor:
```python
def __init__(self, vlm_backend: VLMBackend, config: FormProcessorConfig) -> None
```

Primary method:
```python
def apply_vlm_fallback(
    self,
    fields: list[ExtractedField],
    template: FormTemplate,
    page_images: dict[int, Image.Image],  # page_num -> rendered image
) -> list[ExtractedField]:
```

**Algorithm (from spec §7.5):**

1. **Guard**: If not `config.form_vlm_enabled` or `vlm_backend` is None, return fields unchanged.
2. **Availability check**: Call `vlm_backend.is_available()`. If False, log `E_FORM_VLM_UNAVAILABLE`, return fields unchanged.
3. **Identify candidates**: Filter fields where `confidence < config.form_vlm_fallback_threshold`.
4. **Priority sort**: Sort candidates by `(not required, confidence)` — required fields first, lowest confidence first.
5. **Budget**: Take first `config.form_vlm_max_fields_per_document` candidates. For remaining, append `W_FORM_VLM_BUDGET_EXHAUSTED` to their warnings.
6. **Process each candidate**:
   a. Look up `FieldMapping` from template by `field_id`.
   b. Get page image from `page_images[field.page_number]`.
   c. Crop with 10% padding via `_crop_field_region_with_padding()`.
   d. Convert to PNG bytes.
   e. Call `vlm_backend.extract_field(image_bytes, field_type, field_name, extraction_hint, timeout)`.
   f. On success: if VLM confidence >= `config.form_extraction_min_field_confidence`, create new `ExtractedField` with `extraction_method="vlm_fallback"`, VLM value/confidence. Otherwise, keep original OCR result.
   g. On timeout: log `E_FORM_VLM_TIMEOUT`, keep original OCR result.
   h. On any other error: log `E_FORM_VLM_UNAVAILABLE`, keep original OCR result.
   i. Always append `W_FORM_VLM_FALLBACK_USED` to warnings.
7. **Return**: Updated field list with VLM results replacing low-confidence OCR results where VLM improved.

**Private helpers in the same module:**

```python
def _crop_field_region_with_padding(
    page_image: Image.Image,
    region: BoundingBox,
    padding_pct: float = 0.10,
) -> Image.Image:
    """Crop field region with padding for VLM context (spec §7.5 step 1)."""
```

This extends the logic from `ocr_overlay._crop_field_region` but adds 10% padding on each side, clamped to image bounds.

### 3.2 Update: Extractors `__init__.py`

Add `VLMFieldExtractor` to exports:
```python
from ingestkit_forms.extractors.vlm_fallback import VLMFieldExtractor
__all__ = ["NativePDFExtractor", "OCROverlayExtractor", "VLMFieldExtractor"]
```

### 3.3 Integration Point

The caller (likely the form processing router/orchestrator) should:
1. Call `OCROverlayExtractor.extract()` to get OCR results
2. If `config.form_vlm_enabled`, create `VLMFieldExtractor` and call `apply_vlm_fallback()`
3. The page images rendered by `OCROverlayExtractor` need to be accessible

**Design consideration**: Currently `OCROverlayExtractor.extract()` renders page images internally and deletes them after use (`del page_image`). For VLM fallback, page images need to persist. Two approaches:
- **Option A**: Modify `OCROverlayExtractor.extract()` to optionally return page images alongside results (breaking change to return type).
- **Option B**: `VLMFieldExtractor.apply_vlm_fallback()` accepts `file_path` and re-renders only the pages needed for VLM candidates. This avoids modifying the OCR extractor but costs re-rendering.
- **Option C**: Add a new method to `OCROverlayExtractor` that returns both results and page images, keeping the existing `extract()` signature intact.

**Recommended**: Option B — re-render only pages with VLM candidates. VLM will process at most 10 fields (budget limit), and page rendering is fast (~100ms). This avoids any changes to the existing OCR extractor API and keeps the VLM module fully self-contained. The method signature becomes:

```python
def apply_vlm_fallback(
    self,
    fields: list[ExtractedField],
    template: FormTemplate,
    file_path: str,
) -> list[ExtractedField]:
```

The extractor internally renders only the pages needed using `get_page_image()` from `_rendering.py`.

### 3.4 Tests

**File:** `packages/ingestkit-forms/tests/test_extractors.py` (add to existing)

**Mock:** `_MockVLMBackend` following the pattern of `_MockOCRBackend`:
```python
class _MockVLMBackend:
    def __init__(self, default_value="extracted", default_confidence=0.85, available=True): ...
    def extract_field(self, image_bytes, field_type, field_name, extraction_hint=None, timeout=None) -> VLMFieldResult: ...
    def model_name(self) -> str: ...
    def is_available(self) -> bool: ...
```

**Test cases (minimum):**

| Test | Description | Priority |
|------|-------------|----------|
| `test_vlm_fallback_disabled` | `form_vlm_enabled=False` -> returns fields unchanged | P0 |
| `test_vlm_fallback_no_low_confidence_fields` | All fields above threshold -> no VLM calls | P0 |
| `test_vlm_fallback_improves_field` | Low-confidence OCR field + VLM returns high confidence -> field updated | P0 |
| `test_vlm_fallback_no_improvement` | VLM confidence < min threshold -> original OCR retained | P0 |
| `test_vlm_fallback_budget_exhausted` | 15 low-confidence fields, budget=10 -> first 10 processed, 5 get warning | P0 |
| `test_vlm_fallback_priority_required_first` | Required fields processed before optional, lowest confidence first | P0 |
| `test_vlm_fallback_timeout_graceful` | VLM raises TimeoutError -> original OCR retained, warning emitted | P0 |
| `test_vlm_fallback_error_graceful` | VLM raises Exception -> original OCR retained, warning emitted | P0 |
| `test_vlm_fallback_unavailable` | `is_available()` returns False -> all fields unchanged | P1 |
| `test_vlm_fallback_checkbox_field` | Checkbox field with low confidence -> VLM extracts bool value | P1 |
| `test_vlm_fallback_warnings_appended` | `W_FORM_VLM_FALLBACK_USED` appended to each processed field | P1 |
| `test_crop_with_padding` | Verify 10% padding applied, clamped to image bounds | P1 |
| `test_crop_with_padding_edge` | Field at image edge — padding doesn't exceed bounds | P1 |

---

## 4. Acceptance Criteria

- [ ] `VLMFieldExtractor` class in `extractors/vlm_fallback.py` with `apply_vlm_fallback()` method
- [ ] Trigger condition: field confidence < `form_vlm_fallback_threshold` (0.4) AND `form_vlm_enabled=True`
- [ ] Budget guard: max `form_vlm_max_fields_per_document` (10) fields, emit `W_FORM_VLM_BUDGET_EXHAUSTED` for overflow
- [ ] Priority: required fields first, lowest confidence first
- [ ] Graceful degradation: timeout/error returns original OCR result
- [ ] Field crop with 10% padding for VLM context
- [ ] `extraction_method="vlm_fallback"` on VLM-improved fields
- [ ] `W_FORM_VLM_FALLBACK_USED` warning on all VLM-processed fields
- [ ] `is_available()` check before processing; log `E_FORM_VLM_UNAVAILABLE` if not
- [ ] PII-safe logging (no extracted values unless `log_sample_data=True`)
- [ ] All VLM access via `VLMBackend` protocol only (no concrete imports)
- [ ] Unit tests cover all P0 cases with mock VLM backend
- [ ] No regressions in existing extractor tests
- [ ] `VLMFieldExtractor` exported from `extractors/__init__.py`

---

## 5. Risks & Mitigations

| Risk | Mitigation |
|------|------------|
| Re-rendering pages for VLM is redundant work | Budget cap (10 fields) limits re-renders; only unique pages re-rendered |
| VLM backend not injected when `form_vlm_enabled=True` | Guard clause: if backend is None, return unchanged + log warning |
| Page image not available for VLM (file moved/deleted) | Catch rendering exceptions, return original OCR result |

---

## 6. Dependencies & Blockers

- **No blockers**: All protocols, models, config fields, and error codes already exist.
- **Depends on**: `_rendering.get_page_image()` for page rendering (already implemented per issue #64).
- **Consumed by**: Form processing router/orchestrator (the caller must wire up VLM fallback after OCR extraction).

AGENT_RETURN: .agents/outputs/map-66-021526.md
