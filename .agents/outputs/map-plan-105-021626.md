# Implementation Plan: Issue #105 - Align Observability Log Event Patterns

**Issue**: Align observability log event patterns with spec section 14
**Spec Reference**: `specs/PLUGIN_API_SURFACE_v1.md` section 14 (lines 588-600)
**Date**: 2026-02-16

## Overview

Current implementation uses flat log strings like:
```python
logger.info("form_match stage=match template_candidates=%d...")
```

Spec section 14 requires structured log events with dot-separated patterns:
- `forms.match.*` (INFO/WARN) with `template_id, confidence, document_hash`
- `forms.extract.*` (INFO/ERROR) with `template_id, extraction_method, duration_s, field_count`
- `forms.write.*` (INFO/WARN) with `table_name, chunk_count, point_ids`
- `forms.redact.*` (INFO) with `field_count, patterns_matched`
- `forms.security.*` (WARN/ERROR) with `error_code, file_path`

## Log Calls to Change

### 1. packages/ingestkit-forms/src/ingestkit_forms/router.py

#### Line 146-150: match_document() fallthrough
**Current**:
```python
logger.info(
    "form_match stage=match template_candidates=0 "
    "top_confidence=0.000 match_duration_ms=0.0 "
    "match_result=fallthrough"
)
```
**New**:
```python
logger.info(
    "forms.match.fallthrough",
    extra={
        "template_candidates": 0,
        "confidence": 0.0,
        "match_duration_ms": 0.0,
        "document_hash": compute_document_hash(file_path),  # Add helper
    }
)
```

#### Line 160-168: match_document() result
**Current**:
```python
logger.info(
    "form_match stage=match template_candidates=%d "
    "top_confidence=%.3f match_duration_ms=%.1f "
    "match_result=%s",
    len(matches),
    top_confidence,
    duration_ms,
    match_result,
)
```
**New**:
```python
logger.info(
    f"forms.match.{match_result}",  # "forms.match.auto" or "forms.match.fallthrough"
    extra={
        "template_candidates": len(matches),
        "confidence": top_confidence,
        "match_duration_ms": duration_ms,
        "document_hash": compute_document_hash(file_path),  # Add helper
        "template_id": matches[0].template_id if matches else None,
    }
)
```

#### Line 289-294: extract_form() manual override match
**Current**:
```python
logger.info(
    "form_match stage=match template_candidates=1 "
    "top_confidence=1.000 match_duration_ms=%.1f "
    "match_result=manual",
    match_duration_ms,
)
```
**New**:
```python
logger.info(
    "forms.match.manual",
    extra={
        "template_id": template.template_id,
        "template_version": template.version,
        "confidence": 1.0,
        "match_duration_ms": match_duration_ms,
        "document_hash": compute_document_hash(request.file_path),  # Add helper
    }
)
```

#### Line 307-315: extract_form() auto-match result
**Current**:
```python
logger.info(
    "form_match stage=match template_candidates=%d "
    "top_confidence=%.3f match_duration_ms=%.1f "
    "match_result=%s",
    len(matches),
    top_conf,
    match_duration_ms,
    match_result_str,
)
```
**New**:
```python
logger.info(
    f"forms.match.{match_result_str}",  # "forms.match.auto" or "forms.match.fallthrough"
    extra={
        "template_candidates": len(matches),
        "confidence": top_conf,
        "match_duration_ms": match_duration_ms,
        "document_hash": compute_document_hash(request.file_path),  # Add helper
        "template_id": matches[0].template_id if matches else None,
    }
)
```

#### Line 353-363: extract_form() extraction completed
**Current**:
```python
logger.info(
    "form_extract stage=extract template_id=%s template_version=%d "
    "fields_extracted=%d fields_failed=%d extraction_method=%s "
    "extract_duration_ms=%.1f",
    template.template_id,
    template.version,
    len(fields) - fields_failed,
    fields_failed,
    extraction_method,
    extraction_duration * 1000.0,
)
```
**New**:
```python
logger.info(
    "forms.extract.completed",
    extra={
        "template_id": template.template_id,
        "template_version": template.version,
        "extraction_method": extraction_method,
        "duration_s": extraction_duration,
        "field_count": len(fields),
        "fields_extracted": len(fields) - fields_failed,
        "fields_failed": fields_failed,
    }
)
```

#### Line 367-372: extract_form() low confidence fail-closed
**Current**:
```python
logger.info(
    "Extraction confidence %.3f below threshold %.3f for '%s'",
    overall_confidence,
    cfg.form_extraction_min_overall_confidence,
    request.file_path,
)
```
**New**:
```python
logger.warning(
    "forms.extract.low_confidence",
    extra={
        "template_id": template.template_id,
        "template_version": template.version,
        "extraction_method": extraction_method,
        "duration_s": extraction_duration,
        "field_count": 0,  # No fields accepted due to low confidence
        "overall_confidence": overall_confidence,
        "threshold": cfg.form_extraction_min_overall_confidence,
    }
)
```

#### Line 230-235: try_match() exception fallthrough
**Current**:
```python
logger.warning(
    "try_match fallthrough due to exception for '%s'",
    file_path,
    exc_info=True,
)
```
**New**:
```python
logger.warning(
    "forms.match.error",
    extra={
        "document_hash": compute_document_hash(file_path),
        "error": str(exc),
    },
    exc_info=True,
)
```

#### Line 325-329: extract_form() matched template not found
**Current**:
```python
logger.warning(
    "Matched template %s v%d not found in store",
    best.template_id,
    best.template_version,
)
```
**New**:
```python
logger.warning(
    "forms.match.template_not_found",
    extra={
        "template_id": best.template_id,
        "template_version": best.template_version,
        "document_hash": compute_document_hash(request.file_path),  # Add helper
    }
)
```

### 2. packages/ingestkit-forms/src/ingestkit_forms/output/dual_writer.py

No log calls found that match the `forms.write.*` pattern requirement. Need to add structured logging for dual-write results.

**Add after line 220 (DB write success)**:
```python
logger.info(
    "forms.write.db_success",
    extra={
        "table_name": table_name,
        "template_id": extraction.template_id,
        "form_id": form_id,
    }
)
```

**Add after line 231 (DB write failure)**:
```python
logger.error(
    "forms.write.db_failed",
    extra={
        "template_id": extraction.template_id,
        "error_code": FormErrorCode.E_FORM_DB_WRITE_FAILED.value,
        "error": msg,
    }
)
```

**Add after line 241 (Chunk write success)**:
```python
logger.info(
    "forms.write.chunks_success",
    extra={
        "collection": config.default_collection,
        "chunk_count": len(point_ids),
        "point_ids": point_ids[:10],  # Sample first 10
        "template_id": extraction.template_id,
    }
)
```

**Add after line 252 (Chunk write failure)**:
```python
logger.error(
    "forms.write.chunks_failed",
    extra={
        "collection": config.default_collection,
        "template_id": extraction.template_id,
        "error_code": FormErrorCode.E_FORM_CHUNK_WRITE_FAILED.value,
        "error": msg,
    }
)
```

**Add after line 262 (Partial write warning)**:
```python
logger.warning(
    "forms.write.partial",
    extra={
        "template_id": extraction.template_id,
        "db_success": db_success,
        "chunk_success": chunk_success,
        "error_code": FormErrorCode.E_FORM_DUAL_WRITE_PARTIAL.value,
    }
)
```

### 3. packages/ingestkit-forms/src/ingestkit_forms/matcher.py

#### Line 531-535: match_document() invalid fingerprint skip
**Current**:
```python
logger.warning(
    "Skipping template %s v%d: invalid fingerprint",
    tmpl_id,
    tmpl_version,
)
```
**New**:
```python
logger.warning(
    "forms.match.invalid_fingerprint",
    extra={
        "template_id": tmpl_id,
        "template_version": tmpl_version,
    }
)
```

### 4. packages/ingestkit-forms/src/ingestkit_forms/output/chunk_writer.py

#### Line 278-284: Embed retry warning
**Current**:
```python
logger.warning(
    "Embed attempt %d/%d failed: %s. Retrying in %.1fs.",
    attempt + 1,
    max_attempts,
    exc,
    sleep_time,
)
```
**New**:
```python
logger.warning(
    "forms.write.embed_retry",
    extra={
        "attempt": attempt + 1,
        "max_attempts": max_attempts,
        "retry_delay_s": sleep_time,
        "error": str(exc),
    }
)
```

#### Line 311-317: Upsert retry warning
**Current**:
```python
logger.warning(
    "Upsert attempt %d/%d failed: %s. Retrying in %.1fs.",
    attempt + 1,
    max_attempts,
    exc,
    sleep_time,
)
```
**New**:
```python
logger.warning(
    "forms.write.upsert_retry",
    extra={
        "collection": collection,
        "attempt": attempt + 1,
        "max_attempts": max_attempts,
        "retry_delay_s": sleep_time,
        "error": str(exc),
    }
)
```

### 5. packages/ingestkit-forms/src/ingestkit_forms/output/db_writer.py

#### Line 177: Table creation debug log
**Current**:
```python
logger.debug("Created table %s for template %s", table_name, template.name)
```
**New**:
```python
logger.info(
    "forms.write.table_created",
    extra={
        "table_name": table_name,
        "template_id": template.template_id,
        "template_name": template.name,
    }
)
```

#### Line 208-212: Schema evolution warning
**Current**:
```python
logger.warning(
    "W_FORM_SCHEMA_EVOLVED: Table %s evolved, added columns: %s",
    table_name,
    added,
)
```
**New**:
```python
logger.warning(
    "forms.write.schema_evolved",
    extra={
        "table_name": table_name,
        "columns_added": added,
        "column_count": len(added),
    }
)
```

#### Line 256-263: DB write retry warning
**Current**:
```python
logger.warning(
    "DB write attempt %d/%d failed for %s: %s. Retrying in %.1fs.",
    attempt + 1,
    max_attempts,
    table_name,
    exc,
    sleep_time,
)
```
**New**:
```python
logger.warning(
    "forms.write.db_retry",
    extra={
        "table_name": table_name,
        "attempt": attempt + 1,
        "max_attempts": max_attempts,
        "retry_delay_s": sleep_time,
        "error": str(exc),
    }
)
```

## Additional Requirements

### Helper Function Needed

Add to `packages/ingestkit-forms/src/ingestkit_forms/router.py`:

```python
def compute_document_hash(file_path: str) -> str:
    """Compute SHA256 hash of document for logging/dedup."""
    import hashlib
    with open(file_path, 'rb') as f:
        return hashlib.sha256(f.read()).hexdigest()[:16]  # First 16 chars
```

### Missing Log Events (Not Currently Implemented)

Per spec section 14, these events should exist but are not yet implemented:

1. **`forms.redact.*`** (INFO) - Not found in current codebase. Redaction happens in `dual_writer.py` via `redact_extraction()` but is not logged.

   **Add to `dual_writer.py` after line 82**:
   ```python
   if redacted != extraction:  # Redaction occurred
       redacted_count = sum(1 for f in redacted.fields if f.redacted)
       logger.info(
           "forms.redact.applied",
           extra={
               "template_id": extraction.template_id,
               "field_count": redacted_count,
               "patterns_matched": len(config.redact_patterns),
               "destination": destination,
           }
       )
   ```

2. **`forms.security.*`** (WARN/ERROR) - Security scanner is not yet implemented in the forms package (referenced in spec but not present in code).

## Summary Statistics

- **Files to modify**: 4
  - `router.py`: 9 log calls to change + 1 helper function to add
  - `dual_writer.py`: 0 existing calls to change, 6 new log calls to add
  - `matcher.py`: 1 log call to change
  - `chunk_writer.py`: 2 log calls to change
  - `db_writer.py`: 3 log calls to change

- **Total log calls**: 21 (15 to change, 6 to add)

## Implementation Notes

1. All log events now use dot-separated event patterns (`forms.{stage}.{event}`)
2. All structured data moved to `extra={}` dict for clean log ingestion
3. `document_hash` will be computed from file content SHA256 (first 16 chars)
4. Duration fields standardized: `duration_s` for seconds (spec requirement)
5. Match duration kept as `match_duration_ms` for consistency with existing metrics
6. Level changes:
   - Low confidence extraction: INFO → WARNING (fail-closed event)
   - Table creation: DEBUG → INFO (meaningful state change)

## Testing Approach

1. Unit tests should verify log event names and `extra` dict keys
2. Use `caplog` fixture to capture structured log output
3. Verify all spec-required fields are present in `extra` dict
4. Test both success and error paths for each event type
