---
issue: 57
agent: MAP
date: 2026-02-15
complexity: COMPLEX
stack: backend
---

# MAP: Issue #57 -- Implement Form Data Models (Pydantic v2)

## 1. Executive Summary

Issue #57 requires implementing all Pydantic v2 data models for the `ingestkit-forms` plugin, covering template definitions, matching, extraction results, processing results, request/response, chunk, and rollback models. The spec (§5, §6, §8, §9, §10) provides complete Python code for all models. Key risks are: (1) the spec's `FormTemplate.Config` uses Pydantic v1 `json_encoders` pattern which must be migrated to v2 `model_config`, (2) `SourceFormat` enum values must be lowercase strings ("pdf", "xlsx", "image"), and (3) the spec's `WrittenArtifacts` and `EmbedStageResult` in §10.2 duplicate core models but with extra fields (`db_row_ids`) -- the forms package must extend core, not redefine. Six models from `ingestkit-core` can be reused directly.

---

## 2. Spec Analysis -- All Required Models

### 2.1 Template Models (§5.1)

| Model | Spec Location | Fields | Notes |
|-------|--------------|--------|-------|
| `SourceFormat` | §5.1 line 305-310 | `PDF="pdf"`, `XLSX="xlsx"`, `IMAGE="image"` | **ENUM_VALUE risk**: values are lowercase strings. Use `str, Enum` pattern. |
| `FieldType` | §5.1 line 313-322 | `TEXT="text"`, `NUMBER="number"`, `DATE="date"`, `CHECKBOX="checkbox"`, `RADIO="radio"`, `SIGNATURE="signature"`, `DROPDOWN="dropdown"` | 7 values, all lowercase |
| `BoundingBox` | §5.1 line 325-336 | `x`, `y` (ge=0, le=1), `width`, `height` (gt=0, le=1) | Normalized 0.0-1.0 coordinates |
| `CellAddress` | §5.1 line 339-350 | `cell: str`, `sheet_name: str | None` | Excel cell reference, e.g. "B2" or "D5:D7" |
| `FieldMapping` | §5.1 line 353-399 + §5.2 line 470-492 | 11 fields: `field_id` (uuid default), `field_name`, `field_label`, `field_type`, `page_number` (ge=0), `region`, `cell_address`, `required`, `validation_pattern`, `default_value`, `options`, `extraction_hint` | Needs `model_validator(mode="after")` for mutual exclusivity of `region`/`cell_address` |
| `FormTemplate` | §5.1 line 402-455 | 13 fields: `template_id` (uuid), `name`, `description`, `version` (ge=1), `source_format`, `page_count` (ge=1), `fields` (min_length=1), `layout_fingerprint: bytes | None`, `thumbnail: bytes | None`, `created_at`, `updated_at`, `created_by`, `tenant_id` | **VERIFICATION_GAP**: Spec uses `class Config: json_encoders = {...}` which is Pydantic v1. Must use `model_config = ConfigDict(...)` in v2. |

### 2.2 Matching Models (§6.2, §6.3)

| Model | Spec Location | Fields | Notes |
|-------|--------------|--------|-------|
| `TemplateMatch` | §6.2 line 620-638 | `template_id`, `template_name`, `template_version`, `confidence` (ge=0, le=1), `per_page_confidence: list[float]`, `matched_features: list[str]` | Straightforward |
| `FormIngestRequest` | §6.3 line 654-669 | `file_path`, `template_id: str | None`, `template_version: int | None`, `tenant_id: str | None`, `source_uri: str | None`, `metadata: dict[str, str] | None` | Request model for manual override path |

### 2.3 Extraction Result Models (§10.1)

| Model | Spec Location | Fields | Notes |
|-------|--------------|--------|-------|
| `ExtractedField` | §10.1 line 1407-1440 | `field_id`, `field_name`, `field_label`, `field_type`, `value: str | bool | float | None`, `raw_value: str | None`, `confidence` (ge=0, le=1), `extraction_method`, `bounding_box: BoundingBox | None`, `validation_passed: bool | None`, `warnings: list[str]` | 11 fields |
| `FormExtractionResult` | §10.1 line 1443-1473 | `form_id` (uuid), `template_id`, `template_name`, `template_version`, `source_uri`, `source_format`, `fields: list[ExtractedField]`, `overall_confidence`, `extraction_method`, `match_method`, `match_confidence: float | None`, `pages_processed`, `extraction_duration_seconds`, `warnings: list[str]` | 14 fields. Needs `uuid` import for `form_id` default_factory. |

### 2.4 Processing Result Models (§10.2)

| Model | Spec Location | Fields | Notes |
|-------|--------------|--------|-------|
| `DualWriteMode` | §8.0 line 986-989 | `BEST_EFFORT="best_effort"`, `STRICT_ATOMIC="strict_atomic"` | `str, Enum` |
| `FormProcessingResult` | §10.2 line 1479-1502 | `file_path`, `ingest_key`, `ingest_run_id`, `tenant_id`, `extraction_result: FormExtractionResult`, `embed_result: EmbedStageResult | None`, `chunks_created`, `tables_created`, `tables: list[str]`, `written: WrittenArtifacts`, `errors: list[str]`, `warnings: list[str]`, `error_details: list[IngestError]`, `processing_time_seconds` | References `EmbedStageResult` and `WrittenArtifacts` from core -- see §3 below. |

### 2.5 Request/Response Models (§9.2)

| Model | Spec Location | Fields | Notes |
|-------|--------------|--------|-------|
| `FormTemplateCreateRequest` | §9.2 line 1360-1372 | `name`, `description`, `source_format`, `sample_file_path`, `page_count` (ge=1), `fields` (min_length=1), `tenant_id`, `created_by` | |
| `FormTemplateUpdateRequest` | §9.2 line 1375-1385 | All optional: `name`, `description`, `sample_file_path`, `page_count`, `fields` | |
| `ExtractionPreview` | §9.2 line 1388-1397 | `template_id`, `template_name`, `template_version`, `fields: list[ExtractedField]`, `overall_confidence`, `extraction_method`, `warnings: list[str]` | |

### 2.6 Chunk Models (§8.3, §8.4)

| Model | Spec Location | Fields | Notes |
|-------|--------------|--------|-------|
| `FormChunkMetadata` | §8.3 line 1117-1155 | 19 fields total. Standard: `source_uri`, `source_format`, `ingestion_method="form_extraction"`, `parser_version`, `chunk_index`, `chunk_hash`, `ingest_key`, `ingest_run_id`, `tenant_id`. Form-specific: `template_id`, `template_name`, `template_version`, `form_id`, `field_names`, `extraction_method`, `overall_confidence`, `per_field_confidence`, `form_date`, `page_numbers`, `match_method` | Should extend `BaseChunkMetadata` from core (10 standard fields overlap). See §3. |
| `FormChunkPayload` | §8.4 line 1161-1167 | `id`, `text`, `vector: list[float]`, `metadata: FormChunkMetadata` | Mirrors `ChunkPayload` from core but with `FormChunkMetadata`. |

### 2.7 Rollback Models (§8.5)

| Model | Spec Location | Fields | Notes |
|-------|--------------|--------|-------|
| `RollbackResult` | §8.5 line 1175-1181 | `vector_points_deleted: int = 0`, `db_rows_deleted: int = 0`, `errors: list[str] = []`, `fully_rolled_back: bool = True` | |

---

## 3. Reuse from ingestkit-core

### 3.1 Models to Import Directly (no extension needed)

| Core Model | Location | Usage in forms |
|-----------|----------|---------------|
| `IngestKey` | `ingestkit_core.models` | Used for idempotency keying (same pattern as Excel) |
| `EmbedStageResult` | `ingestkit_core.models` | Referenced by `FormProcessingResult.embed_result` |
| `ClassificationTier` | `ingestkit_core.models` | Not directly used by forms models, but may be needed elsewhere |

### 3.2 Models to Extend

| Core Model | Extension Needed | Rationale |
|-----------|-----------------|-----------|
| `BaseChunkMetadata` | `FormChunkMetadata` should subclass `BaseChunkMetadata`, adding 10 form-specific fields | Core has 13 fields; spec's `FormChunkMetadata` overlaps on 9 standard fields (`source_uri`, `source_format`, `ingestion_method`, `parser_version`, `chunk_index`, `chunk_hash`, `ingest_key`, `ingest_run_id`, `tenant_id`). Core also has `table_name`, `row_count`, `columns`, `section_title` which forms doesn't use -- acceptable to inherit and leave `None`. |
| `WrittenArtifacts` | Spec §10.2 adds `db_row_ids: list[str] = []` field not in core. Must extend core's `WrittenArtifacts` with this field. | Core has `vector_point_ids`, `vector_collection`, `db_table_names`. Spec adds `db_row_ids` for form-level row tracking. |
| `BaseIngestError` | Forms needs its own `IngestError` variant (like Excel has `sheet_name`, PDF has `page_number`). Spec §10.2 references `IngestError` in `FormProcessingResult.error_details`. | Need to define `FormIngestError(BaseIngestError)` with form-specific location fields (e.g., `template_id`, `field_name`). |

### 3.3 Core `ChunkPayload` vs Forms `FormChunkPayload`

The core `ChunkPayload` has `metadata: BaseChunkMetadata`. The forms spec defines `FormChunkPayload` with `metadata: FormChunkMetadata`. Since `FormChunkMetadata` extends `BaseChunkMetadata`, we should define a separate `FormChunkPayload` (not reuse core's) to get proper type hints. This follows the same pattern as Excel's `ChunkMetadata` approach.

---

## 4. Pydantic v2 Migration Issues

### 4.1 FormTemplate.Config (VERIFICATION_GAP -- CONFIRMED)

The spec (§5.1 line 451-455) uses Pydantic v1 patterns:

```python
class Config:
    """Pydantic v2 model configuration."""
    json_encoders = {
        bytes: lambda v: v.hex() if v else None,
    }
```

**Problem**: `json_encoders` is a Pydantic v1 config option. In v2, this should be handled via:
- `model_config = ConfigDict(...)` (class-level config)
- Custom serializers via `@field_serializer` for the `bytes` fields

**Required fix**: Replace with:

```python
from pydantic import field_serializer, ConfigDict

class FormTemplate(BaseModel):
    model_config = ConfigDict(arbitrary_types_allowed=True)
    # ... fields ...

    @field_serializer("layout_fingerprint", "thumbnail")
    @classmethod
    def _serialize_bytes(cls, v: bytes | None) -> str | None:
        return v.hex() if v else None
```

### 4.2 datetime.utcnow Deprecation

The spec uses `default_factory=datetime.utcnow`. In Python 3.12+, `datetime.utcnow()` is deprecated. For forward compatibility, use `datetime.now(tz=timezone.utc)`. However, since the project requires Python >=3.10, either approach works. Follow the spec for now but use `datetime.now(timezone.utc)` as a minor improvement.

---

## 5. WrittenArtifacts Extension Strategy

The core `WrittenArtifacts` (3 fields):
```python
vector_point_ids: list[str] = []
vector_collection: str | None = None
db_table_names: list[str] = []
```

The spec's version (§10.2) adds:
```python
db_row_ids: list[str] = []
```

**Strategy**: Create `FormWrittenArtifacts(WrittenArtifacts)` extending core with the additional field. Reference this in `FormProcessingResult.written`.

---

## 6. Enum Value Risk Assessment (ENUM_VALUE Pattern)

| Enum | Values | Risk | Verification |
|------|--------|------|-------------|
| `SourceFormat` | `"pdf"`, `"xlsx"`, `"image"` | HIGH -- lowercase strings, not Python-name-style | Spec §5.1 line 308-310 confirms lowercase. Use `PDF = "pdf"`, not `PDF = "PDF"`. |
| `FieldType` | `"text"`, `"number"`, `"date"`, `"checkbox"`, `"radio"`, `"signature"`, `"dropdown"` | MEDIUM -- all lowercase | Spec §5.1 line 316-322 confirms. |
| `DualWriteMode` | `"best_effort"`, `"strict_atomic"` | LOW -- snake_case values | Spec §8.0 line 988-989 confirms. |

---

## 7. Complete Model Inventory (21 models)

| # | Model | Category | New / Reuse | Extends |
|---|-------|----------|-------------|---------|
| 1 | `SourceFormat` | Enum | NEW | `str, Enum` |
| 2 | `FieldType` | Enum | NEW | `str, Enum` |
| 3 | `DualWriteMode` | Enum | NEW | `str, Enum` |
| 4 | `BoundingBox` | Template | NEW | `BaseModel` |
| 5 | `CellAddress` | Template | NEW | `BaseModel` |
| 6 | `FieldMapping` | Template | NEW | `BaseModel` + validator |
| 7 | `FormTemplate` | Template | NEW | `BaseModel` + v2 serializer |
| 8 | `TemplateMatch` | Matching | NEW | `BaseModel` |
| 9 | `FormIngestRequest` | Matching | NEW | `BaseModel` |
| 10 | `ExtractedField` | Extraction | NEW | `BaseModel` |
| 11 | `FormExtractionResult` | Extraction | NEW | `BaseModel` |
| 12 | `FormProcessingResult` | Processing | NEW | `BaseModel` |
| 13 | `FormWrittenArtifacts` | Processing | NEW | `WrittenArtifacts` (core) |
| 14 | `FormTemplateCreateRequest` | Request | NEW | `BaseModel` |
| 15 | `FormTemplateUpdateRequest` | Request | NEW | `BaseModel` |
| 16 | `ExtractionPreview` | Response | NEW | `BaseModel` |
| 17 | `FormChunkMetadata` | Chunk | NEW | `BaseChunkMetadata` (core) |
| 18 | `FormChunkPayload` | Chunk | NEW | `BaseModel` |
| 19 | `RollbackResult` | Rollback | NEW | `BaseModel` |
| 20 | `FormIngestError` | Error | NEW | `BaseIngestError` (core) |
| 21 | `IngestKey` | Idempotency | REUSE | import from core |
| 22 | `EmbedStageResult` | Stage | REUSE | import from core |

**Total**: 19 new models/enums + 1 extended + 2 reused from core = 22 types.

---

## 8. File Structure Recommendation

The `ingestkit-forms` package does not exist yet. The models module should be created at:

```
packages/ingestkit-forms/src/ingestkit_forms/models.py
```

Following the `ingestkit-excel` pattern (see `/home/jjob/projects/ingestkit/packages/ingestkit-excel/src/ingestkit_excel/models.py`), all models go in a single `models.py` file, organized into sections:

1. Enumerations (`SourceFormat`, `FieldType`, `DualWriteMode`)
2. Template Models (`BoundingBox`, `CellAddress`, `FieldMapping`, `FormTemplate`)
3. Matching Models (`TemplateMatch`, `FormIngestRequest`)
4. Extraction Models (`ExtractedField`, `FormExtractionResult`)
5. Chunk Models (`FormChunkMetadata`, `FormChunkPayload`)
6. Result Models (`FormWrittenArtifacts`, `FormProcessingResult`, `RollbackResult`)
7. Request/Response Models (`FormTemplateCreateRequest`, `FormTemplateUpdateRequest`, `ExtractionPreview`)
8. Error Model (`FormIngestError`)
9. Re-exports from core (`IngestKey`, `EmbedStageResult`, `WrittenArtifacts`, `BaseChunkMetadata`)

---

## 9. Dependencies for models.py

```python
from __future__ import annotations

import uuid
from datetime import datetime, timezone
from enum import Enum

from pydantic import BaseModel, ConfigDict, Field, field_serializer, model_validator

from ingestkit_core.models import (
    BaseChunkMetadata,
    EmbedStageResult,
    IngestKey,
    WrittenArtifacts,
)
from ingestkit_core.errors import BaseIngestError
```

---

## 10. Open Questions for PLAN

1. **Package scaffolding**: Should PATCH also create the minimal `pyproject.toml`, `__init__.py`, `errors.py` for `ingestkit-forms`, or is the scope limited strictly to `models.py`? The issue says "All Pydantic v2 data models" which suggests `models.py` only, but models reference `IngestError` which needs a forms-specific error module.

2. **FormIngestError fields**: The spec's `FormProcessingResult.error_details` references `IngestError` without specifying form-specific fields. The PLAN should decide: use `BaseIngestError` directly, or define `FormIngestError` with fields like `template_id`, `field_name`, `page_number`.

3. **Test scope**: The issue mentions no test requirements, but project rules say "Every public function/method must have unit tests." All models here are declarative (no methods except validators). Tests should cover: serialization round-trips, validator behavior (`FieldMapping` mutual exclusivity), enum value correctness, `FormTemplate` bytes serialization, and `FormWrittenArtifacts` inheritance.

AGENT_RETURN: .agents/outputs/map-57-021526.md
