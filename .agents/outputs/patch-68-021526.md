---
issue: 68
agent: PATCH
date: 2026-02-15
status: Complete
files_modified: 4
files_created: 1
tests_added: 43
lines_added: ~1,350
lines_removed: ~10
---

# PATCH: Issue #68 -- Implement dual-write output (DB rows and RAG chunks)

## Executive Summary

Implemented the complete dual-write output system for ingestkit-forms across 7 files: `FormDBBackend` protocol, DB row writer with schema evolution and retry, RAG chunk writer with embedding and upsert, dual writer with consistency modes (best_effort/strict_atomic) and PII redaction, mock backends for testing, and 43 unit tests. All PLAN-CHECK corrections applied. Zero regressions in the full 417-test suite.

## Metrics

| Metric | Value |
|--------|-------|
| Files modified | 4 (protocols.py, output/__init__.py, tests/conftest.py, tests/test_output.py) |
| Files created | 3 (output/db_writer.py, output/chunk_writer.py, output/dual_writer.py) |
| Tests added | 43 |
| Tests passing | 417 (full suite) |
| Ruff errors | 0 |

## Files Changed

### `protocols.py` -- Added `FormDBBackend` protocol
- 5 methods: `execute_sql`, `get_table_columns`, `delete_rows`, `table_exists`, `get_connection_uri`
- Added to `__all__`; docstring explains why this lives in ingestkit-forms rather than core

### `output/db_writer.py` -- Full implementation from stub
- Constants: `FIELD_TYPE_TO_SQL` (7 mappings), `METADATA_COLUMNS` (10 columns)
- Helpers: `slugify_template_name`, `get_table_name`, `generate_table_schema`, `build_row_dict`
- `FormDBWriter` class: `ensure_table`, `evolve_schema`, `write_row` with retry

### `output/chunk_writer.py` -- Full implementation from stub
- Helpers: `serialize_field_value`, `serialize_form_to_text`, `split_fields_into_chunks`, `build_chunk_metadata`
- `FormChunkWriter` class: `write_chunks` with embed retry and upsert retry
- Chunk IDs: deterministic via `uuid.uuid5(NAMESPACE_URL, "{ingest_key}:{chunk_hash}")`

### `output/dual_writer.py` -- New file
- Redaction: `apply_redaction`, `redact_extraction` (deep copy, never mutates original)
- `rollback_written_artifacts` module-level function (vector first, then DB)
- `FormDualWriter` class: orchestrates DB + chunk writes with strict_atomic/best_effort modes

### `output/__init__.py` -- Public exports
- Exports: `FormDBWriter`, `FormChunkWriter`, `FormDualWriter`, `rollback_written_artifacts`

### `tests/conftest.py` -- Mock backends and fixtures
- `MockFormDBBackend`: in-memory dict storage, SQL parsing for CREATE/ALTER/INSERT
- `MockVectorStoreBackend`: in-memory collection storage
- `MockEmbeddingBackend`: deterministic vectors
- `make_extracted_field`, `make_extraction_result` factory helpers
- Fixtures: `mock_form_db`, `mock_vector_store`, `mock_embedder`, `output_config`

### `tests/test_output.py` -- 43 unit tests
- DB Writer: 16 tests (slugify, schema, row building, retry)
- Chunk Writer: 12 tests (serialization, splitting, embedding, determinism)
- Dual Writer: 15 tests (both modes, rollback, redaction)

## PLAN-CHECK Corrections Applied

1. **ISSUE-1 (MEDIUM)**: `split_fields_into_chunks` accepts `FormTemplate` parameter and looks up page numbers from template `FieldMapping` objects by `field_id`. `ExtractedField` model unchanged.
2. **ISSUE-2 (LOW)**: `evolve_schema` queries DB columns instead of old_template -- documented as intentional improvement in docstring.
3. **ISSUE-3 (LOW)**: `rollback_written_artifacts` includes `config` parameter -- documented as intentional extension in docstring.

## Deviations from PLAN

- `FormChunkWriter.write_chunks` signature includes `template` parameter (needed for page number lookup per ISSUE-1 fix). The dual writer passes the template through.
- `build_chunk_metadata` also accepts `template` parameter for the same reason.
- Test count is 43 (plan estimated 42) -- one additional test for signature coercion.

## Verification

```
ruff check: All checks passed
pytest test_output.py: 43 passed in 0.07s
pytest full suite: 417 passed in 5.56s (zero regressions)
Import check: OK
```

## Acceptance Criteria Status

All criteria met. See plan-68-021526.md for full list.

---
AGENT_RETURN: .agents/outputs/patch-68-021526.md
