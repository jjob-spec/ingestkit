---
issue: 101
agent: MAP-PLAN
date: 2026-02-16
complexity: SIMPLE
stack: backend
---

# MAP-PLAN: Align TemplateMatch model with spec (add source_format, page_alignment)

## Executive Summary

The `TemplateMatch` model in `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/models.py` is missing two required fields per spec section 3.7: `source_format: SourceFormat` and `page_alignment: dict`. The existing `per_page_confidence: list[float]` and `matched_features: list[str]` fields are useful extensions and will be preserved. Implementation requires: (1) adding two new fields to the model with appropriate descriptions, (2) updating `FormMatcher.match_document()` to populate these fields with data already available from `detect_source_format()` and `_windowed_match()`, and (3) updating the `try_match()` method in FormRouter if needed.

## 1. Investigation Findings

### 1.1 Current TemplateMatch Model

File: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/models.py` (lines 251-271)

**Current implementation:**
```python
class TemplateMatch(BaseModel):
    """Result of matching a document against a single template."""

    template_id: str
    template_name: str
    template_version: int
    confidence: float = Field(
        ge=0.0,
        le=1.0,
        description="Overall match confidence.",
    )
    per_page_confidence: list[float] = Field(
        description="Per-page similarity scores.",
    )
    matched_features: list[str] = Field(
        description=(
            "Which features contributed to the match: "
            "'layout_grid', 'text_anchors', 'field_positions'."
        ),
    )
```

**Fields present**: 6 fields
**Missing per spec**: `source_format`, `page_alignment`
**Extra fields not in spec**: `per_page_confidence`, `matched_features` (these are useful diagnostics)

### 1.2 Spec Requirements (Section 3.7)

File: `/home/jjob/projects/ingestkit/specs/PLUGIN_API_SURFACE_v1.md` (lines 222-231)

**Spec definition:**
```python
class TemplateMatch(BaseModel):
    template_id: str
    template_name: str
    template_version: int
    confidence: float
    source_format: SourceFormat
    page_alignment: dict        # Window offset info
```

**Required additions:**
- `source_format: SourceFormat` - The format of the matched template (PDF, XLSX, IMAGE)
- `page_alignment: dict` - Window offset information from windowed matching

### 1.3 Where TemplateMatch is Constructed

File: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/matcher.py` (lines 548-558)

**Construction site in `FormMatcher.match_document()`:**
```python
confidence, per_page_scores, _window_start = result
if confidence >= _WARNING_FLOOR:
    matches.append(
        TemplateMatch(
            template_id=tmpl_id,
            template_name=tmpl_name,
            template_version=tmpl_version,
            confidence=confidence,
            per_page_confidence=per_page_scores,
            matched_features=["layout_grid"],
        )
    )
```

**Available data at construction:**
- `source_format` - Already detected at line 501 via `detect_source_format(file_path)`
- `_window_start` - Returned from `_windowed_match()` at line 547 (currently unused, but contains window offset)

### 1.4 Window Alignment Details

File: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/matcher.py` (lines 388-448)

The `_windowed_match()` function returns a tuple:
```python
return (confidence, per_page_scores, best_start)
```

Where `best_start` is the index in the document pages where the template match begins. This is the "window offset" that should populate `page_alignment`.

**Semantic meaning:**
- `best_start = 0`: Template matches starting from first page of document
- `best_start = 2`: Template matches starting from page 3 of document (0-indexed)
- Document has D pages, template has T pages
- If D > T, the window slides across document
- `best_start` indicates which window position had the best match

### 1.5 FormRouter.try_match() Usage

File: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/router.py`

Need to check if `try_match()` method relies on current TemplateMatch structure or if it will handle new fields transparently.

## 2. Implementation Plan

### 2.1 Update TemplateMatch Model

**File**: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/models.py`
**Lines**: 251-271

**Changes:**
1. Add `source_format: SourceFormat` field after line 257 (after `template_version`)
2. Add `page_alignment: dict` field after `confidence` (after line 262)
3. Keep existing `per_page_confidence` and `matched_features` as extensions

**New model structure (lines 251-279):**
```python
class TemplateMatch(BaseModel):
    """Result of matching a document against a single template."""

    template_id: str
    template_name: str
    template_version: int
    source_format: SourceFormat = Field(
        description="File format of the matched template (PDF, XLSX, or IMAGE).",
    )
    confidence: float = Field(
        ge=0.0,
        le=1.0,
        description="Overall match confidence.",
    )
    page_alignment: dict = Field(
        description=(
            "Window alignment information. Keys: 'window_start' (int, 0-indexed page "
            "where template match begins), 'template_pages' (int), 'document_pages' (int)."
        ),
    )
    per_page_confidence: list[float] = Field(
        description="Per-page similarity scores (extension beyond spec).",
    )
    matched_features: list[str] = Field(
        description=(
            "Which features contributed to the match (extension beyond spec): "
            "'layout_grid', 'text_anchors', 'field_positions'."
        ),
    )
```

**Rationale for page_alignment structure:**
The spec says "Window offset info" but doesn't specify dict keys. We define a clear structure:
- `window_start`: 0-indexed page offset where match begins
- `template_pages`: Number of pages in template (for context)
- `document_pages`: Number of pages in document (for context)

This provides enough information for consumers to understand where in a multi-page document the template matched.

### 2.2 Update FormMatcher.match_document()

**File**: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/matcher.py`
**Lines**: 485-561

**Changes:**

1. Capture `source_format` variable already computed at line 501
2. Capture `window_start` from `_windowed_match()` result (currently discarded with `_window_start`)
3. Calculate `template_pages` and `document_pages` counts
4. Pass these to TemplateMatch constructor

**Specific edits:**

**Edit 1**: Line 501 - Store source_format in a variable accessible in the loop
- Currently: `source_format = detect_source_format(file_path)` (line 501)
- This is already available, just need to pass it to TemplateMatch constructor

**Edit 2**: Line 547 - Use `window_start` instead of `_window_start`
```python
# Current (line 547):
confidence, per_page_scores, _window_start = result

# New:
confidence, per_page_scores, window_start = result
```

**Edit 3**: Lines 526-558 - Calculate page counts and build page_alignment dict
```python
# After line 528 (after deserializing template pages):
tmpl_page_count = len(tmpl_pages)

# After line 547 (after getting result):
confidence, per_page_scores, window_start = result
doc_page_count = len(doc_pages)

# In TemplateMatch constructor (lines 549-558), add new fields:
if confidence >= _WARNING_FLOOR:
    matches.append(
        TemplateMatch(
            template_id=tmpl_id,
            template_name=tmpl_name,
            template_version=tmpl_version,
            source_format=source_format,  # NEW
            confidence=confidence,
            page_alignment={              # NEW
                "window_start": window_start,
                "template_pages": tmpl_page_count,
                "document_pages": doc_page_count,
            },
            per_page_confidence=per_page_scores,
            matched_features=["layout_grid"],
        )
    )
```

### 2.3 Verify FormRouter.try_match() Compatibility

**File**: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/router.py`

**Action**: Read the `try_match()` method implementation to ensure it doesn't make assumptions about TemplateMatch structure that would break with new fields.

**Expected**: Since we're adding fields to a Pydantic model (not changing existing ones), any code that accesses `TemplateMatch` attributes should continue working. The new fields will be present but won't break existing access patterns.

**Verification**: Check if `try_match()` accesses any TemplateMatch attributes directly or just passes the object through.

### 2.4 Update __all__ Export if Needed

**File**: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/models.py`
**Line**: 539

**Action**: Verify `TemplateMatch` is already in `__all__` list (it is, line 539).

**No changes needed** - TemplateMatch is already exported.

## 3. File-by-File Implementation Steps

### File 1: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/models.py`

**Step 1.1**: Add `source_format` field (after line 257)
```python
    template_version: int
    source_format: SourceFormat = Field(
        description="File format of the matched template (PDF, XLSX, or IMAGE).",
    )
    confidence: float = Field(
```

**Step 1.2**: Add `page_alignment` field (after line 262)
```python
    confidence: float = Field(
        ge=0.0,
        le=1.0,
        description="Overall match confidence.",
    )
    page_alignment: dict = Field(
        description=(
            "Window alignment information. Keys: 'window_start' (int, 0-indexed page "
            "where template match begins), 'template_pages' (int), 'document_pages' (int)."
        ),
    )
    per_page_confidence: list[float] = Field(
```

**Step 1.3**: Update field descriptions for existing fields to note they're extensions
```python
    per_page_confidence: list[float] = Field(
        description="Per-page similarity scores (extension beyond spec).",
    )
    matched_features: list[str] = Field(
        description=(
            "Which features contributed to the match (extension beyond spec): "
            "'layout_grid', 'text_anchors', 'field_positions'."
        ),
    )
```

### File 2: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/matcher.py`

**Step 2.1**: Calculate template page count (after line 528, after deserializing template)
```python
            try:
                tmpl_pages = _deserialize_fingerprint(tmpl_fp, rows, cols)
                tmpl_page_count = len(tmpl_pages)  # NEW
            except ValueError:
```

**Step 2.2**: Rename `_window_start` to `window_start` (line 547)
```python
            # Current:
            confidence, per_page_scores, _window_start = result

            # New:
            confidence, per_page_scores, window_start = result
```

**Step 2.3**: Calculate document page count (after line 547)
```python
            confidence, per_page_scores, window_start = result
            doc_page_count = len(doc_pages)  # NEW
            if confidence >= _WARNING_FLOOR:
```

**Step 2.4**: Update TemplateMatch constructor (lines 549-558)
```python
            if confidence >= _WARNING_FLOOR:
                matches.append(
                    TemplateMatch(
                        template_id=tmpl_id,
                        template_name=tmpl_name,
                        template_version=tmpl_version,
                        source_format=source_format,  # NEW
                        confidence=confidence,
                        page_alignment={              # NEW
                            "window_start": window_start,
                            "template_pages": tmpl_page_count,
                            "document_pages": doc_page_count,
                        },
                        per_page_confidence=per_page_scores,
                        matched_features=["layout_grid"],
                    )
                )
```

### File 3: Verification - Check FormRouter

**Step 3.1**: Read `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/router.py`
- Locate `try_match()` method
- Verify it doesn't make breaking assumptions about TemplateMatch structure
- Ensure it either passes TemplateMatch through or accesses only existing fields

**Expected outcome**: No changes needed to router.py since Pydantic models are additive-compatible.

## 4. Testing Considerations

### 4.1 Unit Tests to Update

**File**: `/home/jjob/projects/ingestkit/packages/ingestkit-forms/tests/test_matcher.py`

**Changes needed**:
1. Update any test that constructs `TemplateMatch` instances to include `source_format` and `page_alignment`
2. Add assertions to verify these fields are populated correctly
3. Test cases for different window_start values (0, 2, etc.)
4. Test cases for different page counts (template_pages = document_pages, template_pages < document_pages)

### 4.2 Manual Tests

Since manual test files exist in the repo:
- `/home/jjob/projects/ingestkit/packages/ingestkit-forms/tests/test_manual_matching.py`

Verify this still works after changes, though it may not explicitly test the new fields.

## 5. Acceptance Criteria

- [ ] TemplateMatch model has `source_format: SourceFormat` field
- [ ] TemplateMatch model has `page_alignment: dict` field with documented structure
- [ ] Existing fields `per_page_confidence` and `matched_features` preserved
- [ ] `FormMatcher.match_document()` populates `source_format` from `detect_source_format()`
- [ ] `FormMatcher.match_document()` populates `page_alignment` with window_start, template_pages, document_pages
- [ ] All existing tests pass
- [ ] TemplateMatch instances constructed in tests include new required fields
- [ ] No breaking changes to FormRouter or other consumers of TemplateMatch

## 6. Verification Gates (for PROVE phase)

- [ ] Run `pytest packages/ingestkit-forms/tests/test_matcher.py -v`
- [ ] Run `pytest packages/ingestkit-forms/tests/ -m unit`
- [ ] Verify no test failures
- [ ] Verify TemplateMatch model exports correctly
- [ ] Check that page_alignment dict keys match documented structure

## 7. Risks and Mitigations

### Risk 1: Breaking Changes to Consumers
**Mitigation**: Pydantic models are additive-compatible. Adding new fields won't break existing code that constructs or consumes TemplateMatch, as long as we provide defaults or make fields optional. Since spec requires these fields, we make them required, which means old code constructing TemplateMatch will fail at instantiation. This is caught by tests.

### Risk 2: Unclear page_alignment Structure
**Mitigation**: Spec says "dict" with "window offset info" but doesn't define keys. We define a clear structure with `window_start`, `template_pages`, `document_pages`. This is documented in the Field description and provides enough context for API consumers.

### Risk 3: _windowed_match May Return None for window_start
**Mitigation**: Code inspection shows `_windowed_match()` always returns `best_start` when it returns a non-None result (line 448). We only construct TemplateMatch when `result is not None`, so `window_start` will always be an int.

## 8. Implementation Notes

### Note 1: Extension Fields
The spec defines 4 fields for TemplateMatch. The current implementation has 6 fields. We're adding the 2 missing spec fields while keeping the 2 extra fields (`per_page_confidence`, `matched_features`) because:
1. They provide useful diagnostic information
2. They don't conflict with spec requirements
3. Removing them would be a breaking change for existing consumers
4. They're marked as "extension beyond spec" in descriptions

### Note 2: Window Start Semantic
The `window_start` value is 0-indexed:
- `window_start=0` means template matches starting from page 1 of document
- `window_start=2` means template matches starting from page 3 of document
- This is consistent with Python's 0-indexed convention

### Note 3: Page Count Context
Including `template_pages` and `document_pages` in `page_alignment` provides essential context:
- Consumers can understand if document has extra pages
- Useful for debugging multi-page alignment issues
- Helps explain confidence scores

## 9. Deviations from Spec

**Deviation 1**: Extra fields in TemplateMatch
- **Spec**: 4 fields (template_id, template_name, template_version, confidence, source_format, page_alignment)
- **Implementation**: 6 fields (adds per_page_confidence, matched_features)
- **Rationale**: Superset approach - provides more information without violating spec requirements
- **Marked**: Fields documented as "extension beyond spec"

**Deviation 2**: page_alignment dict structure
- **Spec**: Says "dict" with "window offset info" but doesn't define keys
- **Implementation**: Defines keys `{window_start, template_pages, document_pages}`
- **Rationale**: Spec leaves structure undefined; we define a practical structure that captures window offset and provides context

## 10. Summary

This is a straightforward model alignment task. The spec requires two fields that are missing from the current implementation, and the data to populate these fields is already available in the matching logic. Implementation involves:

1. Adding two fields to the Pydantic model (5 lines)
2. Updating the matcher to populate these fields (8 lines)
3. Updating tests to include new fields in assertions

**Estimated effort**: 30 minutes implementation + 15 minutes testing = 45 minutes total

**Files modified**: 2 (models.py, matcher.py)
**Files created**: 0
**Tests modified**: 1-2 test files
**Breaking changes**: Yes (TemplateMatch constructor now requires 2 new fields, caught by tests)
