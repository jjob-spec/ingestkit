---
issue: 55
agent: PLAN
date: 2026-02-12
complexity: COMPLEX
stack: backend
depends_on: map-55-021226.md
test_plan: test-plan-55-021226.md
---

# PLAN: Issue #55 -- Extract ingestkit-core Shared Package

## Executive Summary

Create `ingestkit-core` containing 4 protocols, 6 models, 15 error codes, 1 base error model, and 1 utility function extracted from the two sibling packages. Core depends only on `pydantic>=2.0`. Both siblings add core as a dependency and re-export shared symbols for backward compatibility. Error code enum limitation handled via composition (each package keeps its own complete enum; core provides `CoreErrorCode` for shared codes).

---

## Step 1: Package Scaffold -- `packages/ingestkit-core/`

### 1.1 `pyproject.toml` (NEW)

- `name = "ingestkit-core"`, `version = "0.1.0"`, `requires-python = ">=3.10"`
- `dependencies = ["pydantic>=2.0"]` -- only runtime dep; `pandas` is TYPE_CHECKING only
- `[project.optional-dependencies] dev = ["pytest>=7.0", "pytest-cov"]`
- `[tool.setuptools.packages.find] where = ["src"]`
- `[tool.pytest.ini_options] testpaths = ["tests"]`, unit marker

### 1.2 Directory Layout

```
packages/ingestkit-core/
  pyproject.toml
  src/ingestkit_core/
    __init__.py | errors.py | models.py | protocols.py | idempotency.py | py.typed
  tests/
    __init__.py | conftest.py | test_protocols.py | test_models.py
    test_errors.py | test_imports.py | test_cross_package.py
```

`py.typed` is an empty PEP 561 marker.

---

## Step 2: `ingestkit_core/errors.py` (NEW)

**Contents**: `CoreErrorCode(str, Enum)` + `BaseIngestError(BaseModel)`

`CoreErrorCode` -- 15 members (MAP section 3.2):
- Parse: `E_PARSE_CORRUPT`, `E_PARSE_PASSWORD`, `E_PARSE_EMPTY`
- LLM: `E_CLASSIFY_INCONCLUSIVE`, `E_LLM_TIMEOUT`, `E_LLM_MALFORMED_JSON`, `E_LLM_SCHEMA_INVALID`, `E_LLM_CONFIDENCE_OOB`
- Backend: `E_BACKEND_VECTOR_TIMEOUT`, `E_BACKEND_VECTOR_CONNECT`, `E_BACKEND_DB_TIMEOUT`, `E_BACKEND_DB_CONNECT`, `E_BACKEND_EMBED_TIMEOUT`, `E_BACKEND_EMBED_CONNECT`
- Warning: `W_LLM_RETRY`

All values equal their names (e.g. `E_PARSE_CORRUPT = "E_PARSE_CORRUPT"`).

`BaseIngestError` -- 4 fields:
- `code: str` (not `CoreErrorCode` -- allows package enums to pass through)
- `message: str`
- `stage: str | None = None`
- `recoverable: bool = False`

---

## Step 3: `ingestkit_core/models.py` (NEW)

**Contents**: 6 classes

| Class | Type | Fields / Notes |
|-------|------|----------------|
| `ClassificationTier` | `str, Enum` | `RULE_BASED`, `LLM_BASIC`, `LLM_REASONING` -- verbatim from both packages |
| `IngestKey` | `BaseModel` | `content_hash`, `source_uri`, `parser_version`, `tenant_id` + `key` property (SHA-256) -- verbatim from Excel `models.py:85-104` |
| `EmbedStageResult` | `BaseModel` | `texts_embedded: int`, `embedding_dimension: int`, `embed_duration_seconds: float` -- verbatim |
| `BaseChunkMetadata` | `BaseModel` | 13 common fields (MAP section 2.2): `source_uri`, `source_format`, `ingestion_method`, `parser_version`, `chunk_index`, `chunk_hash`, `ingest_key`, `ingest_run_id`, `tenant_id`, `table_name`, `row_count`, `columns`, `section_title`. No default for `source_format` (subclasses provide it). |
| `ChunkPayload` | `BaseModel` | `id: str`, `text: str`, `vector: list[float]`, `metadata: BaseChunkMetadata` |
| `WrittenArtifacts` | `BaseModel` | `vector_point_ids: list[str] = []`, `vector_collection: str | None = None`, `db_table_names: list[str] = []` |

Import: `hashlib` (for IngestKey), `enum.Enum`, `pydantic.BaseModel`.

---

## Step 4: `ingestkit_core/protocols.py` (NEW)

Move all 4 protocols verbatim from Excel's `protocols.py`. Single change: TYPE_CHECKING import path `ingestkit_excel.models.ChunkPayload` becomes `ingestkit_core.models.ChunkPayload`.

Protocols: `VectorStoreBackend`, `StructuredDBBackend`, `LLMBackend`, `EmbeddingBackend` -- all `@runtime_checkable`, signatures identical to current Excel/PDF (MAP section 1).

`pandas` remains TYPE_CHECKING only (not a core runtime dep).

---

## Step 5: `ingestkit_core/idempotency.py` (NEW)

Move `compute_ingest_key()` verbatim from Excel's `idempotency.py`. Single change: import `IngestKey` from `ingestkit_core.models` instead of `ingestkit_excel.models`.

Signature: `compute_ingest_key(file_path: str, parser_version: str, tenant_id: str | None = None, source_uri: str | None = None) -> IngestKey`

---

## Step 6: `ingestkit_core/__init__.py` (NEW)

Re-export all 16 public symbols with `__all__`:
- From `errors`: `CoreErrorCode`, `BaseIngestError`
- From `models`: `ClassificationTier`, `IngestKey`, `EmbedStageResult`, `BaseChunkMetadata`, `ChunkPayload`, `WrittenArtifacts`
- From `idempotency`: `compute_ingest_key`
- From `protocols`: `VectorStoreBackend`, `StructuredDBBackend`, `LLMBackend`, `EmbeddingBackend`

---

## Step 7: Create Test Files

Copy test code from test-plan-55-021226.md sections 4.1-4.5. Adjustments:
- Test plan references `ErrorCode` in core imports -- rename to `CoreErrorCode`
- `test_all_exports` expected set uses `CoreErrorCode` (not `ErrorCode`)
- `test_cross_package.py` tests marked `@pytest.mark.integration`

Add tests for `BaseChunkMetadata` and `ClassificationTier` to `test_models.py`:
- `test_construction_all_required` -- verify 8 required + 5 optional fields
- `test_optional_fields_default_none` -- tenant_id, table_name, etc.
- `test_subclassing_adds_fields` -- Excel/PDF metadata subclass works
- `test_chunk_payload_accepts_subclass` -- ChunkPayload with subclass metadata
- `TestClassificationTier` -- 3 members, values, str enum check

---

## Step 8: Update `ingestkit-excel`

### 8.1 `pyproject.toml`

Add `"ingestkit-core>=0.1.0"` to `dependencies` list.

### 8.2 `models.py` -- Import shared, keep package-specific

- Add imports from `ingestkit_core.models`: `BaseChunkMetadata`, `ChunkPayload`, `ClassificationTier`, `EmbedStageResult`, `IngestKey`, `WrittenArtifacts`
- Remove `import hashlib`
- Delete local definitions of: `ClassificationTier`, `IngestKey`, `EmbedStageResult`, `ChunkPayload`, `WrittenArtifacts`
- Refactor `ChunkMetadata` to extend `BaseChunkMetadata`:
  - Inherits 13 common fields from base
  - Keeps Excel-specific: `sheet_name: str`, `region_id: str | None`, `parser_used: str`, `db_uri: str | None`, `original_structure: str | None`
  - Overrides `source_format: str = "xlsx"`
- Keep as-is: `FileType`, `IngestionMethod`, `RegionType`, `ParserUsed`, `ParseStageResult`, `ClassificationStageResult`, `SheetProfile`, `FileProfile`, `ClassificationResult`, `SheetRegion`, `ProcessingResult`

### 8.3 `errors.py` -- Extend BaseIngestError

- Add import: `from ingestkit_core.errors import BaseIngestError`
- Remove `from pydantic import BaseModel`
- `ErrorCode` enum: **no changes** (all 26 members stay)
- `IngestError`: change parent from `BaseModel` to `BaseIngestError`
  - Remove inherited fields: `message`, `stage`, `recoverable`
  - Keep: `sheet_name: str | None = None`
  - Re-declare: `code: ErrorCode` (narrows type from base `str`)

### 8.4 `protocols.py` -- Replace with re-exports

Replace entire file with 4 re-exports from `ingestkit_core.protocols` + `__all__`.

### 8.5 `idempotency.py` -- Replace with re-exports

Replace entire file with re-exports of `compute_ingest_key` from `ingestkit_core.idempotency` and `IngestKey` from `ingestkit_core.models` + `__all__`.

### 8.6 `__init__.py` -- No changes

Existing imports resolve through updated module-level re-exports automatically.

---

## Step 9: Update `ingestkit-pdf`

### 9.1 `pyproject.toml`

Add `"ingestkit-core>=0.1.0"` to `dependencies` list.

### 9.2 `models.py` -- Same pattern as Excel

- Add imports from `ingestkit_core.models`: `BaseChunkMetadata`, `ChunkPayload`, `ClassificationTier`, `EmbedStageResult`, `IngestKey`, `WrittenArtifacts`
- Remove `import hashlib`
- Delete local definitions of: `ClassificationTier`, `IngestKey`, `EmbedStageResult`, `ChunkPayload`, `WrittenArtifacts`
- Refactor `PDFChunkMetadata` to extend `BaseChunkMetadata`:
  - Inherits 13 common fields from base
  - Keeps PDF-specific: `page_numbers: list[int]`, `heading_path`, `content_type`, `doc_title`, `doc_author`, `doc_date`, `ocr_engine`, `ocr_confidence`, `ocr_dpi`, `ocr_preprocessing`, `table_index`, `language`
  - Overrides `source_format: str = "pdf"`
- Keep as-is: `PDFType`, `PageType`, `IngestionMethod`, `OCREngine`, `ExtractionQualityGrade`, `ContentType`, `ExtractionQuality`, `PageProfile`, `DocumentMetadata`, `DocumentProfile`, `ClassificationResult`, `OCRResult`, `TableResult`, `ParseStageResult`, `ClassificationStageResult`, `OCRStageResult`, `ProcessingResult`

### 9.3 `errors.py` -- Extend BaseIngestError

Same pattern as Excel 8.3:
- `ErrorCode`: **no changes** (all 42 members stay)
- `IngestError(BaseIngestError)`: keeps `page_number: int | None = None`, re-declares `code: ErrorCode`

### 9.4 `protocols.py` -- Replace with re-exports

Same pattern as Excel 8.4.

### 9.5 `__init__.py` -- No changes

Currently minimal, no re-exports to update.

---

## Step 10: Install and Verify

```bash
# 1. Install core first
pip install -e "packages/ingestkit-core[dev]"
# 2. Reinstall siblings
pip install -e "packages/ingestkit-excel[dev]"
pip install -e "packages/ingestkit-pdf[dev]"
# 3. Smoke test
python -c "
from ingestkit_core.protocols import VectorStoreBackend
from ingestkit_excel.protocols import VectorStoreBackend as EVSB
from ingestkit_pdf.protocols import VectorStoreBackend as PVSB
assert VectorStoreBackend is EVSB is PVSB
print('Identity OK')
"
# 4. Run all tests
pytest packages/ingestkit-core/tests -v
pytest packages/ingestkit-excel/tests -v
pytest packages/ingestkit-pdf/tests -v
```

---

## Acceptance Criteria

- [ ] `packages/ingestkit-core/` exists with correct structure
- [ ] Core contains: `CoreErrorCode` (15 codes), `BaseIngestError`, `ClassificationTier`, `IngestKey`, `EmbedStageResult`, `BaseChunkMetadata`, `ChunkPayload`, `WrittenArtifacts`, 4 protocols, `compute_ingest_key`
- [ ] Both siblings list `ingestkit-core>=0.1.0` in dependencies
- [ ] Excel `ChunkMetadata(BaseChunkMetadata)` and PDF `PDFChunkMetadata(BaseChunkMetadata)`
- [ ] Excel `IngestError(BaseIngestError)` with `sheet_name`; PDF with `page_number`
- [ ] Both packages re-export core protocols (identity: `excel.X is core.X`)
- [ ] All existing Excel tests pass without modification
- [ ] All existing PDF tests pass without modification
- [ ] All new core tests pass (71+ tests from test plan)
- [ ] No circular imports between any package pair
- [ ] `import ingestkit_core` does not pull in excel or pdf

---

AGENT_RETURN: plan-55-021226.md
