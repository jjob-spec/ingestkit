---
issue: 67
agent: PATCH
date: 2026-02-15
status: Complete
files_created: 2
files_modified: 3
tests_added: 29
lines_added: ~250
lines_removed: ~5
---

# PATCH: Issue #67 -- Per-field confidence scoring and overall aggregation

## Executive Summary

Implemented the confidence scoring module (`confidence.py`) with three public functions: `compute_field_confidence()` for per-method confidence adjustment, `compute_overall_confidence()` for weighted aggregation (required fields get 2x weight), and `apply_confidence_actions()` for the 4-tier confidence action system. Updated NativePDFExtractor to use variable confidence instead of hardcoded 0.95. Added 29 unit tests covering all spec section 7.4 requirements. Full test suite passes (334 tests, 0 failures).

## Metrics

| Metric | Value |
|--------|-------|
| Files created | 2 (confidence.py, test_confidence.py) |
| Files modified | 3 (__init__.py, native_pdf.py, test_extractors.py) |
| Tests added | 29 |
| Full suite | 334 passed |
| Ruff errors | 0 |

## Files Changed

### Created: `packages/ingestkit-forms/src/ingestkit_forms/confidence.py`
- `compute_field_confidence()`: Clamps native_fields/cell_mapping to 0.90-0.99, deducts 0.02 for coercion; passes through OCR/VLM confidence
- `compute_overall_confidence()`: Weighted mean with 2x for required fields. Uses walrus operator for FieldMapping lookup per PLAN-CHECK correction (avoids bare `FieldMapping()` instantiation)
- `apply_confidence_actions()`: 4-tier system -- accept / accept+warning / mark for VLM / value=None. Uses `model_copy()` for immutable field updates

### Created: `packages/ingestkit-forms/tests/test_confidence.py`
- `TestComputeFieldConfidence`: 13 tests (native PDF base/clamp/coercion, OCR pass-through, cell mapping, VLM, checkbox, unknown method, negative clamping)
- `TestComputeOverallConfidence`: 7 tests (equal confidence, required 2x weight, empty fields, None values, all required, unknown field_id, below threshold)
- `TestApplyConfidenceActions`: 9 tests (tier 1/2/3/4, exact boundaries, zero confidence, field preservation, validation failure)

### Modified: `packages/ingestkit-forms/src/ingestkit_forms/extractors/native_pdf.py`
- Added import of `compute_field_confidence`
- Replaced hardcoded `confidence=0.95` with variable confidence: base 0.99 for direct match, 0.95 if coercion needed, then passed through `compute_field_confidence()`
- Coercion detection: checks if `_coerce_widget_value` changed the value type

### Modified: `packages/ingestkit-forms/tests/test_extractors.py`
- Lines 183, 207: Updated `confidence == 0.95` assertions to `confidence == 0.99` (text fields with no coercion now get 0.99 via compute_field_confidence)

### Modified: `packages/ingestkit-forms/src/ingestkit_forms/__init__.py`
- Added imports and exports for `compute_field_confidence`, `compute_overall_confidence`, `apply_confidence_actions`

## PLAN-CHECK Corrections Applied

1. **FieldMapping() default**: Used `weight = 2.0 if (fm := field_map.get(ef.field_id)) and fm.required else 1.0` -- avoids instantiating bare FieldMapping which requires region/cell_address
2. **test_extractors.py assertions**: Updated lines 183 and 207 from `== 0.95` to `== 0.99`

## Deviations from MAP-PLAN

- **OCR extractor not modified**: The plan called for replacing the simple warning append in `ocr_overlay.py` (lines 293-296) with `apply_confidence_actions()`. Per the user's instruction to be careful about modifying extractors during concurrent patches (#65, #66), I left ocr_overlay.py unchanged. The `apply_confidence_actions()` function is ready for integration when the router or a future patch wires it in.
- **NativePDFExtractor modified minimally**: Only the confidence calculation was changed (hardcoded 0.95 -> variable via `compute_field_confidence`). No structural changes to the extractor.

## Verification

```
ruff check confidence.py:         All checks passed
ruff check native_pdf.py:         All checks passed
test_confidence.py:               29 passed
Full suite:                       334 passed, 0 failures
```

## Acceptance Criteria Status

All criteria met. See map-plan-67-021526.md for full list.

AGENT_RETURN: .agents/outputs/patch-67-021526.md
