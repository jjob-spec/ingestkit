---
issue: 29
agent: PATCH
date: 2026-02-14
status: Complete
files_created: 2
files_modified: 2
tests_added: 66
lines_added: 785
lines_removed: 3
---

# PATCH Artifact: Issue #29 -- PDF LLM Classifier

## Executive Summary

Implemented `PDFLLMClassifier` in `packages/ingestkit-pdf/src/ingestkit_pdf/llm_classifier.py` following the proven Excel `LLMClassifier` pattern adapted for PDF-specific models. The classifier generates PII-safe structural summaries from `DocumentProfile`, validates LLM responses via Pydantic schema (`LLMClassificationResponse` + `PageTypeEntry`), handles JSON/schema retries (max 2 attempts), clamps confidence OOB values, propagates `ConnectionError` to the caller for router-level outage degradation, and fails closed with `confidence=0.0` when retries are exhausted. All 66 new tests pass, and the full PDF test suite (443 tests) shows zero regressions.

## Metrics

| Metric | Value |
|--------|-------|
| Files created | 2 |
| Files modified | 2 |
| Tests added | 66 |
| Tests passing | 66/66 |
| Full suite | 443 passed |
| Regressions | 0 |

## Files Changed

### Created: `packages/ingestkit-pdf/src/ingestkit_pdf/llm_classifier.py` (~370 lines)

- `PageTypeEntry` -- Pydantic sub-model for page type validation with `Literal` values matching all 8 `PageType` enum values
- `LLMClassificationResponse` -- Pydantic model with `type` (Literal["text_native","scanned","complex"]), `confidence` (no bounds), `reasoning` (min_length=1), `page_types` (optional list of `PageTypeEntry`)
- `PDFLLMClassifier` -- main class with `classify(profile, tier)` public API
  - Tier validation, model selection, structural summary generation, prompt building
  - Retry loop (max 2 attempts) for JSON/schema errors and `TimeoutError`
  - `ConnectionError` propagation to caller (key difference from Excel pattern per SPEC 10.6)
  - Fail-closed: `confidence=0.0`, `degraded=False`, `per_page_types={}`
- `_generate_structural_summary()` -- PII-safe, includes page count, file size, creator, PDF version, page type distribution, sample page profiles (up to 10 with diversity sampling), detected languages, TOC info, form fields, encryption status
- `_build_classification_prompt()` -- template with all 3 `PDFType` values and all 8 `PageType` values
- `_validate_and_parse_response()` -- Pydantic validation, confidence clamping, page number cross-reference
- `_to_classification_result()` -- converts `page_types` list to `dict[int, PageType]`
- `_redact()` -- applies `config.redact_patterns`

### Created: `packages/ingestkit-pdf/tests/test_llm_classifier.py` (~660 lines)

66 tests across 14 test classes, all marked `@pytest.mark.unit`:

| Test Class | Tests | Coverage |
|------------|-------|----------|
| TestValidResponseParsing | 7 | Happy path for all 3 types, page_types, tier_used, signals |
| TestDegradedFlag | 2 | degraded=False on success and fail-closed |
| TestMalformedJsonRetry | 4 | JSONDecodeError, generic exception, two failures, correction hint |
| TestSchemaValidation | 6 | Missing/invalid fields, retry+success, two failures |
| TestConfidenceBounds | 5 | Clamping above/below, exact boundaries, no retry for OOB |
| TestTimeoutHandling | 2 | Timeout retry, two timeouts fail-closed |
| TestConnectionErrorPropagation | 2 | ConnectionError re-raised, single call only |
| TestFailClosed | 4 | Zero confidence, correct tier, reasoning, empty per_page_types |
| TestTierModelSelection | 6 | Model names, ValueError for RULE_BASED, temperature, timeout |
| TestStructuralSummary | 12 | All summary fields, no raw text, filename not path, fonts |
| TestPromptContent | 5 | All enum values in prompt, summary inclusion, JSON-only |
| TestPageTypesValidation | 4 | Conversion, unknown pages, null, all 8 types |
| TestLLMClassificationResponseModel | 5 | Pydantic model unit tests |
| TestRedaction | 2 | Pattern application, empty patterns |

### Modified: `packages/ingestkit-pdf/tests/conftest.py`

Added shared test infrastructure:
- `MockLLMBackend` -- configurable response queue with call recording
- `_make_extraction_quality()`, `_make_page_profile()`, `_make_document_profile()` -- factory helpers
- `_valid_response()` -- builds valid LLM response dicts
- `pdf_config`, `document_profile` pytest fixtures

### Modified: `packages/ingestkit-pdf/src/ingestkit_pdf/__init__.py`

Added `PDFLLMClassifier` and `LLMClassificationResponse` to public exports.

## Verification Results

```
# LLM classifier tests
pytest packages/ingestkit-pdf/tests/test_llm_classifier.py -v
66 passed in 0.12s

# Full PDF test suite (no regressions)
pytest packages/ingestkit-pdf/tests/ -q
443 passed in 0.57s

# Import verification
python3 -c "from ingestkit_pdf.llm_classifier import PDFLLMClassifier, LLMClassificationResponse"
# Success
```

## Issues Encountered

1. **conftest import**: Tests initially imported `from conftest import ...` which fails because conftest is auto-loaded by pytest but not importable as a regular module. Fixed by using `from tests.conftest import ...` which works with the package's test configuration.

2. **Linter auto-merge**: The linter automatically re-added `from ingestkit_pdf.inspector import PDFInspector` and its `pdf_inspector` fixture to conftest.py (used by other existing test modules). This was expected and correct.

## Deviations from PLAN

1. **Test count**: PLAN estimated 59 tests; implementation has 66 tests (7 more than planned). Additional tests were added for completeness in areas like `TestDegradedFlag` and more thorough `TestStructuralSummary` coverage.

2. **No deviation on architecture**: All architectural decisions match the PLAN exactly -- `ConnectionError` propagation, confidence clamping, fail-closed semantics, `degraded=False` always, `page_types` list-to-dict conversion.

## Acceptance Criteria Status

All criteria met. See plan-29-021426.md for full list.

AGENT_RETURN: .agents/outputs/patch-29-021426.md
