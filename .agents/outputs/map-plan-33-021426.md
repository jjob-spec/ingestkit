---
issue: 33
agent: MAP-PLAN
date: 2026-02-14
complexity: TRIVIAL
stack: backend
package: ingestkit-pdf
files_to_create:
  - packages/ingestkit-pdf/src/ingestkit_pdf/utils/language.py
  - packages/ingestkit-pdf/tests/test_language.py
files_to_modify:
  - packages/ingestkit-pdf/src/ingestkit_pdf/utils/__init__.py
---

# MAP-PLAN: Issue #33 — Implement language detection (`utils/language.py`)

## Executive Summary

Implement the language detection utility module for `ingestkit-pdf` as specified in SPEC.md section 16. The module provides two functions: `detect_language()` using the `fast-langdetect` library (FastText wrapper) and `map_language_to_ocr()` for mapping ISO 639-1 codes to engine-specific OCR language codes. This is a leaf utility with no downstream dependencies to break — straightforward implementation.

## Investigation Findings

### SPEC Requirements (§16.1-§16.3)

- **§16.1 Purpose**: Detect page language to route to the correct OCR language model. Critical for multi-language HR documents (bilingual handbooks, translated policies).
- **§16.2 Implementation**: Uses `fast-langdetect` (FastText wrapper). 217 languages, ~1MB model, 95% accuracy. Returns `{lang: "en", score: 0.98}`.
- **§16.3 Integration**: Two public functions with signatures:
  - `detect_language(text: str) -> tuple[str, float]` — returns `(iso_639_1_code, confidence)`
  - `map_language_to_ocr(lang: str, engine: OCREngine) -> str` — maps ISO 639-1 to engine-specific codes (e.g., `en` -> `eng` for Tesseract, `en` -> `en` for PaddleOCR)

### OCREngine Enum (models.py)

```python
class OCREngine(str, Enum):
    TESSERACT = "tesseract"
    PADDLEOCR = "paddleocr"
```

Two engines, so `map_language_to_ocr` needs two mapping branches.

### Config Fields (config.py)

```python
# --- Language Detection ---
enable_language_detection: bool = True
default_language: str = "en"
```

The `default_language` config value should be used as the fallback when detection fails or text is empty.

### Dependency Status (pyproject.toml)

`fast-langdetect>=0.2` is already declared as an optional dependency under `[project.optional-dependencies]` → `langdetect = ["fast-langdetect>=0.2"]`. Included in both `baseline` and `full` bundles. No changes to `pyproject.toml` needed.

### fast-langdetect API

```python
from fast_langdetect import detect
result = detect("Hello world", model="lite", k=1)
# Returns: [{"lang": "en", "score": 0.98}]
```

- `model` param: `"lite"` (offline, smaller), `"full"` (higher accuracy, downloads model), `"auto"` (full with lite fallback)
- `k` param: number of top candidates to return
- Returns list of `{"lang": str, "score": float}` dicts

### Existing Utils Module Pattern

- File-level docstring referencing SPEC sections
- `from __future__ import annotations`
- Logger: `logging.getLogger("ingestkit_pdf.utils.<module>")`
- Config passed to classes/functions as needed
- Exports registered in `utils/__init__.py`

## Implementation Plan

### File 1: `packages/ingestkit-pdf/src/ingestkit_pdf/utils/language.py` (NEW)

**Module docstring**: Reference SPEC §16.1-§16.3. Language detection for OCR routing.

**Imports**:
- `from __future__ import annotations`
- `import logging`
- `from ingestkit_pdf.models import OCREngine`

**Logger**: `logger = logging.getLogger("ingestkit_pdf.utils.language")`

**Constants**:

```python
# ISO 639-1 -> Tesseract ISO 639-3 mapping (common languages for HR/IT docs)
_TESSERACT_LANG_MAP: dict[str, str] = {
    "en": "eng",
    "es": "spa",
    "fr": "fra",
    "de": "deu",
    "pt": "por",
    "it": "ita",
    "nl": "nld",
    "ru": "rus",
    "zh": "chi_sim",
    "ja": "jpn",
    "ko": "kor",
    "ar": "ara",
    "hi": "hin",
    "vi": "vie",
    "th": "tha",
    "pl": "pol",
    "tr": "tur",
    "uk": "ukr",
    "sv": "swe",
    "da": "dan",
    "no": "nor",
    "fi": "fin",
    "cs": "ces",
    "ro": "ron",
    "hu": "hun",
    "el": "ell",
    "he": "heb",
    "id": "ind",
    "ms": "msa",
    "tl": "tgl",
}

# PaddleOCR uses ISO 639-1 directly for most languages, with a few exceptions
_PADDLEOCR_LANG_MAP: dict[str, str] = {
    "zh": "ch",       # PaddleOCR uses "ch" for Chinese
    "ko": "korean",
    "ja": "japan",
    "ar": "ar",
    "hi": "hi",
    "en": "en",
    "fr": "fr",
    "de": "german",
    "es": "es",
    "pt": "pt",
    "it": "it",
    "ru": "ru",
}

DEFAULT_TESSERACT_LANG = "eng"
DEFAULT_PADDLEOCR_LANG = "en"
```

**Function 1: `detect_language(text: str, *, default_language: str = "en") -> tuple[str, float]`**

Logic:
1. If `text` is empty or whitespace-only, return `(default_language, 1.0)` — empty text defaults with full confidence (it's a policy choice, not a detection).
2. Strip text. If length < 10 characters after strip, log a warning about short text and return `(default_language, 0.5)` — too short for reliable detection, low confidence.
3. Try `from fast_langdetect import detect`. If `ImportError`, log warning "fast-langdetect not installed, returning default language", return `(default_language, 0.0)`.
4. Call `detect(text, model="lite", k=1)`. Use `"lite"` model to avoid network downloads in on-prem environments.
5. Extract `lang` and `score` from `result[0]`.
6. Handle `zh-cn`/`zh-tw` style codes: split on `-` and take first part for ISO 639-1 consistency, but keep full code available if needed.
7. Return `(lang, score)`.
8. Wrap the detect call in try/except for any unexpected exceptions — return `(default_language, 0.0)` and log the error.

**Function 2: `map_language_to_ocr(lang: str, engine: OCREngine) -> str`**

Logic:
1. If `engine == OCREngine.TESSERACT`: look up `lang` in `_TESSERACT_LANG_MAP`. If found, return it. Otherwise return `DEFAULT_TESSERACT_LANG` and log warning about unmapped language.
2. If `engine == OCREngine.PADDLEOCR`: look up `lang` in `_PADDLEOCR_LANG_MAP`. If found, return it. Otherwise return the `lang` as-is (PaddleOCR is more permissive with ISO 639-1 codes), with a debug log.

### File 2: `packages/ingestkit-pdf/src/ingestkit_pdf/utils/__init__.py` (MODIFY)

Add exports:
```python
from ingestkit_pdf.utils.language import detect_language, map_language_to_ocr

__all__ = ["HeaderFooterDetector", "HeadingDetector", "detect_language", "map_language_to_ocr"]
```

### File 3: `packages/ingestkit-pdf/tests/test_language.py` (NEW)

Follow existing test conventions (see `test_header_footer.py` pattern).

## Test Plan

### Unit Tests (all marked `@pytest.mark.unit`)

**Test `detect_language`:**

| # | Test Name | Input | Expected Output | Notes |
|---|-----------|-------|-----------------|-------|
| 1 | `test_detect_language_empty_string` | `""` | `("en", 1.0)` | Empty text returns default |
| 2 | `test_detect_language_whitespace_only` | `"   \n\t  "` | `("en", 1.0)` | Whitespace-only returns default |
| 3 | `test_detect_language_very_short_text` | `"Hi"` | `("en", 0.5)` | < 10 chars, low confidence fallback |
| 4 | `test_detect_language_english` | `"This is a sample English paragraph..."` | `("en", > 0.8)` | Mock fast-langdetect to return `[{"lang": "en", "score": 0.99}]` |
| 5 | `test_detect_language_spanish` | `"Este es un párrafo de ejemplo..."` | `("es", > 0.8)` | Mock detection |
| 6 | `test_detect_language_custom_default` | `""`, `default_language="fr"` | `("fr", 1.0)` | Custom default language |
| 7 | `test_detect_language_import_error` | Any text, mock `ImportError` | `("en", 0.0)` | Graceful degradation when fast-langdetect not installed |
| 8 | `test_detect_language_unexpected_error` | Any text, mock raises `RuntimeError` | `("en", 0.0)` | Catches unexpected exceptions |
| 9 | `test_detect_language_zh_cn_normalization` | Mock returns `[{"lang": "zh-cn", "score": 0.95}]` | `("zh", 0.95)` | BCP-47 tag normalization |

**Test `map_language_to_ocr`:**

| # | Test Name | Input | Expected Output | Notes |
|---|-----------|-------|-----------------|-------|
| 10 | `test_map_english_to_tesseract` | `"en"`, `TESSERACT` | `"eng"` | Standard mapping |
| 11 | `test_map_english_to_paddleocr` | `"en"`, `PADDLEOCR` | `"en"` | PaddleOCR passthrough |
| 12 | `test_map_chinese_to_tesseract` | `"zh"`, `TESSERACT` | `"chi_sim"` | Special case |
| 13 | `test_map_chinese_to_paddleocr` | `"zh"`, `PADDLEOCR` | `"ch"` | Special case |
| 14 | `test_map_spanish_to_tesseract` | `"es"`, `TESSERACT` | `"spa"` | Standard mapping |
| 15 | `test_map_unknown_lang_tesseract` | `"xx"`, `TESSERACT` | `"eng"` | Falls back to default |
| 16 | `test_map_unknown_lang_paddleocr` | `"xx"`, `PADDLEOCR` | `"xx"` | PaddleOCR: pass through as-is |

**Mocking strategy**: Use `unittest.mock.patch` to mock `fast_langdetect.detect` at the module level. This avoids requiring the actual `fast-langdetect` package to be installed for unit tests. All tests in this file should work without the optional dependency.

## Acceptance Criteria

- [ ] `language.py` created at `packages/ingestkit-pdf/src/ingestkit_pdf/utils/language.py`
- [ ] `detect_language(text: str, *, default_language: str = "en") -> tuple[str, float]` implemented per SPEC §16.3
- [ ] `map_language_to_ocr(lang: str, engine: OCREngine) -> str` implemented per SPEC §16.3
- [ ] Empty/whitespace text returns `(default_language, 1.0)`
- [ ] Very short text (< 10 chars) returns `(default_language, 0.5)` with warning log
- [ ] Graceful degradation when `fast-langdetect` is not installed (returns default, logs warning)
- [ ] Unexpected exceptions caught and logged, returns default
- [ ] BCP-47 codes normalized to ISO 639-1 (e.g., `zh-cn` -> `zh`)
- [ ] Tesseract mapping covers at least 20 common languages
- [ ] PaddleOCR mapping covers common languages, falls through to ISO 639-1 for unmapped
- [ ] Unknown languages fall back to engine defaults
- [ ] Logger uses `ingestkit_pdf.utils.language` name
- [ ] `utils/__init__.py` updated with new exports
- [ ] `test_language.py` created with 16+ unit tests covering all edge cases
- [ ] All tests pass without `fast-langdetect` installed (mocked)
- [ ] All tests marked with `@pytest.mark.unit`
- [ ] No regressions in existing test suite

AGENT_RETURN: .agents/outputs/map-plan-33-021426.md
