# MAP-PLAN: Issue #13 — Test Infrastructure, Mock Backends, and Fixtures

**Issue:** #13 — [Spec] Implement test infrastructure, mock backends, and fixtures (Backend)
**Complexity:** SIMPLE
**Date:** 2026-02-14
**Branch:** `feature/issue-13-test-infrastructure`

---

## 1. Current State Analysis

### 1.1 Existing conftest.py (minimal)

File: `packages/ingestkit-excel/tests/conftest.py`

Currently contains only two fixtures:
- `sample_config` — returns `ExcelProcessorConfig()` with defaults
- `sample_ingest_key` — returns a hardcoded `IngestKey` instance

### 1.2 Ad-hoc Mock Backends (duplicated across 4 test files)

| Mock Class | Defined In | Notes |
|---|---|---|
| `MockStructuredDB` | `test_structured_db.py`, `test_splitter.py` | Identical implementations; stores tables in list, has `fail_on` |
| `MockVectorStore` | `test_structured_db.py`, `test_serializer.py`, `test_splitter.py` | Identical implementations; stores upserted chunks, has `fail_on_upsert` |
| `MockEmbedder` | `test_structured_db.py`, `test_serializer.py`, `test_splitter.py` | Identical implementations; returns `[0.1]*dim` vectors, has `fail_on_embed` |
| `MockLLMBackend` | `test_llm_classifier.py` | Queue-based responses, supports exceptions; **no `generate()`** (raises NotImplementedError) |
| MagicMock backends | `test_router.py` | Uses `unittest.mock.MagicMock` for all 4 backends (lightweight, not Protocol-compliant) |

### 1.3 Ad-hoc Helper Factories (duplicated across 3+ files)

- `_make_sheet_profile()` — in `test_structured_db.py`, `test_serializer.py`, `test_splitter.py`, `test_llm_classifier.py`
- `_make_file_profile()` — in `test_structured_db.py`, `test_serializer.py`, `test_splitter.py`
- `_make_parse_result()` — in `test_structured_db.py`, `test_serializer.py`, `test_splitter.py`
- `_make_classification_stage_result()` — in `test_structured_db.py`, `test_serializer.py`, `test_splitter.py`
- `_make_classification_result()` — in `test_structured_db.py`, `test_serializer.py`, `test_splitter.py`

### 1.4 pytest Markers

Already registered in `pyproject.toml`:
```toml
[tool.pytest.ini_options]
markers = [
    "unit: Unit tests (no external services)",
    "integration: Integration tests (require external services)",
]
```

### 1.5 No Test Fixture .xlsx Files

No `tests/fixtures/` directory exists. No programmatically generated `.xlsx` files.

---

## 2. Protocol Interfaces (from `ingestkit_core/protocols.py`)

### VectorStoreBackend
- `upsert_chunks(collection: str, chunks: list[ChunkPayload]) -> int`
- `ensure_collection(collection: str, vector_size: int) -> None`
- `create_payload_index(collection: str, field: str, field_type: str) -> None`
- `delete_by_ids(collection: str, ids: list[str]) -> int`

### StructuredDBBackend
- `create_table_from_dataframe(table_name: str, df: pd.DataFrame) -> None`
- `drop_table(table_name: str) -> None`
- `table_exists(table_name: str) -> bool`
- `get_table_schema(table_name: str) -> dict`
- `get_connection_uri() -> str`

### LLMBackend
- `classify(prompt: str, model: str, temperature: float = 0.1, timeout: float | None = None) -> dict`
- `generate(prompt: str, model: str, temperature: float = 0.7, timeout: float | None = None) -> str`

### EmbeddingBackend
- `embed(texts: list[str], timeout: float | None = None) -> list[list[float]]`
- `dimension() -> int`

---

## 3. Implementation Plan

### 3.1 File Changes

| # | File | Action | Description |
|---|---|---|---|
| 1 | `tests/conftest.py` | **EDIT** | Add shared mock backends, fixture .xlsx generators, and config fixture |
| 2 | `tests/fixtures/` | **CREATE DIR** | Directory for generated .xlsx files (may be empty if all generated in conftest) |

**Important:** Existing test files are NOT modified. The new conftest fixtures are additive and available for future tests.

### 3.2 Mock Backends to Add to conftest.py

#### MockVectorStore (consolidation of 3 copies)
- Stores chunks in a list (`self.chunks: list[ChunkPayload]`)
- `upsert_chunks()` appends to chunks list, returns count
- `ensure_collection()` tracks calls
- `create_payload_index()` no-op
- `delete_by_ids()` removes matching IDs from chunks list, returns count deleted
- `fail_on_upsert: bool` for error simulation
- Passes `isinstance(mock, VectorStoreBackend)` check

#### MockStructuredDB (consolidation of 2 copies)
- Stores DataFrames in `self.tables: dict[str, pd.DataFrame]`
- `create_table_from_dataframe()` stores df
- `drop_table()` removes from dict
- `table_exists()` checks dict
- `get_table_schema()` returns column dtypes from stored df
- `get_connection_uri()` returns configurable string
- `fail_on: str | None` for error simulation
- Passes `isinstance(mock, StructuredDBBackend)` check

#### MockLLM (enhanced from test_llm_classifier.py's MockLLMBackend)
- Queue-based configurable responses (list of dict | Exception)
- `classify()` pops next response; raises if Exception
- `generate()` pops next response string; raises if Exception
- Supports simulating:
  - **Valid response**: queue a well-formed dict
  - **Malformed JSON**: queue a `json.JSONDecodeError` or return a string that isn't valid JSON
  - **Schema-invalid**: queue a dict missing required fields
  - **Timeout**: queue a `TimeoutError`
- Records all calls for assertion
- Passes `isinstance(mock, LLMBackend)` check

#### MockEmbedding (consolidation of 3 copies as MockEmbedder)
- Returns zero vectors `[0.0] * dimension` of correct dimension (spec says zero vectors)
- Configurable dimension (default 768)
- `embed()` returns `[[0.0]*dim for _ in texts]`
- `dimension()` returns configured dim
- `fail_on_embed: bool` for error simulation
- Passes `isinstance(mock, EmbeddingBackend)` check

### 3.3 Fixture .xlsx Files (generated in conftest.py)

All files generated programmatically using `openpyxl` in session-scoped fixtures, written to a temp directory.

| Fixture Name | File | Description |
|---|---|---|
| `type_a_simple_xlsx` | `type_a_simple.xlsx` | 3 columns (Name, Age, Salary), 20 rows, clean tabular data |
| `type_b_checklist_xlsx` | `type_b_checklist.xlsx` | Merged header cells spanning full width, checklist format with Task/Status/Due columns, text-heavy |
| `type_c_hybrid_xlsx` | `type_c_hybrid.xlsx` | Sheet 1: tabular (3 cols, 10 rows); Sheet 2: document-formatted with merged headers and prose |
| `edge_empty_xlsx` | `edge_empty.xlsx` | Empty workbook (1 sheet, no data) |
| `edge_chart_only_xlsx` | `edge_chart_only.xlsx` | Sheet with no data rows (approximating chart-only; openpyxl can't create true chart-only sheets easily, so empty data with a comment/note) |
| `edge_large_xlsx` | `edge_large.xlsx` | Generated dynamically, exceeds `max_rows_in_memory` (default 100,000); use fixture param to generate with configurable row count |

Use `tmp_path_factory` (session-scoped) to create files once per test session.

### 3.4 Config Fixture

Add a `test_config` fixture (to complement existing `sample_config`):
```python
@pytest.fixture()
def test_config() -> ExcelProcessorConfig:
    """Config with test-friendly defaults (fast timeouts, small limits)."""
    return ExcelProcessorConfig(
        tenant_id="test_tenant",
        backend_timeout_seconds=5.0,
        backend_max_retries=1,
        backend_backoff_base=0.01,
    )
```

### 3.5 Shared Helper Factories

Do NOT add `_make_sheet_profile()` etc. to conftest.py. These are file-specific test helpers with different defaults per test module (tabular defaults vs. formatted-document defaults vs. hybrid defaults). Moving them would break the per-file customization and couple unrelated test files. Leave them as-is in each test file.

---

## 4. Acceptance Criteria Checklist

| # | Criterion | Verification |
|---|---|---|
| 1 | All mock backends satisfy their Protocol (`isinstance` check passes) | Unit test: `test_mock_vector_store_satisfies_protocol`, etc. |
| 2 | `MockLLM` can simulate: valid response, malformed JSON, schema-invalid, timeout | Unit tests for each mode |
| 3 | All fixture .xlsx files created and loadable with openpyxl | Unit test: load each fixture, verify sheet count and basic structure |
| 4 | Markers registered and usable | Already done in `pyproject.toml` |
| 5 | `pytest --co -q` shows discovered tests | Manual verification |
| 6 | Existing tests are NOT broken | Run full test suite |

---

## 5. Task Breakdown

| # | Task | Est. LOC | Dependencies |
|---|---|---|---|
| 1 | Implement `MockVectorStore` in conftest.py | ~35 | None |
| 2 | Implement `MockStructuredDB` in conftest.py | ~40 | None |
| 3 | Implement `MockLLM` in conftest.py | ~55 | None |
| 4 | Implement `MockEmbedding` in conftest.py | ~25 | None |
| 5 | Add pytest fixtures for mock backends | ~20 | Tasks 1-4 |
| 6 | Add `test_config` fixture | ~10 | None |
| 7 | Implement fixture .xlsx generators (session-scoped) | ~80 | None |
| 8 | Write `test_conftest.py` — Protocol conformance + MockLLM modes + .xlsx loadability | ~100 | Tasks 1-7 |
| 9 | Run full test suite, verify no regressions | — | Task 8 |

**Total estimated: ~365 LOC of new code**

---

## 6. Key Design Decisions

1. **Naming**: Use `MockVectorStore`, `MockStructuredDB`, `MockLLM`, `MockEmbedding` (matching SPEC.md names). The existing ad-hoc names (`MockEmbedder`, `MockLLMBackend`) differ slightly but we match the spec for the shared versions.

2. **Zero vectors vs. constant vectors**: SPEC says MockEmbedding returns "zero vectors of correct dimension". Existing mocks return `[0.1]*dim`. The shared mock will use `[0.0]*dim` per spec. Existing tests using `[0.1]*dim` won't break because they use their own local mocks.

3. **MockStructuredDB storage**: Use `dict[str, pd.DataFrame]` (not list of tuples) to support `drop_table()` and `table_exists()` properly. This matches the spec requirement for `drop_table` support.

4. **MockVectorStore.delete_by_ids**: Actually removes matching IDs from the stored chunks list (not just returning len(ids)). This enables proper testing of delete behavior.

5. **Fixture .xlsx files**: Generated in session-scoped fixtures using `tmp_path_factory` for performance. Each fixture returns a `Path` to the generated file.

6. **edge_large.xlsx**: Generated with `max_rows_in_memory + 1` rows (100,001 by default). Uses a fixture factory pattern so tests can customize the row count.

7. **No modification to existing test files**: All new code is additive. Existing ad-hoc mocks remain in their test files. Future refactoring to use shared fixtures is deferred.

---

## 7. Risk Assessment

| Risk | Mitigation |
|---|---|
| Fixture name collision with existing fixtures | Used distinct names (`mock_vector_store_shared`, etc.) — actually NO, use standard names since conftest fixtures have lowest priority and local fixtures override them. The existing test files define their own local `mock_vector_store` etc. fixtures which will take precedence. |
| Session-scoped .xlsx fixtures could cause test isolation issues | Files are read-only; tests should not modify them. Document this in fixture docstrings. |
| Large .xlsx generation is slow | Use session scope; only generate once. For `edge_large`, consider reducing to `max_rows_in_memory + 100` instead of +1 to be clearly over the limit. |

**Fixture naming resolution**: Since existing test files (test_structured_db.py, test_serializer.py, test_splitter.py) define their own `mock_vector_store`, `mock_embedder`, `mock_db` fixtures locally, pytest will use the local fixtures (closest scope wins). The conftest.py fixtures will only be used by tests that don't define their own. This is the correct pytest behavior and means no conflicts.

---

AGENT_RETURN: map-plan-13-021226.md
