# Patch Artifact — Issue #13: Test Infrastructure, Mock Backends, Fixtures

**Date**: 2026-02-14
**Branch**: feature/issue-13-test-infrastructure
**Status**: COMPLETE

## Summary

Implemented shared test infrastructure for ingestkit-excel: four Protocol-compliant mock backends, a `test_config` fixture, and six session-scoped `.xlsx` fixture generators. All validated by 37 new unit tests with zero regressions across the full 583-test suite.

## Files Modified

### 1. `packages/ingestkit-excel/tests/conftest.py` (MODIFIED)

**Preserved**: Existing `sample_config` and `sample_ingest_key` fixtures unchanged.

**Added mock backends** (all pass `isinstance` checks against `ingestkit_core.protocols`):

| Class | Protocol | Storage | Notes |
|-------|----------|---------|-------|
| `MockVectorStore` | `VectorStoreBackend` | `dict[str, list[ChunkPayload]]` | upsert, delete, ensure_collection, create_payload_index |
| `MockStructuredDB` | `StructuredDBBackend` | `dict[str, pd.DataFrame]` | create/drop/exists/schema/connection_uri |
| `MockLLM` | `LLMBackend` | Queue-based (`list`) | Sentinels: `__TIMEOUT__` raises TimeoutError, `__MALFORMED_JSON__` returns raw dict, missing-key dicts for schema-invalid |
| `MockEmbedding` | `EmbeddingBackend` | Stateless | Returns `[0.0] * dim` zero vectors; configurable dimension |

**Added fixtures**:
- `mock_vector_store`, `mock_structured_db`, `mock_llm`, `mock_embedding` — function-scoped, fresh per test
- `test_config` — `ExcelProcessorConfig` with `tenant_id="test_tenant"` and `log_sample_data=True`

**Added session-scoped .xlsx generators** (created once per session in temp directory):
- `type_a_simple_xlsx` — 3 columns, 20 rows, clean tabular
- `type_b_checklist_xlsx` — merged header, 10 checklist items, text-heavy
- `type_c_hybrid_xlsx` — Sheet1 tabular (10 rows), Sheet2 formatted with merges
- `edge_empty_xlsx` — empty workbook
- `edge_chart_only_xlsx` — data + embedded chart
- `edge_large_xlsx` — 100,001 rows (write-only mode for speed)

### 2. `packages/ingestkit-excel/tests/test_conftest.py` (CREATED)

37 unit tests organized in 7 test classes:

| Class | Tests | Purpose |
|-------|-------|---------|
| `TestProtocolConformance` | 4 | `isinstance` checks against runtime-checkable Protocols |
| `TestMockVectorStore` | 4 | upsert, delete, missing collection, payload index |
| `TestMockStructuredDB` | 4 | create/drop/schema/connection_uri |
| `TestMockLLM` | 8 | valid, malformed, timeout, schema-invalid, empty queue, generate, ordering |
| `TestMockEmbedding` | 4 | dimension, zero vectors, custom dim, call recording |
| `TestXlsxFixtures` | 6 | Loadability, row counts, merged cells, chart presence |
| `TestFixtureAvailability` | 7 | Smoke tests for all fixtures |

## Verification

```
$ pytest packages/ingestkit-excel/tests/test_conftest.py -v
37 passed in 2.93s

$ pytest packages/ingestkit-excel/tests -q
583 passed in 4.46s
```

## Design Decisions

1. **MockLLM returns dict for malformed JSON** — The `classify()` Protocol returns `dict`, so instead of returning a raw string (violating the protocol), the mock returns `{"raw": "<<<not json>>>"}` which is protocol-compliant but triggers downstream validation failures.

2. **Session-scoped xlsx with lazy temp dir** — Uses a module-level `TemporaryDirectory` to avoid regenerating large files per-test. The `edge_large_xlsx` uses openpyxl write-only mode for speed.

3. **No modifications to existing test files** — Existing tests use their own local mocks and continue to work unchanged.
