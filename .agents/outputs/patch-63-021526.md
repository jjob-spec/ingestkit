---
issue: 63
agent: patch
timestamp: 2026-02-15
status: Complete
files_modified: 3
files_created: 1
tests_added: 16
lines_added: ~520
lines_removed: ~25
---

# PATCH: Issue #63 -- Native PDF Form Field Extraction

## Executive Summary

Implemented `NativePDFExtractor` in `extractors/native_pdf.py` with full IoU-based widget matching, value coercion for all 7 `FieldType` values, regex validation, and flattened form detection. Updated `extractors/__init__.py` with export, replaced placeholder conftest fixtures with real `MockPDFWidgetBackend`/`MockOCRBackend` classes and factory helpers, and wrote 16 unit tests -- all passing.

## Metrics

| Metric | Value |
|--------|-------|
| Files modified | 3 (`native_pdf.py`, `__init__.py`, `conftest.py`) |
| Files created | 0 (all were stubs being filled in) |
| Tests added | 16 |
| Tests passing | 16/16 |
| Regressions | 0 (3 pre-existing failures in `test_matcher.py`/`test_stores.py` unrelated to this issue) |
| Ruff lint | All checks passed |

## Files Changed

### `packages/ingestkit-forms/src/ingestkit_forms/extractors/native_pdf.py` (REWRITE)

Implemented `NativePDFExtractor` class per PLAN sections 1.1-1.7:
- Constructor: `pdf_backend` (required), `config` (required), `ocr_backend` (optional)
- `extract()`: Flattened form detection, page grouping, per-field widget matching
- `_match_and_extract()`: IoU-based best-match selection with configurable threshold
- `_compute_iou()`: Standard axis-aligned IoU on normalized coordinates
- `_coerce_widget_value()`: Handles TEXT, DATE, NUMBER, CHECKBOX, RADIO, DROPDOWN, SIGNATURE
- `_validate_field_value()`: `re.fullmatch()` with graceful invalid-regex handling

### `packages/ingestkit-forms/src/ingestkit_forms/extractors/__init__.py` (UPDATE)

Added `NativePDFExtractor` export and `__all__` list.

### `packages/ingestkit-forms/tests/conftest.py` (UPDATE)

- Replaced `form_config` fixture (was `return {}`) with `return FormProcessorConfig()`
- Added `MockPDFWidgetBackend` class with configurable widgets-by-page and `has_fields` toggle
- Added `MockOCRBackend` class
- Added `make_widget()`, `make_field_mapping()`, `make_template()` factory functions
- Updated `mock_pdf_widget_backend` and `mock_ocr_backend` fixtures to return real mocks
- Preserved all existing fixtures (`mock_template_store`, `sample_pdf_form`, `sample_excel_form`, `sample_scanned_form`)

### `packages/ingestkit-forms/tests/test_extractors.py` (REWRITE)

16 `@pytest.mark.unit` tests covering all acceptance criteria. See PLAN for test matrix.

## Issues Encountered

1. **conftest import problem**: Test file couldn't `from conftest import ...` because `tests/__init__.py` exists (making it a package). Resolved by defining mock classes and factory functions directly in the test file (prefixed with `_`). The conftest still holds the shared fixtures for other test modules.

2. **Floating point precision**: `_compute_iou()` with identical boxes returned `1.0000000000000007` instead of exact `1.0` due to float arithmetic. Fixed test to use `abs(result - expected) < 1e-9` for all IoU assertions.

## Deviations from PLAN

1. Mock classes and factories are duplicated in both `conftest.py` (for fixtures used by other test files) and `test_extractors.py` (for direct use in tests). The PLAN assumed `conftest` imports would work, but pytest's package-mode import semantics prevented this. The conftest versions remain available as fixtures for future test files.

2. IoU test assertions use approximate comparison (`abs(x - y) < 1e-9`) instead of exact equality due to floating point behavior.

## Acceptance Criteria Status

All criteria met. See PLAN for full list.

## Verification

```
ruff check packages/ingestkit-forms/src/ingestkit_forms/extractors/ -> All checks passed
pytest packages/ingestkit-forms/tests/test_extractors.py -v          -> 16 passed
pytest packages/ingestkit-forms/tests/ -q                            -> 209 passed, 3 failed (pre-existing)
```

---

AGENT_RETURN: .agents/outputs/patch-63-021526.md
