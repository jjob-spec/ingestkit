---
issue: 36
agent: MAP-PLAN
date: 2026-02-14
complexity: SIMPLE
stack: backend
---

# MAP-PLAN: Issue #36 â€” Implement OCR Postprocessing

## Executive Summary

Implement `utils/ocr_postprocess.py`, a pure text-processing utility that cleans raw OCR output before it enters the chunking pipeline. The module performs four operations specified in SPEC section 11.2 step 6: merge hyphenated line breaks, normalize whitespace and Unicode, and strip OCR artifacts. This is a stdlib-only utility (uses `re` and `unicodedata`) with no external dependencies.

## Investigation Findings

### Spec Requirements (SPEC 11.2, step 6)

The spec defines exactly four postprocessing operations:

1. **Merge hyphenated line breaks** -- `docu-\nment` becomes `document`
2. **Normalize whitespace** -- collapse multiple spaces, normalize line endings
3. **Normalize Unicode** -- NFC normalization
4. **Strip OCR artifacts** -- random isolated characters, repeated punctuation

### Integration Point

- Called by `OCRProcessor.process()` (Path B) after OCR engine produces raw text, before optional LLM cleanup (step 7) and before heading detection / chunking (step 9).
- Also used by Path C `ComplexProcessor` for pages routed through OCR.

### Config Dependencies

Two config fields are relevant:

| Field | Default | Usage |
|-------|---------|-------|
| `enable_ocr_cleanup` | `False` | Controls LLM cleanup (step 7), NOT this module. This module always runs. |
| `log_ocr_output` | `False` | If true, raw OCR text may be logged. Postprocessor should use `ingestkit_pdf` logger namespace. |

The postprocessor itself requires no config -- it is stateless and always applied. No config fields need to be added.

### Existing Patterns

- Utils follow a consistent pattern: module docstring referencing spec section, `from __future__ import annotations`, logger under `ingestkit_pdf` namespace.
- `__init__.py` currently exports `HeaderFooterDetector` and `HeadingDetector`. Will need to add the postprocessor export.
- Test files follow `test_<module>.py` naming, use `pytest`, and are located in `packages/ingestkit-pdf/tests/`.

## Implementation Plan

### File 1: `packages/ingestkit-pdf/src/ingestkit_pdf/utils/ocr_postprocess.py`

**Public API:**

```python
def postprocess_ocr_text(text: str) -> str:
    """Apply all OCR postprocessing steps to raw OCR text.

    Steps (per SPEC 11.2 step 6):
    1. Merge hyphenated line breaks
    2. Normalize Unicode (NFC)
    3. Normalize whitespace
    4. Strip OCR artifacts

    Returns cleaned text. Returns empty string for empty/None-like input.
    """
```

**Internal helpers (private):**

| Function | Responsibility |
|----------|---------------|
| `_merge_hyphenated_breaks(text: str) -> str` | Regex: `r'(\w)-\n(\w)' -> r'\1\2'`. Must handle `\r\n` as well. |
| `_normalize_unicode(text: str) -> str` | `unicodedata.normalize("NFC", text)` |
| `_normalize_whitespace(text: str) -> str` | Collapse runs of spaces/tabs to single space. Normalize `\r\n` and `\r` to `\n`. Strip trailing whitespace per line. Collapse 3+ consecutive newlines to 2. |
| `_strip_ocr_artifacts(text: str) -> str` | Remove isolated single characters surrounded by whitespace (except common single-char words like "I", "a", "A"). Remove sequences of 3+ repeated punctuation (e.g., `...` is fine but `....` or `!!!!` gets collapsed). |

**Design decisions:**

- Function-based, not class-based (no state needed).
- Single public entry point `postprocess_ocr_text()` applies all steps in order.
- Order matters: merge hyphens first (needs original line breaks), then Unicode normalization, then whitespace normalization, then artifact stripping (needs clean whitespace to detect isolated chars).
- The artifact stripping must preserve legitimate content: "I am a doctor" should keep "I" and "a". Common single-letter English words are whitelisted.

### File 2: `packages/ingestkit-pdf/src/ingestkit_pdf/utils/__init__.py`

Add import and export for the postprocessor:

```python
from ingestkit_pdf.utils.ocr_postprocess import postprocess_ocr_text

__all__ = ["HeaderFooterDetector", "HeadingDetector", "postprocess_ocr_text"]
```

### File 3: `packages/ingestkit-pdf/tests/test_ocr_postprocess.py`

See test plan below.

## Test Plan

All tests are unit tests (`@pytest.mark.unit` or unmarked -- check `conftest.py` for default marks). No external dependencies.

### Test Cases

**Hyphenated line break merging:**

| ID | Input | Expected | Notes |
|----|-------|----------|-------|
| T1 | `"docu-\nment"` | `"document"` | Basic case from spec |
| T2 | `"docu-\r\nment"` | `"document"` | Windows line endings |
| T3 | `"end-\npoint config-\nuration"` | `"endpoint configuration"` | Multiple hyphens |
| T4 | `"self-service"` | `"self-service"` | Hyphen NOT at line break -- preserve |
| T5 | `"123-\n456"` | `"123-\n456"` | Digits -- do not merge (not word chars in hyphenation context) |

**Unicode normalization:**

| ID | Input | Expected | Notes |
|----|-------|----------|-------|
| T6 | `"caf\u0065\u0301"` (NFD) | `"caf\u00e9"` (NFC) | Composed form |
| T7 | `"resume"` (ASCII) | `"resume"` | No change for ASCII |

**Whitespace normalization:**

| ID | Input | Expected | Notes |
|----|-------|----------|-------|
| T8 | `"hello   world"` | `"hello world"` | Collapse spaces |
| T9 | `"a\t\tb"` | `"a b"` | Collapse tabs |
| T10 | `"line1\r\nline2\rline3"` | `"line1\nline2\nline3"` | Normalize line endings |
| T11 | `"a\n\n\n\nb"` | `"a\n\nb"` | Collapse excessive blank lines |
| T12 | `"  trailing  \n"` | `"trailing\n"` | Strip trailing whitespace per line |

**OCR artifact stripping:**

| ID | Input | Expected | Notes |
|----|-------|----------|-------|
| T13 | `"hello x world"` | `"hello world"` | Isolated single char removed |
| T14 | `"I am a doctor"` | `"I am a doctor"` | Common words preserved |
| T15 | `"price!!!!!"` | `"price!"` | Repeated punctuation collapsed |
| T16 | `"wait..."` | `"wait..."` | Ellipsis (3 dots) preserved |
| T17 | `"Mr. Smith"` | `"Mr. Smith"` | Single period preserved |

**Integration (full pipeline):**

| ID | Input | Expected | Notes |
|----|-------|----------|-------|
| T18 | `"docu-\nment   with   extra  spaces"` | `"document with extra spaces"` | All steps combined |
| T19 | `""` | `""` | Empty string |
| T20 | `"Clean text preserved."` | `"Clean text preserved."` | Clean text unchanged |
| T21 | Long multi-paragraph OCR sample | Verified clean output | Realistic OCR output test |

## Acceptance Criteria

1. `postprocess_ocr_text()` is importable from `ingestkit_pdf.utils`.
2. All four operations from SPEC 11.2 step 6 are implemented.
3. Clean text passes through unchanged (T20).
4. Empty/whitespace-only input returns empty string.
5. No external dependencies -- only `re`, `unicodedata` from stdlib.
6. Logger uses `ingestkit_pdf` namespace.
7. All test cases pass. No regressions in existing tests.
8. Module docstring references SPEC 11.2 step 6.

## Risks / Edge Cases

- **Hyphen merging false positives**: Must only merge when hyphen is immediately followed by a newline and then a lowercase letter (word continuation). Hyphens in compounds like "self-service" on the same line must be preserved.
- **Artifact stripping aggressiveness**: Single-character removal must whitelist common English words ("I", "a", "A") and single digits that appear in context. Overly aggressive stripping could damage tabular data or lists.
- **Unicode edge cases**: Some OCR engines produce mixed NFC/NFD output. A single NFC pass handles this.
