---
issue: 30
agent: PATCH
date: 2026-02-14
status: Complete
files_created: 2
files_modified: 1
tests_added: 26
lines_added: 637
lines_removed: 0
---

# PATCH: Issue #30 â€” Header/Footer Detection

## Executive Summary

Implemented `HeaderFooterDetector` in `utils/header_footer.py` per SPEC sections 13.1-13.3. The class uses cross-page text similarity via `difflib.SequenceMatcher` to detect repeating headers/footers from sampled pages of a `fitz.Document`, and provides a `strip()` method to remove matching lines from extracted text. All 26 unit tests pass. No regressions introduced (2 pre-existing failures in `test_chunker.py` and `test_heading_detector.py` are unrelated).

## Metrics

| Metric | Value |
|--------|-------|
| Files created | 2 |
| Files modified | 1 |
| Tests added | 26 |
| Lines added | 637 |

## Files Changed

### Created: `packages/ingestkit-pdf/src/ingestkit_pdf/utils/header_footer.py` (264 lines)

`HeaderFooterDetector` class with:
- `__init__` storing config parameters (`_sample_pages`, `_zone_ratio`, `_similarity_threshold`)
- `_select_sample_indices()` for even page distribution
- `_extract_zone_text()` filtering blocks by y-coordinate zone and type
- `_find_repeating_patterns()` using SequenceMatcher with deduplication
- `detect()` returning `(header_patterns, footer_patterns)` tuples
- `strip()` removing matching lines via similarity comparison
- PII-safe logging via `ingestkit_pdf.utils.header_footer` logger

### Created: `packages/ingestkit-pdf/tests/test_header_footer.py` (373 lines)

26 tests across 6 classes:
- `TestSelectSampleIndices` (4 tests): fewer pages, exact, evenly distributed, single page
- `TestExtractZoneText` (4 tests): header/footer extraction, image block filtering, empty text exclusion
- `TestDetect` (10 tests): single page, consistent header/footer, missing pages, unique text, empty doc, two-page minimum, custom thresholds
- `TestStrip` (7 tests): header/footer/both stripping, body preservation, fuzzy matching, no-op cases
- `TestIntegration` (1 test): full detect-then-strip pipeline

All tests use mock `fitz.Document`/`fitz.Page` objects; no real PDFs needed.

### Modified: `packages/ingestkit-pdf/src/ingestkit_pdf/utils/__init__.py` (6 lines)

Added re-export of `HeaderFooterDetector` (alongside existing `HeadingDetector`).

## Verification Results

```
tests/test_header_footer.py: 26 passed in 0.16s
Full test suite: 297 passed, 2 failed (pre-existing) in 0.78s
```

Pre-existing failures (not introduced by this change):
- `test_chunker.py::TestHeadingRespect::test_heading_path_propagated`
- `test_heading_detector.py::TestDetectFromMarkdown::test_markdown_headers_parsed`

## Issues Encountered

1. **Sample index rounding**: The MAP-PLAN expected `[0, 5, 10, 15, 19]` for 20 pages with 5 samples, but `round(3 * 19 / 4)` yields 14 not 15. Fixed the test expectation to `[0, 5, 10, 14, 19]`.

2. **Fuzzy match false positives in test**: The test for "unique text not detected" originally used `"Unique Header 0"` through `"Unique Header 4"`, which are >0.7 similar (differing only by one digit). Replaced with genuinely distinct strings to properly test the scenario.

## Acceptance Criteria Status

All criteria met. See MAP-PLAN for full list.

AGENT_RETURN: .agents/outputs/patch-30-021426.md
