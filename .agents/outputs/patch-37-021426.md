---
issue: 37
agent: PATCH
date: 2026-02-14
status: Complete
files_created: 2
files_modified: 1
tests_added: 18
lines_added: 348
lines_removed: 0
---

# PATCH: Issue #37 -- Layout Analysis for Multi-Column Detection

## Executive Summary

Implemented `utils/layout_analysis.py` with `LayoutAnalyzer` class, `TextBlock` and `LayoutResult` Pydantic models, and gap-based x-coordinate clustering for multi-column detection. Added `page_width` to `LayoutResult` per PLAN-CHECK advisory to support the 75% full-width threshold in `reorder_blocks`. All 18 unit tests pass. Full test suite (551 tests) passes with zero regressions.

## Metrics

| Metric | Value |
|--------|-------|
| Files created | 2 |
| Files modified | 1 |
| Tests added | 18 |
| Tests passing | 551 (full suite) |
| Regressions | 0 |

## Files Changed

### Created: `packages/ingestkit-pdf/src/ingestkit_pdf/utils/layout_analysis.py`
- `TextBlock` Pydantic model (x0, y0, x1, y1, text, block_number)
- `LayoutResult` Pydantic model (is_multi_column, column_count, column_boundaries, page_width)
- `LayoutAnalyzer` class with `detect_columns(page)` and `reorder_blocks(blocks, layout)`
- `extract_text_blocks(page)` module-level helper
- Gap-based 1D clustering (10% page width threshold, max 3 columns, min 2 blocks per cluster)
- Full-width block detection (>75% page width) excluded from clustering
- Fail-safe try/except on all public methods returning single-column defaults
- Logger at `ingestkit_pdf.utils.layout_analysis`
- `TYPE_CHECKING` guard for fitz, `from __future__ import annotations`

### Created: `packages/ingestkit-pdf/tests/test_layout_analysis.py`
- 18 unit tests across 6 test classes (all `@pytest.mark.unit`)
- T1-T3: Single-column detection (aligned, image-only, fewer than 3 blocks)
- T4-T5: Two-column detection (classic, unequal counts)
- T6: Three-column detection
- T7-T8: Mixed layout (full-width header + columns, all full-width)
- T9-T11: Reading order (two-column, single-column sort, mixed header+columns)
- T12-T16: Edge cases (image filtering, empty text, narrow page, overlapping x-ranges, exception handling)
- T17-T18: Column boundary validation (non-overlapping, sorted)

### Modified: `packages/ingestkit-pdf/src/ingestkit_pdf/utils/__init__.py`
- Added imports for `LayoutAnalyzer`, `LayoutResult`, `TextBlock`
- Added to `__all__` list (alphabetical order maintained)

## PLAN-CHECK Advisory Resolution

The PLAN-CHECK flagged that `reorder_blocks` needs `page_width` for the 75% full-width threshold. Resolved by adding `page_width: float` field to `LayoutResult`. This is populated during `detect_columns` from `page.rect.width` and consumed by `reorder_blocks` without needing direct page access.

## Deviations from MAP-PLAN

1. Added `page_width` field to `LayoutResult` (per PLAN-CHECK advisory -- not in original plan).
2. `detect_columns` and `reorder_blocks` are public API on `LayoutAnalyzer` class (as planned), plus `extract_text_blocks` as a module-level function (as planned).

## Verification

```
pytest packages/ingestkit-pdf/tests/test_layout_analysis.py -v  # 18 passed
pytest packages/ingestkit-pdf/tests/ -v                          # 551 passed, 0 failed
```

## Acceptance Criteria Status

All criteria met. See map-plan-37-021426.md for full list.

AGENT_RETURN: .agents/outputs/patch-37-021426.md
