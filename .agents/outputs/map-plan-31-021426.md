---
issue: 31
agent: MAP-PLAN
date: 2026-02-14
complexity: SIMPLE
stack: backend
files_to_create:
  - packages/ingestkit-pdf/src/ingestkit_pdf/utils/heading_detector.py
  - packages/ingestkit-pdf/tests/test_heading_detector.py
files_to_modify:
  - packages/ingestkit-pdf/src/ingestkit_pdf/utils/__init__.py
---

# MAP-PLAN: Issue #31 — Heading Hierarchy Detection

## Executive Summary

Implement `HeadingDetector` in `utils/heading_detector.py` with three strategies for extracting heading hierarchies from PDF documents: (1) PDF outline/bookmarks via `doc.get_toc()`, (2) font-size-based inference from text span metadata, and (3) markdown header parsing from pymupdf4llm output. The class provides two public methods: `detect()` returning an ordered list of `(level, title, page_number)` tuples, and `get_heading_path()` returning heading ancestry at a given page/y-position.

## Investigation Findings

### SPEC Reference
- **Section 14.1-14.4** defines all three strategies and the public interface (SPEC.md lines 1301-1336).
- Strategy 1 (PDF outline) is authoritative when present; strategies 2 and 3 are fallbacks.
- The spec does not define a priority between Strategy 2 and Strategy 3. Based on the design principle of minimal external dependencies and the fact that font-based inference uses only PyMuPDF (already a core dep), Strategy 2 should be preferred over Strategy 3. Strategy 3 (pymupdf4llm) is an additional fallback.

### Config Parameters
- `heading_min_font_size_ratio: float = 1.2` in `PDFProcessorConfig` (config.py line 83) — the threshold ratio for font-based heading detection.

### Models
- `DocumentProfile.has_toc: bool` and `DocumentProfile.toc_entries: list[tuple[int, str, int]] | None` already exist in models.py (lines 183-184), matching the `detect()` return type.
- `PDFChunkMetadata.heading_path: list[str] | None` (models.py line 239) is the consumer of `get_heading_path()`.

### Dependencies
- `pymupdf>=1.24` (fitz) — core dependency, provides `doc.get_toc()` and `page.get_text("dict")`.
- `pymupdf4llm>=0.0.10` — core dependency, provides `to_markdown()`.

### Existing Patterns
- All modules accept `PDFProcessorConfig` in `__init__`.
- Tests use programmatic PDF generation via `reportlab` (see `test_security.py`).
- Logger name convention: `ingestkit_pdf`.
- No existing utils modules beyond empty `__init__.py`.

### Error Codes
- No heading-specific error code exists. Heading detection is a best-effort utility; failures should log warnings and return empty lists rather than raising. This matches the "fail gracefully" design principle.

## Implementation Plan

### File 1: `packages/ingestkit-pdf/src/ingestkit_pdf/utils/heading_detector.py`

```
Module: heading_detector.py
Logger: logging.getLogger("ingestkit_pdf")
```

#### Imports
- `from __future__ import annotations`
- `import logging`, `import re`
- `from collections import Counter`
- `from typing import TYPE_CHECKING`
- `if TYPE_CHECKING: import fitz`
- `from ingestkit_pdf.config import PDFProcessorConfig`

#### Class: `HeadingDetector`

**`__init__(self, config: PDFProcessorConfig)`**
- Store `self._config = config`
- Store `self._headings: list[tuple[int, str, int]] = []` (populated by `detect()`)
- Store `self._logger = logging.getLogger("ingestkit_pdf")`

**`detect(self, doc: fitz.Document) -> list[tuple[int, str, int]]`**
- Primary public method. Returns `[(level, title, page_number), ...]` ordered by appearance.
- Strategy cascade:
  1. Call `self._detect_from_outline(doc)`. If result is non-empty, store in `self._headings` and return.
  2. Call `self._detect_from_fonts(doc)`. If result is non-empty, store in `self._headings` and return.
  3. Call `self._detect_from_markdown(doc)`. Store in `self._headings` and return (may be empty).
- Log which strategy was used at DEBUG level.

**`_detect_from_outline(self, doc: fitz.Document) -> list[tuple[int, str, int]]`** (Strategy 1)
- Call `toc = doc.get_toc()` which returns `[[level, title, page_number], ...]`.
- If `toc` is empty or falsy, return `[]`.
- Convert each entry: `(int(entry[0]), str(entry[1]).strip(), int(entry[2]))`.
- Filter out entries with empty titles after stripping.
- Return the list (already ordered by appearance in the PDF).

**`_detect_from_fonts(self, doc: fitz.Document) -> list[tuple[int, str, int]]`** (Strategy 2)
- Phase 1: Collect font sizes across all pages.
  - For each page: `page.get_text("dict")` returns `{"blocks": [...]}`.
  - For each block with `type == 0` (text block), iterate `lines` -> `spans`.
  - Each span has `size` (float), `flags` (int, bit 4 = bold i.e. `flags & 2**4`), `text` (str).
  - Collect all `(font_size, text_length)` pairs to find body size.
- Phase 2: Compute body font size.
  - Use `Counter` weighted by text length: the font size with the greatest total character count is the body size.
- Phase 3: Identify headings.
  - Threshold: `body_size * self._config.heading_min_font_size_ratio`.
  - A span qualifies as a heading if: `span_size >= threshold` AND `flags & 2**4 != 0` (is bold).
  - Collect qualifying spans as `(font_size, title_text, page_number, y_position)`.
  - Merge consecutive heading spans on the same line (same page, same y-position within tolerance of 2pt) by concatenating text.
- Phase 4: Map font sizes to levels.
  - Get distinct heading font sizes, sort descending.
  - Top 3 map to H1, H2, H3 (level 1, 2, 3). Any additional sizes map to H3.
  - Build final list: `(level, title, page_number)`.
- Return the list ordered by (page_number, y_position).

**`_detect_from_markdown(self, doc: fitz.Document) -> list[tuple[int, str, int]]`** (Strategy 3)
- `import pymupdf4llm`
- Call `md_text = pymupdf4llm.to_markdown(doc, page_chunks=True)`.
  - `page_chunks=True` returns a list of dicts with `{"metadata": {"page": N}, "text": "..."}`.
- For each page chunk, parse markdown headers with regex: `r'^(#{1,3})\s+(.+)$'` (multiline).
  - Level = number of `#` characters.
  - Title = the text after `# `.
  - Page number = from chunk metadata (1-indexed, matching fitz convention).
- Return the list ordered by appearance.
- Wrap in try/except; if pymupdf4llm fails, log warning and return `[]`.

**`get_heading_path(self, page_number: int, position_y: float) -> list[str]`**
- Must be called after `detect()`. If `self._headings` is empty, return `[]`.
- Find the "current" heading: the last heading that appears at or before the given `(page_number, position_y)`.
  - Compare by page_number first; headings on earlier pages are "before". For headings on the same page, we need y-position data, but the stored tuples only have page_number. For simplicity (and matching the spec signature), treat all headings on pages <= page_number as candidates, with the last one on the target page being the closest.
- Build ancestry: walk backward from the current heading, collecting the most recent heading at each higher level.
  - Example: if current is H3 "Section 2.1.1", find the most recent H2 before it, then the most recent H1 before that H2.
  - Return `["Chapter 2", "Section 2.1", "Section 2.1.1"]` (H1 first, deepest last).

**Internal storage enhancement**: To support `get_heading_path()` with y-position awareness, internally store headings as `list[tuple[int, str, int, float]]` where the 4th element is y_position (0.0 for outline-sourced headings). The public `detect()` return strips the y_position.

### File 2: `packages/ingestkit-pdf/src/ingestkit_pdf/utils/__init__.py`

Add re-export:
```python
"""Utility modules for ingestkit-pdf."""

from ingestkit_pdf.utils.heading_detector import HeadingDetector

__all__ = ["HeadingDetector"]
```

### File 3: `packages/ingestkit-pdf/tests/test_heading_detector.py`

## Test Plan

All tests mock `fitz.Document` and page objects. No binary PDF fixtures. Tests marked with `@pytest.mark.unit`.

### Fixtures

**`default_config()`** — Returns `PDFProcessorConfig()` with defaults.

**`detector(default_config)`** — Returns `HeadingDetector(default_config)`.

**`mock_doc_with_toc()`** — Mock `fitz.Document` where `get_toc()` returns a well-formed TOC list. Pages are mocked minimally.

**`mock_doc_no_toc()`** — Mock `fitz.Document` where `get_toc()` returns `[]`. Pages have font metadata with bold headings at larger sizes and body text at 12pt.

**`mock_doc_empty()`** — Mock `fitz.Document` with `get_toc()` returning `[]`, pages with no text blocks.

### Test Class: `TestDetectFromOutline`

| Test | Input | Expected |
|------|-------|----------|
| `test_toc_returns_headings` | TOC: `[[1,"Ch1",1],[2,"Sec1.1",1],[1,"Ch2",3]]` | Returns 3 tuples with correct levels |
| `test_toc_strips_empty_titles` | TOC with an entry `[1,"",2]` | That entry is filtered out |
| `test_toc_preferred_over_fonts` | Doc with both TOC and font-based headings | Only TOC headings returned (Strategy 1 wins) |

### Test Class: `TestDetectFromFonts`

| Test | Input | Expected |
|------|-------|----------|
| `test_bold_large_text_detected` | Body=12pt, heading spans: 18pt bold "Title", 15pt bold "Section" | Returns H1 "Title", H2 "Section" |
| `test_non_bold_large_text_ignored` | 18pt non-bold span | Not detected as heading |
| `test_body_size_calculated_correctly` | Mix of 12pt (80%), 10pt (15%), 18pt (5%) | Body size = 12pt |
| `test_three_levels_mapped` | Three distinct heading sizes: 24, 18, 15 | Mapped to H1, H2, H3 |
| `test_more_than_three_sizes_capped` | Four heading sizes: 28, 24, 18, 15 | 28->H1, 24->H2, 18->H3, 15->H3 |
| `test_consecutive_spans_merged` | Two bold 18pt spans on same line | Merged into single heading |
| `test_no_bold_headings_returns_empty` | All text is regular weight | Returns `[]` |
| `test_heading_min_font_size_ratio_configurable` | Config with ratio=1.5, body=12pt | Only spans >= 18pt qualify |

### Test Class: `TestDetectFromMarkdown`

| Test | Input | Expected |
|------|-------|----------|
| `test_markdown_headers_parsed` | Markdown with `# H1`, `## H2`, `### H3` | Returns 3 headings with correct levels |
| `test_h4_and_deeper_ignored` | `#### H4` in markdown | Not included (only 1-3 levels) |
| `test_page_numbers_from_chunks` | Two page chunks with headers | Page numbers match chunk metadata |

### Test Class: `TestGetHeadingPath`

| Test | Input | Expected |
|------|-------|----------|
| `test_ancestry_built_correctly` | Headings: H1@p1, H2@p1, H3@p2; query p2 | `["H1 title", "H2 title", "H3 title"]` |
| `test_mid_document_position` | Headings: H1@p1, H2@p2, H1@p5, H2@p6; query p3 | `["H1@p1 title", "H2@p2 title"]` |
| `test_no_headings_returns_empty` | No `detect()` called or empty headings | `[]` |
| `test_position_before_first_heading` | Query page 0 (before any heading) | `[]` |
| `test_y_position_selects_correct_heading` | Two H2 headings on same page at different y; query between them | Returns path to the first H2 |

### Test Class: `TestStrategyCascade`

| Test | Input | Expected |
|------|-------|----------|
| `test_outline_used_when_available` | Doc with TOC | `_detect_from_outline` result used |
| `test_fonts_used_when_no_outline` | Doc without TOC, with font headings | `_detect_from_fonts` result used |
| `test_markdown_used_as_last_resort` | Doc without TOC, no bold large text | `_detect_from_markdown` attempted |
| `test_all_strategies_fail_returns_empty` | Empty doc | Returns `[]` |

### Test Class: `TestEdgeCases`

| Test | Input | Expected |
|------|-------|----------|
| `test_single_page_doc` | 1-page doc with one heading | Works correctly |
| `test_unicode_heading_titles` | TOC with unicode characters | Preserved correctly |
| `test_very_long_heading_title` | 500-char heading title | Returned without truncation |
| `test_detect_idempotent` | Call `detect()` twice on same doc | Same result both times |

## Acceptance Criteria

- [ ] `HeadingDetector` class created in `packages/ingestkit-pdf/src/ingestkit_pdf/utils/heading_detector.py`
- [ ] Constructor accepts `PDFProcessorConfig`
- [ ] `detect(doc)` returns `list[tuple[int, str, int]]` ordered by appearance
- [ ] Strategy 1 (PDF outline via `doc.get_toc()`) implemented and preferred when TOC exists
- [ ] Strategy 2 (font-based inference) implemented: body size = most common font size, threshold = `body_size * config.heading_min_font_size_ratio`, requires bold, maps top 3 sizes to H1/H2/H3
- [ ] Strategy 3 (pymupdf4llm markdown parsing) implemented as final fallback
- [ ] `get_heading_path(page_number, position_y)` returns heading ancestry `list[str]`
- [ ] No concrete backend imports; uses only PyMuPDF and pymupdf4llm (already core deps)
- [ ] Logger uses `ingestkit_pdf` name
- [ ] Failures log warnings and return empty lists (never raise)
- [ ] `utils/__init__.py` re-exports `HeadingDetector`
- [ ] All tests in `test_heading_detector.py` pass with mocked fitz.Document
- [ ] Tests marked `@pytest.mark.unit`
- [ ] No binary PDF fixtures committed
- [ ] `heading_min_font_size_ratio` config parameter is respected
