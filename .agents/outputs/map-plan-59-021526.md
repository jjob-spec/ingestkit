---
issue: 59
agent: MAP-PLAN
date: 2026-02-15
complexity: SIMPLE
stack: backend
depends_on: [56, 58]
---

# MAP-PLAN: Issue #59 -- Implement FormProcessorConfig with validation

## Executive Summary

Implement `FormProcessorConfig(BaseModel)` in `packages/ingestkit-forms/src/ingestkit_forms/config.py` per spec section 11. The config model has 43 fields across 14 categories (identity, form matching, fingerprinting, OCR, native PDF, VLM fallback, field extraction, output DB, chunking, embedding, vector store, template storage, resource limits, backend resilience, dual-write, logging/PII). Requires a `model_validator(mode="after")` for cross-field validation of enum-like string fields and a threshold ordering constraint. Also requires a `RedactTarget(str, Enum)` and a `from_file()` classmethod matching the established pattern from `ingestkit-excel` and `ingestkit-pdf`. Depends on #56 (scaffold) and #58 (errors module) being in place first.

## Investigation Summary

### Files Read

- `docs/specs/form-ingestor-plugin.md` lines 1524-1789 -- authoritative spec for FormProcessorConfig
- `packages/ingestkit-excel/src/ingestkit_excel/config.py` -- ExcelProcessorConfig pattern (no Field imports, no validators)
- `packages/ingestkit-pdf/src/ingestkit_pdf/config.py` -- PDFProcessorConfig pattern (uses model_validator, similar from_file)
- `packages/ingestkit-core/src/ingestkit_core/errors.py` -- BaseIngestError (no config types in core)
- `packages/ingestkit-core/src/ingestkit_core/models.py` -- shared models (no config base class)
- `.agents/outputs/map-plan-58-021526.md` -- dependency plan; confirms package skeleton at `packages/ingestkit-forms/`

### Key Findings

1. **Package skeleton expected at `packages/ingestkit-forms/`** per #56 and #58 plans. Config goes in `config.py` per spec section 4.4 module structure.

2. **Spec section 11 is fully transcribed Python code** (lines 1526-1789). The implementation is a near-direct transcription with 43 fields, many using `Field()` with `ge`/`le` constraints and descriptions.

3. **`RedactTarget` enum** is defined in the spec's PII section (line 1984). It's a `str, Enum` with three members: `BOTH = "both"`, `CHUNKS_ONLY = "chunks_only"`, `DB_ONLY = "db_only"`. The config's `redact_target` field uses string values but the validator checks against allowed set. Decision: define `RedactTarget` enum in `config.py` (or `models.py`) and type the field as `RedactTarget` instead of `str` for type safety, while keeping the validator as a fallback.

4. **`model_validator(mode="after")` validates 5 enum-like string fields** plus 1 cross-field threshold constraint:
   - `dual_write_mode` in `{"best_effort", "strict_atomic"}`
   - `redact_target` in `{"both", "chunks_only", "db_only"}`
   - `page_match_strategy` in `{"windowed"}`
   - `form_ocr_engine` in `{"paddleocr", "tesseract"}`
   - `pdf_widget_backend` in `{"pymupdf", "pdfplumber"}`
   - `form_vlm_fallback_threshold < form_extraction_min_field_confidence`

5. **`from_file()` classmethod** is identical to the Excel/PDF pattern: detect `.yaml`/`.yml`/`.json` by extension, lazy-import yaml, return `cls(**data)`.

6. **No shared config base class exists in ingestkit-core.** Each package defines its own config model independently. This is consistent -- no need to create one.

7. **ENUM_VALUE pattern risk:** The `redact_target` field in the spec uses lowercase string values (`"both"`, `"chunks_only"`, `"db_only"`). The `RedactTarget` enum names are UPPERCASE (`BOTH`, `CHUNKS_ONLY`, `DB_ONLY`). The config default is `"both"` (lowercase value). Must ensure the Field default uses the enum member or its `.value`, not its `.name`.

## Plan

### Step 1: Define `RedactTarget` enum in `config.py`

**File:** `packages/ingestkit-forms/src/ingestkit_forms/config.py` (CREATE)

```python
class RedactTarget(str, Enum):
    """Where redaction applies."""
    BOTH = "both"
    CHUNKS_ONLY = "chunks_only"
    DB_ONLY = "db_only"
```

Place before `FormProcessorConfig`. Export from `__init__.py`.

### Step 2: Implement `FormProcessorConfig(BaseModel)` with all 43 fields

Transcribe directly from spec section 11 (lines 1526-1724). Field groups:

| Group | Fields | Notes |
|-------|--------|-------|
| Identity | `parser_version`, `tenant_id` | Plain defaults, no Field() |
| Form Matching | `form_match_enabled`, `form_match_confidence_threshold`, `form_match_per_page_minimum`, `form_match_extra_page_penalty`, `page_match_strategy` | Threshold fields use `Field(ge=, le=)` |
| Fingerprinting | `fingerprint_dpi`, `fingerprint_grid_rows`, `fingerprint_grid_cols` | Field() with description |
| OCR | `form_ocr_dpi`, `form_ocr_engine`, `form_ocr_language`, `form_ocr_per_field_timeout_seconds` | Field() with description |
| Native PDF | `pdf_widget_backend` | Field() with description |
| VLM Fallback | `form_vlm_enabled`, `form_vlm_model`, `form_vlm_fallback_threshold`, `form_vlm_timeout_seconds`, `form_vlm_max_fields_per_document` | Field() with ge/le constraints |
| Field Extraction | `form_extraction_min_field_confidence`, `form_extraction_min_overall_confidence`, `checkbox_fill_threshold`, `signature_ink_threshold`, `native_pdf_iou_threshold` | All `Field(ge=0.0, le=1.0)` |
| Output DB | `form_db_table_prefix` | Field() with description |
| Chunking | `chunk_max_fields` | Field() with description |
| Embedding | `embedding_model`, `embedding_dimension`, `embedding_batch_size` | Plain defaults |
| Vector Store | `default_collection` | Plain default |
| Template Storage | `form_template_storage_path` | Field() with description |
| Resource Limits | `max_file_size_mb`, `per_document_timeout_seconds` | Field() with description |
| Backend Resilience | `backend_timeout_seconds`, `backend_max_retries`, `backend_backoff_base` | Plain defaults |
| Dual-Write | `dual_write_mode` | Field() with description |
| Logging/PII | `log_sample_data`, `log_ocr_output`, `log_extraction_details`, `redact_patterns`, `redact_target` | `redact_target` typed as `RedactTarget` with default `RedactTarget.BOTH` |

**Total: 43 fields** (matching the 40+ requirement).

### Step 3: Implement `model_validator(mode="after")`

Transcribe from spec lines 1726-1748. Six validations:

```python
@model_validator(mode="after")
def _validate_enum_fields(self) -> FormProcessorConfig:
    # 1. dual_write_mode in {"best_effort", "strict_atomic"}
    # 2. redact_target in {"both", "chunks_only", "db_only"}
    # 3. page_match_strategy in {"windowed"}
    # 4. form_ocr_engine in {"paddleocr", "tesseract"}
    # 5. pdf_widget_backend in {"pymupdf", "pdfplumber"}
    # 6. form_vlm_fallback_threshold < form_extraction_min_field_confidence
    return self
```

Note: If `redact_target` is typed as `RedactTarget` enum, the validator check for it becomes redundant (Pydantic will reject invalid values). Keep the validator anyway for defense-in-depth and to match spec exactly. Alternatively, keep `redact_target` as `str` to match the spec code verbatim. **Decision: keep as `str` to match spec exactly**, and define `RedactTarget` as a standalone enum for callers who want type-safe construction.

### Step 4: Implement `from_file()` classmethod

Copy the established pattern from `ingestkit-pdf/config.py` lines 152-188. Identical logic:
- Detect extension (`.yaml`/`.yml`/`.json`)
- Lazy-import yaml
- Return `cls(**data)`

### Step 5: Update `__init__.py` with re-exports

Add `FormProcessorConfig` and `RedactTarget` to `packages/ingestkit-forms/src/ingestkit_forms/__init__.py`.

### Step 6: Write unit tests

**File:** `packages/ingestkit-forms/tests/test_config.py` (CREATE)

Tests (following patterns from ingestkit-excel and ingestkit-pdf test suites):

| # | Test | Priority |
|---|------|----------|
| 1 | Default construction succeeds with all defaults | P0 |
| 2 | All 43 fields present on default instance | P0 |
| 3 | Default values match spec (spot-check 10+ fields) | P0 |
| 4 | `model_validator` rejects invalid `dual_write_mode` | P0 |
| 5 | `model_validator` rejects invalid `redact_target` | P0 |
| 6 | `model_validator` rejects invalid `page_match_strategy` | P0 |
| 7 | `model_validator` rejects invalid `form_ocr_engine` | P0 |
| 8 | `model_validator` rejects invalid `pdf_widget_backend` | P0 |
| 9 | `model_validator` rejects `vlm_fallback_threshold >= field_confidence` | P0 |
| 10 | Valid cross-field thresholds pass | P0 |
| 11 | `from_file()` loads JSON config | P0 |
| 12 | `from_file()` loads YAML config | P1 |
| 13 | `from_file()` raises FileNotFoundError for missing file | P1 |
| 14 | `from_file()` raises ValueError for unsupported extension | P1 |
| 15 | Field constraints: `form_match_confidence_threshold` rejects values > 1.0 | P1 |
| 16 | Field constraints: `form_match_confidence_threshold` rejects values < 0.0 | P1 |
| 17 | `RedactTarget` enum has 3 members with correct values | P0 |
| 18 | Pydantic serialization round-trip (model_dump / model_validate) | P1 |
| 19 | Override individual fields via constructor kwargs | P1 |
| 20 | `from_file()` with empty YAML returns defaults | P2 |

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `packages/ingestkit-forms/src/ingestkit_forms/config.py` | CREATE | RedactTarget enum + FormProcessorConfig (43 fields, validator, from_file) |
| `packages/ingestkit-forms/src/ingestkit_forms/__init__.py` | MODIFY | Add FormProcessorConfig, RedactTarget to exports |
| `packages/ingestkit-forms/tests/test_config.py` | CREATE | 20 unit tests |

## Acceptance Criteria

- [ ] `FormProcessorConfig` is a Pydantic `BaseModel` with 43+ fields matching spec section 11
- [ ] All `Field()` constraints (ge, le, description) match spec exactly
- [ ] Default values match spec table (section 11 Configuration Summary Table)
- [ ] `model_validator(mode="after")` validates 5 enum-like string fields + 1 cross-field threshold
- [ ] `from_file(path)` classmethod loads YAML and JSON configs
- [ ] `RedactTarget(str, Enum)` with members BOTH, CHUNKS_ONLY, DB_ONLY
- [ ] Unit tests cover all validators, defaults, from_file, and Field constraints
- [ ] No regressions in existing tests
- [ ] `redact_target` config field uses string value `"both"` (not `"BOTH"`) -- ENUM_VALUE check

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| ENUM_VALUE: `RedactTarget.BOTH` name vs `"both"` value | Test that default `redact_target == "both"` (lowercase) |
| Dependency on #56 (scaffold) not merged | Plan assumes `packages/ingestkit-forms/` structure exists; if not, step 1 must create minimal skeleton |
| Dependency on #58 (errors) not merged | Config module has no import dependency on errors.py; can proceed independently |
| Spec drift if threshold defaults change | Tests pin default values; update if spec changes |

## Verification Gates (for PROVE)

```bash
# Install package in dev mode
pip install -e "packages/ingestkit-forms[dev]"

# Run unit tests
pytest packages/ingestkit-forms/tests/test_config.py -v

# Verify no regressions
pytest packages/ingestkit-forms/tests/ -v

# Check imports work
python -c "from ingestkit_forms.config import FormProcessorConfig, RedactTarget; print('OK')"
```

AGENT_RETURN: .agents/outputs/map-plan-59-021526.md
