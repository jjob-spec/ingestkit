---
issue: 30
agent: MAP-PLAN
date: 2026-02-14
complexity: SIMPLE
stack: backend
files_to_create:
  - packages/ingestkit-pdf/src/ingestkit_pdf/utils/header_footer.py
  - packages/ingestkit-pdf/tests/test_header_footer.py
files_to_modify:
  - packages/ingestkit-pdf/src/ingestkit_pdf/utils/__init__.py
---

# MAP-PLAN: Issue #30 — Header/Footer Detection

## Executive Summary

Implement `HeaderFooterDetector` in `utils/header_footer.py` per SPEC sections 13.1-13.3. The class uses cross-page text similarity (via `difflib.SequenceMatcher`) to detect repeating headers and footers in a `fitz.Document`, then provides a `strip()` method to remove them from extracted text. This is a self-contained utility with no dependencies beyond `fitz`, `difflib`, and our `PDFProcessorConfig`.

## Investigation Findings

### SPEC Requirements (sections 13.1-13.3)

**Algorithm (13.1):**
1. Sample `config.header_footer_sample_pages` pages (default 5), evenly distributed across the document.
2. Extract text from top `header_footer_zone_ratio` (default 10%) and bottom 10% by y-coordinate.
3. Compare text across sampled pages using `difflib.SequenceMatcher`.
4. Text on >= (sampled_pages - 1) pages at same position with similarity >= 0.7 is header/footer.
5. Build header patterns and footer patterns sets.
6. Strip matching text from each page before chunking.

**Fast Path (13.2):** pymupdf4llm handles most cases with `header=False, footer=False`. This module is a second pass for edge cases.

**Public Interface (13.3):**
- `HeaderFooterDetector.__init__(self, config: PDFProcessorConfig)`
- `HeaderFooterDetector.detect(self, doc: fitz.Document) -> tuple[list[str], list[str]]`
- `HeaderFooterDetector.strip(self, text: str, page_number: int, headers: list[str], footers: list[str]) -> str`

### Config Parameters (from `config.py` lines 77-80)

| Parameter | Type | Default | Purpose |
|-----------|------|---------|---------|
| `header_footer_sample_pages` | `int` | `5` | Number of pages to sample |
| `header_footer_zone_ratio` | `float` | `0.10` | Top/bottom zone as fraction of page height |
| `header_footer_similarity_threshold` | `float` | `0.7` | Minimum SequenceMatcher ratio to consider match |

### Existing Patterns

- `utils/__init__.py` is empty (1 line) — needs re-export.
- Tests use `pytest`, class-based grouping (e.g., `class TestValidPDF:`), programmatic PDF generation (reportlab + fitz), and `@pytest.fixture` for setup.
- `conftest.py` is a stub — no shared fixtures yet.
- Logger convention: `ingestkit_pdf` namespace.
- PII-safe logging: no raw text in logs unless `config.log_sample_text=True`.

### fitz API Notes

- `doc[i]` returns a `fitz.Page` object.
- `page.rect` gives page dimensions (`page.rect.height` for total height).
- `page.get_text("dict")` returns structured dict with `"blocks"` list; each block has `"bbox"` tuple `(x0, y0, x1, y1)` and `"lines"` containing `"spans"` with text.
- `page.get_text("blocks")` returns list of `(x0, y0, x1, y1, text, block_no, type)` tuples — simpler for zone extraction.
- `len(doc)` gives page count.

---

## Implementation Plan

### File 1: `packages/ingestkit-pdf/src/ingestkit_pdf/utils/header_footer.py`

```
Module docstring referencing SPEC sections 13.1-13.3
Imports: __future__.annotations, difflib, logging, TYPE_CHECKING (for fitz)
Import: PDFProcessorConfig from ingestkit_pdf.config
Logger: logging.getLogger("ingestkit_pdf.utils.header_footer")
```

#### Class: `HeaderFooterDetector`

**`__init__(self, config: PDFProcessorConfig)`**
- Store `self._config = config`
- Store shorthand references:
  - `self._sample_pages = config.header_footer_sample_pages`
  - `self._zone_ratio = config.header_footer_zone_ratio`
  - `self._similarity_threshold = config.header_footer_similarity_threshold`

**`_select_sample_indices(self, page_count: int) -> list[int]`** (private)
- If `page_count <= self._sample_pages`: return `list(range(page_count))`
- Otherwise: return evenly distributed indices using `[round(i * (page_count - 1) / (self._sample_pages - 1)) for i in range(self._sample_pages)]`
- Purpose: evenly distribute sample across document

**`_extract_zone_text(self, page: fitz.Page, zone: str) -> list[str]`** (private)
- `zone` is `"header"` or `"footer"`
- Get `page_height = page.rect.height`
- Compute zone boundary: `zone_height = page_height * self._zone_ratio`
- Get text blocks via `page.get_text("blocks")` — returns list of `(x0, y0, x1, y1, text, block_no, type)` tuples
- Filter blocks where `type == 0` (text blocks, not images)
- For `"header"`: filter blocks where `y0 < zone_height` (top zone)
- For `"footer"`: filter blocks where `y1 > page_height - zone_height` (bottom zone)
- Return list of stripped text strings (one per block), excluding empty strings
- Log at DEBUG level only; never log actual text unless `config.log_sample_text`

**`_find_repeating_patterns(self, zone_texts: list[list[str]]) -> list[str]`** (private)
- `zone_texts` is a list (one per sampled page) of lists of text strings found in the zone
- `min_occurrences = max(len(zone_texts) - 1, 1)` — text must appear on >= (sampled_pages - 1) pages
- Collect all unique candidate texts from first page's zone
- For each candidate, count how many other pages have a text block with `SequenceMatcher(None, candidate, other_text).ratio() >= self._similarity_threshold`
- If count >= `min_occurrences`: add to patterns (use the candidate text as the pattern)
- Also check candidates from all pages (not just first) to handle case where first page is a title page without the header
- Strategy: gather all unique texts from all pages, then for each check occurrence count
- Return deduplicated list of pattern strings

**`detect(self, doc: fitz.Document) -> tuple[list[str], list[str]]`** (public)
- Get `page_count = len(doc)`
- If `page_count < 2`: return `([], [])` — need at least 2 pages for cross-page comparison
- Select sample indices via `_select_sample_indices(page_count)`
- For each sampled page index:
  - Extract header zone texts via `_extract_zone_text(doc[idx], "header")`
  - Extract footer zone texts via `_extract_zone_text(doc[idx], "footer")`
  - Collect into `header_zone_texts: list[list[str]]` and `footer_zone_texts: list[list[str]]`
- Find header patterns via `_find_repeating_patterns(header_zone_texts)`
- Find footer patterns via `_find_repeating_patterns(footer_zone_texts)`
- Log info: number of header/footer patterns detected
- Return `(header_patterns, footer_patterns)`

**`strip(self, text: str, page_number: int, headers: list[str], footers: list[str]) -> str`** (public)
- `page_number` is available for future positional logic but not required for basic stripping
- For each header pattern in `headers`:
  - Remove lines from text that match with `SequenceMatcher` ratio >= `self._similarity_threshold`
- For each footer pattern in `footers`:
  - Remove lines from text that match with `SequenceMatcher` ratio >= `self._similarity_threshold`
- Implementation: split text into lines, filter out lines matching any pattern, rejoin
- Strip leading/trailing blank lines from result
- Return cleaned text

### File 2: `packages/ingestkit-pdf/src/ingestkit_pdf/utils/__init__.py`

Add re-export:
```python
"""Utility modules for ingestkit-pdf."""

from ingestkit_pdf.utils.header_footer import HeaderFooterDetector

__all__ = ["HeaderFooterDetector"]
```

### File 3: `packages/ingestkit-pdf/tests/test_header_footer.py`

```
Module docstring
Imports: __future__.annotations, unittest.mock, pytest, difflib
Import: PDFProcessorConfig, HeaderFooterDetector
```

#### Mock Strategy

Since we test without real PDFs, create mock `fitz.Document` and `fitz.Page` objects:

**Helper: `_make_mock_page(header_text, body_text, footer_text, page_height=792.0, zone_ratio=0.10)`**
- Creates a `MagicMock` page with:
  - `page.rect.height = page_height`
  - `page.get_text("blocks")` returns a list of block tuples:
    - Header block: `(72, 10, 500, 50, header_text, 0, 0)` — y0=10 is in top 10% zone (79.2)
    - Body block: `(72, 200, 500, 600, body_text, 1, 0)` — middle of page
    - Footer block: `(72, 750, 500, 780, footer_text, 2, 0)` — y1=780 is in bottom 10% zone (>712.8)
  - Filter empty texts from blocks

**Helper: `_make_mock_doc(pages: list[MagicMock])`**
- Creates a `MagicMock` doc with:
  - `len(doc)` returns `len(pages)` (via `__len__`)
  - `doc[i]` returns `pages[i]` (via `__getitem__`)

#### Test Classes

**`class TestSelectSampleIndices:`** (test private method directly for correctness)
- `test_fewer_pages_than_sample`: 3-page doc with sample=5 returns `[0, 1, 2]`
- `test_exact_pages`: 5-page doc returns `[0, 1, 2, 3, 4]`
- `test_more_pages_evenly_distributed`: 20-page doc with sample=5 returns `[0, 5, 10, 15, 19]`
- `test_single_page`: returns `[0]`

**`class TestExtractZoneText:`**
- `test_header_zone_extraction`: mock page with known header text, verify only header blocks returned
- `test_footer_zone_extraction`: mock page with known footer text, verify only footer blocks returned
- `test_image_blocks_ignored`: block with type=1 (image) should be excluded
- `test_empty_text_excluded`: blocks with empty/whitespace text should be excluded

**`class TestDetect:`**
- `test_single_page_returns_empty`: 1-page doc returns `([], [])`
- `test_consistent_header_detected`: 5-page doc where all pages have "Company Name" in header zone — detected
- `test_consistent_footer_detected`: 5-page doc where all pages have "Page X of Y" in footer zone — detected (similarity-based, not exact match)
- `test_header_missing_one_page_still_detected`: 5 pages, 4 have same header — should still detect (>= sampled_pages - 1)
- `test_header_missing_two_pages_not_detected`: 5 pages, only 3 have same header — should NOT detect
- `test_unique_text_not_detected`: each page has different header text — no patterns found
- `test_both_header_and_footer_detected`: pages with consistent header AND footer — both returned
- `test_empty_document`: 0-page doc returns `([], [])`
- `test_two_page_document`: minimum viable case, 2 pages with same header — detected
- `test_custom_config_thresholds`: config with different similarity threshold affects detection

**`class TestStrip:`**
- `test_strip_header_from_text`: text with matching header line is removed
- `test_strip_footer_from_text`: text with matching footer line is removed
- `test_strip_both_header_and_footer`: both removed in one call
- `test_strip_preserves_body`: body text unrelated to patterns is preserved
- `test_strip_similar_but_not_exact_match`: slightly different header text (e.g., "Page 1 of 10" vs pattern "Page 3 of 10") still stripped if similarity >= threshold
- `test_strip_no_patterns_returns_unchanged`: empty pattern lists return original text
- `test_strip_no_match_returns_unchanged`: patterns that don't match any line leave text intact

**`class TestIntegration:`**
- `test_detect_then_strip_pipeline`: full flow — detect on mock doc, then strip on sample text, verify clean output

All tests marked with `@pytest.mark.unit`.

---

## Acceptance Criteria

- [ ] `HeaderFooterDetector` class exists in `packages/ingestkit-pdf/src/ingestkit_pdf/utils/header_footer.py`
- [ ] `__init__` accepts `PDFProcessorConfig` and stores relevant parameters
- [ ] `detect()` accepts `fitz.Document`, returns `tuple[list[str], list[str]]`
- [ ] `detect()` samples pages evenly distributed across the document
- [ ] `detect()` extracts text from top/bottom `zone_ratio` of each sampled page by y-coordinate
- [ ] `detect()` uses `difflib.SequenceMatcher` for cross-page text comparison
- [ ] `detect()` requires text on >= (sampled_pages - 1) pages with similarity >= threshold
- [ ] `detect()` returns `([], [])` for documents with < 2 pages
- [ ] `strip()` removes lines matching header/footer patterns using similarity comparison
- [ ] `strip()` preserves non-matching body text
- [ ] `utils/__init__.py` re-exports `HeaderFooterDetector`
- [ ] All tests pass: `pytest packages/ingestkit-pdf/tests/test_header_footer.py -v`
- [ ] No raw text logged unless `config.log_sample_text=True` (PII-safe logging)
- [ ] No concrete backend dependencies — only stdlib `difflib` and `fitz` for document access
- [ ] Logger uses `ingestkit_pdf.utils.header_footer` name
