---
issue: 61
agent: PATCH
date: 2026-02-15
status: Complete
files_modified: 6
files_created: 3
tests_added: 57
lines_added: ~1100
lines_removed: ~15
---

# PATCH: Issue #61 -- Template System: CRUD, Versioning, and Fingerprinting

## Executive Summary

Implemented three interconnected components: (1) `matcher.py` with layout fingerprinting and similarity scoring using Otsu thresholding and grid-based quantization, (2) `FileSystemTemplateStore` in `stores/filesystem.py` implementing all 6 `FormTemplateStore` protocol methods with JSON persistence and metadata-based soft-delete, (3) `FormTemplateAPI` in `api.py` with 6 CRUD operations that compose the store and matcher. Added `FormIngestException` to `errors.py` as a raisable Exception wrapper for the Pydantic-based `FormIngestError` model. All 209 tests pass (152 existing + 57 new), zero regressions.

## Metrics

| Metric | Value |
|--------|-------|
| Files modified | 6 |
| Files created | 3 |
| Tests added | 57 |
| Total tests passing | 209 |
| Regressions | 0 |

## Files Changed

### Created

| File | Purpose |
|------|---------|
| `packages/ingestkit-forms/src/ingestkit_forms/stores/__init__.py` | Package init, exports `FileSystemTemplateStore` |
| `packages/ingestkit-forms/src/ingestkit_forms/stores/filesystem.py` | `FileSystemTemplateStore` with 6 protocol methods, `_TemplateMeta` for soft-delete |
| `packages/ingestkit-forms/tests/test_stores.py` | 18 tests for FileSystemTemplateStore |

### Modified

| File | Changes |
|------|---------|
| `packages/ingestkit-forms/src/ingestkit_forms/matcher.py` | Replaced docstring stub with full implementation: `compute_layout_fingerprint`, `compute_layout_similarity`, `compute_layout_fingerprint_from_file`, `_compute_otsu_threshold`, `_quantize_fill_ratio`, `PageRenderer` type alias |
| `packages/ingestkit-forms/src/ingestkit_forms/api.py` | Replaced docstring stub with `FormTemplateAPI` class: create, update, delete, get, list, list_versions |
| `packages/ingestkit-forms/src/ingestkit_forms/errors.py` | Added `FormIngestException(Exception)` wrapper class |
| `packages/ingestkit-forms/src/ingestkit_forms/__init__.py` | Added exports for `FormTemplateAPI`, matcher functions, `FileSystemTemplateStore`, `FormIngestException` |
| `packages/ingestkit-forms/tests/conftest.py` | Added `MockFormTemplateStore`, image fixtures (`blank_page_image`, `form_like_image`, `sample_image_file`), updated `mock_template_store` fixture |
| `packages/ingestkit-forms/tests/test_matcher.py` | 26 tests for fingerprinting, quantization, similarity, file-based fingerprinting |
| `packages/ingestkit-forms/tests/test_api.py` | 13 tests for all 6 CRUD operations, error paths, fingerprint failure handling |

## Issues Encountered

### 1. FormIngestError is not raisable (CRITICAL)

`FormIngestError` extends `BaseIngestError(BaseModel)` from `ingestkit-core`. Pydantic BaseModel instances cannot be raised as Python exceptions. The PLAN specified `raise FormIngestError(...)` in stores, API, and matcher, but this causes `TypeError` at runtime.

**Resolution:** Created `FormIngestException(Exception)` in `errors.py` that wraps a `FormIngestError` model as its `.error` attribute. All `raise` statements use `FormIngestException`. The structured `FormIngestError` model remains available for serialization/data via `exc.error`. Convenience properties (`code`, `message`, `stage`, `recoverable`) delegate to the underlying model.

This is a cross-cutting issue that also affects other issues (#62, #63, #64) that similarly raise `FormIngestError`. Those will need to be updated to use `FormIngestException` as well.

### 2. Otsu threshold edge case with sparse structural elements

The Otsu thresholding implementation returned threshold=0 for images with mostly white background and sparse dark structural elements (like form lines/boxes). With the binarization check `p < 0`, no pixels were classified as dark.

**Resolution:** (a) Changed binarization from `p < threshold` to `p <= threshold` to correctly classify pixels AT the threshold as dark. (b) Added fallback: if `max_variance == 0.0` (uniform image), return threshold=128 (midpoint) instead of 0.

### 3. Pillow deprecation: `getdata()` -> `get_flattened_data()`

`Image.Image.getdata()` is deprecated and will be removed in Pillow 14 (2027-10-15).

**Resolution:** Used `get_flattened_data()` instead.

### 4. Pre-existing broken test_extractors.py

`test_extractors.py` imports from `_helpers` module which does not exist -- this is from another issue's uncommitted work. All test runs exclude this file.

## Deviations from PLAN

1. **`FormIngestException` added** -- not in PLAN. Required because `FormIngestError` (Pydantic BaseModel) cannot be raised as an exception.
2. **Otsu threshold binarization** -- PLAN specified `p < threshold`; changed to `p <= threshold` to fix edge case where threshold=0.
3. **`get_flattened_data()`** -- PLAN specified `getdata()`; updated due to Pillow deprecation.
4. **Test count** -- PLAN targeted ~48 tests; delivered 57 (more granular coverage).

## Acceptance Criteria Status

All criteria from PLAN met. See plan-61-021526.md for full list.

## Verification

```
$ ruff check packages/ingestkit-forms/
All checks passed!

$ pytest packages/ingestkit-forms/tests/ -q --ignore=.../test_extractors.py
209 passed in 3.75s

$ python3 -c "from ingestkit_forms.stores.filesystem import FileSystemTemplateStore; ..."
isinstance check: True
```

---

AGENT_RETURN: .agents/outputs/patch-61-021526.md
