---
issue: 65
agent: PATCH
date: 2026-02-15
status: Complete
files_modified: 2
files_created: 0
tests_added: 19
lines_added: ~520
lines_removed: 6
---

# PATCH: Issue #65 -- Implement Excel Cell Mapping Extraction

## Executive Summary

Implemented `ExcelCellExtractor` in `extractors/excel_cell.py` replacing the stub. The class extracts form field values from Excel files using openpyxl cell address mappings, supporting single cells, ranges (D5:D7), merged cell resolution, type coercion for all FieldTypes, confidence scoring (0.95/0.0/0.95), and validation pattern with ReDoS timeout protection. Added 19 unit tests (27 including parametrized variants) with full coverage of the spec section 7.3 algorithm. All 374 tests pass, zero regressions.

## Metrics

| Metric | Value |
|--------|-------|
| Files modified | 2 (`excel_cell.py`, `test_extractors.py`) |
| Files updated (wiring) | 1 (`extractors/__init__.py` -- auto-formatted by linter to include VLMFieldExtractor too) |
| Tests added | 19 test functions (27 variants with parametrize) |
| Lines added | ~520 |
| Lint status | All checks passed |
| Test status | 374 passed, 0 failed |

## Files Changed

### `packages/ingestkit-forms/src/ingestkit_forms/extractors/excel_cell.py`

Replaced 6-line stub with full implementation (~260 lines):

- `ExcelCellExtractor.__init__(config)` -- takes `FormProcessorConfig`
- `extract(file_path, template) -> list[ExtractedField]` -- main entry, opens workbook with `data_only=True`, `read_only=False`
- `_extract_field(wb, field)` -- per-field extraction with sheet resolution, cell/range dispatch, empty handling, coercion, validation
- `_resolve_merged_cell(ws, cell_coord)` -- checks `ws.merged_cells.ranges` containment, reads top-left cell
- `_read_range(ws, range_str)` -- reads all cells in range, joins non-empty with newline (always TEXT before coercion, per PLAN-CHECK correction)
- `_coerce_value(raw_value, field_type)` -- static method, handles NUMBER (float), DATE (datetime->ISO string), CHECKBOX (truthy/falsy mapping including Python bools), TEXT/DROPDOWN/RADIO/SIGNATURE (str.strip)
- `_validate_field_value(value, field)` -- static method with ReDoS-protected `_regex_match_with_timeout()` using threading (1s timeout), consistent with OCR overlay extractor
- `_regex_match_with_timeout(pattern, value, timeout)` -- module-level helper using `re.fullmatch` (not `re.match` as in OCR overlay, since validation requires full string match)

### `packages/ingestkit-forms/src/ingestkit_forms/extractors/__init__.py`

Added `ExcelCellExtractor` to imports and `__all__`. (Linter auto-formatted to multi-line `__all__`.)

### `packages/ingestkit-forms/tests/test_extractors.py`

Added Excel cell extraction test section (~260 lines) with mock helpers and 19 test functions:

| # | Test | Verifies |
|---|------|----------|
| 1 | `test_excel_extract_text_field_single_cell` | Single cell TEXT, confidence=0.95, method="cell_mapping" |
| 2 | `test_excel_extract_number_field_coercion` | NUMBER coercion float(42.5) |
| 3 | `test_excel_extract_number_field_coercion_failure` | NUMBER "abc" -> None, W_FORM_FIELD_TYPE_COERCION |
| 4 | `test_excel_extract_date_field` | DATE datetime -> ISO string |
| 5 | `test_excel_extract_checkbox_true_values` | Parametrized: X, x, Yes, TRUE, 1, True -> True |
| 6 | `test_excel_extract_checkbox_false_values` | Parametrized: No, FALSE, 0, False -> False |
| 7 | `test_excel_extract_cell_range` | Range D5:D7 -> newline join |
| 8 | `test_excel_extract_cell_range_skips_empty` | Range with None cells -> skipped |
| 9 | `test_excel_merged_cell_resolution` | Merged cell -> top-left, W_FORM_MERGED_CELL_RESOLVED |
| 10 | `test_excel_empty_required_field` | Empty + required -> confidence=0.0, W_FORM_FIELD_MISSING_REQUIRED |
| 11 | `test_excel_empty_optional_field` | Empty + optional -> confidence=0.95, value=default |
| 12 | `test_excel_validation_pattern_pass` | Regex match -> validation_passed=True |
| 13 | `test_excel_validation_pattern_fail` | Regex fail -> validation_passed=False, W_FORM_FIELD_VALIDATION_FAILED |
| 14 | `test_excel_sheet_name_resolution` | Explicit sheet_name routing |
| 15 | `test_excel_sheet_name_not_found` | Invalid sheet -> value=None, confidence=0.0 |
| 16 | `test_excel_multiple_fields_extraction` | 3 fields in order |
| 17 | `test_excel_skips_pdf_fields` | Region-based fields skipped |
| 18 | `test_excel_corrupt_workbook_raises_exception` | FormIngestException with E_FORM_FILE_CORRUPT |
| 19 | `test_excel_validation_redos_protection` | ReDoS pattern -> timeout/no match |

## PLAN-CHECK Corrections Applied

1. **ReDoS timeout protection**: Implemented `_regex_match_with_timeout()` in `excel_cell.py` using threading with 1s timeout, consistent with `ocr_overlay.py`. Uses `re.fullmatch` (stricter than OCR's `re.match`) since validation patterns should match the entire value.

2. **`_read_range` return type clarified**: Returns `tuple[str, list[str]]` -- ranges always produce TEXT values (newline-joined strings) before coercion. Documented in docstring per PLAN-CHECK recommendation.

3. **Corrupt workbook test added**: Test 18 verifies `FormIngestException` with `E_FORM_FILE_CORRUPT` on workbook open failure (optional improvement from PLAN-CHECK).

## Deviations from MAP-PLAN

1. **DATE coercion returns ISO string**: `ExtractedField.value` is typed `str | bool | float | None` -- cannot hold `datetime` objects. Changed `_coerce_value` to return `datetime.isoformat()` string instead. Test updated accordingly.

2. **MagicMock `__getitem__` requires `_self` parameter**: MagicMock dunder methods pass `self` as first arg. All mock helper `getitem` functions updated to accept `(_self, key)`.

## Verification

```
ruff check extractors/excel_cell.py  -> All checks passed!
pytest -k "excel or cell"           -> 27 passed
pytest (full suite)                  -> 374 passed, 0 failed, 2 warnings
```

## Acceptance Criteria Status

All criteria met. See MAP-PLAN for full list.

---

AGENT_RETURN: .agents/outputs/patch-65-021526.md
