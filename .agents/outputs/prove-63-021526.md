---
issue: 63
agent: PROVE
date: 2026-02-15
status: PASS
tests_passed: 305
tests_failed: 0
regressions: 0
native_pdf_tests: 16
---

# PROVE Report: Issue #63 -- Native PDF Form Field Extraction

## Executive Summary

All 7 verification gates pass. `NativePDFExtractor` is fully implemented with correct IoU matching, value coercion for all 7 `FieldType` values, regex validation, and flattened form detection. 16 native PDF unit tests pass; 305 total tests pass with zero failures and zero regressions. No direct PyMuPDF imports exist in the source. Ruff lint is clean.

---

## Verification Results

### 1. Ruff Lint

```
ruff check packages/ingestkit-forms/src/ingestkit_forms/extractors/native_pdf.py
All checks passed!
```

**Result:** PASS

### 2. Native PDF Tests (16/16)

```
pytest packages/ingestkit-forms/tests/test_extractors.py -v -k "<native_pdf_filter>"
16 passed
```

| # | Test | Status |
|---|------|--------|
| 1 | test_extract_text_field_exact_match | PASS |
| 2 | test_extract_text_field_iou_above_threshold | PASS |
| 3 | test_extract_text_field_iou_below_threshold | PASS |
| 4 | test_extract_checkbox_checked | PASS |
| 5 | test_extract_checkbox_unchecked | PASS |
| 6 | test_extract_radio_button | PASS |
| 7 | test_extract_dropdown | PASS |
| 8 | test_extract_number_field_coercion | PASS |
| 9 | test_flattened_form_detection | PASS |
| 10 | test_validation_pattern_pass | PASS |
| 11 | test_validation_pattern_fail | PASS |
| 12 | test_multiple_fields_multiple_pages | PASS |
| 13 | test_no_ocr_backend_unmatched_field | PASS |
| 14 | test_configurable_iou_threshold | PASS |
| 15 | test_iou_computation_direct | PASS |
| 16 | test_extraction_method_label | PASS |

**Result:** PASS

### 3. IoU Computation Correctness

Verified by code inspection (`native_pdf.py:138-168`) and test 15:

- **Algorithm:** Standard axis-aligned bounding box IoU. Converts `(x, y, w, h)` to corner coordinates, computes intersection rectangle with `max/min` clamped to 0, divides intersection area by union area (`area_a + area_b - intersection`).
- **Edge cases:** Zero union returns 0.0. Negative intersection dimensions clamped to 0.0.
- **Test coverage:** Identical boxes (1.0), no overlap (0.0), partial overlap (1/3), configurable threshold (test 14 confirms 0.5 vs 0.8 behavior).

**Result:** PASS -- mathematically correct standard IoU

### 4. All 7 FieldTypes Handled in Coercion

`_coerce_widget_value()` (`native_pdf.py:170-201`):

| FieldType | Coercion | Null handling |
|-----------|----------|---------------|
| TEXT | Return as-is | None |
| DATE | Return as-is | None |
| NUMBER | `float()`, fallback to raw | None |
| CHECKBOX | Truthy set `{"yes","on","true","1"}` | False |
| RADIO | Same truthy set as CHECKBOX | False |
| SIGNATURE | `bool(raw_value.strip())` | False |
| DROPDOWN | Return as-is | None |

All 7 values of `FieldType` enum are covered. Confirmed by cross-referencing `models.py:41-50`.

**Result:** PASS

### 5. Flattened Form Detection

`extract()` method (`native_pdf.py:60-62`):
```python
if not self._pdf_backend.has_form_fields(file_path):
    logger.warning("PDF has no form fields (flattened): %s", file_path)
    return []
```

Test 9 (`test_flattened_form_detection`) confirms: `MockPDFWidgetBackend(has_fields=False)` causes `extract()` to return `[]`.

**Result:** PASS

### 6. No Direct PyMuPDF Imports

Searched `native_pdf.py` for `fitz`, `pymupdf`, `PyMuPDF` -- zero matches. All PDF interaction goes through the `PDFWidgetBackend` protocol and `WidgetField` model from `protocols.py`.

**Result:** PASS

### 7. Full Test Suite

```
pytest packages/ingestkit-forms/tests/ -q
305 passed, 2 warnings in 6.00s
```

Zero failures. The 2 warnings are unrelated Pillow deprecation notices in OCR overlay tests. The PATCH reported 3 pre-existing failures in `test_matcher.py`/`test_stores.py` -- these have been resolved since (likely by a subsequent patch).

**Result:** PASS

---

## Acceptance Criteria

| Criterion | Status |
|-----------|--------|
| `NativePDFExtractor` with extract/iou/coerce/validate/match methods | PASS |
| Constructor: PDFWidgetBackend (req), Config (req), OCRBackend (opt) | PASS |
| IoU threshold from `config.native_pdf_iou_threshold` | PASS |
| Matched fields: confidence=0.95, method="native_fields" | PASS |
| Unmatched + OCR backend: method="native_fields_with_ocr_fallback" | PASS |
| Unmatched + no OCR: method="native_fields", value=None | PASS |
| Flattened PDF: returns empty list | PASS |
| All 7 FieldTypes coerced correctly | PASS |
| Validation via `re.fullmatch()`, invalid regex handled | PASS |
| `extractors/__init__.py` exports NativePDFExtractor | PASS |
| MockPDFWidgetBackend and MockOCRBackend in test file | PASS |
| 16 unit tests, all passing | PASS |
| No concrete backend imports in native_pdf.py | PASS |
| Ruff lint clean | PASS |

---

## Comparison with PATCH

All PATCH claims verified. One discrepancy noted (non-blocking):

- **PATCH claimed:** "3 pre-existing failures in test_matcher.py/test_stores.py"
- **Actual:** 305 passed, 0 failed. These failures have been resolved since the PATCH was written (likely by issue #64 or #65 patches that landed afterward). This is a positive discrepancy.

---

## Recommendation

**APPROVED** -- Issue #63 is complete and ready for merge.

---

**Generated:** 2026-02-15
**Agent:** PROVE
**Verification Method:** ruff lint + pytest execution + code inspection

AGENT_RETURN: .agents/outputs/prove-63-021526.md
