---
issue: 44
agent: PATCH
date: 2026-02-14
status: Complete
files_modified: 3
files_created: 0
tests_added: 22
lines_added: 413
lines_removed: 8
---

# PATCH Artifact: Issue #44 -- PaddleOCR Adapter and Engine Fallback Chain

## Executive Summary

Implemented `PaddleOCREngine` adapter class in `ocr_engines.py` with PIL-to-numpy conversion, defensive parsing of PaddleOCR's nested result structure, and PaddleOCR-specific language mapping (4 exceptions). Updated `create_ocr_engine()` factory to return `PaddleOCREngine` when paddleocr is importable, preserving the existing `W_OCR_ENGINE_FALLBACK` warning on fallback. Added 22 new tests (21 unit + 1 integration gated behind `@pytest.mark.ocr_paddle`). All 676 tests pass, zero regressions.

## Metrics

| Metric | Value |
|--------|-------|
| Files modified | 3 |
| Files created | 0 |
| Tests added | 22 |
| Lines added | 413 |
| Lines removed | 8 |

## Files Changed

### 1. `packages/ingestkit-pdf/src/ingestkit_pdf/utils/ocr_engines.py` (+126/-8)

- Added `_PADDLEOCR_LANG_MAP` dict with 4 exception mappings (zh->ch, ko->korean, ja->japan, de->german)
- Added `_to_paddleocr_lang()` function with pass-through for unmapped codes
- Added `PaddleOCREngine` class with `__init__`, `recognize`, `name` methods matching SPEC 12.4
- Updated `create_ocr_engine()` factory: replaced stub `raise ImportError` with `return PaddleOCREngine(lang=config.ocr_language), warnings`
- Updated module docstring to mention PaddleOCR adapter

### 2. `packages/ingestkit-pdf/src/ingestkit_pdf/utils/__init__.py` (+2/-0)

- Added `PaddleOCREngine` to import from `ocr_engines`
- Added `"PaddleOCREngine"` to `__all__` list (alphabetical position between `OCRPageResult` and `PageRenderer`)

### 3. `packages/ingestkit-pdf/tests/test_ocr_engines.py` (+293/-0)

- Updated imports to include `PaddleOCREngine`, `_PADDLEOCR_LANG_MAP`, `_to_paddleocr_lang`
- Added `TestPaddleOCRLanguageMapping` class (8 tests): all 4 exception mappings, pass-through for en/fr/xyz, map-only-contains-exceptions
- Added `_mock_paddleocr_result()` helper for building mock PaddleOCR return values
- Added `TestPaddleOCREngine` class (12 tests): name, init, language mapping, ImportError, recognize basic/empty/None/whitespace/language-remap, confidence, protocol, default lang
- Added `test_paddleocr_engine_satisfies_protocol` to `TestOCREngineInterface`
- Added `test_paddleocr_config_returns_paddleocr_engine_when_available` to `TestCreateOCREngine`
- Added `TestPaddleOCREngineIntegration` class (1 test) gated with `@pytest.mark.ocr_paddle` + `@pytest.mark.skipif`
- Added module-level `_has_paddleocr` flag for skipif condition

## Issues Encountered

### numpy mock interaction with pytest.approx

**Problem**: Initially used `patch.dict(sys.modules, {"numpy": mock_np})` to mock numpy in `recognize()` tests. This polluted `sys.modules["numpy"]` such that `pytest.approx` (which internally calls `isinstance(val, np.bool_)`) received a MagicMock instead of the real numpy module, causing `TypeError`.

**Fix**: Changed to `patch("numpy.array", mock_np.array)` which patches only the `array` function on the real numpy module, leaving `numpy.bool_` intact for pytest.

### Integration test not auto-skipping

**Problem**: The `@pytest.mark.ocr_paddle` marker is registered in `pyproject.toml` but doesn't auto-skip tests. Without paddleocr installed, the integration test failed with `ModuleNotFoundError`.

**Fix**: Added `@pytest.mark.skipif(not _has_paddleocr, reason="PaddleOCR not installed")` decorator alongside `@pytest.mark.ocr_paddle`. The module-level try/except import sets the `_has_paddleocr` flag.

## Deviations from PLAN

1. **numpy mock strategy**: PLAN used `patch.dict(sys.modules, {"numpy": mock_np})`. Changed to `patch("numpy.array", ...)` to avoid breaking pytest internals (see Issues Encountered above).
2. **Integration test skipif**: PLAN did not include `@pytest.mark.skipif`. Added to prevent failure in environments without paddleocr since the `ocr_paddle` marker alone doesn't skip.

Both deviations are strictly necessary fixes; no functional behavior change.

## Verification

```
pytest packages/ingestkit-pdf/tests/test_ocr_engines.py -v  -->  57 passed, 1 skipped
pytest packages/ingestkit-pdf/tests/ -q (excl. pre-broken test_utils.py)  -->  676 passed, 1 skipped
ruff check (3 modified files)  -->  0 new errors (1 pre-existing F401 in test imports)
```

## Acceptance Criteria Status

All criteria from PLAN met. See plan-44-021426.md for full list.

---

AGENT_RETURN: .agents/outputs/patch-44-021426.md
