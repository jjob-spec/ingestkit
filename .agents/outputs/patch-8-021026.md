# PATCH Artifact: Issue #8 -- Path A Structured DB Processor

**Issue:** #8
**Date:** 2026-02-11
**Plan artifact:** `plan-8-021026.md`
**Map artifact:** `map-8-021026.md`
**Status:** IMPLEMENTED -- all tests passing

---

## Files Created

### 1. `src/ingestkit_excel/processors/__init__.py` (NEW)

Re-exports `StructuredDBProcessor` from the `structured_db` submodule.

### 2. `src/ingestkit_excel/processors/structured_db.py` (NEW)

Main processor implementation containing:

- **Module-level helpers:**
  - `clean_name(raw: str) -> str` -- Cleans column/sheet names for DB identifiers (lowercase, special chars to underscores, dedup consecutive underscores, strip leading/trailing).
  - `deduplicate_names(names: list[str]) -> list[str]` -- Deduplicates cleaned names with `_1`, `_2` suffixes. Empty names become `column_N`.

- **`StructuredDBProcessor` class:**
  - `__init__(structured_db, vector_store, embedder, config)` -- Accepts all backend dependencies.
  - `process(file_path, profile, ingest_key, ingest_run_id, parse_result, classification_result, classification) -> ProcessingResult` -- Full Path A processing pipeline.
  - `_auto_detect_dates(df)` -- Two heuristics: Excel serial dates (35000-55000 range) and string dates (>50% parse threshold). Compatible with pandas 3.0 `StringDtype`.
  - `_generate_schema_description(table_name, df)` -- Natural language schema for embedding.
  - `_infer_type_label(series)` -- Maps pandas dtypes to human labels.
  - `_describe_column(series, col_type, low_card_threshold)` -- Generates column value descriptions.
  - `_serialize_rows(...)` -- Converts rows to NL sentences for vector search.
  - `_classify_backend_error(exc)` -- Maps exceptions to ErrorCode values.

### 3. `tests/test_structured_db.py` (NEW)

59 tests organized in 9 test classes:

| Class | Tests | Coverage |
|---|---|---|
| `TestCleanName` | 7 | Column name cleaning edge cases |
| `TestDeduplicateNames` | 4 | Name deduplication logic |
| `TestAutoDetectDates` | 6 | Date detection heuristics |
| `TestSchemaDescription` | 8 | Schema description generation |
| `TestSerializeRows` | 5 | Row serialization format and metadata |
| `TestProcessFlow` | 12 | Full process() happy path and field verification |
| `TestRowSerializationIntegration` | 4 | Row serialization triggers and batching |
| `TestMultiSheetProcessing` | 3 | Multi-sheet, global chunk index, name dedup |
| `TestSheetSkipping` | 3 | Hidden, oversized, all-skipped scenarios |
| `TestErrorHandling` | 5 | DB/embed failures, error details, continuation |
| `TestConfigInteractions` | 2 | Config-driven behavior (clean names, custom collection) |

Mock backends: `MockStructuredDB`, `MockVectorStore`, `MockEmbedder` -- all defined in-file with recording capabilities and configurable failure modes.

---

## Files Modified

### 4. `src/ingestkit_excel/__init__.py` (MODIFIED)

- Added `from ingestkit_excel.processors import StructuredDBProcessor` import.
- Added `"StructuredDBProcessor"` to `__all__` list under `# Processors` section.

---

## Key Implementation Decisions

### pandas 3.0 Compatibility

The project uses pandas 3.0.0, which defaults to `StringDtype` instead of `object` for string columns. The date detection heuristic was updated to check both:

```python
if series.dtype == object or pd.api.types.is_string_dtype(series):
```

This ensures string date detection works with both pandas 2.x (`object` dtype) and pandas 3.x (`StringDtype`).

### ENUM_VALUE Pattern

Correctly applied throughout:
- `ChunkMetadata.ingestion_method` = `IngestionMethod.SQL_AGENT.value` = `"sql_agent"` (string)
- `ProcessingResult.ingestion_method` = `IngestionMethod.SQL_AGENT` (enum member)
- `ChunkMetadata.parser_used` = `sheet.parser_used.value` = `"openpyxl"` (string)
- Warning/error strings use `ErrorCode.*.value`

### Date Detection with `format="mixed"`

Uses `format="mixed"` instead of the deprecated `infer_datetime_format=True`, compatible with pandas >= 2.0.

---

## Test Results

```
335 passed in 0.46s
```

- 276 existing tests: all pass (no regressions)
- 59 new tests: all pass
