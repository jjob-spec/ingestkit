---
issue: 69
agent: PATCH
date: 2026-02-15
status: Complete
files_modified: 3
files_created: 0
tests_added: 18
lines_added: ~520
lines_removed: ~5
---

# PATCH - Issue #69: FormRouter and Plugin API Surface

## Executive Summary

Implemented `FormRouter` orchestrator (~320 lines) in `router.py` with the full 12-step extraction pipeline, `create_default_router()` factory, and 4 new API methods on `FormTemplateAPI`. All 3 PLAN-CHECK blocking issues applied: idempotency module untouched (B1), router calls `compute_ingest_key()` directly (B2), `__init__.py` only adds `FormRouter` and `create_default_router` (B3). All 491 tests pass including 18 new tests (18 router + 7 API).

## Metrics

| Metric | Value |
|--------|-------|
| Files modified | 3 (`router.py`, `api.py`, `__init__.py`) |
| Files created | 0 |
| Tests added | 18 router + 7 API = 25 total new tests |
| Full suite | 491 passed, 0 failed |

## Files Changed

### `packages/ingestkit-forms/src/ingestkit_forms/router.py`
- Replaced 5-line stub with full `FormRouter` class (~320 lines)
- Constructor accepts 9 DI backends per PLAN D1
- `extract_form()`: 12-step pipeline (ingest key, run_id, template resolve, extraction key, source detect, extract, confidence, VLM, fail-closed, build result, dual-write, assemble)
- `extract_form_batch()`: sequential iteration
- Private helpers: `_select_extractor`, `_run_extraction`, `_apply_confidence_and_vlm`, `_build_extraction_result`
- `create_default_router()`: factory requiring 5 explicit backends, optional 3

### `packages/ingestkit-forms/src/ingestkit_forms/api.py`
- Added `matcher` and `router` optional params to `FormTemplateAPI.__init__`
- Added 4 new methods: `render_document`, `preview_extraction`, `match_document`, `extract_form`
- All new methods guard on dependency availability (raise `FormIngestException` if not configured)

### `packages/ingestkit-forms/src/ingestkit_forms/__init__.py`
- Added import of `FormRouter` and `create_default_router` from `router`
- Added both to `__all__`

### `packages/ingestkit-forms/tests/test_router.py`
- 18 tests: constructor (2), extractor selection (4), pipeline (7), VLM (1), factory (3), idempotency (1)

### `packages/ingestkit-forms/tests/test_api.py`
- 7 new tests: match_document (2), extract_form (2), render_document (1), preview_extraction (1), existing match_document_raises (already counted)

## PLAN-CHECK Corrections Applied

1. **B1**: Did NOT touch `idempotency.py` -- already fully implemented
2. **B2**: Router calls `compute_ingest_key()` from `ingestkit_forms.idempotency` (re-exported from core), not the non-existent `compute_form_ingest_key()`
3. **B3**: `__init__.py` only adds `FormRouter` and `create_default_router` -- idempotency exports already present

## Deviations from PLAN

1. **Extraction key unused warning**: The `compute_form_extraction_key()` result is assigned to `_extraction_key` (underscore prefix) since it's computed for spec compliance/idempotency tracking but not consumed by a downstream step in the current pipeline. The dedup gate (#72) will use it.
2. **Test count**: PLAN estimated 18 router tests; implemented 18. PLAN estimated 5 API tests; implemented 7 (added guards for both match_document and extract_form without dependencies).

## Verification

```
ruff check: All checks passed
pytest test_router.py test_api.py: 37 passed
pytest full suite: 491 passed, 0 failed
Import check: from ingestkit_forms import FormRouter, create_default_router -- OK
```

## Acceptance Criteria Status

All criteria met. See plan-69-021526.md for full list.

---
AGENT_RETURN: patch-69-021526.md
