# MAP Artifact: Issue #64 — Implement OCR Overlay Extraction for Scanned/Image Forms

**Date:** 2026-02-15
**Issue:** #64 — Implement OCR overlay extraction for scanned/image forms
**Complexity:** COMPLEX

---

## 1. Codebase Context

### 1.1 Files Investigated

| File | Path | Status | Relevance |
|------|------|--------|-----------|
| Spec §7.2 | `/home/jjob/projects/ingestkit/docs/specs/form-ingestor-plugin.md` L744-828 | Authoritative | Full algorithm, preprocessing pipeline, per-field-type logic |
| Spec §3.1 | Same file, L107-155 | Authoritative | Source detection flow — OCR extractor invoked for scanned PDFs, flattened PDFs, and images |
| Spec §7.4 | Same file, L869-907 | Authoritative | Per-field confidence scoring, overall confidence computation |
| Spec §7.5 | Same file, L909-975 | Context | VLM fallback (downstream consumer, not part of this issue) |
| Spec §13.4 | Same file, L1999-2004 | Authoritative | Security: decompression bomb, resolution limits, no external URLs |
| Spec §18.1-18.2 | Same file, L2390-2412 | Authoritative | Performance: <2s per OCR field, 10s timeout, 512MB peak memory |
| OCR stub | `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/extractors/ocr_overlay.py` | Stub (7 lines) | Target file for implementation |
| Protocols | `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/protocols.py` | Complete | `OCRBackend.ocr_region()` signature, `OCRRegionResult` model |
| Models | `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/models.py` | Complete | `BoundingBox`, `ExtractedField`, `FieldType`, `FieldMapping`, `FormTemplate` |
| Config | `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/config.py` | Complete | `form_ocr_dpi`, `form_ocr_engine`, `form_ocr_language`, `form_ocr_per_field_timeout_seconds`, `checkbox_fill_threshold`, `signature_ink_threshold`, `form_extraction_min_field_confidence` |
| Errors | `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/errors.py` | Complete | `E_FORM_OCR_FAILED`, `E_FORM_EXTRACTION_TIMEOUT`, `E_FORM_EXTRACTION_FAILED`, `W_FORM_FIELD_VALIDATION_FAILED`, `W_FORM_FIELD_LOW_CONFIDENCE` |
| Test file | `/home/jjob/projects/ingestkit/packages/ingestkit-forms/tests/test_extractors.py` | Stub (1 line) | Target file for tests |
| Native PDF extractor | `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/extractors/native_pdf.py` | Stub (7 lines) | Sibling extractor — same stub pattern |
| Extractors __init__ | `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/extractors/__init__.py` | Exists | Will need updated exports |

### 1.2 Key Design Constraints

1. **Backend-agnostic core**: OCR engine accessed only via `OCRBackend` protocol (never import Tesseract/PaddleOCR directly)
2. **Structural subtyping**: No ABCs, use `typing.Protocol` with `@runtime_checkable`
3. **Pillow is a core dependency**: Available for all image operations (crop, deskew, contrast, threshold)
4. **PyMuPDF is optional** (`[pdf]` extra): PDF page rendering requires it; must handle import failure gracefully
5. **PII-safe logging**: No raw OCR text in logs unless `config.log_ocr_output=True`
6. **Fail-closed**: On extraction failure, return `ExtractedField` with `value=None` and `confidence=0.0`

---

## 2. Implementation Plan

### 2.1 Subtask Breakdown

#### Subtask 1: Image Preprocessing Module
**File:** `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/extractors/_preprocessing.py` (new private module)

Implement standalone image preprocessing functions used by the OCR extractor:

| Function | Purpose | Spec Reference |
|----------|---------|----------------|
| `deskew(image: Image) -> Image` | Correct rotation up to +/-15 degrees | §7.2 preprocessing pipeline |
| `enhance_contrast(image: Image) -> Image` | CLAHE (Contrast Limited Adaptive Histogram Equalization) | §7.2 preprocessing pipeline |
| `reduce_noise(image: Image) -> Image` | Bilateral filter to preserve edges | §7.2 preprocessing pipeline |
| `adaptive_threshold(image: Image) -> Image` | Binarization via adaptive threshold / Otsu's method | §7.2 preprocessing pipeline |
| `preprocess_for_ocr(image: Image, field_type: FieldType) -> Image` | Orchestrates the full pipeline per field type | §7.2 field-specific preprocessing |
| `compute_fill_ratio(image: Image) -> float` | Dark pixels / total pixels for checkbox/radio | §7.2 step 2e |
| `compute_ink_ratio(image: Image) -> float` | Ink ratio for signature detection | §7.2 step 2f |

**Implementation notes:**
- Use Pillow (`PIL.ImageFilter`, `PIL.ImageOps`, `PIL.ImageEnhance`) for basic operations
- CLAHE: Pillow does not have native CLAHE. Implement manually using `ImageOps.equalize` with tiled approach, OR note that `Pillow>=10.0` supports `ImageFilter` — simplest approach is a contrast-limited equalization approximation using `ImageOps.autocontrast` with `cutoff` parameter as an acceptable v1 approximation (document the trade-off). Alternatively, if numpy is available (it will be as a transitive dependency of any OCR backend), implement a proper CLAHE on the numpy array.
- Bilateral filter: Not natively in Pillow. Use a median filter (`ImageFilter.MedianFilter`) as v1 approximation, or implement bilateral via numpy. Since numpy will be available (Pillow's internal dep + OCR backends pull it in), a numpy-based bilateral is feasible.
- Deskew: Compute skew angle via Hough line detection or projection profile analysis on the binarized image. Pillow's `Image.rotate()` for correction.

**Risk:** CLAHE and bilateral filter are not native Pillow operations. Options:
- (a) Add `numpy` as explicit dependency (it's already a transitive dep of Pillow and all OCR backends)
- (b) Use Pillow approximations (lower quality but zero new deps)
- **Recommendation:** Option (a) — numpy is already pulled in transitively. Add it to `pyproject.toml` dependencies explicitly.

#### Subtask 2: Source Rendering (PDF + Image Loading)
**File:** `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/extractors/_rendering.py` (new private module)

| Function | Purpose | Spec Reference |
|----------|---------|----------------|
| `render_pdf_page(file_path: str, page: int, dpi: int) -> Image` | Render a PDF page to a Pillow Image at target DPI | §7.2 step 1, §3.1 |
| `load_image_file(file_path: str, max_dpi: int) -> Image` | Load image file, resize if resolution exceeds target | §7.2 step 1, §13.4 |
| `validate_image_safety(file_path: str, max_dimension: int = 10000) -> None` | Check decompression bomb + resolution limits | §13.4 |
| `get_page_image(file_path: str, page: int, dpi: int) -> Image` | Unified entry point: detects PDF vs image, dispatches | §3.1 |

**Implementation notes:**
- PDF rendering uses PyMuPDF (`fitz`). Must handle `ImportError` gracefully → raise `FormIngestError` with `E_FORM_UNSUPPORTED_FORMAT` if PyMuPDF not installed and file is PDF.
- Image loading uses `PIL.Image.open()`. Supported formats: JPEG, PNG, TIFF (from §3.1).
- Security: Check `PIL.Image.MAX_IMAGE_PIXELS` or set `PIL.Image.DecompressionBombCheck` before loading. Check compressed vs decompressed ratio per §13.4.

#### Subtask 3: OCROverlayExtractor Core Implementation
**File:** `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/extractors/ocr_overlay.py` (replace stub)

**Class:** `OCROverlayExtractor`

```python
class OCROverlayExtractor:
    def __init__(
        self,
        ocr_backend: OCRBackend,
        config: FormProcessorConfig,
    ) -> None: ...

    def extract(
        self,
        file_path: str,
        template: FormTemplate,
    ) -> list[ExtractedField]: ...
```

**Algorithm (from spec §7.2):**

1. Group template fields by `page_number`
2. For each page with fields:
   a. Render page image via `get_page_image()`
   b. Get page dimensions in pixels
   c. For each field on this page:
      - Convert normalized bbox to pixel coordinates
      - Crop field region from page image
      - Branch on `field_type`:
        - **TEXT**: `preprocess_for_ocr(crop, FieldType.TEXT)` → deskew + CLAHE contrast → call `ocr_backend.ocr_region()` with timeout → confidence = mean of char_confidences
        - **NUMBER**: same preprocessing + pass `config="--psm 7 digits"` (Tesseract) or equivalent PaddleOCR config → post-process: strip non-digit chars
        - **DATE**: same preprocessing + pass date-format hint from `field.extraction_hint` → OCR → post-process with date hint
        - **CHECKBOX**: `adaptive_threshold(crop)` → `compute_fill_ratio()` → compare to `config.checkbox_fill_threshold` (0.3) → value = `True`/`False`, confidence = `abs(fill_ratio - threshold) / threshold` capped at 1.0
        - **RADIO**: Same logic as CHECKBOX
        - **SIGNATURE**: `adaptive_threshold(crop)` → `compute_ink_ratio()` → compare to `config.signature_ink_threshold` (0.05) → value = `True`/`False`, confidence = `abs(ink_ratio - threshold) / threshold` capped at 1.0
      - Apply `validation_pattern` regex if defined → on failure: set value=None, confidence=0.0, add `W_FORM_FIELD_VALIDATION_FAILED` warning
      - Build `ExtractedField` with `extraction_method="ocr_overlay"`
3. Return all `ExtractedField` objects

**Per-field timeout:** Pass `config.form_ocr_per_field_timeout_seconds` to `ocr_backend.ocr_region(timeout=...)`. On timeout, set field value=None, confidence=0.0, emit warning.

**Error handling:**
- OCR backend failure on a single field: catch exception, set value=None, confidence=0.0, add `E_FORM_OCR_FAILED` to field warnings. Continue to next field.
- Page rendering failure: catch exception, skip all fields on that page, add `E_FORM_EXTRACTION_FAILED` to each skipped field's warnings.
- Complete extraction failure: raise `FormIngestError` with `E_FORM_EXTRACTION_FAILED`.

#### Subtask 4: OCR Config String Builder
**Within:** Subtask 3 (private helper method or function)

Build OCR engine-specific config strings per field type:

| Field Type | Tesseract Config | PaddleOCR Equivalent |
|------------|-----------------|---------------------|
| TEXT | `--psm 7` (single line) | `use_angle_cls=True` |
| NUMBER | `--psm 7 -c tessedit_char_whitelist=0123456789.-` | `rec_char_type='EN'` with digit filter |
| DATE | `--psm 7` | default + date hint postprocessing |

#### Subtask 5: Unit Tests
**File:** `/home/jjob/projects/ingestkit/packages/ingestkit-forms/tests/test_extractors.py` (replace stub)

**Test categories:**

1. **Preprocessing tests** (mock-free, use synthetic images):
   - `test_deskew_corrects_rotation` — create rotated image, verify deskew straightens it
   - `test_enhance_contrast_increases_range` — verify histogram spread
   - `test_adaptive_threshold_produces_binary` — verify output is binary
   - `test_compute_fill_ratio_empty_region` — all white → ratio near 0.0
   - `test_compute_fill_ratio_filled_region` — all black → ratio near 1.0
   - `test_compute_fill_ratio_partial` — 50% fill → ratio ~0.5
   - `test_compute_ink_ratio_blank` — all white → ratio near 0.0
   - `test_compute_ink_ratio_signed` — scattered dark pixels → ratio > 0.05

2. **Rendering tests** (mock PyMuPDF):
   - `test_load_image_file_jpeg` — load a test JPEG
   - `test_load_image_file_rejects_oversized` — >10000px → error
   - `test_render_pdf_page_calls_backend` — mock fitz, verify DPI passed
   - `test_render_pdf_page_import_error` — no PyMuPDF → graceful error

3. **OCROverlayExtractor tests** (mock `OCRBackend`):
   - `test_extract_text_field` — mock OCR returns text with confidence, verify ExtractedField
   - `test_extract_number_field_strips_nonnumeric` — OCR returns "12.34 USD", verify "12.34"
   - `test_extract_date_field_with_hint` — verify extraction_hint passed to OCR config
   - `test_extract_checkbox_checked` — fill ratio > 0.3 → value=True
   - `test_extract_checkbox_unchecked` — fill ratio < 0.3 → value=False
   - `test_extract_checkbox_confidence_calculation` — verify abs(ratio-0.3)/0.3 formula
   - `test_extract_signature_signed` — ink ratio > 0.05 → value=True
   - `test_extract_signature_blank` — ink ratio < 0.05 → value=False
   - `test_validation_pattern_pass` — regex matches → value kept
   - `test_validation_pattern_fail` — regex fails → value=None, confidence=0.0, warning added
   - `test_per_field_timeout_passed_to_backend` — verify timeout propagation
   - `test_ocr_timeout_returns_none_value` — backend timeout → value=None, confidence=0.0
   - `test_ocr_failure_continues_to_next_field` — one field fails, others succeed
   - `test_multi_page_extraction` — fields on pages 0 and 1, verify both pages rendered
   - `test_bbox_to_pixel_conversion` — verify normalized→pixel math

4. **Security tests**:
   - `test_decompression_bomb_rejected` — per §13.5
   - `test_resolution_guardrail` — per §13.5

5. **PII safety tests**:
   - `test_no_raw_ocr_in_logs_by_default` — verify no extracted text logged
   - `test_raw_ocr_logged_when_enabled` — `log_ocr_output=True` → text appears in logs

#### Subtask 6: Update Extractors __init__.py
**File:** `/home/jjob/projects/ingestkit/packages/ingestkit-forms/src/ingestkit_forms/extractors/__init__.py`

Add export: `from ingestkit_forms.extractors.ocr_overlay import OCROverlayExtractor`

---

## 3. Dependency Graph

```
Subtask 1 (_preprocessing.py)  ─────┐
                                      ├──> Subtask 3 (ocr_overlay.py) ──> Subtask 6 (__init__.py)
Subtask 2 (_rendering.py)      ─────┘                                  │
                                                                        │
Subtask 4 (OCR config builder) ─── included in Subtask 3               │
                                                                        │
Subtask 5 (tests)  ─────────────────────────────────────────────────────┘
```

- Subtasks 1 and 2 are independent and can be developed in parallel.
- Subtask 3 depends on both Subtask 1 and 2.
- Subtask 4 is a helper within Subtask 3.
- Subtask 5 depends on all implementation subtasks.
- Subtask 6 is a trivial update after Subtask 3.

**Recommended execution order:** 1 → 2 → 3 (includes 4) → 6 → 5

---

## 4. Interfaces and Contracts

### 4.1 Public API

```python
# ocr_overlay.py
class OCROverlayExtractor:
    """Extract field values by rendering document pages and OCR-ing each field region."""

    def __init__(
        self,
        ocr_backend: OCRBackend,        # from protocols.py
        config: FormProcessorConfig,     # from config.py
    ) -> None: ...

    def extract(
        self,
        file_path: str,
        template: FormTemplate,          # from models.py
    ) -> list[ExtractedField]: ...       # from models.py
```

### 4.2 Protocol Dependencies

| Protocol | Method Used | Defined In |
|----------|-------------|------------|
| `OCRBackend` | `ocr_region(image_bytes, language, config, timeout) -> OCRRegionResult` | `protocols.py` L138-163 |
| `OCRBackend` | `engine_name() -> str` | `protocols.py` L165-166 |

### 4.3 Model Dependencies

| Model | Fields Used | Defined In |
|-------|-------------|------------|
| `BoundingBox` | `x`, `y`, `width`, `height` (all float, 0.0-1.0) | `models.py` L65-76 |
| `FieldMapping` | `field_id`, `field_name`, `field_label`, `field_type`, `page_number`, `region`, `required`, `validation_pattern`, `extraction_hint` | `models.py` L93-158 |
| `FieldType` | `TEXT`, `NUMBER`, `DATE`, `CHECKBOX`, `RADIO`, `SIGNATURE`, `DROPDOWN` | `models.py` L41-50 |
| `ExtractedField` | All fields — constructor output | `models.py` L271-304 |
| `FormTemplate` | `fields`, `page_count`, `source_format` | `models.py` L161-218 |
| `OCRRegionResult` | `text`, `confidence`, `char_confidences`, `engine` | `protocols.py` L48-57 |

### 4.4 Config Dependencies

| Config Field | Type | Default | Usage |
|-------------|------|---------|-------|
| `form_ocr_dpi` | `int` | 300 | Page rendering resolution |
| `form_ocr_engine` | `str` | `"paddleocr"` | For OCR config string selection |
| `form_ocr_language` | `str` | `"en"` | Passed to `ocr_region()` |
| `form_ocr_per_field_timeout_seconds` | `int` | 10 | Per-field OCR timeout |
| `checkbox_fill_threshold` | `float` | 0.3 | Checkbox checked/unchecked cutoff |
| `signature_ink_threshold` | `float` | 0.05 | Signature signed/blank cutoff |
| `form_extraction_min_field_confidence` | `float` | 0.5 | Below this → value set to None |
| `log_ocr_output` | `bool` | False | PII-safe logging control |
| `log_sample_data` | `bool` | False | PII-safe logging control |

### 4.5 Error Codes Used

| Code | When | Recoverable |
|------|------|-------------|
| `E_FORM_OCR_FAILED` | OCR backend error on a field | Yes (per-field) |
| `E_FORM_EXTRACTION_FAILED` | Page rendering failure or complete extraction failure | No |
| `E_FORM_EXTRACTION_TIMEOUT` | Per-field timeout exceeded | Yes (per-field) |
| `E_FORM_UNSUPPORTED_FORMAT` | File type not supported or required backend missing | No |
| `W_FORM_FIELD_VALIDATION_FAILED` | Validation pattern regex doesn't match | Warning |
| `W_FORM_FIELD_LOW_CONFIDENCE` | Field confidence below min threshold | Warning |

---

## 5. Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| CLAHE/bilateral filter not natively in Pillow | May need numpy dependency or lower-quality approximation | Add numpy to explicit deps (already transitive); implement proper CLAHE via numpy array ops |
| Deskew accuracy for severely rotated scans | Incorrect rotation correction degrades OCR | Limit correction to +/-15 degrees per spec; use projection profile method which is robust for small angles |
| PyMuPDF not installed (optional dep) | PDF page rendering fails | Detect import error at call time, raise clear `E_FORM_UNSUPPORTED_FORMAT` with install hint |
| Large multi-page forms with many fields | Memory pressure from holding all page images | Render one page at a time, release after processing all fields on that page |
| Regex validation pattern could be a ReDoS vector | Hang on malicious pattern | Wrap `re.match()` with a timeout (spec §13.5 requires ReDoS protection test) |
| OCR backend timeout not honored | Field extraction hangs | `ocr_region()` protocol accepts `timeout` param; additionally wrap call with Python-level timeout guard |

---

## 6. Verification Checklist

- [ ] `OCROverlayExtractor` accepts `OCRBackend` protocol, never imports concrete OCR engine
- [ ] All image operations use Pillow (+ numpy for CLAHE/bilateral)
- [ ] PyMuPDF import is lazy and handles `ImportError`
- [ ] Per-field timeout propagated to `ocr_region()`
- [ ] Checkbox: `fill_ratio > config.checkbox_fill_threshold` → True
- [ ] Signature: `ink_ratio > config.signature_ink_threshold` → True
- [ ] Confidence for checkbox/signature: `min(abs(ratio - threshold) / threshold, 1.0)`
- [ ] Text field confidence: mean of `char_confidences` from OCR result
- [ ] Validation pattern failure: value=None, confidence=0.0, `W_FORM_FIELD_VALIDATION_FAILED`
- [ ] No raw OCR text in logs when `log_ocr_output=False`
- [ ] Security: decompression bomb check, resolution limit 10000px
- [ ] All unit tests use mock `OCRBackend`, no external services
- [ ] Tests marked with `@pytest.mark.unit`

---

AGENT_RETURN: .agents/outputs/map-64-021526.md
