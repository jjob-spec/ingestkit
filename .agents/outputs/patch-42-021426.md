---
issue: 42
agent: PATCH
date: 2026-02-14
status: Complete
files_created: 2
files_modified: 1
tests_added: 39
lines_added: ~1100
lines_removed: ~10
---

# PATCH: Issue #42 -- PDFRouter orchestrator and public API

## Executive Summary

Implemented `PDFRouter` class in `router.py` as the top-level orchestrator for the ingestkit-pdf pipeline. The router executes a 15-step `process()` flow per SPEC section 17.1, includes tiered classification with LLM outage resilience per SPEC section 5.2, `process_batch()` with `ProcessPoolExecutor`, `create_default_router()` factory, and full `__init__.py` public API exports per SPEC section 21.1. All 39 unit tests pass, all ruff checks pass, no regressions in the existing test suite.

## Metrics

| Metric | Value |
|--------|-------|
| Files created | 2 (`router.py`, `test_router.py`) |
| Files modified | 1 (`__init__.py`) |
| Tests added | 39 |
| Test classes | 9 |
| `router.py` lines | ~580 |
| `test_router.py` lines | ~780 |

## Files Changed

### `packages/ingestkit-pdf/src/ingestkit_pdf/router.py` (CREATED)

- `PDFRouter` class with `can_handle()`, `process()`, `process_batch()`
- `_build_document_profile()` and `_build_page_profile()` private methods for PyMuPDF document profiling
- `_classify()` with full tiered classification (Tier 1 -> Tier 2 -> Tier 3) and LLM outage resilience
- `_determine_page_type()` static method for preliminary page type heuristics
- `_build_parse_stage_result()`, `_build_error_result()`, `_merge_errors()` helpers
- `_pdf_type_to_ingestion_method()` and `_pdf_type_to_path_name()` static helpers
- Module-level `_process_single_file()` worker function for `ProcessPoolExecutor`
- `create_default_router()` factory function importing backends from `ingestkit_excel.backends`

### `packages/ingestkit-pdf/tests/test_router.py` (CREATED)

9 test classes, 39 test methods:
- `TestCanHandle` (6): PDF extension matching
- `TestClassify` (4): Tier escalation
- `TestLLMOutageResilience` (5): SPEC 5.2 contract
- `TestSecurityScan` (2): Fatal errors and warnings
- `TestDocumentProfiling` (5): Page profiles, language, TOC
- `TestProcessFlow` (6): Processor routing, corrupt files, fail-closed
- `TestIngestKey` (3): Deterministic keys, tenant_id, source_uri
- `TestProcessBatch` (3): Empty batch, ordering, timeouts
- `TestCreateDefaultRouter` (2): Factory and config overrides
- `TestLogging` (3): PII-safe INFO/WARNING/ERROR

### `packages/ingestkit-pdf/src/ingestkit_pdf/__init__.py` (MODIFIED)

Updated with all SPEC section 21.1 public API exports plus backward-compatible additions from existing code.

## PLAN-CHECK Corrections Applied

**ISSUE-1 (MEDIUM)**: Used string-based error messages instead of nonexistent error codes: `"ComplexProcessor not available"` for COMPLEX type routing, `"Processing timeout"` for batch timeouts, `"Processing failed: {exc}"` for batch exceptions.

**ISSUE-2 (LOW)**: Removed `OCRStageResult` from router.py imports (unused). Also removed `EmbedStageResult` which was listed in PLAN imports but unused.

## Deviations from PLAN

1. **`_determine_page_type()` extracted as static method**: The PLAN described this inline in `_build_page_profile()`. Extracted for clarity and testability.

2. **process_batch() test mocking**: PLAN described testing process_batch with `ProcessPoolExecutor`. Since mock backends are not picklable, tests mock the executor and `as_completed` at the interface boundary instead of patching the worker function.

3. **conftest import approach**: Used `sys.path` insertion to import conftest helpers since pytest's conftest auto-loading doesn't support `from conftest import ...` as a module import.

## Verification

```
pytest packages/ingestkit-pdf/tests/test_router.py -v    # 39 passed
pytest packages/ingestkit-pdf/tests/ -q                   # 782 passed, 2 failed (pre-existing), 1 skipped
ruff check packages/ingestkit-pdf/src/ingestkit_pdf/router.py  # All checks passed
ruff check packages/ingestkit-pdf/tests/test_router.py         # All checks passed
```

The 2 pre-existing failures are in `test_complex_processor.py` and are unrelated to this change.

## Acceptance Criteria Status

All criteria met. See plan-42-021426.md for full list.

AGENT_RETURN: .agents/outputs/patch-42-021426.md
