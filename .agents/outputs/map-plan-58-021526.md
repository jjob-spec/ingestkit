# MAP-PLAN: Issue #58 -- Form Error Taxonomy and Structured Error Model

## Investigation Summary

### Files Read
- `docs/specs/form-ingestor-plugin.md` section 12 (lines 1830-1959) -- authoritative spec for error codes and model
- `packages/ingestkit-core/src/ingestkit_core/errors.py` -- `CoreErrorCode(str, Enum)` and `BaseIngestError(BaseModel)`
- `packages/ingestkit-excel/src/ingestkit_excel/errors.py` -- `ErrorCode(str, Enum)` and `IngestError(BaseIngestError)` (sibling pattern)
- `packages/ingestkit-core/src/ingestkit_core/__init__.py` -- public re-exports

### Key Findings

1. **No `packages/ingestkit-forms/` directory exists yet.** This is the first module for the forms package. A new package must be created.

2. **Established pattern from ingestkit-excel:**
   - Package-specific `ErrorCode(str, Enum)` with all codes (including duplicated backend codes from core)
   - Package-specific `IngestError(BaseIngestError)` that narrows the `code` field and adds a location field (`sheet_name`)
   - `BaseIngestError` from `ingestkit-core` has: `code: str`, `message: str`, `stage: str | None`, `recoverable: bool`

3. **E_BACKEND_* codes already exist in `CoreErrorCode`:** All 6 backend codes (`E_BACKEND_VECTOR_TIMEOUT`, `E_BACKEND_VECTOR_CONNECT`, `E_BACKEND_DB_TIMEOUT`, `E_BACKEND_DB_CONNECT`, `E_BACKEND_EMBED_TIMEOUT`, `E_BACKEND_EMBED_CONNECT`) are in `ingestkit_core.errors.CoreErrorCode`.

4. **Spec defines 40 codes total:** 22 error codes (E_) + 14 warning codes (W_) + 6 backend codes (reused) = 42 enum members.

5. **FormIngestError extends beyond BaseIngestError.** The spec model has additional fields not in `BaseIngestError`: `template_id`, `template_version`, `field_name`, `page_number`, and 3 diagnostic `Field()` descriptors (`candidate_matches`, `backend_operation_id`, `fallback_reason`). Decision: extend `BaseIngestError` (like Excel does) rather than use a standalone `BaseModel`.

6. **ENUM_VALUE risk:** Spec explicitly shows all values matching their names (e.g., `E_FORM_NO_MATCH = "E_FORM_NO_MATCH"`). Must verify this in implementation.

## Plan

### Step 1: Create package skeleton for `ingestkit-forms`

**File:** `packages/ingestkit-forms/src/ingestkit_forms/__init__.py`

Create minimal `__init__.py` that re-exports `FormErrorCode` and `FormIngestError`.

**File:** `packages/ingestkit-forms/src/ingestkit_forms/errors.py`

This is the primary deliverable.

### Step 2: Implement `FormErrorCode(str, Enum)` in `errors.py`

Transcribe all 42 enum members from spec section 12.1 exactly:

```python
class FormErrorCode(str, Enum):
    # Template errors (4)
    E_FORM_TEMPLATE_NOT_FOUND = "E_FORM_TEMPLATE_NOT_FOUND"
    E_FORM_TEMPLATE_INVALID = "E_FORM_TEMPLATE_INVALID"
    E_FORM_TEMPLATE_VERSION_CONFLICT = "E_FORM_TEMPLATE_VERSION_CONFLICT"
    E_FORM_TEMPLATE_STORE_UNAVAILABLE = "E_FORM_TEMPLATE_STORE_UNAVAILABLE"

    # Matching errors (2)
    E_FORM_NO_MATCH = "E_FORM_NO_MATCH"
    E_FORM_FINGERPRINT_FAILED = "E_FORM_FINGERPRINT_FAILED"

    # Extraction errors (6)
    E_FORM_EXTRACTION_FAILED = "E_FORM_EXTRACTION_FAILED"
    E_FORM_EXTRACTION_LOW_CONFIDENCE = "E_FORM_EXTRACTION_LOW_CONFIDENCE"
    E_FORM_EXTRACTION_TIMEOUT = "E_FORM_EXTRACTION_TIMEOUT"
    E_FORM_UNSUPPORTED_FORMAT = "E_FORM_UNSUPPORTED_FORMAT"
    E_FORM_OCR_FAILED = "E_FORM_OCR_FAILED"
    E_FORM_NATIVE_FIELDS_UNAVAILABLE = "E_FORM_NATIVE_FIELDS_UNAVAILABLE"

    # Output errors (3)
    E_FORM_DB_SCHEMA_EVOLUTION_FAILED = "E_FORM_DB_SCHEMA_EVOLUTION_FAILED"
    E_FORM_DB_WRITE_FAILED = "E_FORM_DB_WRITE_FAILED"
    E_FORM_CHUNK_WRITE_FAILED = "E_FORM_CHUNK_WRITE_FAILED"

    # Dual-write errors (1)
    E_FORM_DUAL_WRITE_PARTIAL = "E_FORM_DUAL_WRITE_PARTIAL"

    # Manual override errors (1)
    E_FORM_FORMAT_MISMATCH = "E_FORM_FORMAT_MISMATCH"

    # VLM errors (2)
    E_FORM_VLM_UNAVAILABLE = "E_FORM_VLM_UNAVAILABLE"
    E_FORM_VLM_TIMEOUT = "E_FORM_VLM_TIMEOUT"

    # Security errors (2)
    E_FORM_FILE_TOO_LARGE = "E_FORM_FILE_TOO_LARGE"
    E_FORM_FILE_CORRUPT = "E_FORM_FILE_CORRUPT"

    # Backend errors (reused from core) (6)
    E_BACKEND_VECTOR_TIMEOUT = "E_BACKEND_VECTOR_TIMEOUT"
    E_BACKEND_VECTOR_CONNECT = "E_BACKEND_VECTOR_CONNECT"
    E_BACKEND_DB_TIMEOUT = "E_BACKEND_DB_TIMEOUT"
    E_BACKEND_DB_CONNECT = "E_BACKEND_DB_CONNECT"
    E_BACKEND_EMBED_TIMEOUT = "E_BACKEND_EMBED_TIMEOUT"
    E_BACKEND_EMBED_CONNECT = "E_BACKEND_EMBED_CONNECT"

    # Warnings (14)
    W_FORM_FIELD_LOW_CONFIDENCE = "W_FORM_FIELD_LOW_CONFIDENCE"
    W_FORM_FIELD_VALIDATION_FAILED = "W_FORM_FIELD_VALIDATION_FAILED"
    W_FORM_FIELD_MISSING_REQUIRED = "W_FORM_FIELD_MISSING_REQUIRED"
    W_FORM_FIELD_TYPE_COERCION = "W_FORM_FIELD_TYPE_COERCION"
    W_FORM_FIELDS_FLATTENED = "W_FORM_FIELDS_FLATTENED"
    W_FORM_MATCH_BELOW_THRESHOLD = "W_FORM_MATCH_BELOW_THRESHOLD"
    W_FORM_MULTI_MATCH = "W_FORM_MULTI_MATCH"
    W_FORM_OCR_DEGRADED = "W_FORM_OCR_DEGRADED"
    W_FORM_MERGED_CELL_RESOLVED = "W_FORM_MERGED_CELL_RESOLVED"
    W_FORM_SCHEMA_EVOLVED = "W_FORM_SCHEMA_EVOLVED"
    W_FORM_ROLLBACK_FAILED = "W_FORM_ROLLBACK_FAILED"
    W_FORM_PARTIAL_WRITE = "W_FORM_PARTIAL_WRITE"
    W_FORM_VLM_FALLBACK_USED = "W_FORM_VLM_FALLBACK_USED"
    W_FORM_VLM_BUDGET_EXHAUSTED = "W_FORM_VLM_BUDGET_EXHAUSTED"
```

**ENUM_VALUE check:** Every member name == its string value. Verified against spec.

### Step 3: Implement `FormIngestError(BaseIngestError)` in `errors.py`

Extend `BaseIngestError` from `ingestkit-core` (inherits `code`, `message`, `stage`, `recoverable`). Add form-specific fields per spec section 12.2:

```python
from pydantic import Field
from ingestkit_core.errors import BaseIngestError

class FormIngestError(BaseIngestError):
    code: FormErrorCode  # type: ignore[assignment]  # narrows base str to FormErrorCode
    template_id: str | None = None
    template_version: int | None = None
    field_name: str | None = None
    page_number: int | None = None
    # Diagnostic context (P1)
    candidate_matches: list[dict] | None = Field(
        default=None,
        description="Top template match candidates with confidences (for match-related errors).",
    )
    backend_operation_id: str | None = Field(
        default=None,
        description="Backend-specific operation ID for tracing write/rollback failures.",
    )
    fallback_reason: str | None = Field(
        default=None,
        description="Why fallback was triggered (for degraded-path errors).",
    )
```

Note: `stage` and `recoverable` are already on `BaseIngestError`, so no need to redeclare.

### Step 4: Create `pyproject.toml` for the forms package

Minimal pyproject.toml following the pattern of `ingestkit-excel`:

- Name: `ingestkit-forms`
- Dependency: `ingestkit-core` (for `BaseIngestError`)
- Dependency: `pydantic>=2.0` (for `Field`)
- Python: `>=3.10`

### Step 5: Write unit tests

**File:** `packages/ingestkit-forms/tests/test_errors.py`

Tests:
1. Every `FormErrorCode` member's `.value` equals its `.name` (ENUM_VALUE guard)
2. Total member count == 42
3. All E_ codes are errors, all W_ codes are warnings (prefix check)
4. `FormIngestError` can be constructed with all required fields
5. `FormIngestError` serializes/deserializes correctly (Pydantic round-trip)
6. `FormIngestError` is a subclass of `BaseIngestError`
7. Backend codes in `FormErrorCode` match values in `CoreErrorCode`
8. Default `recoverable` is `False`
9. Diagnostic context fields (`candidate_matches`, `backend_operation_id`, `fallback_reason`) default to `None`

**File:** `packages/ingestkit-forms/tests/conftest.py` -- empty or minimal fixtures

### Step 6: Update `__init__.py` with re-exports

```python
from ingestkit_forms.errors import FormErrorCode, FormIngestError

__all__ = ["FormErrorCode", "FormIngestError"]
```

## Files to Create/Modify

| File | Action | Description |
|------|--------|-------------|
| `packages/ingestkit-forms/pyproject.toml` | CREATE | Package config with ingestkit-core dep |
| `packages/ingestkit-forms/src/ingestkit_forms/__init__.py` | CREATE | Re-exports FormErrorCode, FormIngestError |
| `packages/ingestkit-forms/src/ingestkit_forms/errors.py` | CREATE | FormErrorCode enum (42 members) + FormIngestError model |
| `packages/ingestkit-forms/tests/__init__.py` | CREATE | Empty |
| `packages/ingestkit-forms/tests/conftest.py` | CREATE | Minimal test config |
| `packages/ingestkit-forms/tests/test_errors.py` | CREATE | Unit tests for error taxonomy |

## Risks and Mitigations

| Risk | Mitigation |
|------|------------|
| ENUM_VALUE mismatch (name != value) | Unit test asserts `member.name == member.value` for all 42 members |
| Missing code from spec | Unit test asserts total count == 42 |
| BaseIngestError API drift | Import and extend, test isinstance check |
| Duplicate backend codes diverge from core | Unit test compares FormErrorCode backend values against CoreErrorCode |

## Estimated Complexity

Low -- pure data definitions (enum + Pydantic model) with no business logic. Roughly 150 lines of production code and 100 lines of tests.

AGENT_RETURN: .agents/outputs/map-plan-58-021526.md
